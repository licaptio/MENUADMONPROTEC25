  <!DOCTYPE html>
  <html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AlikaBot - Nuevo Recordatorio</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
      body {
        margin: 0;
        font-family: 'Segoe UI', sans-serif;
        color: white;
        background-color: black;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }
  
      .container {
        max-width: 500px;
        width: 100%;
        padding: 20px;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1;
      }
  
      h1 {
        text-align: center;
      }
  
      input, select, textarea {
        width: 100%;
        margin-bottom: 10px;
        padding: 12px;
        font-size: 16px;
        border-radius: 5px;
        border: none;
      }
  
      textarea {
        height: 120px;
        resize: vertical;
      }
  
      label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 15px;
        margin-bottom: 10px;
      }
  
      .crear-btn {
        background-color: #af3a43;
        border: none;
        color: white;
        padding: 12px;
        font-size: 16px;
        width: 100%;
        cursor: pointer;
        border-radius: 5px;
      }
  
      .fondo {
        position: fixed;
        z-index: -1;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: black;
        background-image: url("fondo-lobas.jpg");
        background-repeat: no-repeat;
        background-size: contain;
        background-position: center;
        opacity: 0.7;
      }
  
      @media (min-width: 800px) {
        body {
          flex-direction: row;
          justify-content: flex-end;
        }
        .fondo {
          background-position: left center;
          background-size: auto 100%;
        }
        .container {
          margin-right: 5%;
        }
      }
  
      @media (max-width: 799px) {
        .fondo {
          background-position: bottom center;
          background-size: 100% auto;
        }
      }
  .switch-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    font-size: 15px;
  }
  
  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
  }
  
  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  
  .slider {
    position: absolute;
    cursor: pointer;
    background-color: #555;
    border-radius: 34px;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    transition: .4s;
  }
  
  .slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    border-radius: 50%;
    transition: .4s;
  }
  
  .switch input:checked + .slider {
    background-color: #af3a43;
  }
  
  .switch input:checked + .slider:before {
    transform: translateX(26px);
  }
  
  .ver-btn {
    background-color: #f9c74f;
    color: black;
    border: none;
    padding: 12px;
    width: 100%;
    font-size: 16px;
    font-weight: bold;
    margin-top: 20px;
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.3s ease;
  }
  
  .ver-btn:hover {
    background-color: #ffd86a;
  }
  #btn-microfono.grabando {
    background-color:#af3a43;
    animation:latido 1s infinite;
  }
  @keyframes latido {
    0% { transform:scale(1); }
    50% { transform:scale(1.12); }
    100% { transform:scale(1); }
  }
.icon-btn{
  background:#555; border:none; border-radius:10px;
  width:48px; height:48px; font-size:20px; color:#fff; cursor:pointer;
}
.icon-btn:active{ transform:scale(0.98); }
/* ===== Sub-p√°gina (overlay) para fecha ===== */
.subpage-overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  display:flex; align-items:center; justify-content:center;
  backdrop-filter: blur(2px);
}
.subpage{
  width:min(420px, 92vw);
  background:#111; color:#fff;
  border:1px solid #333; border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.5);
}
.subpage-header{
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 16px; border-bottom:1px solid #222;
}
.subpage-x{
  background:transparent; border:none; color:#aaa; font-size:18px; cursor:pointer;
}
.subpage-x:hover{ color:#fff; }
.subpage-body{ padding:16px; }
.subpage-body input[type="date"]{
  width:100%; font-size:16px; padding:10px 12px;
  background:#000; color:#fff; border:1px solid #444; border-radius:8px;
}
.subpage-actions{
  display:flex; gap:10px; justify-content:flex-end;
  padding:12px 16px; border-top:1px solid #222;
}
.subpage-actions button{
  border:none; border-radius:8px; padding:10px 14px; font-size:14px; cursor:pointer;
}
#subfecha-cancel{ background:#333; color:#eee; }
#subfecha-ok{ background:#af3a43; color:#fff; }
#subfecha-ok:active, #subfecha-cancel:active{ transform:scale(.98); }

/* Fuerza a ocultar cualquier elemento con [hidden] aunque tenga display en su clase */
[hidden] { 
  display: none !important;
}

    </style>
  </head>
  <body>
    <div class="fondo"></div>
    <div class="container">
      <h1>üåü AlikaBot - Nuevo Recordatorio</h1>
  
  <label for="descripcion">üé§ Descripci√≥n o nota:</label>
  <div style="display:flex; align-items:center; gap:10px;">
    <textarea id="descripcion" placeholder="Toca aqu√≠ y habla o escribe..." style="flex:1;"></textarea>
    <button id="btn-microfono" type="button" aria-label="Micr√≥fono" style="
      background-color:#555;
      border:none;
      border-radius:50%;
      width:56px;
      height:56px;
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:24px;
      color:white;
      cursor:pointer;
      flex:0 0 56px;
    ">üé§</button>
  </div>
<div style="display:flex; gap:10px; align-items:center;">
  <input type="tel" id="fechaTexto" inputmode="numeric" maxlength="6" pattern="[0-9]*" placeholder="Fecha (ej. 030825)" style="flex:1;" />
  <button id="btn-cal" type="button" class="icon-btn" aria-label="Abrir calendario">üìÖ</button>
  <!-- Picker nativo oculto -->
</div>

<input type="tel" id="horaTexto"  inputmode="numeric" maxlength="4" pattern="[0-9]*"  placeholder="Hora (ej. 1740)" />

<select id="canal">
  <option value="telegram">Telegram</option>
</select>

<select id="tags">
  <option value="alika">alika</option>
</select>
  <div class="switch-wrapper">
    <span>Activo</span>
    <label class="switch">
      <input type="checkbox" id="activo" checked>
      <span class="slider"></span>
    </label>
  </div>
  
  <div class="switch-wrapper">
    <span>Recurrente</span>
    <label class="switch">
      <input type="checkbox" id="recurrente">
      <span class="slider"></span>
    </label>
  </div>
      <button class="crear-btn" onclick="crearRecordatorio()">üîî Crear recordatorio</button>
      <button onclick="location.href='ver-recordatorios.html'" class="ver-btn">Ver y editar recordatorios</button>
    </div>
  <div id="mensaje-exito" style="
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    display: none;
    z-index: 9999;
  ">
    ‚úÖ Guardado exitosamente
  </div>
  
<script>
  let idEditando = null;

  // Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
    authDomain: "notasfoliador.firebaseapp.com",
    projectId: "notasfoliador",
    storageBucket: "notasfoliador.appspot.com",
    messagingSenderId: "96242533231",
    appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Par√°metros y refs generales
  const params = new URLSearchParams(window.location.search);
  const idDesdeURL = params.get("id");
  const btnCrear = document.querySelector('.crear-btn');

  // No-op: la sobreescribimos al inicializar el modal
  window.syncDatePickerFromText = function(){};

  // === CRUD ===
  function crearRecordatorio() {
    btnCrear.disabled = true;
    btnCrear.textContent = '‚è≥ Guardando...';

    const descripcion = document.getElementById('descripcion').value.trim();
    const fechaTexto  = document.getElementById('fechaTexto').value.trim(); // ddmmaa
    const horaTexto   = document.getElementById('horaTexto').value.trim();  // hhmm
    const canal       = document.getElementById('canal').value;
    const tags        = document.getElementById('tags').value;
    const activo      = document.getElementById('activo').checked;
    const recurrente  = document.getElementById('recurrente').checked;

    if (!descripcion || !fechaTexto || !horaTexto || fechaTexto.length !== 6 || horaTexto.length !== 4) {
      alert("Falta descripci√≥n o fecha/hora inv√°lida.");
      btnCrear.disabled = false;
      btnCrear.textContent = idEditando ? 'üíæ Guardar cambios' : 'üîî Crear recordatorio';
      return;
    }

    const dia     = parseInt(fechaTexto.substring(0, 2));
    const mes     = parseInt(fechaTexto.substring(2, 4)) - 1;
    const a√±o     = parseInt("20" + fechaTexto.substring(4, 6));
    const horas   = parseInt(horaTexto.substring(0, 2));
    const minutos = parseInt(horaTexto.substring(2, 4));

    const fecha = new Date(a√±o, mes, dia, horas, minutos);
    const yyEntrada = parseInt(fechaTexto.slice(4, 6), 10);
    const fechaEstricaOk =
      fecha.getFullYear() === (2000 + yyEntrada) &&
      fecha.getMonth() === mes &&
      fecha.getDate() === dia;

    if (!fechaEstricaOk) {
      alert("La fecha no es v√°lida (d√≠a/mes/a√±o). Verif√≠cala.");
      btnCrear.disabled = false;
      btnCrear.textContent = idEditando ? 'üíæ Guardar cambios' : 'üîî Crear recordatorio';
      return;
    }

    if ([dia, mes, a√±o, horas, minutos].some(Number.isNaN)) {
      alert("Fecha u hora inv√°lidas.");
      btnCrear.disabled = false;
      btnCrear.textContent = idEditando ? 'üíæ Guardar cambios' : 'üîî Crear recordatorio';
      return;
    }
    if (horas < 0 || horas > 23 || minutos < 0 || minutos > 59) {
      alert("Hora inv√°lida (usa formato 24h, ej. 1740).");
      btnCrear.disabled = false;
      btnCrear.textContent = idEditando ? 'üíæ Guardar cambios' : 'üîî Crear recordatorio';
      return;
    }
    if (isNaN(fecha.getTime())) {
      alert("La fecha/hora no existe. Verifica d√≠a, mes y a√±o.");
      btnCrear.disabled = false;
      btnCrear.textContent = idEditando ? 'üíæ Guardar cambios' : 'üîî Crear recordatorio';
      return;
    }

    const nuevo = {
      descripcion,
      fecha,
      canal,
      tags: [tags],
      activo,
      recurrente,
      enviado: false
    };

    const coleccion = db.collection("recordatorios_alika");

    if (idEditando) {
      coleccion.doc(idEditando).get().then(doc => {
        if (!doc.exists) {
          alert("El recordatorio a editar no existe.");
          btnCrear.disabled = false;
          btnCrear.textContent = 'üíæ Guardar cambios';
          return;
        }
        const anterior   = doc.data();
        const fechaAntes = anterior.fecha.toDate().getTime();
        const fechaNueva = fecha.getTime();

        nuevo.enviado = (fechaAntes === fechaNueva) ? anterior.enviado : false;

        coleccion.doc(idEditando).update(nuevo)
          .then(() => {
            console.log("‚úÖ Actualizado");
            mostrarMensajeExito("‚úÖ Cambios guardados");
            limpiarFormulario();

            btnCrear.disabled = false;
            btnCrear.textContent = 'üîî Crear recordatorio';

            setTimeout(() => {
              window.history.replaceState({}, document.title, window.location.pathname);
              location.reload();
            }, 2000);
          })
          .catch(e => {
            console.error("‚ùå Error actualizando:", e);
            btnCrear.disabled = false;
            btnCrear.textContent = idEditando ? 'üíæ Guardar cambios' : 'üîî Crear recordatorio';
          });
      }).catch(e => {
        console.error("‚ùå Error obteniendo documento:", e);
        btnCrear.disabled = false;
        btnCrear.textContent = 'üíæ Guardar cambios';
      });
    } else {
      coleccion.add(nuevo)
        .then(() => {
          console.log("‚úÖ Guardado en Firestore");
          mostrarMensajeExito();
          limpiarFormulario();
          btnCrear.disabled = false;
          btnCrear.textContent = 'üîî Crear recordatorio';
          setTimeout(() => location.reload(), 2000);
        })
        .catch(e => {
          console.error("‚ùå Error guardando en Firestore:", e);
          btnCrear.disabled = false;
          btnCrear.textContent = 'üîî Crear recordatorio';
        });
    }
  }

  function editarRecordatorio(id) {
    db.collection("recordatorios_alika").doc(id).get().then(doc => {
      if (doc.exists) {
        const r = doc.data();
        document.getElementById('descripcion').value = r.descripcion;
        document.getElementById('canal').value       = r.canal;
        document.getElementById('tags').value        = r.tags?.[0] || '';
        document.getElementById('activo').checked    = r.activo;
        document.getElementById('recurrente').checked= r.recurrente;

        const d  = r.fecha.toDate();
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const yy = String(d.getFullYear()).slice(-2);
        const hh = String(d.getHours()).padStart(2, '0');
        const mi = String(d.getMinutes()).padStart(2, '0');

        document.getElementById('fechaTexto').value = `${dd}${mm}${yy}`;
        document.getElementById('horaTexto').value  = `${hh}${mi}`;

        idEditando = id;
        document.querySelector('.crear-btn').textContent = 'üíæ Guardar cambios';
        // sincroniza el modal si est√° abierto
        if (window.syncDatePickerFromText) window.syncDatePickerFromText();
      }
    });
  }

  function mostrarMensajeExito(texto = "‚úÖ Guardado exitosamente") {
    const mensaje = document.getElementById("mensaje-exito");
    mensaje.textContent = texto;
    mensaje.style.display = "block";
    setTimeout(() => { mensaje.style.display = "none"; }, 2000);
  }

  // Inicializaciones de UI y modal fecha
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('subfecha');
  if (modal) { modal.hidden = true; modal.setAttribute('aria-hidden','true'); }
    const btnCal       = document.getElementById('btn-cal');
    const fechaTextoEl = document.getElementById('fechaTexto');

    // Sugerir fecha/hora (ahora +2h) si no hay valores previos
    {
      const now = new Date();
      const future = new Date(now.getTime() + 2 * 60 * 60 * 1000);
      const dd = String(future.getDate()).padStart(2, '0');
      const mm = String(future.getMonth() + 1).padStart(2, '0');
      const yy = String(future.getFullYear()).slice(-2);
      const hh = String(future.getHours()).padStart(2, '0');
      const mi = String(future.getMinutes()).padStart(2, '0');

      if (!fechaTextoEl.value) document.getElementById('fechaTexto').value = `${dd}${mm}${yy}`;
      if (!document.getElementById('horaTexto').value) {
        document.getElementById('horaTexto').value = `${hh}${mi}`;
      }
    }

    // ===== Modal "sub-p√°gina" de fecha =====
    if (btnCal) {
      const modal     = document.getElementById('subfecha');
      const dateModal = document.getElementById('fechaPickerModal');
      const btnClose  = document.getElementById('subfecha-close');
      const btnCancel = document.getElementById('subfecha-cancel');
      const btnOk     = document.getElementById('subfecha-ok');

      const pad2 = n => String(n).padStart(2,'0');
      const ddmmaaToISO = (v) => {
        if (!v || v.length !== 6) return '';
        const dd = v.slice(0,2), mm = v.slice(2,4), aa = v.slice(4,6);
        const yyyy = 2000 + parseInt(aa,10);
        return `${yyyy}-${mm}-${dd}`;
      };
      const isoToDDMMAA = (iso) => {
        const [yyyy, mm, dd] = iso.split('-');
        return `${dd}${mm}${yyyy.slice(-2)}`;
      };

      function openSubpage(){
        let iso = ddmmaaToISO((fechaTextoEl.value || '').trim());
        if (!iso || isNaN(new Date(iso).getTime())) {
          const t = new Date();
          iso = `${t.getFullYear()}-${pad2(t.getMonth()+1)}-${pad2(t.getDate())}`;
        }
        dateModal.value = iso;
modal.hidden = false;
  modal.setAttribute('aria-hidden', 'false');
  setTimeout(()=>dateModal.focus(), 0);
  document.addEventListener('keydown', escHandler);
  document.body.style.overflow = 'hidden';
}
function closeSubpage(){
  modal.hidden = true;
  modal.setAttribute('aria-hidden', 'true');
  document.removeEventListener('keydown', escHandler);
  document.body.style.overflow = '';
  btnCal.focus();
} 
      function escHandler(e){
        if (e.key === 'Escape') closeSubpage();
      }
      function confirmDate(){
        if (dateModal.value) {
          fechaTextoEl.value = isoToDDMMAA(dateModal.value);
        }
        closeSubpage();
      }

      // Abrir SOLO con interacci√≥n t√°ctil/rat√≥n (no por teclado)
let allowOpen = false;
btnCal.addEventListener('pointerdown', () => { allowOpen = true; });
btnCal.addEventListener('click', (e) => {
  if (!allowOpen) return;     // ignora clicks ‚Äúsint√©ticos‚Äù
  allowOpen = false;
  openSubpage();
});
// Evita que Enter/Espacio en el bot√≥n disparen el modal
btnCal.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') e.preventDefault();
});

      btnClose.addEventListener('click', closeSubpage);
      btnCancel.addEventListener('click', closeSubpage);
      btnOk.addEventListener('click', confirmDate);
      modal.addEventListener('click', (e)=>{
        if (e.target === modal) closeSubpage();
      });
      dateModal.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') confirmDate();
      });

      // Sincroniza el <input type="date"> si editas ddmmaa mientras el modal est√° abierto
      window.syncDatePickerFromText = function(){
        const v = (fechaTextoEl.value || '').trim();
        if (!modal.hidden && v.length === 6) {
          const iso = ddmmaaToISO(v);
          if (iso && !isNaN(new Date(iso).getTime())) dateModal.value = iso;
        }
      };

      // Cada vez que escribas en ddmmaa
      fechaTextoEl.addEventListener('input', window.syncDatePickerFromText);
    }

    // Si venimos con ?id=... cargar para editar
    if (idDesdeURL && idDesdeURL !== "nuevo") {
      editarRecordatorio(idDesdeURL);
    }
  });

  // üé§ Micr√≥fono (igual que lo ten√≠as)
  const textarea = document.getElementById('descripcion');
  const btnMicro = document.getElementById('btn-microfono');
  btnMicro.title = 'Toca para grabar';
  btnMicro.setAttribute('aria-pressed', 'false');

  let grabando = false;
  let recognition = null;

  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = 'es-MX';
    recognition.continuous = true;
    recognition.interimResults = false;

    btnMicro.addEventListener('click', () => {
      if (!grabando) {
        try { recognition.start(); } catch (e) { console.warn('start() ignorado:', e); }
      } else {
        try { recognition.stop(); } catch (e) { console.warn('stop() ignorado:', e); }
      }
    });

    recognition.onstart = () => {
      grabando = true;
      btnMicro.classList.add('grabando');
      btnMicro.textContent = 'üõë';
      btnMicro.setAttribute('aria-pressed', 'true');
      btnMicro.title = 'Toca para detener';
    };

    recognition.onend = () => {
      grabando = false;
      btnMicro.classList.remove('grabando');
      btnMicro.textContent = 'üé§';
      btnMicro.setAttribute('aria-pressed', 'false');
      btnMicro.title = 'Toca para grabar';
    };

    recognition.onresult = (event) => {
      let agregado = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const res = event.results[i];
        if (res.isFinal) agregado += (agregado ? ' ' : '') + res[0].transcript;
      }
      if (agregado) textarea.value += (textarea.value ? ' ' : '') + agregado;
    };

    recognition.onerror = (e) => {
      console.warn('üé§ Error de reconocimiento:', e);
      grabando = false;
      btnMicro.classList.remove('grabando');
      btnMicro.textContent = 'üé§';
      btnMicro.setAttribute('aria-pressed', 'false');
      btnMicro.title = 'Toca para grabar';
    };
  } else {
    btnMicro.disabled = true;
    btnMicro.title = 'Tu navegador no soporta dictado por voz';
  }

  function limpiarFormulario() {
    document.getElementById('descripcion').value = "";

    const now = new Date();
    const future = new Date(now.getTime() + 2 * 60 * 60 * 1000);
    const dd = String(future.getDate()).padStart(2, '0');
    const mm = String(future.getMonth() + 1).padStart(2, '0');
    const yy = String(future.getFullYear()).slice(-2);
    const hh = String(future.getHours()).padStart(2, '0');
    const mi = String(future.getMinutes()).padStart(2, '0');

    document.getElementById('fechaTexto').value = `${dd}${mm}${yy}`;
    document.getElementById('horaTexto').value  = `${hh}${mi}`;
    document.getElementById('canal').value      = "telegram";
    document.getElementById('tags').value       = "alika";
    document.getElementById('activo').checked   = true;
    document.getElementById('recurrente').checked = false;

    idEditando = null;
    document.querySelector('.crear-btn').textContent = 'üîî Crear recordatorio';

    if (window.syncDatePickerFromText) window.syncDatePickerFromText();
  }
</script>
<!-- Sub-p√°gina: selector de fecha -->
<div id="subfecha" class="subpage-overlay" hidden>
  <div class="subpage" role="dialog" aria-modal="true" aria-labelledby="subfecha-title">
    <header class="subpage-header">
      <h2 id="subfecha-title" style="margin:0;">Selecciona la fecha</h2>
      <button type="button" id="subfecha-close" aria-label="Cerrar" class="subpage-x">‚úï</button>
    </header>
    <div class="subpage-body">
      <input type="date" id="fechaPickerModal" />
    </div>
    <footer class="subpage-actions">
      <button type="button" id="subfecha-cancel">Cancelar</button>
      <button type="button" id="subfecha-ok">Aceptar</button>
    </footer>
  </div>
</div>
  </body>
  </html>
