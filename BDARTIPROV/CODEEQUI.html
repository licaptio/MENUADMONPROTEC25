<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Insertar Equivalentes en Firestore</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { color: #003366; }
    #log { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; max-height: 300px; overflow-y: auto; }
    button { margin-right: 10px; padding: 8px 16px; }
    .progress-container { margin-top: 15px; width: 100%; background: #eee; border-radius: 6px; height: 24px; }
    .progress-bar { height: 100%; width: 0%; background: #4caf50; border-radius: 6px; text-align: center; color: white; font-size: 14px; }
  </style>
</head>
<body>
  <h1>🔄 Insertar Equivalentes en Firestore</h1>
  <input type="file" id="archivoTxt" accept=".txt">
  <button id="btnPreview">Vista previa</button>
  <button id="btnConfirmar">Confirmar</button>

  <!-- Barra de progreso -->
  <div class="progress-container">
    <div id="progressBar" class="progress-bar">0%</div>
  </div>

  <div id="log"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, writeBatch } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 🔹 Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const log = msg => {
      document.getElementById("log").innerHTML += msg + "<br>";
    };

    function actualizarProgreso(actual, total) {
      const porcentaje = Math.round((actual / total) * 100);
      const bar = document.getElementById("progressBar");
      bar.style.width = porcentaje + "%";
      bar.textContent = porcentaje + "%";
    }

    async function procesar(escribir = false) {
      document.getElementById("log").innerHTML = "";
      const bar = document.getElementById("progressBar");
      bar.style.width = "0%"; bar.textContent = "0%";

      const file = document.getElementById("archivoTxt").files[0];
      if (!file) {
        alert("Sube el archivo equiv.txt");
        return;
      }

      const text = await file.text();
      const lineas = text.split("\n").map(l => l.replace(/"/g,"").trim()).filter(l => l);
      const total = lineas.length;

      log("⏳ Cargando productos activos de Firestore...");
      const snap = await getDocs(collection(db, "productos"));

      // 🔹 Mapeo en memoria {codigoBarra: docId}
      const mapa = {};
      snap.forEach(d => {
        const data = d.data();
        if (data.activo && data.codigoBarra) {
          mapa[data.codigoBarra] = d.id;
        }
      });
      log(`✅ Productos activos cargados: ${Object.keys(mapa).length}`);

      // 🔹 Escritura en batch
      let batch = writeBatch(db);
      let contador = 0, lote = 1, procesados = 0;

      for (const linea of lineas) {
        procesados++;
        actualizarProgreso(procesados, total);

        const [codigoBase, codigoEq] = linea.split(/\s+/);

        if (!codigoBase || !codigoEq) {
          log(`⚠ Línea inválida: ${linea}`);
          continue;
        }

        if (mapa[codigoBase]) {
          const ref = doc(db, "productos", mapa[codigoBase]);

          if (escribir) {
            batch.update(ref, { codigosEquivalentes: arrayUnion(codigoEq) });
            contador++;

            if (contador % 500 === 0) {
              await batch.commit();
              log(`💾 Lote ${lote} de 500 guardado en Firestore`);
              batch = writeBatch(db);
              lote++;
            }
          } else {
            log(`✔ Preview: ${codigoBase} → ${codigoEq}`);
          }
        } else {
          log(`❌ No encontrado: ${codigoBase}`);
        }
      }

      if (escribir && contador % 500 !== 0) {
        await batch.commit();
        log(`💾 Lote final (${contador % 500} docs) guardado`);
      }

      log(escribir ? "✅ Escritura completada en Firestore." : "✅ Vista previa lista (sin escribir).");
      actualizarProgreso(total, total);
    }

    document.getElementById("btnPreview").addEventListener("click", () => procesar(false));
    document.getElementById("btnConfirmar").addEventListener("click", () => procesar(true));
  </script>
</body>
</html>
