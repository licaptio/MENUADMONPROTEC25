<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Consulta de art√≠culo</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // üîπ Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // üîπ Buscar art√≠culo por c√≥digo exacto
    async function buscarArticulo() {
      const codigo = document.getElementById("codigo").value.trim();
      if (!codigo) {
        alert("Introduce un c√≥digo de barras");
        return;
      }

      const ref = doc(db, "productos", codigo);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        document.getElementById("detalle").innerHTML = "<p style='color:red;'>‚ö†Ô∏è No se encontr√≥ el producto.</p>";
        document.getElementById("editor").style.display = "none";
        return;
      }

      const data = snap.data();
      mostrarArticulo(data, codigo);
    }

    // üîπ Mostrar todo el objeto + formulario editable
    function mostrarArticulo(data, codigo) {
      document.getElementById("codigoShow").innerText = codigo;

      // Mostrar todo el objeto en tabla
      const contenedor = document.getElementById("detalle");
      contenedor.innerHTML = "<h3>üìã Datos completos</h3>";
      const tabla = document.createElement("table");
      tabla.border = "1"; tabla.cellPadding = "5"; tabla.style.width = "100%";

      for (const [key, value] of Object.entries(data)) {
        const fila = document.createElement("tr");
        fila.innerHTML = `<td><b>${key}</b></td><td>${JSON.stringify(value)}</td>`;
        tabla.appendChild(fila);
      }
      contenedor.appendChild(tabla);

      // Precargar formulario de edici√≥n
      document.getElementById("concepto").value = data.concepto || "";
      document.getElementById("departamento").value = data.departamento || "";
      document.getElementById("marca").value = data.marca || "";
      document.getElementById("ivaTasa").value = data.ivaTasa ?? 0;
      document.getElementById("iepsTasa").value = data.iepsTasa ?? 0;
      document.getElementById("activo").checked = data.activo === true;

      document.getElementById("editor").style.display = "block";
    }

    // üîπ Guardar cambios
    async function guardarCambios() {
      const codigo = document.getElementById("codigoShow").innerText;
      const ref = doc(db, "productos", codigo);

      const cambios = {
        concepto: document.getElementById("concepto").value,
        departamento: document.getElementById("departamento").value,
        marca: document.getElementById("marca").value,
        ivaTasa: parseFloat(document.getElementById("ivaTasa").value) || 0,
        iepsTasa: parseFloat(document.getElementById("iepsTasa").value) || 0,
        activo: document.getElementById("activo").checked,
        actualizadoEn: new Date()
      };

      await updateDoc(ref, cambios);
      alert("‚úÖ Cambios guardados correctamente");
    }

    window.buscarArticulo = buscarArticulo;
    window.guardarCambios = guardarCambios;
  </script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { text-align: center; }
    .box { max-width: 700px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px; background: #fafafa; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input[type="text"], input[type="number"] { width: 100%; padding: 5px; }
    button { margin-top: 15px; padding: 10px 15px; cursor: pointer; }
    #editor { display: none; margin-top: 20px; }
    table { border-collapse: collapse; margin-top: 10px; }
    td { border: 1px solid #ddd; padding: 5px; }
  </style>
</head>
<body>
  <h1>üîé Consulta de art√≠culos por c√≥digo</h1>
  <div class="box">
    <label>C√≥digo de barras</label>
    <input type="text" id="codigo" placeholder="Escribe c√≥digo exacto...">
    <button onclick="buscarArticulo()">Traer</button>

    <div id="detalle"></div>

    <div id="editor">
      <h3>‚úèÔ∏è Editar art√≠culo: <span id="codigoShow"></span></h3>
      <label>Concepto</label>
      <input type="text" id="concepto">

      <label>Departamento</label>
      <input type="text" id="departamento">

      <label>Marca</label>
      <input type="text" id="marca">

      <label>IVA Tasa</label>
      <input type="number" step="0.01" id="ivaTasa">

      <label>IEPS Tasa</label>
      <input type="number" step="0.01" id="iepsTasa">

      <label><input type="checkbox" id="activo"> Activo</label>

      <button onclick="guardarCambios()">üíæ Guardar cambios</button>
    </div>
  </div>
</body>
</html>
