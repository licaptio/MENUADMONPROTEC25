<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Traspaso entre Almacenes</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, addDoc } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ---------------- FIREBASE ----------------
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------------- VARIABLES ----------------
    let carrito = [];
    let resultadosBusqueda = [];
    let paginaActual = 0;
    const porPagina = 10;

    // ---------------- INDEXEDDB ----------------
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("provsoftDB", 1);
        request.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains("productos")) {
            db.createObjectStore("productos", { keyPath: "codigoBarra" });
          }
          if (!db.objectStoreNames.contains("meta")) {
            db.createObjectStore("meta", { keyPath: "clave" });
          }
        };
        request.onsuccess = e => resolve(e.target.result);
        request.onerror = e => reject(e);
      });
    }

    async function saveProductos(lista) {
      const db = await openDB();
      const tx = db.transaction("productos", "readwrite");
      const store = tx.objectStore("productos");
      lista.forEach(p => store.put(p));
      return tx.done || new Promise(resolve => tx.oncomplete = resolve);
    }

    async function getAllProductos() {
      const db = await openDB();
      return new Promise(resolve => {
        const tx = db.transaction("productos", "readonly");
        const store = tx.objectStore("productos");
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result);
      });
    }

    async function saveMeta(clave, valor) {
      const db = await openDB();
      const tx = db.transaction("meta", "readwrite");
      tx.objectStore("meta").put({ clave, valor });
    }

    async function getMeta(clave) {
      const db = await openDB();
      return new Promise(resolve => {
        const tx = db.transaction("meta", "readonly");
        const store = tx.objectStore("meta");
        const req = store.get(clave);
        req.onsuccess = () => resolve(req.result ? req.result.valor : null);
      });
    }

    // ---------------- SYNC ----------------
    async function syncProductos() {
      try {
        const lastSync = await getMeta("lastSync");
        const ahora = Date.now();
        const unDia = 24 * 60 * 60 * 1000;

        if (lastSync && (ahora - lastSync) < unDia) {
          console.log("üì¶ Usando cat√°logo local");
          return;
        }

        console.log("‚¨áÔ∏è Descargando cat√°logo Firestore...");
        const q = query(collection(db, "productos"), where("activo", "==", true));
        const snap = await getDocs(q);

        const lista = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        await saveProductos(lista);
        await saveMeta("lastSync", ahora);

        console.log("‚úÖ Cat√°logo sincronizado con IndexedDB");
      } catch (err) {
        console.warn("‚ö†Ô∏è Error al sincronizar:", err.message);
      }
    }

    // ---------------- BUSCAR ----------------
    async function buscarPorCodigo() {
      const codigo = document.getElementById("buscadorCodigo").value.trim();
      if (!codigo) return;

      const productos = await getAllProductos();
      const encontrado = productos.find(p => p.codigoBarra == codigo);

      if (encontrado) {
        seleccionarProducto(encontrado);
      } else {
        alert("‚ö†Ô∏è Producto no encontrado, prueba con la b√∫squeda por nombre üîç");
      }
    }

    async function abrirBusquedaNombre() {
      const termino = document.getElementById("buscadorCodigo").value.trim().toLowerCase();
      if (termino.length < 2) {
        alert("Escribe al menos 2 caracteres para buscar por nombre");
        return;
      }

      const productos = await getAllProductos();
      resultadosBusqueda = productos.filter(p =>
        p.concepto && p.concepto.toLowerCase().includes(termino)
      );
      paginaActual = 0;
      mostrarResultadosPaginados();
      document.getElementById("modalResultados").style.display = "block";
    }

    function mostrarResultadosPaginados() {
      const lista = document.getElementById("listaResultados");
      lista.innerHTML = "";

      const inicio = paginaActual * porPagina;
      const fin = inicio + porPagina;
      const pagina = resultadosBusqueda.slice(inicio, fin);

      pagina.forEach(data => {
        const item = document.createElement("div");
        item.className = "item";
        item.innerText = `${data.concepto} ‚Äî $${data.precioPublico}`;
        item.onclick = () => {
          seleccionarProducto(data);
          cerrarModal();
        };
        lista.appendChild(item);
      });

      document.getElementById("paginacion").innerHTML = `
        <button ${paginaActual === 0 ? "disabled" : ""} onclick="anteriorPagina()">‚¨ÖÔ∏è Anterior</button>
        P√°gina ${paginaActual+1} de ${Math.ceil(resultadosBusqueda.length / porPagina)}
        <button ${(fin >= resultadosBusqueda.length) ? "disabled" : ""} onclick="siguientePagina()">Siguiente ‚û°Ô∏è</button>
      `;
    }

    // ---------------- PAGINACI√ìN ----------------
    window.anteriorPagina = function() {
      if (paginaActual > 0) {
        paginaActual--;
        mostrarResultadosPaginados();
      }
    };

    window.siguientePagina = function() {
      if ((paginaActual+1) * porPagina < resultadosBusqueda.length) {
        paginaActual++;
        mostrarResultadosPaginados();
      }
    };

    // ---------------- SELECCION ----------------
    function seleccionarProducto(data) {
      document.getElementById("codigoSel").value = data.codigoBarra;
      document.getElementById("conceptoSel").value = data.concepto;
      document.getElementById("precioSel").value = data.precioPublico;
      document.getElementById("preview").innerText = `${data.concepto} ‚Äî $${data.precioPublico}`;
      document.getElementById("cantidad").focus();
    }

    // ---------------- CARRITO ----------------
    function agregarItem() {
      const codigo = document.getElementById("codigoSel").value;
      const concepto = document.getElementById("conceptoSel").value;
      const precio = parseFloat(document.getElementById("precioSel").value);
      let cantidad = parseInt(document.getElementById("cantidad").value);

      if (!codigo) return;
      if (!cantidad || cantidad < 1) cantidad = 1;

      carrito.push({ codigo, concepto, precio, cantidad });
      renderTabla();

      document.getElementById("buscadorCodigo").value = "";
      document.getElementById("cantidad").value = "1"; 
      document.getElementById("preview").innerText = "";
      document.getElementById("codigoSel").value = "";
      document.getElementById("conceptoSel").value = "";
      document.getElementById("precioSel").value = "";
      document.getElementById("buscadorCodigo").focus();
    }

    function renderTabla() {
      const tabla = document.getElementById("tabla");
      tabla.innerHTML = "";
      carrito.forEach((item, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.codigo}</td>
          <td>${item.concepto}</td>
          <td>${item.cantidad}</td>
          <td>$${item.precio}</td>
          <td><button onclick="eliminarItem(${i})">‚ùå</button></td>
        `;
        tabla.appendChild(row);
      });
    }

    window.eliminarItem = function(index) {
      carrito.splice(index, 1);
      renderTabla();
    };

    // ---------------- MODAL ----------------
    function cerrarModal(){
      document.getElementById("modalResultados").style.display = "none";
    }

    // ---------------- INIT ----------------
    document.addEventListener("DOMContentLoaded", async ()=>{
      await syncProductos();
      document.getElementById("buscadorCodigo").focus();
      document.getElementById("buscadorCodigo").addEventListener("keypress",(e)=>{
        if(e.key === "Enter"){ e.preventDefault(); buscarPorCodigo(); }
      });
      document.getElementById("cerrarModal").addEventListener("click", cerrarModal);
    });

    // Exponer
    window.agregarItem = agregarItem;
    window.buscarPorCodigo = buscarPorCodigo;
    window.abrirBusquedaNombre = abrirBusquedaNombre;
  </script>

  <style>
    body{font-family:Arial,sans-serif;margin:20px;background:#f5f5f5;}
    .panel{max-width:800px;margin:auto;background:white;padding:20px;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,.15);}
    label{display:block;margin-top:10px;font-weight:bold;}
    input,select{padding:8px;margin:4px 0;border:1px solid #ccc;border-radius:6px;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{border:1px solid #ccc;padding:6px;text-align:left;}
    th{background:#eee;}
    button{padding:8px 12px;border:none;border-radius:6px;cursor:pointer;}
    .btn{background:#007bff;color:white;}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);}
    .modal-content{background:#fff;margin:5% auto;padding:20px;border-radius:10px;width:80%;max-width:600px;max-height:70%;overflow-y:auto;}
    .item{padding:8px;border-bottom:1px solid #eee;cursor:pointer;}
    .item:hover{background:#f0f0f0;}
    #paginacion{text-align:center;margin-top:10px;}
  </style>
</head>
<body>
  <div class="panel">
    <h2>‚¨áÔ∏è Traspaso a Vendedores</h2>

    <label>Ruta destino:</label>
    <select id="ruta">
      <option value="">-- Seleccionar --</option>
      <option value="Almacen_Ruta_1">Ruta 1</option>
      <option value="Almacen_Ruta_2">Ruta 2</option>
    </select>

    <label>Vendedor:</label>
    <input type="text" id="vendedor" readonly />

    <label>Ingresar c√≥digo de barras:</label>
    <div style="display:flex;gap:5px;align-items:center;">
      <input type="number" id="buscadorCodigo" placeholder="Escanea c√≥digo de barras..." style="flex:1;">
      <button class="btn" onclick="abrirBusquedaNombre()">üîç</button>
    </div>

    <div id="preview" style="margin:10px 0;font-weight:bold;color:#003366;"></div>

    <input type="hidden" id="codigoSel">
    <input type="hidden" id="conceptoSel">
    <input type="hidden" id="precioSel">

    <label>Cantidad:</label>
    <input type="number" id="cantidad" value="1" min="1"/>

    <button class="btn" onclick="agregarItem()">‚ûï Agregar a Lista</button>

    <table>
      <thead><tr><th>C√≥digo</th><th>Producto</th><th>Cantidad</th><th>Precio P√∫blico</th><th></th></tr></thead>
      <tbody id="tabla"></tbody>
    </table>

    <button class="btn">üì§ Finalizar Traspaso</button>
  </div>

  <!-- üîπ Modal resultados -->
  <div id="modalResultados" class="modal">
    <div class="modal-content">
      <span id="cerrarModal" class="close" style="cursor:pointer;">&times;</span>
      <h3>Resultados de b√∫squeda</h3>
      <div id="listaResultados"></div>
      <div id="paginacion"></div>
    </div>
  </div>
</body>
</html>
