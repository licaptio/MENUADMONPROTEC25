<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PROVSOFT â€“ Ventas Anuales</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- LIBRERÃAS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  padding:30px;
  font-family:'Poppins',sans-serif;
  background:linear-gradient(to right,#00416A,#0c6cbd);
}
.card{
  background:white;
  max-width:900px;
  margin:auto;
  padding:25px;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.25);
}
h1{
  text-align:center;
  color:#00416A;
  margin-bottom:5px;
}
p{
  text-align:center;
  color:#555;
  margin-top:0;
}
canvas{
  margin-top:25px;
}
</style>
</head>

<body>

<div class="card">
  <h1>Ventas Anuales Acumuladas</h1>
  <p>Subtotal + IVA + IEPS â€” RFC PDD031204KL5</p>
  <canvas id="graficaAnual"></canvas>
</div>

<script>
// ========================================
// ðŸ”Œ CONEXIÃ“N SUPABASE
// ========================================
const SUPABASE_URL = "https://cvpbtjlupswbyxenugpz.supabase.co";
const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY";

const supabase = window.supabase;

// ========================================
// ðŸ“¥ DESCARGAR TODO UN AÃ‘O (PAGINADO)
// ========================================
async function obtenerIngresos(anio){
  let offset = 0;
  const limit = 5000;
  let rows = [];

  while(true){
    const { data, error } = await supabase.rpc(
      "descargar_ingresos_paginado",
      { anio, inicio: offset, cantidad: limit }
    );

    if(error) throw error;
    if(!data || data.length === 0) break;

    rows = rows.concat(data);
    offset += limit;
  }
  return rows;
}

// ========================================
// ðŸ§® CALCULAR TOTAL CON IMPUESTOS
// ========================================
function totalConImpuestos(lista){
  return lista.reduce((sum,r)=>(
    sum +
    Number(r.subtotal||0) +
    Number(r.total_iva||0) +
    Number(r.total_ieps||0)
  ),0);
}

// ========================================
// ðŸ“Š GRAFICAR
// ========================================
async function cargarGrafica(){
  const ingresos2023 = await obtenerIngresos(2023);
  const ingresos2024 = await obtenerIngresos(2024);
  const ingresos2025 = await obtenerIngresos(2025);

  const totales = [
    totalConImpuestos(ingresos2023),
    totalConImpuestos(ingresos2024),
    totalConImpuestos(ingresos2025)
  ];

  new Chart(document.getElementById("graficaAnual"), {
    type: "bar",
    data: {
      labels: ["2023", "2024", "2025"],
      datasets: [{
        data: totales,
        backgroundColor: ["#2E75B6","#FFC000","#C0504D"],
        barThickness: 90,
        borderRadius: 6
      }]
    },
    options: {
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: ctx => `AÃ±o ${ctx[0].label}`,
            label: ctx =>
              "$" + ctx.raw.toLocaleString("es-MX", { minimumFractionDigits: 2 }),
            afterLabel: () => "Datos acumulados del aÃ±o"
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: v => (v / 1_000_000).toFixed(0) + " M"
          }
        }
      }
    },
    plugins: [{
      id: "etiquetaVertical",
      afterDatasetsDraw(chart) {
        const { ctx } = chart;
        const meta = chart.getDatasetMeta(0);

        ctx.save();
        meta.data.forEach((bar, i) => {
          const valor = chart.data.datasets[0].data[i];
          const texto = (valor / 1_000_000).toFixed(1) + " M";

          ctx.translate(bar.x, bar.y - 14);
          ctx.rotate(-Math.PI / 2);
          ctx.fillStyle = "#333";
          ctx.font = "bold 13px Poppins";
          ctx.fillText(texto, 0, 0);
          ctx.setTransform(1, 0, 0, 1, 0, 0);
        });
        ctx.restore();
      }
    }]
  });
}

cargarGrafica();

</script>

</body>
</html>
