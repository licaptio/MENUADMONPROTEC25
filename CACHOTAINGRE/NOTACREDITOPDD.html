<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carga de XML ‚Äì Ingresos PDD (Depurado)</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f9f9f9; color:#111; }
    h2 { color: #00416A; }
    ul { padding: 0; list-style: none; }
    li { margin-bottom: 6px; font-size: 14px; }
    .ok { color: green; }
    .warn { color: orange; }
    .err { color: red; }
    .pending { color: blue; }
    pre { background:#eee; padding:10px; max-height:240px; overflow:auto; font-size:13px; }
    .progress-bar { width:100%; background:#ddd; border-radius:4px; overflow:hidden; height:16px; margin-top:6px; }
    .progress-bar div { height:100%; width:0%; background:#0c6cbd; transition:width 0.3s ease; }
  </style>
</head>
<body>
  <h2>Subir NOTAS DE CR√âDITO (CFDI tipo E) ‚Äì SAT</h2>
  <input type="file" id="xmlInput" accept=".xml" multiple>
  <button onclick="procesarArchivos()">Procesar y Subir</button>

  <div class="progress-bar"><div id="progreso"></div></div>
  <h3>Archivos</h3>
  <ul id="archivoList"></ul>
  <h3>Bit√°cora</h3>
  <pre id="bitacora"></pre>

<script>
    const SUPABASE_URL = "https://cvpbtjlupswbyxenugpz.supabase.co";
    const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY";
    let archivosDatos = [];
  
document.getElementById("xmlInput").addEventListener("change", async function () {
  const lista = document.getElementById("archivoList");
  lista.innerHTML = "";
  archivosDatos = [];

  for (const file of this.files) {
    try {
      const text = await file.text();
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, "application/xml");

      const cfdiNS = "http://www.sat.gob.mx/cfd/4";
      const comprobante = xml.getElementsByTagNameNS(cfdiNS, "Comprobante")[0];
      const emisor = xml.getElementsByTagNameNS(cfdiNS, "Emisor")[0];

      let timbre = null;
      for (const n of xml.getElementsByTagName("*")) {
        if (n.localName === "TimbreFiscalDigital") {
          timbre = n;
          break;
        }
      }

      const uuid = timbre?.getAttribute("UUID")?.toUpperCase() || "";
      const tipo = comprobante?.getAttribute("TipoDeComprobante") || "";
      const emisorRFC = emisor?.getAttribute("Rfc") || "";

      if (!uuid || tipo !== "E" || emisorRFC !== "PDD031204KL5") {
        const li = document.createElement("li");
        li.innerHTML = `‚ùå <b>${file.name}</b> <span class="err">‚Üí Rechazado</span>`;
        lista.appendChild(li);
        continue;
      }

      const fecha = comprobante.getAttribute("Fecha");
      const total = parseFloat(comprobante.getAttribute("Total")) || 0;
      const fechaObj = new Date(fecha);

      const notaCredito = {
        uuid_cfdi: uuid,
        rfc_emisor: emisorRFC,
        rfc_receptor: "PDD031204KL5",
        fecha_emision: fecha,
        fecha_certificacion: timbre.getAttribute("FechaTimbrado"),
        fecha_cancelacion: null,
        monto: total,
        moneda: comprobante.getAttribute("Moneda"),
        efecto_comprobante: "E",
        estatus: 1,
        periodo_anio: fechaObj.getFullYear(),
        periodo_mes: fechaObj.getMonth() + 1,
        raw_line: file.name
      };

      archivosDatos.push(notaCredito);

      const li = document.createElement("li");
      li.dataset.uuid = uuid;
      li.innerHTML = `üìÑ <b>${uuid}</b> <span class="pending">‚Üí Nota lista</span>`;
      lista.appendChild(li);

    } catch (e) {
      const li = document.createElement("li");
      li.innerHTML = `‚ùå <b>${file.name}</b> <span class="err">‚Üí Error</span>`;
      lista.appendChild(li);
    }
  }
});
</script>

<script>
async function procesarArchivos() {
  const progreso = document.getElementById("progreso");
  const total = archivosDatos.length;

  logBitacora(`üöÄ Iniciando carga de ${total} notas de cr√©dito`);

  for (let i = 0; i < total; i++) {
    const data = archivosDatos[i];
    const item = document.querySelector(
      `#archivoList li[data-uuid="${data.uuid_cfdi}"]`
    );

    // üîµ Progreso visual
    const porcentaje = Math.round(((i + 1) / total) * 100);
    progreso.style.width = `${porcentaje}%`;
    item.querySelector("span").textContent = `‚è≥ Subiendo (${porcentaje}%)`;
    item.querySelector("span").className = "pending";

    try {
      // üîç Validar duplicado
      const existe = await fetch(
        `${SUPABASE_URL}/rest/v1/notas_credito_sat?uuid_cfdi=eq.${data.uuid_cfdi}`,
        { headers: { apikey: API_KEY, Authorization: `Bearer ${API_KEY}` } }
      );
      const yaExiste = await existe.json();

      if (yaExiste.length > 0) {
        item.querySelector("span").textContent = "‚ö†Ô∏è Ya existe";
        item.querySelector("span").className = "warn";
        continue;
      }

      // üì§ Insert
      const insert = await fetch(
        `${SUPABASE_URL}/rest/v1/notas_credito_sat`,
        {
          method: "POST",
          headers: {
            apikey: API_KEY,
            Authorization: `Bearer ${API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data)
        }
      );

      if (insert.ok) {
        item.querySelector("span").textContent = "‚úÖ Subido";
        item.querySelector("span").className = "ok";
      } else {
        const err = await insert.text();
        item.querySelector("span").textContent = `‚ùå ${err}`;
        item.querySelector("span").className = "err";
      }

    } catch (e) {
      item.querySelector("span").textContent = "‚ùå Error red";
      item.querySelector("span").className = "err";
    }

    await new Promise(r => setTimeout(r, 300));
  }

  progreso.style.width = "100%";
  logBitacora("‚úÖ Proceso terminado. Todas las NC procesadas.");
}
</script>


  <footer style="margin-top:40px;padding:10px;text-align:center;font-size:13px;color:#555;border-top:1px solid #ccc;">
    ‚öôÔ∏è POWERED BY <b>PROVSOFT</b> ¬∑ 2025 ¬∑ Sistema de integraci√≥n CFDI 4.0
  </footer>
</body>
</html>
