<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carga de Notas de Crédito – SAT</title>
  <style>
    body { font-family: Arial; padding: 20px; background:#f9f9f9; }
    li { font-size: 14px; margin-bottom: 4px; }
    .ok { color: green; }
    .warn { color: orange; }
    .err { color: red; }
    .pending { color: blue; }
    .progress-bar { width:100%; height:16px; background:#ddd; border-radius:6px; }
    .progress-bar div { height:100%; width:0%; background:#0c6cbd; }
    pre { background:#eee; padding:10px; max-height:200px; overflow:auto; }
  </style>
</head>
<body>

<h2>Subir NOTAS DE CRÉDITO (CFDI tipo E) – SAT</h2>
<input type="file" id="xmlInput" accept=".xml" multiple>
<button onclick="procesarArchivos()">Procesar y Subir</button>

<div class="progress-bar"><div id="progreso"></div></div>

<ul id="archivoList"></ul>
<pre id="bitacora"></pre>


<script>
const SUPABASE_URL = "https://cvpbtjlupswbyxenugpz.supabase.co";
const API_KEY = "TU_API_KEY";
let archivosDatos = [];

document.getElementById("xmlInput").addEventListener("change", async function () {
  const lista = document.getElementById("archivoList");
  lista.innerHTML = "";
  archivosDatos = [];

  for (const file of this.files) {
    try {
      const xml = new DOMParser()
        .parseFromString(await file.text(), "application/xml");

      const ns = "http://www.sat.gob.mx/cfd/4";
      const c = xml.getElementsByTagNameNS(ns, "Comprobante")[0];
      const e = xml.getElementsByTagNameNS(ns, "Emisor")[0];

      let t = [...xml.getElementsByTagName("*")]
        .find(n => n.localName === "TimbreFiscalDigital");

      const uuid = t?.getAttribute("UUID") || "";
      if (!uuid || c.getAttribute("TipoDeComprobante") !== "E") continue;

      const f = new Date(c.getAttribute("Fecha"));

      archivosDatos.push({
        uuid_cfdi: uuid,
        rfc_emisor: e.getAttribute("Rfc"),
        rfc_receptor: e.getAttribute("Rfc"),
        fecha_emision: c.getAttribute("Fecha"),
        fecha_certificacion: t.getAttribute("FechaTimbrado"),
        fecha_cancelacion: null,
        monto: parseFloat(c.getAttribute("Total")),
        moneda: c.getAttribute("Moneda"),
        efecto_comprobante: "E",
        estatus: 1,
        periodo_anio: f.getFullYear(),
        periodo_mes: f.getMonth() + 1,
        raw_line: file.name
      });

      const li = document.createElement("li");
      li.dataset.uuid = uuid;
      li.innerHTML = `<b>${uuid}</b> <span class="pending">→ Lista</span>`;
      lista.appendChild(li);

    } catch {
      lista.innerHTML += `<li class="err">${file.name} error</li>`;
    }
  }
});
</script>

<script>
<script>
async function procesarArchivos() {
  const bar = document.getElementById("progreso");
  const total = archivosDatos.length;

  for (let i = 0; i < total; i++) {
    const d = archivosDatos[i];
    const li = document.querySelector(`li[data-uuid="${d.uuid_cfdi}"]`);
    const pct = Math.round(((i + 1) / total) * 100);

    bar.style.width = pct + "%";
    li.querySelector("span").textContent = `⏳ ${pct}%`;

    const existe = await fetch(
      `${SUPABASE_URL}/rest/v1/notas_credito_sat?uuid_cfdi=eq.${d.uuid_cfdi}`,
      { headers:{ apikey:API_KEY, Authorization:`Bearer ${API_KEY}` } }
    ).then(r=>r.json());

    if (existe.length) {
      li.querySelector("span").textContent = "⚠️ Existe";
      li.querySelector("span").className = "warn";
      continue;
    }

    const r = await fetch(`${SUPABASE_URL}/rest/v1/notas_credito_sat`,{
      method:"POST",
      headers:{
        apikey:API_KEY,
        Authorization:`Bearer ${API_KEY}`,
        "Content-Type":"application/json"
      },
      body: JSON.stringify(d)
    });

    li.querySelector("span").textContent = r.ok ? "✅ Subido" : "❌ Error";
    li.querySelector("span").className = r.ok ? "ok" : "err";
    await new Promise(r=>setTimeout(r,250));
  }

  bar.style.width = "100%";
}
</script>



  <footer style="margin-top:40px;padding:10px;text-align:center;font-size:13px;color:#555;border-top:1px solid #ccc;">
    ⚙️ POWERED BY <b>PROVSOFT</b> · 2025 · Sistema de integración CFDI 4.0
  </footer>
</body>
</html>
