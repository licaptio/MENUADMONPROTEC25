<script>
/****************************************************
 * ðŸ”‘ SECCIÃ“N 1 â€“ CONFIGURACIÃ“N SUPABASE
 ****************************************************/
const SUPABASE_URL = "https://cvpbtjlupswbyxenugpz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


/****************************************************
 * ðŸ“¦ SECCIÃ“N 2 â€“ FUNCIÃ“N: obtenerDatos()
 * â†’ Consulta subtotal, IVA, IEPS y total
 ****************************************************/
async function obtenerDatos() {
  const { data, error } = await supabase
    .from('ingresos_gorb')
    .select('subtotal, total_iva, total_ieps, total, periodo_mes, periodo_anio');

  if (error) {
    console.error("âŒ Error al obtener datos:", error);
    return { etiquetas: [], datos: [] };
  }

  // Agrupador
  const acumulado = {};

  data.forEach(row => {
    const clave = `${row.periodo_anio}-${String(row.periodo_mes).padStart(2, '0')}`;

    if (!acumulado[clave]) {
      acumulado[clave] = { subtotal: 0, iva: 0, ieps: 0, total: 0 };
    }

    acumulado[clave].subtotal += parseFloat(row.subtotal || 0);
    acumulado[clave].iva      += parseFloat(row.total_iva || 0);
    acumulado[clave].ieps     += parseFloat(row.total_ieps || 0);
    acumulado[clave].total    += parseFloat(row.total || 0);
  });

  // Convertir a lista ordenada
  const ordenado = Object.entries(acumulado)
    .sort(([a], [b]) => a.localeCompare(b))
    .map(([periodo, valores]) => ({
      periodo,
      ...valores
    }));

  return {
    etiquetas: ordenado.map(o => o.periodo),
    datos: ordenado
  };
}


/****************************************************
 * ðŸŽ¨ SECCIÃ“N 3 â€“ FUNCIÃ“N: renderizarGrafica()
 * â†’ Dibuja la grÃ¡fica con tooltip detallado
 ****************************************************/
function renderizarGrafica(etiquetas, datos) {
  const ctx = document.getElementById('chartIngresos').getContext('2d');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: etiquetas,
      datasets: [{
        label: 'Total Facturado',
        data: datos.map(d => d.total),
        backgroundColor: 'rgba(12,108,189,0.7)',
        borderColor: '#00416A',
        borderWidth: 1.5
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true, position: 'bottom' },

        /******************************
         * ðŸ” TOOLTIP PERSONALIZADO
         ******************************/
        tooltip: {
          callbacks: {
            label: context => {
              const idx = context.dataIndex;
              const d = datos[idx];

              return [
                `TOTAL: $${d.total.toLocaleString('es-MX',{minimumFractionDigits:2})}`,
                `Subtotal: $${d.subtotal.toLocaleString('es-MX',{minimumFractionDigits:2})}`,
                `IVA: $${d.iva.toLocaleString('es-MX',{minimumFractionDigits:2})}`,
                `IEPS: $${d.ieps.toLocaleString('es-MX',{minimumFractionDigits:2})}`
              ];
            }
          }
        },

        title: {
          display: true,
          text: 'Total Mensual Facturado (Subtotal + IVA + IEPS)',
          font: { size: 16 }
        }
      },

      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: val => '$' + val.toLocaleString('es-MX')
          }
        }
      }
    }
  });
}


/****************************************************
 * ðŸš€ SECCIÃ“N 4 â€“ INICIALIZACIÃ“N
 ****************************************************/
(async () => {
  const { etiquetas, datos } = await obtenerDatos();
  renderizarGrafica(etiquetas, datos);
})();
</script>
