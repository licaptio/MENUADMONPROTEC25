<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PROVSOFT ‚Äì Dashboard PDD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Librer√≠as externas -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #F5AF19, #F12711);
      margin: 0;
      padding: 20px;
      color: #111;
    }
    h1, h2, h3 {
      text-align: center;
      color: white;
      margin-top: 0;
    }
    .card {
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 20px;
      margin: 20px auto;
      max-width: 1000px;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align:left; }
    th { background: #F5AF19; color: white; }
    canvas { margin-top: 20px; width: 100% !important; }
    tr:hover { background-color: #f7f7f7; }

    /* Barra de progreso */
    .progress-container {
      background: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      height: 24px;
      margin: 10px auto;
      width: 90%;
      max-width: 600px;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      color: white;
      text-align: center;
      font-weight: bold;
      transition: width 0.8s ease;
      border-radius: 10px;
    }

    button {
      background: #F5AF19;
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background: #F12711;
    }
  #paginaInfo {
  display: block;
  margin-top: 6px;
  font-size: 0.85em;
  color: #666;
}

  </style>
</head>
<body>

  <h1>üìä PROVSOFT ‚Äì Dashboard de Ingresos PDD</h1>
  <h3>Proveedora de Dulces y Desechables | Resumen 24 Meses</h3>
<div style="text-align:center; margin-top:15px;">
  <button 
    onclick="window.open('https://licaptio.github.io/MENUADMONPROTEC25/CONTABILIDAD/CargaIngresoPDD.html', '_blank')"
    style="
      background: linear-gradient(to right, #F5AF19, #F12711);
      color: white;
      padding: 10px 22px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      font-family: 'Poppins', sans-serif;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    "
    onmouseover="this.style.opacity='0.85'"
    onmouseout="this.style.opacity='1'">
    ‚öôÔ∏è Cargar Nuevos Ingresos XML (Abrir m√≥dulo)
  </button>
</div>

  <!-- üí∞ Ingresos por mes -->
  <div class="card">
    <h2>üí∞ Ingresos Totales por Mes</h2>
    <canvas id="graficoMensual" height="120"></canvas>
  </div>

  <!-- üì¶ Totales 2024 -->
  <div class="card">
    <h2>üì¶ Totales por Art√≠culo ‚Äì A√±o 2024</h2>
    <canvas id="graficoArticulos2024" height="120"></canvas>
  </div>

  <!-- üì¶ Totales 2025 -->
  <div class="card">
    <h2>üì¶ Totales por Art√≠culo ‚Äì A√±o 2025</h2>
    <canvas id="graficoArticulos2025" height="120"></canvas>
  </div>

  <!-- üìà Comparativo -->
  <div class="card">
    <h2>üìà Ingreso Acumulado 2025 vs 2024</h2>
    <canvas id="graficoComparativo" height="120"></canvas>
    <p style="text-align:center; font-size:0.9em; color:#333;">
      *L√≠mite 2025: <b>20 √ó UMA anual ($41,273.52) √ó 10 socios = $8,254,700 MXN</b>.
    </p>
  </div>

  <!-- üßæ Totales y barra din√°mica -->
  <div class="card">
    <h2>üßæ Ingreso Total Acumulado 2024 vs 2025</h2>
    <canvas id="graficoTotalesAnuales" height="120"></canvas>
    <div class="progress-container"><div id="progressBar" class="progress-bar">0%</div></div>
    <p id="progressText" style="text-align:center; font-size:0.9em; color:#333;"></p>
  </div>

  <!-- üìÑ Detalle de Ingresos con paginaci√≥n -->
  <div class="card">
    <h2>üìÑ Detalle de Ingresos (Tabla ingresos_pdd)</h2>
    <input id="buscador" type="text"
      placeholder="üîç Buscar por RFC, nombre, UUID o serie..."
      style="width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin-bottom:10px;">

    <div style="overflow-x:auto; max-height:420px;">
      <table id="tablaCFDI">
        <thead>
          <tr>
            <th>UUID</th>
            <th>Fecha</th>
            <th>RFC Receptor</th>
            <th>Nombre del Receptor</th>
            <th>Serie</th>
            <th>Factura</th>
            <th>Total ($)</th>
            <th>Periodo</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="paginacion" style="text-align:center; margin-top:10px;">
      <button id="anterior" disabled>‚¨Ö Anterior</button>
      <span id="paginaInfo" style="margin:0 8px;color:#333;font-weight:bold;"></span>
      <button id="siguiente">Siguiente ‚û°</button>
    </div>
  </div>

  <footer>PROVSOFT ¬© 2025 | Dashboard Inteligente de Ingresos y CFDI</footer>

<script>
  const supabase = window.supabase.createClient(
    "https://cvpbtjlupswbyxenugpz.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
  );

  const UMA_ANUAL_2025 = 41273.52;
  const NUM_SOCIOS = 10;
  const LIMITE_SPR_2025 = UMA_ANUAL_2025 * 20 * NUM_SOCIOS;

<script>
const supabase = window.supabase.createClient(
  "https://cvpbtjlupswbyxenugpz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
);

const UMA_ANUAL_2025 = 41273.52;
const NUM_SOCIOS = 10;
const LIMITE_SPR_2025 = UMA_ANUAL_2025 * 20 * NUM_SOCIOS;

// 1Ô∏è‚É£ Ingresos totales por mes (usando subtotal)
async function cargarTotalesMensuales() {
  const { data, error } = await supabase
    .from('ingresos_pdd')
    .select('fecha, subtotal');

  if (error) return console.error("Error al cargar ingresos_pdd:", error);

  // Agrupar por mes (YYYY-MM)
  const totales = {};
  data.forEach(r => {
    const mes = new Date(r.fecha).toISOString().slice(0,7);
    totales[mes] = (totales[mes] || 0) + Number(r.subtotal || 0);
  });

  new Chart(document.getElementById('graficoMensual'), {
    type: 'line',
    data: {
      labels: Object.keys(totales),
      datasets: [{
        label: 'Subtotal mensual ($)',
        data: Object.values(totales),
        borderColor: '#F12711',
        backgroundColor: '#F5AF1940',
        borderWidth: 2,
        fill: true
      }]
    },
    options: { scales: { y: { beginAtZero: true } } }
  });
}

// 2Ô∏è‚É£ Totales por a√±o (comparativo 2024 vs 2025)
async function cargarTotalesAnuales() {
  const { data, error } = await supabase
    .from('ingresos_pdd')
    .select('fecha, subtotal');
  if (error) return console.error(error);

  const totales = {2024:0,2025:0};
  data.forEach(r=>{
    const anio = new Date(r.fecha).getFullYear();
    if(anio===2024||anio===2025)
      totales[anio] += Number(r.subtotal||0);
  });

  const total24 = totales[2024];
  const total25 = totales[2025];
  const progress = Math.min((total25 / LIMITE_SPR_2025) * 100, 100);
  const bar = document.getElementById("progressBar");
  const text = document.getElementById("progressText");

  let color = "#4CAF50";
  if (progress >= 90) color = "#E53935";
  else if (progress >= 70) color = "#FBC02D";

  bar.style.width = progress.toFixed(1) + "%";
  bar.style.background = color;
  bar.textContent = progress.toFixed(1) + "%";
  text.innerHTML = `Ingresos acumulados 2025 (Subtotal): <b>$${total25.toLocaleString('es-MX')}</b> / L√≠mite: <b>$${LIMITE_SPR_2025.toLocaleString('es-MX')}</b>`;

  new Chart(document.getElementById('graficoTotalesAnuales'), {
    type:'bar',
    data:{
      labels:['2024','2025','L√≠mite SPR 2025'],
      datasets:[{
        label:'Subtotal Acumulado ($)',
        data:[total24,total25,LIMITE_SPR_2025],
        backgroundColor:['#F5AF19',color,'#9E9E9E']
      }]
    },
    options:{
      plugins:{
        legend:{display:false},
        datalabels:{
          color:'#111',anchor:'end',align:'start',font:{weight:'bold',size:13},
          formatter:v=>'$'+v.toLocaleString('es-MX')
        }
      },
      scales:{y:{beginAtZero:true}}
    },
    plugins:[ChartDataLabels]
  });
}

// 3Ô∏è‚É£ Comparativo mensual (2024 vs 2025)
async function cargarComparativo() {
  const { data, error } = await supabase
    .from('ingresos_pdd')
    .select('fecha, subtotal');
  if (error) return console.error(error);

  const porMesYA√±o = {};
  data.forEach(r=>{
    const fecha = new Date(r.fecha);
    const anio = fecha.getFullYear();
    const mes = fecha.toISOString().slice(0,7);
    if(!porMesYA√±o[anio]) porMesYA√±o[anio]={};
    porMesYA√±o[anio][mes]=(porMesYA√±o[anio][mes]||0)+Number(r.subtotal||0);
  });

  const meses = [...new Set(Object.keys(porMesYA√±o[2024]||{}).concat(Object.keys(porMesYA√±o[2025]||{})))].sort();
  const linea = meses.map(()=>LIMITE_SPR_2025);
  
  new Chart(document.getElementById('graficoComparativo'), {
    type:'line',
    data:{
      labels:meses,
      datasets:[
        {label:'2024 ‚Äì Subtotal ($)', data:meses.map(m=>porMesYA√±o[2024]?.[m]||0), borderColor:'#F5AF19', borderWidth:2, tension:0.3},
        {label:'2025 ‚Äì Subtotal ($)', data:meses.map(m=>porMesYA√±o[2025]?.[m]||0), borderColor:'#F12711', borderWidth:2, tension:0.3},
        {label:`L√≠mite SPR 2025 ($${LIMITE_SPR_2025.toLocaleString('es-MX')})`, data:linea, borderColor:'#E53935', borderDash:[5,5], borderWidth:1.5, pointRadius:0}
      ]
    },
    options:{scales:{y:{beginAtZero:true}}, plugins:{legend:{position:'bottom'}}}
  });
}

// 4Ô∏è‚É£ Detalle CFDI (igual, mantiene total SAT)
let paginaActual = 1;
const registrosPorPagina = 30;
let datosTotales = [];

async function cargarDetalleCFDI() {
  const { data, error } = await supabase
    .from('ingresos_pdd')
    .select('uuid_cfdi, fecha, rfc_receptor, razon_social_receptor, serie, factura, subtotal, total')
    .order('fecha', { ascending: false })
    .limit(120);

  if (error) return console.error("Error cargando ingresos_pdd:", error);

  datosTotales = (data || []).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
  mostrarPagina(1);
}

function mostrarPagina(numPagina) {
  const inicio = (numPagina - 1) * registrosPorPagina;
  const fin = inicio + registrosPorPagina;
  const paginaDatos = datosTotales.slice(inicio, fin);

  const tbody = document.querySelector("#tablaCFDI tbody");
  tbody.innerHTML = "";

  paginaDatos.forEach(r => {
    const periodo = new Date(r.fecha).toISOString().slice(0, 7);
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td>${r.uuid_cfdi}</td>
      <td>${new Date(r.fecha).toLocaleDateString('es-MX')}</td>
      <td>${r.rfc_receptor || '-'}</td>
      <td>${r.razon_social_receptor || '-'}</td>
      <td>${r.serie || '-'}</td>
      <td>${r.factura || '-'}</td>
      <td>$${Number(r.total || 0).toLocaleString('es-MX')}</td>
      <td>${periodo}</td>`;
    tbody.appendChild(fila);
  });

  actualizarControles(numPagina, inicio, fin);
}

function actualizarControles(numPagina, inicio, fin) {
  const totalRegistros = datosTotales.length;
  const totalPaginas = Math.ceil(totalRegistros / registrosPorPagina);
  const paginaInfo = document.getElementById("paginaInfo");
  paginaInfo.innerHTML = `P√°gina ${numPagina} de ${totalPaginas} ‚Äî Mostrando del ${inicio + 1} al ${Math.min(fin, totalRegistros)} de ${totalRegistros}`;
  document.getElementById("anterior").disabled = numPagina === 1;
  document.getElementById("siguiente").disabled = numPagina === totalPaginas;
}

document.getElementById("buscador").addEventListener("input", e => {
  const filtro = e.target.value.toLowerCase();
  document.querySelectorAll("#tablaCFDI tbody tr").forEach(tr => {
    const visible = [...tr.children].some(td =>
      td.textContent.toLowerCase().includes(filtro)
    );
    tr.style.display = visible ? "" : "none";
  });
});

document.getElementById("anterior").addEventListener("click", () => {
  if (paginaActual > 1) {
    paginaActual--;
    mostrarPagina(paginaActual);
  }
});
document.getElementById("siguiente").addEventListener("click", () => {
  const totalPaginas = Math.ceil(datosTotales.length / registrosPorPagina);
  if (paginaActual < totalPaginas) {
    paginaActual++;
    mostrarPagina(paginaActual);
  }
});

// üöÄ Inicializaci√≥n
cargarTotalesMensuales();
cargarComparativo();
cargarTotalesAnuales();
cargarDetalleCFDI();
</script>


</body>
</html>
