<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Representación Impresa CFDI – PROVSOFT</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#eaeaea;
  padding:30px;
}

.cfdi{
  background:#fff;
  max-width:950px;
  margin:auto;
  padding:30px;
  border:1px solid #ccc;
}

.header{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:20px;
  border-bottom:2px solid #000;
  padding-bottom:10px;
}

.box{
  font-size:13px;
}

.box strong{
  font-size:14px;
}

.right{
  text-align:right;
}

.section{
  margin-top:18px;
}

.section h3{
  margin:6px 0;
  font-size:14px;
  border-bottom:1px solid #000;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

th,td{
  border:1px solid #000;
  padding:6px;
}

th{
  background:#f0f0f0;
}

.totales{
  width:320px;
  float:right;
  margin-top:10px;
}

.footer{
  margin-top:40px;
  font-size:11px;
}
</style>
</head>

<body>

<div class="cfdi" id="cfdi"></div>

<script>
const db = supabase.createClient(
  'https://cvpbtjlupswbyxenugpz.supabase.co',
  'TU_ANON_KEY'
);

const uuid = new URLSearchParams(location.search).get('uuid');

async function cargar(){
  const { data, error } = await db
    .from('ingresos_pdd')
    .select('*')
    .eq('uuid_cfdi', uuid)
    .single();

  if(error){
    document.getElementById('cfdi').innerHTML = 'CFDI no encontrado';
    return;
  }

  render(data);
}

function render(f){
  document.getElementById('cfdi').innerHTML = `
    <!-- ENCABEZADO -->
    <div class="header">
      <div class="box">
        <strong>${f.razon_social_emisor}</strong><br>
        RFC: ${f.rfc_emisor}<br>
        ${f.periodo_anio ?? ''} ${f.periodo_mes ?? ''}
      </div>
      <div class="box right">
        <strong>FACTURA</strong><br>
        Serie/Folio: ${f.serie} ${f.folio}<br>
        UUID: ${f.uuid_cfdi}<br>
        Fecha emisión: ${f.fecha.replace('T',' ').replace('+00:00','')}
      </div>
    </div>

    <!-- RECEPTOR -->
    <div class="section">
      <h3>Datos del Receptor</h3>
      <div class="box">
        <strong>${f.razon_social_receptor}</strong><br>
        RFC: ${f.rfc_receptor}<br>
        Uso CFDI: ${f.uso_cfdi}
      </div>
    </div>

    <!-- CONCEPTOS -->
    <div class="section">
      <h3>Conceptos</h3>
      <table>
        <thead>
          <tr>
            <th>Cant.</th>
            <th>Descripción</th>
            <th>Importe</th>
          </tr>
        </thead>
        <tbody>
          ${(f.conceptos ?? []).map(c=>`
            <tr>
              <td>${c.cantidad}</td>
              <td>${c.descripcion}</td>
              <td class="right">$ ${Number(c.importe).toLocaleString('es-MX',{minimumFractionDigits:2})}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>

    <!-- TOTALES -->
    <table class="totales">
      <tr><td>Subtotal</td><td class="right">$ ${fmt(f.subtotal)}</td></tr>
      <tr><td>IVA</td><td class="right">$ ${fmt(f.total_iva)}</td></tr>
      <tr><td>IEPS</td><td class="right">$ ${fmt(f.total_ieps)}</td></tr>
      <tr><th>Total</th><th class="right">$ ${fmt(f.total)}</th></tr>
    </table>

    <!-- FOOTER -->
    <div class="footer">
      <strong>Este documento es una representación impresa de un CFDI</strong><br>
      PAC: ${f.no_certificado_sat}
    </div>
  `;
}

function fmt(n){
  return Number(n ?? 0).toLocaleString('es-MX',{minimumFractionDigits:2});
}

cargar();
</script>

</body>
</html>
