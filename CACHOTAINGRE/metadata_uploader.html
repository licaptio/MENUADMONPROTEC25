<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PROVSOFT â€“ Carga Metadata SAT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: Arial, sans-serif;
  background:#0c6cbd;
  padding:30px;
}
.card{
  background:#fff;
  max-width:700px;
  margin:auto;
  padding:25px;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.25);
}
h2{ color:#00416A; margin-top:0; }
button{
  padding:10px 18px;
  font-size:15px;
  border-radius:6px;
  border:none;
  cursor:pointer;
}
#log{
  margin-top:15px;
  font-family:monospace;
  font-size:13px;
  white-space:pre-wrap;
  background:#f5f5f5;
  padding:10px;
  border-radius:6px;
  max-height:220px;
  overflow:auto;
}
</style>
</head>

<body>

<div class="card">
  <h2>ðŸ“¥ Carga Metadata SAT</h2>

  <input type="file" id="fileInput" accept=".txt"><br><br>

  <button onclick="procesarArchivo()">Procesar archivo</button>

  <div id="log"></div>
</div>

<script>
// ================= CONFIGURACIÃ“N =================
const SUPABASE_URL = "https://cvpbtjlupswbyxenugpz.supabase.co";
const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY";

// ===============================================
const RFC_PERMITIDO = "PDD031204KL5";
function log(msg){
  document.getElementById("log").textContent += msg + "\n";
}

async function procesarArchivo(){
  const input = document.getElementById("fileInput");
  if(!input.files.length){
    alert("Selecciona un archivo TXT");
    return;
  }

  const file = input.files[0];
  const text = await file.text();
  const lineas = text.split(/\r?\n/).filter(l => l.trim());

  log(`Archivo: ${file.name}`);
  log(`Registros detectados: ${lineas.length}`);
 // ðŸ”’ VALIDACIÃ“N RFC EMISOR
   const rfcInvalidos = new Set();

for (const linea of lineas) {

  // â›” IGNORAR ENCABEZADO DEL SAT
  if (linea.startsWith("Uuid~")) continue;

  const c = linea.split("~");
  if (c.length < 4) continue;

  const rfcReceptor = c[3].trim();

  if (rfcReceptor !== RFC_PERMITIDO) {
    rfcInvalidos.add(rfcReceptor);
  }
}

  if(rfcInvalidos.size > 0){
    log("âŒ VALIDACIÃ“N FALLIDA");
    log("Se detectaron RFC emisores no permitidos:");
    rfcInvalidos.forEach(rfc => log(" - " + rfc));
alert(
  "ERROR DE SEGURIDAD\n\n" +
  "El archivo contiene CFDI cuyo RFC RECEPTOR NO es:\n" +
  RFC_PERMITIDO + "\n\n" +
  "Carga cancelada."
);
    return;
  }

  log("âœ” ValidaciÃ³n RFC receptor correcta (" + RFC_PERMITIDO + ")");
  if(!confirm(`Se cargarÃ¡n ${lineas.length} registros a Supabase.\nÂ¿Deseas continuar?`)){
    log("Carga cancelada por el usuario.");
    return;
  }

  let enviados = 0;

  for(const linea of lineas){
    const c = linea.split("~"); // SAT usa ~

    if(c.length < 11) continue;

    const payload = {
      uuid_cfdi: c[0],
      rfc_emisor: c[1],
      nombre_emisor: c[2],
      rfc_receptor: c[3],
      nombre_receptor: c[4],
      rfc_pac: c[5],
      fecha_emision: c[6] || null,
      fecha_certificacion: c[7] || null,
      monto: Number(c[8] || 0),
      efecto_comprobante: c[9],
      estatus: Number(c[10]),
      fecha_cancelacion: c[11] || null,
      periodo_anio: new Date(c[6]).getFullYear(),
      periodo_mes: new Date(c[6]).getMonth() + 1,
      raw_line: linea
    };

    const res = await fetch(SUPABASE_URL, {
      method: "POST",
headers: {
  "apikey": ANON_KEY,
  "Authorization": "Bearer " + ANON_KEY,
  "Content-Type": "application/json",
  "Prefer": "resolution=merge-duplicates"
},
      body: JSON.stringify(payload)
    });

    if(res.ok) enviados++;
  }

  log(`âœ” Registros enviados: ${enviados}`);
  log("Proceso terminado.");
}
</script>

</body>
</html>
