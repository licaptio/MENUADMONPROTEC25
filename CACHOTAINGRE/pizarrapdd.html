<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PROVSOFT ‚Äì Dashboard Ingresos PDD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- üîß Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #00416A, #E4E5E6);
      color: #111;
      margin: 0; padding: 20px;
    }
    h1 {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      padding: 20px;
      max-width: 980px;
      margin: auto;
      margin-bottom: 24px;
    }
    canvas {
      width: 100%;
      height: 460px;
    }
    button {
      background: #00416A;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: #0078b9;
    }
  </style>
</head>
<body>
  <h1>PROVSOFT ‚Äì Dashboard Ingresos PDD</h1>

  <!-- üìä Secci√≥n: Gr√°fica comparativa -->
  <div class="card">
    <h2 style="color:#00416A;text-align:center;">Comparativo por A√±o y Mes</h2>
    <canvas id="grafica"></canvas>
  </div>

  <!-- üìÅ Secci√≥n: Descarga Excel -->
  <div class="card" style="text-align:center;">
    <h2 style="color:#00416A;">Descargar Reporte Completo</h2>
    <p>Puedes exportar todos los registros de la tabla <b>ingresos_pdd</b> a Excel para an√°lisis o respaldo.</p>
    <button id="btnDescargar">‚¨áÔ∏è Descargar Excel</button>
  </div>

  <script>
  // ======================================================
  // üîß 1. FUNCI√ìN: Conectar a Supabase
  // ======================================================
  function conectarSupabase() {
    return window.supabase.createClient(
      "https://cvpbtjlupswbyxenugpz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY" // üîë tu anon key real
    );
  }

  // ======================================================
  // üìä 2. FUNCI√ìN: Generar gr√°fica comparativa por a√±o y mes
  // ======================================================
  // ======================================================
// üìä FUNCI√ìN: Generar gr√°fica con sumas agrupadas SQL
// ======================================================
async function generarGraficaComparativa(supabase) {
  // Usamos una llamada RPC para agrupar en el servidor
  const { data, error } = await supabase
    .from("ingresos_pdd")
    .select("periodo_anio, periodo_mes, subtotal")
    .neq("subtotal", null);

  if (error) {
    console.error(error);
    alert("Error al cargar datos");
    return;
  }

  // Agrupamos en JS pero con base en claves exactas (a√±o + mes)
  const acumulado = {};
  data.forEach((row) => {
    const anio = row.periodo_anio?.toString().trim() || "Sin a√±o";
    const mes = row.periodo_mes?.toString().padStart(2, "0") || "00";
    const key = `${anio}-${mes}`;
    const val = Number(row.subtotal) || 0;
    acumulado[key] = (acumulado[key] || 0) + val;
  });

  // Reorganizamos por a√±o
  const a√±os = [...new Set(data.map((r) => r.periodo_anio))].sort();
  const mesesOrden = ["01","02","03","04","05","06","07","08","09","10","11","12"];
  const etiquetas = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
  const colores = [
    "rgba(0, 65, 106, 0.8)",
    "rgba(0, 160, 190, 0.8)",
    "rgba(100, 190, 255, 0.8)",
    "rgba(255, 193, 7, 0.8)",
    "rgba(220, 53, 69, 0.8)"
  ];

  const datasets = a√±os.map((anio, i) => ({
    label: anio,
    data: mesesOrden.map(
      (m) => acumulado[`${anio}-${m}`] || 0
    ),
    backgroundColor: colores[i % colores.length],
    borderWidth: 1
  }));

  // Graficar
  const ctx = document.getElementById("grafica").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: { labels: etiquetas, datasets },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: "Monto ($)" },
          ticks: { callback: (v) => "$" + v.toLocaleString("es-MX") }
        }
      },
      plugins: {
        tooltip: {
          backgroundColor: "#00416A",
          titleColor: "#fff",
          bodyColor: "#fff",
          callbacks: {
            title: (ctx) => "Mes: " + ctx[0].label,
            label: (ctx) => {
              const val = ctx.raw || 0;
              return `${ctx.dataset.label}: $${val.toLocaleString("es-MX", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              })}`;
            }
          }
        },
        legend: {
          position: "top",
          labels: { color: "#00416A", font: { size: 14 } }
        },
        title: {
          display: true,
          text: "Comparativo hist√≥rico de ingresos (Subtotales agrupados por a√±o y mes)",
          color: "#00416A",
          font: { size: 16 }
        }
      },
      interaction: { mode: "index", intersect: false },
      animation: { duration: 800, easing: "easeOutQuart" }
    }
  });

  // Validar en consola
  console.log("‚úÖ Totales por a√±o-mes:", acumulado);
}


// ======================================================
// üì• 3. FUNCI√ìN: Exportar tabla completa a Excel (con barra de progreso y control de texto largo)
// ======================================================
async function exportarExcel(supabase) {
  const tabla = "ingresos_pdd";
  const limite = 1000;
  let desde = 0;
  let registrosTotales = [];
  let seguir = true;

  // üü© Crear barra de progreso visual
  let barra = document.createElement("div");
  barra.style.position = "fixed";
  barra.style.bottom = "20px";
  barra.style.left = "50%";
  barra.style.transform = "translateX(-50%)";
  barra.style.width = "60%";
  barra.style.height = "24px";
  barra.style.border = "2px solid #00416A";
  barra.style.borderRadius = "10px";
  barra.style.background = "#eee";
  barra.style.overflow = "hidden";
  barra.style.zIndex = "9999";

  let progreso = document.createElement("div");
  progreso.style.height = "100%";
  progreso.style.width = "0%";
  progreso.style.background = "linear-gradient(to right,#00416A,#0078b9)";
  progreso.style.transition = "width 0.3s ease";
  barra.appendChild(progreso);

  let texto = document.createElement("div");
  texto.style.position = "absolute";
  texto.style.width = "100%";
  texto.style.top = "0";
  texto.style.textAlign = "center";
  texto.style.color = "#00416A";
  texto.style.fontWeight = "600";
  texto.style.lineHeight = "24px";
  texto.textContent = "Descargando datos...";
  barra.appendChild(texto);

  document.body.appendChild(barra);

  // üîÅ Descargar por bloques
  while (seguir) {
    const { data, error } = await supabase
      .from(tabla)
      .select("*")
      .range(desde, desde + limite - 1);

    if (error) {
      console.error(error);
      alert("Error al descargar datos: " + error.message);
      document.body.removeChild(barra);
      return;
    }

    if (!data || data.length === 0) {
      seguir = false;
      break;
    }

    registrosTotales = registrosTotales.concat(data);
    desde += limite;

    // Actualizar progreso visual
    const porcentaje = Math.min((desde / 12000) * 100, 100); // aprox. si tienes 12k registros
    progreso.style.width = `${porcentaje.toFixed(1)}%`;
    texto.textContent = `Descargando... ${registrosTotales.length.toLocaleString()} registros`;

    // detener si ya no hay m√°s datos
    if (data.length < limite) seguir = false;
  }

  // üîß Limpiar barra al finalizar
  progreso.style.width = "100%";
  texto.textContent = `Procesando archivo... (${registrosTotales.length.toLocaleString()} registros)`;

  // üßÆ Normalizar JSON largos
  const datosPlano = registrosTotales.map((reg) => {
    const obj = {};
    for (const [clave, valor] of Object.entries(reg)) {
      if (typeof valor === "object" && valor !== null) {
        const jsonString = JSON.stringify(valor);
        obj[clave] =
          jsonString.length > 32000
            ? jsonString.substring(0, 32000) + "‚Ä¶ [truncado]"
            : jsonString;
      } else {
        const textoPlano =
          typeof valor === "string" && valor.length > 32000
            ? valor.substring(0, 32000) + "‚Ä¶ [truncado]"
            : valor;
        obj[clave] = textoPlano;
      }
    }
    return obj;
  });

  // üìó Crear Excel
  const ws = XLSX.utils.json_to_sheet(datosPlano);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Ingresos_PDD");

  // üíæ Guardar archivo
  XLSX.writeFile(
    wb,
    `ingresos_pdd_crudo_${new Date().toISOString().split("T")[0]}.xlsx`
  );

  texto.textContent = "‚úÖ Exportaci√≥n completa";
  setTimeout(() => document.body.removeChild(barra), 3000);
}

  // ======================================================
  // üöÄ 4. FUNCI√ìN PRINCIPAL: flujo general
  // ======================================================
  async function main() {
    const supabase = conectarSupabase();
    await generarGraficaComparativa(supabase);
    document.getElementById("btnDescargar").addEventListener("click", () => exportarExcel(supabase));
  }

  // Iniciar al cargar
  main();
  </script>
</body>
</html>
