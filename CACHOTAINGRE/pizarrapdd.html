<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PROVSOFT ‚Äì Dashboard Ingresos PDD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- üìö Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #00416A, #E4E5E6);
      color: #111;
      margin: 0; padding: 20px;
    }
    h1 {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      padding: 20px;
      max-width: 980px;
      margin: auto;
      margin-bottom: 24px;
    }
    canvas {
      width: 100%;
      height: 460px;
    }
    button {
      background: #00416A;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: #0078b9;
    }
  </style>
</head>
<body>

  <h1>PROVSOFT ‚Äì Dashboard Ingresos PDD</h1>

  <!-- ========================================================== -->
  <!-- üìä SECCI√ìN 1: COMPARATIVO POR A√ëO Y MES -->
  <!-- ========================================================== -->
  <div class="card">
    <h2 style="color:#00416A;text-align:center;">Comparativo por A√±o y Mes</h2>
    <canvas id="grafica"></canvas>
  </div>

  <!-- ========================================================== -->
  <!-- üìà SECCI√ìN 2: COMPARATIVO POR SUCURSAL (SERIE) -->
  <!-- ========================================================== -->
  <div class="card">
    <h2 style="color:#00416A;text-align:center;">Comparativo por Sucursal (Serie)</h2>
    <p style="text-align:center;color:#555;">Evoluci√≥n mensual por sucursal ‚Äî selecciona un a√±o:</p>
    <div style="text-align:center;margin-bottom:12px;">
      <select id="selectorAnioSucursal" style="padding:8px 10px;border-radius:8px;border:1px solid #ccc;">
        <option value="2023">2023</option>
        <option value="2024">2024</option>
        <option value="2025" selected>2025</option>
      </select>
    </div>
    <canvas id="graficaSucursales"></canvas>
  </div>

  <!-- ========================================================== -->
  <!-- üì• SECCI√ìN 3: DESCARGA EXCEL -->
  <!-- ========================================================== -->
  <div class="card" style="text-align:center;">
    <h2 style="color:#00416A;">Descargar Reporte Completo</h2>
    <p>Puedes exportar todos los registros de la tabla <b>ingresos_pdd</b> a Excel para an√°lisis o respaldo.</p>
    <button id="btnDescargar">‚¨áÔ∏è Descargar Excel</button>
  </div>

  <script>
  // ======================================================
  // üîß 1. FUNCI√ìN: Conexi√≥n a Supabase
  // ======================================================
  function conectarSupabase() {
    return window.supabase.createClient(
      "https://cvpbtjlupswbyxenugpz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
    );
  }

  // ======================================================
  // üìä 2. FUNCI√ìN: Gr√°fica comparativa por a√±o y mes
  // ======================================================
  async function generarGraficaComparativa(supabase) {
    const { data, error } = await supabase
      .from("ingresos_pdd")
      .select("periodo_mes, periodo_anio, subtotal");

    if (error) {
      console.error(error);
      alert("Error al cargar datos");
      return;
    }

    const acumulado = {};
    data.forEach(row => {
      const anio = row.periodo_anio || "Sin a√±o";
      const mes = row.periodo_mes?.toString().padStart(2, "0") || "00";
      const subtotal = parseFloat(row.subtotal || 0);
      if (!acumulado[anio]) acumulado[anio] = {};
      acumulado[anio][mes] = (acumulado[anio][mes] || 0) + subtotal;
    });

    const mesesOrden = ["01","02","03","04","05","06","07","08","09","10","11","12"];
    const etiquetas = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
    const colores = [
      "rgba(0, 65, 106, 0.8)",
      "rgba(0, 160, 190, 0.8)",
      "rgba(100, 190, 255, 0.8)"
    ];

    const datasets = Object.keys(acumulado).sort().map((anio, i) => ({
      label: anio,
      data: mesesOrden.map(m => acumulado[anio][m] || 0),
      backgroundColor: colores[i % colores.length],
      borderWidth: 1
    }));

    const ctx = document.getElementById("grafica").getContext("2d");
    new Chart(ctx, {
      type: "bar",
      data: { labels: etiquetas, datasets },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: "Monto ($)" },
            ticks: { callback: v => "$" + v.toLocaleString("es-MX") }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              title: ctx => "Mes: " + ctx[0].label,
              label: ctx => `${ctx.dataset.label}: $${(ctx.raw || 0).toLocaleString("es-MX", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              })}`
            }
          },
          legend: { position: "top" },
          title: {
            display: true,
            text: "Comparativo hist√≥rico de ingresos (Subtotales)",
            color: "#00416A"
          }
        }
      }
    });
  }

  // ======================================================
  // üìà 3. FUNCI√ìN: Gr√°fica lineal por sucursal (serie)
  // ======================================================
  async function generarGraficaSucursales(supabase) {
    const selectAnio = document.getElementById("selectorAnioSucursal");

    async function cargarDatos(anioSeleccionado) {
      const { data, error } = await supabase
        .from("vista_ingresos_sucursales")
        .select("*")
        .eq("periodo_anio", anioSeleccionado);

      if (error) {
        console.error(error);
        alert("Error al cargar datos de sucursales");
        return;
      }

      const sucursales = [...new Set(data.map(d => d.serie))];
      const mesesOrden = ["01","02","03","04","05","06","07","08","09","10","11","12"];
      const etiquetas = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
      const colores = [
        "#00416A", "#00A0BE", "#64BEFF", "#FFC107",
        "#DC3545", "#28A745", "#6F42C1", "#FF5733"
      ];

      const datasets = sucursales.map((serie, i) => ({
        label: serie,
        data: mesesOrden.map(mes => {
          const fila = data.find(f => f.periodo_mes === mes && f.serie === serie);
          return fila ? Number(fila.total_subtotal) : 0;
        }),
        borderColor: colores[i % colores.length],
        backgroundColor: colores[i % colores.length],
        tension: 0.3,
        borderWidth: 3,
        pointRadius: 4,
        pointHoverRadius: 6,
        fill: false
      }));

      const ctx = document.getElementById("graficaSucursales").getContext("2d");
      if (window.graficaSucursales) window.graficaSucursales.destroy();
      window.graficaSucursales = new Chart(ctx, {
        type: "line",
        data: { labels: etiquetas, datasets },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: `Ingresos por Sucursal ‚Äì A√±o ${anioSeleccionado}`,
              color: "#00416A"
            },
            legend: { position: "bottom" },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: $${(ctx.raw || 0).toLocaleString("es-MX", {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2
                })}`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: "Monto ($)" },
              ticks: { callback: v => "$" + v.toLocaleString("es-MX") }
            }
          }
        }
      });
    }

    await cargarDatos(selectAnio.value);
    selectAnio.addEventListener("change", e => cargarDatos(e.target.value));
  }

  // ======================================================
  // üì• 4. FUNCI√ìN: Exportar tabla completa a Excel
  // ======================================================
  async function exportarExcel(supabase) {
    const tabla = "ingresos_pdd";
    const limite = 1000;
    let desde = 0;
    let registrosTotales = [];
    let seguir = true;

    let barra = document.createElement("div");
    barra.style.position = "fixed";
    barra.style.bottom = "20px";
    barra.style.left = "50%";
    barra.style.transform = "translateX(-50%)";
    barra.style.width = "60%";
    barra.style.height = "24px";
    barra.style.border = "2px solid #00416A";
    barra.style.borderRadius = "10px";
    barra.style.background = "#eee";
    barra.style.overflow = "hidden";
    barra.style.zIndex = "9999";

    let progreso = document.createElement("div");
    progreso.style.height = "100%";
    progreso.style.width = "0%";
    progreso.style.background = "linear-gradient(to right,#00416A,#0078b9)";
    progreso.style.transition = "width 0.3s ease";
    barra.appendChild(progreso);

    let texto = document.createElement("div");
    texto.style.position = "absolute";
    texto.style.width = "100%";
    texto.style.top = "0";
    texto.style.textAlign = "center";
    texto.style.color = "#00416A";
    texto.style.fontWeight = "600";
    texto.style.lineHeight = "24px";
    texto.textContent = "Descargando datos...";
    barra.appendChild(texto);

    document.body.appendChild(barra);

    while (seguir) {
      const { data, error } = await supabase
        .from(tabla)
        .select("*")
        .range(desde, desde + limite - 1);

      if (error) {
        console.error(error);
        alert("Error al descargar datos: " + error.message);
        document.body.removeChild(barra);
        return;
      }

      if (!data || data.length === 0) {
        seguir = false;
        break;
      }

      registrosTotales = registrosTotales.concat(data);
      desde += limite;

      const porcentaje = Math.min((desde / 12000) * 100, 100);
      progreso.style.width = `${porcentaje.toFixed(1)}%`;
      texto.textContent = `Descargando... ${registrosTotales.length.toLocaleString()} registros`;

      if (data.length < limite) seguir = false;
    }

    progreso.style.width = "100%";
    texto.textContent = `Procesando archivo... (${registrosTotales.length.toLocaleString()} registros)`;

    const ws = XLSX.utils.json_to_sheet(registrosTotales);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ingresos_PDD");
    XLSX.writeFile(wb, `ingresos_pdd_${new Date().toISOString().split("T")[0]}.xlsx`);

    texto.textContent = "‚úÖ Exportaci√≥n completa";
    setTimeout(() => document.body.removeChild(barra), 3000);
  }

  // ======================================================
  // üöÄ 5. FUNCI√ìN PRINCIPAL
  // ======================================================
  async function main() {
    const supabase = conectarSupabase();
    await generarGraficaComparativa(supabase);
    await generarGraficaSucursales(supabase);
    document.getElementById("btnDescargar").addEventListener("click", () => exportarExcel(supabase));
  }

  // Ejecutar
  main();
  </script>
</body>
</html>
