<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PROVSOFT ‚Äì Dashboard Ingresos PDD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- üìö Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #00416A, #E4E5E6);
      color: #111;
      margin: 0; padding: 20px;
    }
    h1 {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      padding: 20px;
      max-width: 980px;
      margin: auto;
      margin-bottom: 24px;
    }
    canvas {
      width: 100%;
      height: 460px;
    }
    button {
      background: #00416A;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: #0078b9;
    }
  </style>
</head>
<body>

  <h1>PROVSOFT ‚Äì Dashboard Ingresos PDD</h1>

  <!-- ========================================================== -->
  <!-- üìä SECCI√ìN 1: COMPARATIVO POR A√ëO Y MES -->
  <!-- ========================================================== -->
  <div class="card">
    <h2 style="color:#00416A;text-align:center;">Comparativo por A√±o y Mes</h2>
    <canvas id="grafica"></canvas>
  </div>

  <!-- ========================================================== -->
  <!-- üìà SECCI√ìN 2: COMPARATIVO POR SUCURSAL (SERIE) -->
  <!-- ========================================================== -->
  <div class="card">
    <h2 style="color:#00416A;text-align:center;">Comparativo por Sucursal (Serie)</h2>
    <p style="text-align:center;color:#555;">Evoluci√≥n mensual por sucursal ‚Äî selecciona un a√±o:</p>
    <div style="text-align:center;margin-bottom:12px;">
      <select id="selectorAnioSucursal" style="padding:8px 10px;border-radius:8px;border:1px solid #ccc;">
        <option value="2023">2023</option>
        <option value="2024">2024</option>
        <option value="2025" selected>2025</option>
      </select>
    </div>
    <canvas id="graficaSucursales"></canvas>
  </div>

  <!-- ========================================================== -->
  <!-- üì• SECCI√ìN 3: DESCARGA EXCEL -->
  <!-- ========================================================== -->
  <div class="card" style="text-align:center;">
    <h2 style="color:#00416A;">Descargar Reporte Completo</h2>
    <p>Puedes exportar todos los registros de la tabla <b>ingresos_pdd</b> a Excel para an√°lisis o respaldo.</p>
    <button id="btnDescargar">‚¨áÔ∏è Descargar Excel</button>
  </div>

<!-- ========================================================== -->
<!-- üß© SECCI√ìN 4: GRAFICAS COMPARATIVAS POR SUCURSAL -->
<!-- ========================================================== -->
<div class="card">
  <h2 style="color:#00416A;text-align:center;">Comparativo por Sucursal (2023-2025)</h2>
  <p style="text-align:center;color:#555;">Evoluci√≥n mensual por sucursal ‚Äì comparaci√≥n de a√±os</p>
  <div id="contenedorGraficasSucursales"
       style="display:flex;flex-wrap:wrap;gap:20px;justify-content:center;"></div>
</div>

 <!-- ========================================================== -->
<!-- üßæ SECCI√ìN 5: √öLTIMAS FACTURAS POR SUCURSAL -->
<!-- ========================================================== -->
<div class="card">
  <h2 style="color:#00416A;text-align:center;">√öltimas Facturas por Sucursal</h2>
  <p style="text-align:center;color:#555;">Consulta las 3 facturas m√°s recientes por sucursal</p>
  <div id="contenedorUltimasFacturas"
       style="display:flex;flex-wrap:wrap;gap:20px;justify-content:center;"></div>
</div>

<!-- ========================================================== -->
<!-- üèÜ SECCI√ìN 6: TOP 10 CLIENTES 2025 -->
<!-- ========================================================== -->
<div class="card">
  <h2 style="color:#00416A;text-align:center;">üèÜ Top 10 Clientes ‚Äì A√±o 2025</h2>
  <p style="text-align:center;color:#555;">Clientes con mayores ingresos (subtotal acumulado)</p>
  <div id="contenedorTopClientes" style="max-width:900px;margin:auto;"></div>
</div>
  
<!-- ========================================================== -->
<!-- üì¶ SECCI√ìN 7: TOP 15 ART√çCULOS M√ÅS FACTURADOS (2025) -->
<!-- ========================================================== -->
<div class="card">
  <h2 style="color:#00416A;text-align:center;">üì¶ Top 15 Art√≠culos M√°s Facturados ‚Äì A√±o 2025</h2>
  <p style="text-align:center;color:#555;">Basado en subtotales acumulados del campo <b>conceptos</b></p>
  <div id="contenedorTopArticulos" style="max-width:900px;margin:auto;"></div>
</div>
  
  <script>
// ======================================================
// üîß 1. FUNCI√ìN: Conexi√≥n a Supabase
// ======================================================
function conectarSupabase() {
  return window.supabase.createClient(
    "https://cvpbtjlupswbyxenugpz.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
  );
}

// ======================================================
// üìä 2. FUNCI√ìN: Gr√°fica comparativa por a√±o y mes (desde vista_ingresos_mensuales)
// ======================================================
async function generarGraficaComparativa(supabase) {
  const ctx = document.getElementById("grafica").getContext("2d");
  let graficaComparativa = null;

  // üì° Leer datos desde la nueva vista
  const { data, error } = await supabase
    .from("vista_ingresos_mensuales")
    .select("periodo_anio, periodo_mes, total_subtotal");

  if (error) {
    console.error("‚ùå Error al cargar ingresos:", error);
    alert("Error al cargar datos de ingresos");
    return;
  }

  if (!data || data.length === 0) {
    console.warn("‚ö†Ô∏è No hay datos para mostrar");
    return;
  }

  // üßÆ Agrupar por a√±o y mes
  const acumulado = {};
  data.forEach(row => {
    const anio = String(row.periodo_anio);
    const mes = String(row.periodo_mes).padStart(2, "0");
    const val = Number(row.total_subtotal) || 0;
    if (!acumulado[anio]) acumulado[anio] = {};
    acumulado[anio][mes] = val;
  });

  // üìÖ Configuraci√≥n de meses y colores
  const mesesOrden = ["01","02","03","04","05","06","07","08","09","10","11","12"];
  const etiquetas = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
  const colores = [
    "rgba(0, 65, 106, 0.8)",
    "rgba(0, 160, 190, 0.8)",
    "rgba(100, 190, 255, 0.8)",
    "rgba(255, 193, 7, 0.8)"
  ];

  // üìä Crear datasets por a√±o
  const datasets = Object.keys(acumulado).sort().map((anio, i) => ({
    label: anio,
    data: mesesOrden.map(m => acumulado[anio][m] || 0),
    backgroundColor: colores[i % colores.length],
    borderColor: colores[i % colores.length],
    borderWidth: 1
  }));

  // üßπ Limpiar gr√°fica previa
  if (graficaComparativa instanceof Chart) graficaComparativa.destroy();

  // üß≠ Graficar
  graficaComparativa = new Chart(ctx, {
    type: "bar",
    data: { labels: etiquetas, datasets },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          suggestedMax: Math.max(...datasets.flatMap(d => d.data)) * 1.1,
          title: { display: true, text: "Monto ($)" },
          ticks: { callback: v => "$" + v.toLocaleString("es-MX") }
        }
      },
      plugins: {
        title: {
          display: true,
          text: "Comparativo hist√≥rico de ingresos (Vista agrupada por a√±o y mes)",
          color: "#00416A",
          font: { size: 16 }
        },
        legend: { position: "top", labels: { color: "#00416A" } },
        tooltip: {
          callbacks: {
            label: ctx => {
              const val = ctx.raw || 0;
              return `${ctx.dataset.label}: $${val.toLocaleString("es-MX", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              })}`;
            }
          }
        }
      }
    }
  });

  console.log("‚úÖ Datos graficados (vista_ingresos_mensuales):", acumulado);
}

// ======================================================
// üìà 3. FUNCI√ìN: Gr√°fica lineal por sucursal (serie) ‚Äì DEPURADA
// ======================================================
async function generarGraficaSucursales(supabase) {
  const selectAnio = document.getElementById("selectorAnioSucursal");
  const ctx = document.getElementById("graficaSucursales").getContext("2d");
  let graficaSucursales = null;

  async function cargarDatos(anioSeleccionado) {
    const { data, error } = await supabase
      .from("vista_ingresos_sucursales")
      .select("*")
      .eq("periodo_anio", anioSeleccionado);

    if (error) {
      console.error("‚ùå Error al cargar sucursales:", error);
      alert("Error al cargar datos de sucursales");
      return;
    }

    if (!data || data.length === 0) {
      console.warn("‚ö†Ô∏è Sin datos para el a√±o:", anioSeleccionado);
      if (graficaSucursales) graficaSucursales.destroy();
      return;
    }

    const sucursales = [...new Set(data.map(d => d.serie))];
    const mesesOrden = ["01","02","03","04","05","06","07","08","09","10","11","12"];
    const etiquetas = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
    const colores = [
      "#00416A", "#00A0BE", "#64BEFF", "#FFC107",
      "#DC3545", "#28A745", "#6F42C1", "#FF5733"
    ];

    const datasets = sucursales.map((serie, i) => ({
      label: serie,
      data: mesesOrden.map(m => {
        const fila = data.find(f => f.periodo_mes === m && f.serie === serie);
        return fila ? Number(fila.total_subtotal) : 0;
      }),
      borderColor: colores[i % colores.length],
      backgroundColor: colores[i % colores.length],
      tension: 0.3,
      borderWidth: 3,
      pointRadius: 4,
      pointHoverRadius: 6,
      fill: false
    }));

    if (graficaSucursales instanceof Chart) graficaSucursales.destroy();

    graficaSucursales = new Chart(ctx, {
      type: "line",
      data: { labels: etiquetas, datasets },
      options: {
        responsive: true,
        interaction: { mode: "index", intersect: false },
        plugins: {
          title: {
            display: true,
            text: `Ingresos por Sucursal ‚Äì A√±o ${anioSeleccionado}`,
            color: "#00416A",
            font: { size: 16 }
          },
          legend: {
            position: "bottom",
            labels: { color: "#00416A", font: { size: 13 } }
          },
          tooltip: {
            callbacks: {
              label: ctx => {
                const val = ctx.raw || 0;
                return `${ctx.dataset.label}: $${val.toLocaleString("es-MX", {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2
                })}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: "Monto ($)" },
            ticks: { callback: v => "$" + v.toLocaleString("es-MX") }
          }
        }
      }
    });
  }

  await cargarDatos(selectAnio.value);
  selectAnio.addEventListener("change", e => cargarDatos(e.target.value));
}

// ======================================================
// üß© 4. FUNCI√ìN: Generar gr√°ficas comparativas por sucursal (2023‚Äì2025)
// ======================================================
async function generarGraficasSucursalesComparativo(supabase) {
  const contenedor = document.getElementById("contenedorGraficasSucursales");
  contenedor.innerHTML = "<p style='text-align:center;'>Cargando datos...</p>";

  const { data, error } = await supabase
    .from("vista_ingresos_sucursal_anual")
    .select("serie, periodo_anio, periodo_mes, total_subtotal");

  if (error) {
    console.error("‚ùå Error al cargar datos comparativos:", error);
    contenedor.innerHTML = "<p>Error al cargar datos.</p>";
    return;
  }

  if (!data || data.length === 0) {
    contenedor.innerHTML = "<p>No hay datos disponibles.</p>";
    return;
  }

  contenedor.innerHTML = ""; // limpiar el ‚ÄúCargando‚Ä¶‚Äù

  const sucursales = [...new Set(data.map(d => d.serie))];
  const mesesOrden = ["01","02","03","04","05","06","07","08","09","10","11","12"];
  const etiquetas = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
  const colores = [
    "rgba(0, 65, 106, 0.8)",
    "rgba(0, 160, 190, 0.8)",
    "rgba(100, 190, 255, 0.8)"
  ];

  sucursales.forEach(serie => {
    // Crear el contenedor individual
    const div = document.createElement("div");
    div.style.flex = "1 1 420px";
    div.style.minWidth = "380px";
    div.style.background = "white";
    div.style.borderRadius = "12px";
    div.style.padding = "16px";
    div.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
    div.style.textAlign = "center";

    const titulo = document.createElement("h3");
    titulo.textContent = `Sucursal ${serie}`;
    titulo.style.color = "#00416A";
    titulo.style.marginBottom = "10px";
    div.appendChild(titulo);

    const canvas = document.createElement("canvas");
    div.appendChild(canvas);
    contenedor.appendChild(div);

    // Filtrar los datos de esa sucursal
    const datosSucursal = data.filter(d => d.serie === serie);
    const anios = [...new Set(datosSucursal.map(d => d.periodo_anio))].sort();

    // Crear datasets comparativos
    const datasets = anios.map((anio, i) => ({
      label: anio,
      data: mesesOrden.map(mes => {
        const fila = datosSucursal.find(f => f.periodo_anio === anio && f.periodo_mes === mes);
        return fila ? Number(fila.total_subtotal) : 0;
      }),
      backgroundColor: colores[i % colores.length],
      borderColor: colores[i % colores.length],
      borderWidth: 1
    }));

    new Chart(canvas, {
      type: "bar",
      data: { labels: etiquetas, datasets },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: `Comparativo ${serie} ‚Äì Ingresos por mes`,
            color: "#00416A"
          },
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: ctx => {
                const val = ctx.raw || 0;
                return `${ctx.dataset.label}: $${val.toLocaleString("es-MX", {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2
                })}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: "Monto ($)" },
            ticks: { callback: v => "$" + v.toLocaleString("es-MX") }
          }
        }
      }
    });
  });
}

    
// ======================================================
// üì• 4. FUNCI√ìN: Exportar tabla completa a Excel
// ======================================================
async function exportarExcel(supabase) {
  const tabla = "ingresos_pdd";
  const limite = 1000;
  let desde = 0;
  let registrosTotales = [];
  let seguir = true;

  const barra = document.createElement("div");
  barra.style.position = "fixed";
  barra.style.bottom = "20px";
  barra.style.left = "50%";
  barra.style.transform = "translateX(-50%)";
  barra.style.width = "60%";
  barra.style.height = "24px";
  barra.style.border = "2px solid #00416A";
  barra.style.borderRadius = "10px";
  barra.style.background = "#eee";
  barra.style.overflow = "hidden";
  barra.style.zIndex = "9999";

  const progreso = document.createElement("div");
  progreso.style.height = "100%";
  progreso.style.width = "0%";
  progreso.style.background = "linear-gradient(to right,#00416A,#0078b9)";
  progreso.style.transition = "width 0.3s ease";
  barra.appendChild(progreso);

  const texto = document.createElement("div");
  texto.style.position = "absolute";
  texto.style.width = "100%";
  texto.style.top = "0";
  texto.style.textAlign = "center";
  texto.style.color = "#00416A";
  texto.style.fontWeight = "600";
  texto.style.lineHeight = "24px";
  texto.textContent = "Descargando datos...";
  barra.appendChild(texto);

  document.body.appendChild(barra);

  while (seguir) {
    const { data, error } = await supabase
      .from(tabla)
      .select("*")
      .range(desde, desde + limite - 1);

    if (error) {
      console.error(error);
      alert("Error al descargar datos: " + error.message);
      document.body.removeChild(barra);
      return;
    }

    if (!data || data.length === 0) break;

    registrosTotales = registrosTotales.concat(data);
    desde += limite;

    const porcentaje = Math.min((desde / 12000) * 100, 100);
    progreso.style.width = `${porcentaje.toFixed(1)}%`;
    texto.textContent = `Descargando... ${registrosTotales.length.toLocaleString()} registros`;

    if (data.length < limite) seguir = false;
  }

  progreso.style.width = "100%";
  texto.textContent = `Procesando archivo... (${registrosTotales.length.toLocaleString()} registros)`;

  const ws = XLSX.utils.json_to_sheet(registrosTotales);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Ingresos_PDD");
  XLSX.writeFile(wb, `ingresos_pdd_${new Date().toISOString().split("T")[0]}.xlsx`);

  texto.textContent = "‚úÖ Exportaci√≥n completa";
  setTimeout(() => document.body.removeChild(barra), 3000);
}


// ======================================================
// üßæ 5. FUNCI√ìN: Mostrar las 3 facturas m√°s recientes por sucursal (adaptada a ingresos_pdd)
// ======================================================
async function mostrarUltimasFacturasPorSucursal(supabase) {
  const contenedor = document.getElementById("contenedorUltimasFacturas");
  contenedor.innerHTML = "<p style='text-align:center;'>Cargando √∫ltimas facturas...</p>";

  // üì° Consulta las columnas necesarias
  const { data, error } = await supabase
    .from("ingresos_pdd")
    .select("fecha, razon_social_receptor, serie, subtotal")
    .order("fecha", { ascending: false });

  if (error) {
    console.error("‚ùå Error al cargar facturas:", error);
    contenedor.innerHTML = "<p>Error al cargar datos.</p>";
    return;
  }

  if (!data || data.length === 0) {
    contenedor.innerHTML = "<p>No hay facturas disponibles.</p>";
    return;
  }

  contenedor.innerHTML = "";

  // üîπ Agrupar por serie (sucursal)
  const agrupado = {};
  data.forEach(factura => {
    const clave = factura.serie || "Sin serie";
    if (!agrupado[clave]) agrupado[clave] = [];
    if (agrupado[clave].length < 3) agrupado[clave].push(factura);
  });

  // üîπ Definir colores por sucursal (opcional PROVSOFT style)
  const coloresSucursal = {
    "LMN": "#0c6cbd",
    "MM": "#28A745",
    "LP": "#FFC107",
    "LO": "#DC3545",
    "AM": "#6F42C1",
    "SAN": "#17A2B8"
  };

  // üîπ Crear tarjetas por sucursal
  Object.keys(agrupado).forEach(serie => {
    const facturas = agrupado[serie];
    const colorCabecera = coloresSucursal[serie] || "#00416A";

    const div = document.createElement("div");
    div.style.flex = "1 1 380px";
    div.style.background = "white";
    div.style.borderRadius = "12px";
    div.style.padding = "16px";
    div.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
    div.style.textAlign = "center";

    const titulo = document.createElement("h3");
    titulo.textContent = `Sucursal ${serie}`;
    titulo.style.color = colorCabecera;
    titulo.style.marginBottom = "10px";
    div.appendChild(titulo);

    const tabla = document.createElement("table");
    tabla.style.width = "100%";
    tabla.style.borderCollapse = "collapse";
    tabla.innerHTML = `
      <thead>
        <tr style="background:${colorCabecera};color:white;">
          <th>Fecha</th><th>Nombre</th><th>Serie</th><th>Monto</th>
        </tr>
      </thead>
      <tbody>
        ${facturas.map(f => `
          <tr>
            <td>${new Date(f.fecha).toLocaleDateString("es-MX")}</td>
            <td>${f.razon_social_receptor || "‚Äî"}</td>
            <td>${f.serie || "‚Äî"}</td>
            <td>$${Number(f.subtotal || 0).toLocaleString("es-MX", { minimumFractionDigits: 2 })}</td>
          </tr>
        `).join("")}
      </tbody>
    `;

    // Estilo de tabla
    tabla.querySelectorAll("td").forEach(td => {
      td.style.padding = "6px";
      td.style.borderBottom = "1px solid #ddd";
      td.style.fontSize = "13px";
    });
    tabla.querySelectorAll("th").forEach(th => th.style.padding = "6px");
    div.appendChild(tabla);
    contenedor.appendChild(div);
  });
}

// ======================================================
// üèÜ 6. FUNCI√ìN: TOP 10 DE CLIENTES POR A√ëO (2025)
// ======================================================
async function mostrarTopClientes2025(supabase) {
  const contenedor = document.getElementById("contenedorTopClientes");
  contenedor.innerHTML = "<p style='text-align:center;'>Cargando datos...</p>";

  // üì° Consulta registros del a√±o 2025
  const { data, error } = await supabase
    .from("ingresos_pdd")
    .select("razon_social_receptor, subtotal, periodo_anio")
    .eq("periodo_anio", 2025);

  if (error) {
    console.error("‚ùå Error al cargar datos:", error);
    contenedor.innerHTML = "<p>Error al cargar datos.</p>";
    return;
  }

  if (!data || data.length === 0) {
    contenedor.innerHTML = "<p>No hay datos disponibles para 2025.</p>";
    return;
  }

  // üßÆ Agrupar por cliente y sumar subtotales
  const acumulado = {};
  data.forEach(row => {
    const cliente = row.razon_social_receptor?.trim() || "Sin nombre";
    const monto = Number(row.subtotal) || 0;
    acumulado[cliente] = (acumulado[cliente] || 0) + monto;
  });

  // üèÜ Ordenar y tomar Top 10
  const top10 = Object.entries(acumulado)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);

  const maxValor = top10[0] ? top10[0][1] : 1;

  // üé® Construir tabla con barras de progreso
  contenedor.innerHTML = `
    <table style="width:100%;border-collapse:collapse;">
      <thead>
        <tr style="background:#00416A;color:white;">
          <th style="padding:8px;text-align:left;">#</th>
          <th style="padding:8px;text-align:left;">Cliente</th>
          <th style="padding:8px;text-align:right;">Monto</th>
        </tr>
      </thead>
      <tbody>
        ${top10.map(([cliente, monto], i) => `
          <tr>
            <td style="padding:8px;text-align:center;font-weight:600;">${i + 1}</td>
            <td style="padding:8px;">${cliente}</td>
            <td style="padding:8px;text-align:right;">$${monto.toLocaleString("es-MX", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            })}</td>
          </tr>
          <tr>
            <td colspan="3" style="padding:4px 8px;">
              <div style="background:#e5e5e5;border-radius:6px;height:10px;overflow:hidden;">
                <div style="height:10px;width:${(monto / maxValor) * 100}%;
                            background:linear-gradient(to right,#00416A,#00A0BE);"></div>
              </div>
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}

// ======================================================
// üì¶ 7. FUNCI√ìN: TOP 15 ART√çCULOS M√ÅS FACTURADOS (A√ëO 2025)
// ======================================================
async function mostrarTopArticulos2025(supabase) {
  const contenedor = document.getElementById("contenedorTopArticulos");
  contenedor.innerHTML = "<p style='text-align:center;'>Cargando art√≠culos...</p>";

  // üì° Consulta los datos del a√±o 2025
const { data, error } = await supabase
  .from("vista_top_articulos")
  .select("*")
  .eq("periodo_anio", 2025);


  if (error) {
    console.error("‚ùå Error al cargar art√≠culos:", error);
    contenedor.innerHTML = "<p>Error al cargar datos.</p>";
    return;
  }

  if (!data || data.length === 0) {
    contenedor.innerHTML = "<p>No hay datos disponibles para 2025.</p>";
    return;
  }

  // üßÆ Agrupar por nombre del art√≠culo (campo conceptos)
  const acumulado = {};
  data.forEach(row => {
    const concepto = (row.conceptos || "Sin descripci√≥n").trim();
    const monto = Number(row.subtotal) || 0;
    acumulado[concepto] = (acumulado[concepto] || 0) + monto;
  });

  // üèÜ Ordenar y tomar los 15 m√°s altos
  const top15 = Object.entries(acumulado)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 15);

  const maxValor = top15[0] ? top15[0][1] : 1;

  // üé® Crear tabla con barra de progreso
  contenedor.innerHTML = `
    <table style="width:100%;border-collapse:collapse;">
      <thead>
        <tr style="background:#00416A;color:white;">
          <th style="padding:8px;text-align:left;">#</th>
          <th style="padding:8px;text-align:left;">Art√≠culo</th>
          <th style="padding:8px;text-align:right;">Subtotal</th>
        </tr>
      </thead>
      <tbody>
        ${top15.map(([concepto, monto], i) => `
          <tr>
            <td style="padding:8px;text-align:center;font-weight:600;">${i + 1}</td>
            <td style="padding:8px;">${concepto}</td>
            <td style="padding:8px;text-align:right;">$${monto.toLocaleString("es-MX", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            })}</td>
          </tr>
          <tr>
            <td colspan="3" style="padding:4px 8px;">
              <div style="background:#e5e5e5;border-radius:6px;height:10px;overflow:hidden;">
                <div style="height:10px;width:${(monto / maxValor) * 100}%;
                            background:linear-gradient(to right,#0078b9,#00a6ff);"></div>
              </div>
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}
    
// ======================================================
// üöÄ 5. FUNCI√ìN PRINCIPAL
// ======================================================
async function main() {
  const supabase = conectarSupabase();
  
  // üîπ Cargar las tres gr√°ficas principales
  await generarGraficaComparativa(supabase);
  await generarGraficaSucursales(supabase);
  await mostrarUltimasFacturasPorSucursal(supabase);
  await generarGraficasSucursalesComparativo(supabase); // üß© <-- ESTA FALTABA
  await mostrarTopClientes2025(supabase); // üèÜ Nuevo Top 10
  await mostrarTopArticulos2025(supabase);

  
  // üîπ Bot√≥n de descarga
  document.getElementById("btnDescargar").addEventListener("click", () => exportarExcel(supabase));
}

main();
</script>

</body>
</html>
