<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PROVSOFT ‚Äì Dashboard Ingresos PDD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- üìö Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #00416A, #E4E5E6);
      color: #111;
      margin: 0; padding: 20px;
    }
    h1 {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      padding: 20px;
      max-width: 980px;
      margin: auto;
      margin-bottom: 24px;
    }
    canvas {
      width: 100%;
      height: 460px;
    }
    button {
      background: #00416A;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: #0078b9;
    }
  </style>
</head>
<body>

  <h1>PROVSOFT ‚Äì Dashboard Ingresos PDD</h1>
<!-- ========================================================== -->
<!-- üìà SECCI√ìN: HIST√ìRICO MENSUAL DE INGRESOS (MULTI-A√ëO) -->
<!-- ========================================================== -->
<div class="card">
  <h2 style="color:#00416A;text-align:center;">üìà Hist√≥rico Mensual de Ingresos (Todos los A√±os)</h2>
  <p style="text-align:center;color:#555;">Evoluci√≥n mensual total ‚Äî RFC: PDD031204KL5</p>
  <canvas id="graficaHistorica"></canvas>
</div>
<!-- ========================================================== -->
<!-- üíµ SECCI√ìN: RESUMEN ANUAL DE INGRESOS (ANTES DE IMPUESTOS) -->
<!-- ========================================================== -->
<div class="card">
  <h2 style="color:#00416A;text-align:center;">üíµ Ingresos Totales Antes de Impuestos</h2>
  <p style="text-align:center;color:#555;">Comparativo anual (subtotal acumulado) ‚Äî RFC: PDD031204KL5</p>
  <div id="contenedorResumenIngresos" style="max-width:700px;margin:auto;text-align:center;"></div>
</div>
<!-- ========================================================== -->
<!-- üí∞ SECCI√ìN: VENTAS POR IMPUESTO MULTIANUAL -->
<!-- ========================================================== -->
<div class="card">
  <h2 style="color:#00416A;text-align:center;">üí∞ Ventas por Impuesto (Multianual)</h2>
  <p style="text-align:center;color:#555;">
    Totales por tipo de impuesto (IVA, IEPS, 0%) ‚Äî Fuente: ingresos_pdd
  </p>
  <canvas id="graficaImpuestos"></canvas>
</div>

  <!-- ========================================================== -->
  <!-- üì• SECCI√ìN 3: DESCARGA EXCEL -->
  <!-- ========================================================== -->
  <div class="card" style="text-align:center;">
    <h2 style="color:#00416A;">Descargar Reporte Completo</h2>
    <p>Puedes exportar todos los registros de la tabla <b>ingresos_pdd</b> a Excel para an√°lisis o respaldo.</p>
    <button id="btnDescargar">‚¨áÔ∏è Descargar Excel</button>
  </div>

<!-- ========================================================== -->
<!-- üß© SECCI√ìN 4: GRAFICAS COMPARATIVAS POR SUCURSAL -->
<!-- ========================================================== -->
<div class="card">
  <h2 style="color:#00416A;text-align:center;">Comparativo por Sucursal (2023-2025)</h2>
  <p style="text-align:center;color:#555;">Evoluci√≥n mensual por sucursal ‚Äì comparaci√≥n de a√±os</p>
  <div id="contenedorGraficasSucursales"
       style="display:flex;flex-wrap:wrap;gap:20px;justify-content:center;"></div>
</div>

 <!-- ========================================================== -->
<!-- üßæ SECCI√ìN 5: √öLTIMAS FACTURAS POR SUCURSAL -->
<!-- ========================================================== -->
<div class="card">
  <h2 style="color:#00416A;text-align:center;">√öltimas Facturas por Sucursal</h2>
  <p style="text-align:center;color:#555;">Consulta las 3 facturas m√°s recientes por sucursal</p>
  <div id="contenedorUltimasFacturas"
       style="display:flex;flex-wrap:wrap;gap:20px;justify-content:center;"></div>
</div>

<!-- ========================================================== -->
<!-- üèÜ SECCI√ìN 6: TOP 10 CLIENTES 2025 -->
<!-- ========================================================== -->
<div class="card">
  <h2 style="color:#00416A;text-align:center;">üèÜ Top 10 Clientes ‚Äì A√±o 2025</h2>
  <p style="text-align:center;color:#555;">Clientes con mayores ingresos (subtotal acumulado)</p>
  <div id="contenedorTopClientes" style="max-width:900px;margin:auto;"></div>
</div>
  
<!-- ========================================================== -->
<!-- üì¶ SECCI√ìN 7: TOP 15 ART√çCULOS M√ÅS FACTURADOS (2025) -->
<!-- ========================================================== -->
<div class="card">
  <h2 style="color:#00416A;text-align:center;">üì¶ Top 15 Art√≠culos M√°s Facturados ‚Äì A√±o 2025</h2>
  <p style="text-align:center;color:#555;">Basado en subtotales acumulados del campo <b>conceptos</b></p>
  <div id="contenedorTopArticulos" style="max-width:900px;margin:auto;"></div>
</div>
  
  <script>
// ======================================================
// üîß 1. FUNCI√ìN: Conexi√≥n a Supabase
// ======================================================
function conectarSupabase() {
  return window.supabase.createClient(
    "https://cvpbtjlupswbyxenugpz.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
  );
}

// ======================================================
// üß© 4. FUNCI√ìN: Generar gr√°ficas comparativas por sucursal (2023‚Äì2025)
// ======================================================
async function generarGraficasSucursalesComparativo(supabase) {
  const contenedor = document.getElementById("contenedorGraficasSucursales");
  contenedor.innerHTML = "<p style='text-align:center;'>Cargando datos...</p>";

  const { data, error } = await supabase
    .from("vista_ingresos_sucursal_anual")
    .select("serie, periodo_anio, periodo_mes, total_subtotal");

  if (error) {
    console.error("‚ùå Error al cargar datos comparativos:", error);
    contenedor.innerHTML = "<p>Error al cargar datos.</p>";
    return;
  }

  if (!data || data.length === 0) {
    contenedor.innerHTML = "<p>No hay datos disponibles.</p>";
    return;
  }

  contenedor.innerHTML = ""; // limpiar el ‚ÄúCargando‚Ä¶‚Äù

  const sucursales = [...new Set(data.map(d => d.serie))];
  const mesesOrden = ["01","02","03","04","05","06","07","08","09","10","11","12"];
  const etiquetas = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
  const colores = [
    "rgba(0, 65, 106, 0.8)",
    "rgba(0, 160, 190, 0.8)",
    "rgba(100, 190, 255, 0.8)"
  ];

  sucursales.forEach(serie => {
    // Crear el contenedor individual
    const div = document.createElement("div");
    div.style.flex = "1 1 420px";
    div.style.minWidth = "380px";
    div.style.background = "white";
    div.style.borderRadius = "12px";
    div.style.padding = "16px";
    div.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
    div.style.textAlign = "center";

    const titulo = document.createElement("h3");
    titulo.textContent = `Sucursal ${serie}`;
    titulo.style.color = "#00416A";
    titulo.style.marginBottom = "10px";
    div.appendChild(titulo);

    const canvas = document.createElement("canvas");
    div.appendChild(canvas);
    contenedor.appendChild(div);

    // Filtrar los datos de esa sucursal
    const datosSucursal = data.filter(d => d.serie === serie);
    const anios = [...new Set(datosSucursal.map(d => d.periodo_anio))].sort();

// Crear datasets comparativos con colores fijos por a√±o
const coloresPorAnio = {
  2023: "#E91E63", // rosa
  2024: "#FFC107", // amarillo
  2025: "#28A745"  // verde
};

const datasets = anios.map(anio => ({
  label: anio,
  data: mesesOrden.map(mes => {
    const fila = datosSucursal.find(f => f.periodo_anio === anio && f.periodo_mes === mes);
    return fila ? Number(fila.total_subtotal) : 0;
  }),
  backgroundColor: coloresPorAnio[anio] || "#999", // color por a√±o o gris por defecto
  borderColor: coloresPorAnio[anio] || "#999",
  borderWidth: 1
}));


    new Chart(canvas, {
      type: "bar",
      data: { labels: etiquetas, datasets },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: `Comparativo ${serie} ‚Äì Ingresos por mes`,
            color: "#00416A"
          },
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: ctx => {
                const val = ctx.raw || 0;
                return `${ctx.dataset.label}: $${val.toLocaleString("es-MX", {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2
                })}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: "Monto ($)" },
            ticks: { callback: v => "$" + v.toLocaleString("es-MX") }
          }
        }
      }
    });
  });
}

    
// ======================================================
// üì• 4. FUNCI√ìN: Exportar tabla completa a Excel
// ======================================================
async function exportarExcel(supabase) {
  const tabla = "ingresos_pdd";
  const limite = 1000;
  let desde = 0;
  let registrosTotales = [];
  let seguir = true;

  const barra = document.createElement("div");
  barra.style.position = "fixed";
  barra.style.bottom = "20px";
  barra.style.left = "50%";
  barra.style.transform = "translateX(-50%)";
  barra.style.width = "60%";
  barra.style.height = "24px";
  barra.style.border = "2px solid #00416A";
  barra.style.borderRadius = "10px";
  barra.style.background = "#eee";
  barra.style.overflow = "hidden";
  barra.style.zIndex = "9999";

  const progreso = document.createElement("div");
  progreso.style.height = "100%";
  progreso.style.width = "0%";
  progreso.style.background = "linear-gradient(to right,#00416A,#0078b9)";
  progreso.style.transition = "width 0.3s ease";
  barra.appendChild(progreso);

  const texto = document.createElement("div");
  texto.style.position = "absolute";
  texto.style.width = "100%";
  texto.style.top = "0";
  texto.style.textAlign = "center";
  texto.style.color = "#00416A";
  texto.style.fontWeight = "600";
  texto.style.lineHeight = "24px";
  texto.textContent = "Descargando datos...";
  barra.appendChild(texto);

  document.body.appendChild(barra);

  while (seguir) {
    const { data, error } = await supabase
      .from(tabla)
      .select("*")
      .range(desde, desde + limite - 1);

    if (error) {
      console.error(error);
      alert("Error al descargar datos: " + error.message);
      document.body.removeChild(barra);
      return;
    }

    if (!data || data.length === 0) break;

    registrosTotales = registrosTotales.concat(data);
    desde += limite;

    const porcentaje = Math.min((desde / 12000) * 100, 100);
    progreso.style.width = `${porcentaje.toFixed(1)}%`;
    texto.textContent = `Descargando... ${registrosTotales.length.toLocaleString()} registros`;

    if (data.length < limite) seguir = false;
  }

  progreso.style.width = "100%";
  texto.textContent = `Procesando archivo... (${registrosTotales.length.toLocaleString()} registros)`;

  const ws = XLSX.utils.json_to_sheet(registrosTotales);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Ingresos_PDD");
  XLSX.writeFile(wb, `ingresos_pdd_${new Date().toISOString().split("T")[0]}.xlsx`);

  texto.textContent = "‚úÖ Exportaci√≥n completa";
  setTimeout(() => document.body.removeChild(barra), 3000);
}


// ======================================================
// üßæ 5. FUNCI√ìN: Mostrar las 3 facturas m√°s recientes por sucursal (adaptada a ingresos_pdd)
// ======================================================
async function mostrarUltimasFacturasPorSucursal(supabase) {
  const contenedor = document.getElementById("contenedorUltimasFacturas");
  contenedor.innerHTML = "<p style='text-align:center;'>Cargando √∫ltimas facturas...</p>";

  // üì° Consulta las columnas necesarias
  const { data, error } = await supabase
    .from("ingresos_pdd")
    .select("fecha, razon_social_receptor, serie, subtotal")
    .order("fecha", { ascending: false });

  if (error) {
    console.error("‚ùå Error al cargar facturas:", error);
    contenedor.innerHTML = "<p>Error al cargar datos.</p>";
    return;
  }

  if (!data || data.length === 0) {
    contenedor.innerHTML = "<p>No hay facturas disponibles.</p>";
    return;
  }

  contenedor.innerHTML = "";

  // üîπ Agrupar por serie (sucursal)
  const agrupado = {};
  data.forEach(factura => {
    const clave = factura.serie || "Sin serie";
    if (!agrupado[clave]) agrupado[clave] = [];
    if (agrupado[clave].length < 3) agrupado[clave].push(factura);
  });

  // üîπ Definir colores por sucursal (opcional PROVSOFT style)
  const coloresSucursal = {
    "LMN": "#0c6cbd",
    "MM": "#28A745",
    "LP": "#FFC107",
    "LO": "#DC3545",
    "AM": "#6F42C1",
    "SAN": "#17A2B8"
  };

  // üîπ Crear tarjetas por sucursal
  Object.keys(agrupado).forEach(serie => {
    const facturas = agrupado[serie];
    const colorCabecera = coloresSucursal[serie] || "#00416A";

    const div = document.createElement("div");
    div.style.flex = "1 1 380px";
    div.style.background = "white";
    div.style.borderRadius = "12px";
    div.style.padding = "16px";
    div.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
    div.style.textAlign = "center";

    const titulo = document.createElement("h3");
    titulo.textContent = `Sucursal ${serie}`;
    titulo.style.color = colorCabecera;
    titulo.style.marginBottom = "10px";
    div.appendChild(titulo);

    const tabla = document.createElement("table");
    tabla.style.width = "100%";
    tabla.style.borderCollapse = "collapse";
    tabla.innerHTML = `
      <thead>
        <tr style="background:${colorCabecera};color:white;">
          <th>Fecha</th><th>Nombre</th><th>Serie</th><th>Monto</th>
        </tr>
      </thead>
      <tbody>
        ${facturas.map(f => `
          <tr>
            <td>${new Date(f.fecha).toLocaleDateString("es-MX")}</td>
            <td>${f.razon_social_receptor || "‚Äî"}</td>
            <td>${f.serie || "‚Äî"}</td>
            <td>$${Number(f.subtotal || 0).toLocaleString("es-MX", { minimumFractionDigits: 2 })}</td>
          </tr>
        `).join("")}
      </tbody>
    `;

    // Estilo de tabla
    tabla.querySelectorAll("td").forEach(td => {
      td.style.padding = "6px";
      td.style.borderBottom = "1px solid #ddd";
      td.style.fontSize = "13px";
    });
    tabla.querySelectorAll("th").forEach(th => th.style.padding = "6px");
    div.appendChild(tabla);
    contenedor.appendChild(div);
  });
}

// ======================================================
// üèÜ 6. FUNCI√ìN: TOP 10 DE CLIENTES POR A√ëO (2025)
// ======================================================
async function mostrarTopClientes2025(supabase) {
  const contenedor = document.getElementById("contenedorTopClientes");
  contenedor.innerHTML = "<p style='text-align:center;'>Cargando datos...</p>";

  // üì° Consulta registros del a√±o 2025
  const { data, error } = await supabase
    .from("ingresos_pdd")
    .select("razon_social_receptor, subtotal, periodo_anio")
    .eq("periodo_anio", 2025);

  if (error) {
    console.error("‚ùå Error al cargar datos:", error);
    contenedor.innerHTML = "<p>Error al cargar datos.</p>";
    return;
  }

  if (!data || data.length === 0) {
    contenedor.innerHTML = "<p>No hay datos disponibles para 2025.</p>";
    return;
  }

  // üßÆ Agrupar por cliente y sumar subtotales
  const acumulado = {};
  data.forEach(row => {
    const cliente = row.razon_social_receptor?.trim() || "Sin nombre";
    const monto = Number(row.subtotal) || 0;
    acumulado[cliente] = (acumulado[cliente] || 0) + monto;
  });

  // üèÜ Ordenar y tomar Top 10
  const top10 = Object.entries(acumulado)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);

  const maxValor = top10[0] ? top10[0][1] : 1;

  // üé® Construir tabla con barras de progreso
  contenedor.innerHTML = `
    <table style="width:100%;border-collapse:collapse;">
      <thead>
        <tr style="background:#00416A;color:white;">
          <th style="padding:8px;text-align:left;">#</th>
          <th style="padding:8px;text-align:left;">Cliente</th>
          <th style="padding:8px;text-align:right;">Monto</th>
        </tr>
      </thead>
      <tbody>
        ${top10.map(([cliente, monto], i) => `
          <tr>
            <td style="padding:8px;text-align:center;font-weight:600;">${i + 1}</td>
            <td style="padding:8px;">${cliente}</td>
            <td style="padding:8px;text-align:right;">$${monto.toLocaleString("es-MX", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            })}</td>
          </tr>
          <tr>
            <td colspan="3" style="padding:4px 8px;">
              <div style="background:#e5e5e5;border-radius:6px;height:10px;overflow:hidden;">
                <div style="height:10px;width:${(monto / maxValor) * 100}%;
                            background:linear-gradient(to right,#00416A,#00A0BE);"></div>
              </div>
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}

// ======================================================
// üì¶ 7. FUNCI√ìN: TOP 15 ART√çCULOS M√ÅS FACTURADOS (A√ëO 2025)
// ======================================================
async function mostrarTopArticulos2025(supabase) {
  const contenedor = document.getElementById("contenedorTopArticulos");
  contenedor.innerHTML = "<p style='text-align:center;'>Cargando art√≠culos...</p>";

  // üì° Consulta los datos del a√±o 2025
const { data, error } = await supabase
  .from("vista_top_articulos")
  .select("*")
  .eq("periodo_anio", 2025);


  if (error) {
    console.error("‚ùå Error al cargar art√≠culos:", error);
    contenedor.innerHTML = "<p>Error al cargar datos.</p>";
    return;
  }

  if (!data || data.length === 0) {
    contenedor.innerHTML = "<p>No hay datos disponibles para 2025.</p>";
    return;
  }

  // üßÆ Agrupar por nombre del art√≠culo (campo conceptos)
  const acumulado = {};
  data.forEach(row => {
const concepto = (row.articulo || "Sin descripci√≥n").trim();
const monto = Number(row.total_subtotal) || 0;
    acumulado[concepto] = (acumulado[concepto] || 0) + monto;
  });

  // üèÜ Ordenar y tomar los 15 m√°s altos
  const top15 = Object.entries(acumulado)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 15);

  const maxValor = top15[0] ? top15[0][1] : 1;

  // üé® Crear tabla con barra de progreso
  contenedor.innerHTML = `
    <table style="width:100%;border-collapse:collapse;">
      <thead>
        <tr style="background:#00416A;color:white;">
          <th style="padding:8px;text-align:left;">#</th>
          <th style="padding:8px;text-align:left;">Art√≠culo</th>
          <th style="padding:8px;text-align:right;">Subtotal</th>
        </tr>
      </thead>
      <tbody>
        ${top15.map(([concepto, monto], i) => `
          <tr>
            <td style="padding:8px;text-align:center;font-weight:600;">${i + 1}</td>
            <td style="padding:8px;">${concepto}</td>
            <td style="padding:8px;text-align:right;">$${monto.toLocaleString("es-MX", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            })}</td>
          </tr>
          <tr>
            <td colspan="3" style="padding:4px 8px;">
              <div style="background:#e5e5e5;border-radius:6px;height:10px;overflow:hidden;">
                <div style="height:10px;width:${(monto / maxValor) * 100}%;
                            background:linear-gradient(to right,#0078b9,#00a6ff);"></div>
              </div>
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}
// ======================================================
// üìà FUNCI√ìN: Gr√°fica hist√≥rica mensual (todos los a√±os)
// ======================================================
async function generarGraficaHistorica(supabase) {
  const ctx = document.getElementById("graficaHistorica").getContext("2d");

  // üì° Leer todos los registros del RFC en la vista
  const { data, error } = await supabase
    .from("vista_ingresos_totales_mensuales")
    .select("periodo_anio, periodo_mes, total_con_impuestos, rfc_emisor")
    .eq("rfc_emisor", "PDD031204KL5")
    .order("periodo_anio", { ascending: true })
    .order("periodo_mes", { ascending: true });

  if (error) {
    console.error("‚ùå Error al cargar datos hist√≥ricos:", error);
    alert("Error al cargar datos hist√≥ricos");
    return;
  }

  if (!data || data.length === 0) {
    console.warn("‚ö†Ô∏è No hay datos para graficar");
    return;
  }

  // üßÆ Crear etiquetas combinadas: "Ene 2023", "Feb 2023", ..., "Dic 2025"
  const etiquetas = [];
  const valores = [];

  const nombresMes = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

  data.forEach(row => {
    const anio = row.periodo_anio;
    const mes = nombresMes[parseInt(row.periodo_mes) - 1] || row.periodo_mes;
    etiquetas.push(`${mes} ${anio}`);
    valores.push(Number(row.total_con_impuestos) || 0);
  });

  // üé® Crear gr√°fica de l√≠nea continua
  new Chart(ctx, {
    type: "line",
    data: {
      labels: etiquetas,
      datasets: [{
        label: "Ingresos totales con impuestos",
        data: valores,
        borderColor: "#00416A",
        backgroundColor: "rgba(0, 160, 190, 0.2)",
        fill: true,
        tension: 0.3,
        borderWidth: 3,
        pointRadius: 3,
        pointHoverRadius: 5
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: "Hist√≥rico de Ingresos Totales Mensuales (multi-a√±o)",
          color: "#00416A",
          font: { size: 16 }
        },
        legend: { position: "bottom" },
        tooltip: {
          callbacks: {
            label: ctx => {
              const val = ctx.raw || 0;
              return "Total: $" + val.toLocaleString("es-MX", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              });
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { color: "#00416A", maxRotation: 45, minRotation: 45 },
          title: { display: true, text: "Mes / A√±o" }
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: "Monto ($)" },
          ticks: { callback: v => "$" + v.toLocaleString("es-MX") }
        }
      }
    }
  });

  console.log("‚úÖ Datos hist√≥ricos graficados:", data.length, "meses");
}

// ======================================================
// üíµ FUNCI√ìN: Mostrar resumen anual antes de impuestos
// ======================================================
async function mostrarResumenIngresosAnuales(supabase) {
  const contenedor = document.getElementById("contenedorResumenIngresos");
  contenedor.innerHTML = "<p style='text-align:center;'>Cargando resumen...</p>";

  const { data, error } = await supabase
    .from("vista_ingresos_totales_anuales")
    .select("periodo_anio, rfc_emisor, total_sin_impuestos")
    .eq("rfc_emisor", "PDD031204KL5");

  if (error) {
    console.error("‚ùå Error al cargar resumen:", error);
    contenedor.innerHTML = "<p>Error al cargar datos.</p>";
    return;
  }

  if (!data || data.length === 0) {
    contenedor.innerHTML = "<p>No hay datos disponibles.</p>";
    return;
  }

  // üßÆ Ordenar por a√±o y tomar los √∫ltimos tres
  const datosOrdenados = data.sort((a, b) => a.periodo_anio - b.periodo_anio);
  const ultimos = datosOrdenados.slice(-3);
  const maxValor = Math.max(...ultimos.map(x => x.total_sin_impuestos));

  // üé® Renderizar tabla con barras comparativas
  contenedor.innerHTML = `
    <table style="width:100%;border-collapse:collapse;margin-bottom:15px;">
      <thead>
        <tr style="background:#00416A;color:white;">
          <th style="padding:10px;">A√±o</th>
          <th style="padding:10px;text-align:right;">Total sin impuestos</th>
        </tr>
      </thead>
      <tbody>
        ${ultimos.map((row, i) => `
          <tr style="background:${row.periodo_anio === 2025 ? '#D1F7D1' : '#f8f8f8'};">
            <td style="padding:8px;font-weight:600;">${row.periodo_anio}</td>
            <td style="padding:8px;text-align:right;font-weight:600;">
              $${Number(row.total_sin_impuestos).toLocaleString("es-MX", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              })}
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>

    <div>
      ${ultimos.map(row => `
        <div style="margin:10px 0;">
          <div style="display:flex;justify-content:space-between;color:#00416A;font-weight:600;">
            <span>${row.periodo_anio}</span>
            <span>$${Number(row.total_sin_impuestos).toLocaleString("es-MX")}</span>
          </div>
          <div style="background:#eee;border-radius:8px;height:10px;overflow:hidden;">
            <div style="height:10px;width:${(row.total_sin_impuestos / maxValor) * 100}%;
                        background:${row.periodo_anio === 2025 ? '#28A745' :
                                   row.periodo_anio === 2024 ? '#FFC107' :
                                   '#E91E63'};
                        border-radius:8px;"></div>
          </div>
        </div>
      `).join("")}
    </div>
  `;
}
// ======================================================
// üí∞ FUNCI√ìN: Graficar ventas por impuesto (multianual)
// ======================================================
async function generarGraficaImpuestos(supabase) {
  const ctx = document.getElementById("graficaImpuestos").getContext("2d");

  const { data, error } = await supabase
    .from("vista_ventas_por_impuesto_multianual")
    .select("*")
    .order("periodo_anio", { ascending: true })
    .order("tipo_impuesto", { ascending: true });

  if (error) {
    console.error("‚ùå Error al cargar datos de impuestos:", error);
    alert("Error al cargar datos fiscales");
    return;
  }

  if (!data || data.length === 0) {
    console.warn("‚ö†Ô∏è No hay datos de impuestos disponibles");
    return;
  }

  // üßÆ Agrupar por tipo de impuesto
  const tipos = ["IVA", "IEPS", "0%"];
  const anios = [...new Set(data.map(d => d.periodo_anio))].sort();

  const colores = {
    "IVA": "#0c6cbd",  // Azul PROVSOFT
    "IEPS": "#FFC107", // Amarillo
    "0%": "#E91E63"    // Rosa
  };

  const datasets = tipos.map(tipo => ({
    label: tipo,
    backgroundColor: colores[tipo],
    data: anios.map(anio => {
      const fila = data.find(f => f.periodo_anio === anio && f.tipo_impuesto === tipo);
      return fila ? Number(fila.total_impuesto) : 0;
    }),
    borderWidth: 1
  }));

  // üìä Renderizar la gr√°fica de barras agrupadas
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: anios,
      datasets
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: "Monto ($)" },
          ticks: { callback: v => "$" + v.toLocaleString("es-MX") }
        },
        x: {
          title: { display: true, text: "A√±o" }
        }
      },
      plugins: {
        title: {
          display: true,
          text: "Comparativo Multianual de Ventas por Impuesto",
          color: "#00416A",
          font: { size: 16 }
        },
        legend: {
          position: "bottom",
          labels: { color: "#00416A", font: { size: 13 } }
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const val = ctx.raw || 0;
              return `${ctx.dataset.label}: $${val.toLocaleString("es-MX", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              })}`;
            }
          }
        }
      }
    }
  });
}
    
// ======================================================
// üöÄ 5. FUNCI√ìN PRINCIPAL
// ======================================================
async function main() {
  const supabase = conectarSupabase();
  
  // üîπ Cargar las tres gr√°ficas principales
   await mostrarUltimasFacturasPorSucursal(supabase);
  await generarGraficasSucursalesComparativo(supabase); // üß© <-- ESTA FALTABA
  await mostrarTopClientes2025(supabase); // üèÜ Nuevo Top 10
  await mostrarTopArticulos2025(supabase);
await generarGraficaHistorica(supabase);
  await mostrarResumenIngresosAnuales(supabase);
  await generarGraficaImpuestos(supabase);


  
  // üîπ Bot√≥n de descarga
  document.getElementById("btnDescargar").addEventListener("click", () => exportarExcel(supabase));
}

main();
</script>

</body>
</html>
