<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Checklist PROVSOFT</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    :root {
      --primary:#2c3e50; 
      --secondary:#3498db; 
      --bg:#f4f4f4;
      --card:#ffffff; 
      --border:#e0e0e0;
      --text:#333;
      --accent:#16a34a;
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { 
      font-family: "Segoe UI", Arial, sans-serif; 
      background:var(--bg); 
      color:var(--text);
      padding:20px; 
      min-height:100vh; 
      display:flex; 
      flex-direction:column; 
    }
    h2 { 
      text-align:center; 
      color:var(--primary); 
      margin-bottom:20px; 
    }
    .controls { 
      text-align:center; 
      margin-bottom:20px; 
    }
    input[type="text"] { 
      padding:8px; 
      width:240px; 
      border:1px solid var(--border); 
      border-radius:6px;
      margin-right:8px;
    }
    button { 
      background:var(--secondary); 
      color:#fff; 
      border:none; 
      padding:6px 12px; 
      border-radius:6px;
      cursor:pointer; 
      transition:.2s;
      margin:4px;
      font-size:0.85rem;
    }
    button:hover { background:#2980b9; }
    table { 
      border-collapse: collapse; 
      margin:0 auto; 
      background:var(--card); 
      box-shadow:0 2px 6px rgba(0,0,0,.08); 
      border-radius:8px; 
      overflow:hidden;
    }
    th, td { 
      border:1px solid var(--border); 
      padding:8px 12px; 
      text-align:center; 
    }
    th { background:var(--primary); color:#fff; }
    td input[type="checkbox"] { transform:scale(1.2); cursor:pointer; }
    td input.editing { width:95%; padding:4px; }
    footer { 
      margin-top:auto; 
      text-align:center; 
      padding:12px; 
      font-size:0.9rem; 
      color:#666; 
    }
    footer span { 
      font-weight:bold; 
      color:var(--secondary);
    }
  </style>
</head>
<body>
  <h2>‚úÖ Checklist</h2>

  <div class="controls">
    <input type="text" id="nuevaTarea" placeholder="Nueva tarea...">
    <button onclick="agregarFila()">‚ûï Agregar fila</button>
    <button onclick="agregarColumna()">‚ûï Agregar columna</button>
  </div>

  <table id="tabla"></table>

  <footer>
    Powered by <span>PROVSOFT</span> üöÄ
  </footer>

  <script>
    // üîë Credenciales Supabase
    const SUPABASE_URL = "https://cvpbtjlupswbyxenugpz.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let columnas = 3; // valor inicial

    async function cargar() {
      const { data, error } = await supabase.from("checklist_json").select("*").order("id");
      if (error) { console.error("Error cargando:", error); return; }

      if (data && data.length > 0) {
        const maxCols = Math.max(...data.map(f => (f.checks ? f.checks.length : 0)));
        columnas = maxCols > 0 ? maxCols : columnas;
      }
      renderTabla(data);
    }

    function renderTabla(filas) {
      const tabla = document.getElementById("tabla");
      tabla.innerHTML = "";

      // encabezado
      let header = "<tr><th>Tarea</th>";
      for (let c=0; c<columnas; c++) header += `<th>C${c+1}</th>`;
      header += "<th>Acciones</th></tr>";
      tabla.innerHTML += header;

      // filas
      filas.forEach(f => {
        let checks = f.checks || [];
        if (checks.length < columnas) {
          checks = [...checks, ...Array(columnas - checks.length).fill(false)];
        }

        let row = `<tr id="fila-${f.id}">
          <td id="tarea-${f.id}">${f.tarea}</td>`;

        for (let c=0; c<columnas; c++) {
          const val = checks[c] ? "checked" : "";
          row += `<td><input type="checkbox" onchange="guardarCheck(${f.id}, ${c}, this.checked)" ${val}></td>`;
        }

        row += `<td>
                  <button onclick="editarFila(${f.id}, '${f.tarea.replace(/'/g,"\\'")}')">‚úèÔ∏è Editar</button>
                </td>
        </tr>`;
        tabla.innerHTML += row;
      });
    }

    async function guardarCheck(id, col, valor) {
      const { data, error } = await supabase.from("checklist_json").select("checks").eq("id", id).single();
      if (error) { console.error("Error leyendo checks:", error); return; }
      let checks = data.checks || [];
      checks[col] = valor;
      const { error: upErr } = await supabase.from("checklist_json").update({ checks }).eq("id", id);
      if (upErr) console.error("Error guardando check:", upErr);
    }

    // Funci√≥n para editar nombre de la tarea
    window.editarFila = function(id, tareaActual) {
      const celda = document.getElementById(`tarea-${id}`);
      celda.innerHTML = `<input type="text" id="edit-${id}" class="editing" value="${tareaActual}"> 
                         <button onclick="guardarEdicion(${id})">üíæ Guardar</button>`;
    };

    // Guardar edici√≥n
    window.guardarEdicion = async function(id) {
      const nuevoTexto = document.getElementById(`edit-${id}`).value.trim();
      if (!nuevoTexto) return alert("El nombre no puede estar vac√≠o");

      const { error } = await supabase.from("checklist_json").update({ tarea: nuevoTexto }).eq("id", id);
      if (error) { console.error("Error actualizando tarea:", error); return; }

      cargar(); // refrescar tabla
    };

    // ‚¨áÔ∏è Funciones globales
    window.agregarFila = async function() {
      const tarea = document.getElementById("nuevaTarea").value.trim();
      if (!tarea) return alert("Escribe una tarea");
      const { error } = await supabase.from("checklist_json").insert([{ tarea, checks: Array(columnas).fill(false) }]);
      if (error) { console.error("Error insertando fila:", error); return; }
      document.getElementById("nuevaTarea").value = "";
      cargar();
    };

    window.agregarColumna = async function() {
      columnas++;
      const { data, error } = await supabase.from("checklist_json").select("id, checks");
      if (error) { console.error(error); return; }

      for (let fila of data) {
        let checks = fila.checks || [];
        checks.push(false);
        await supabase.from("checklist_json").update({ checks }).eq("id", fila.id);
      }
      cargar();
    };

    cargar();
  </script>
</body>
</html>
