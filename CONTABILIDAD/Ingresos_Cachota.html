<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carga de XML ‚Äì Ingresos CAC180615354</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f9f9f9; color:#111; }
    h2 { color: #00416A; }
    ul { padding: 0; list-style: none; }
    li { margin-bottom: 6px; font-size: 14px; }
    .ok { color: green; }
    .warn { color: orange; }
    .err { color: red; }
    .pending { color: blue; }
    pre { background:#eee; padding:10px; max-height:240px; overflow:auto; font-size:13px; }
    .progress-bar { width:100%; background:#ddd; border-radius:4px; overflow:hidden; height:16px; margin-top:6px; }
    .progress-bar div { height:100%; width:0%; background:#0c6cbd; transition:width 0.3s ease; }
  </style>
</head>
<body>
  <h2>Subir CFDI v√°lidos (solo tipo I, emisor CAC180615354, sin n√≥mina/egreso/carta porte/pago)</h2>
  <input type="file" id="xmlInput" accept=".xml" multiple>
  <button onclick="procesarArchivos()">Procesar y Subir</button>

  <div class="progress-bar"><div id="progreso"></div></div>
  <h3>Archivos</h3>
  <ul id="archivoList"></ul>
  <h3>Bit√°cora</h3>
  <pre id="bitacora"></pre>

  <script>
    const SUPABASE_URL = "https://cvpbtjlupswbyxenugpz.supabase.co";
    const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY";
    let archivosDatos = [];

    document.getElementById("xmlInput").addEventListener("change", async function () {
      const lista = document.getElementById("archivoList");
      lista.innerHTML = "";
      archivosDatos = [];

      for (const file of this.files) {
        try {
          const text = await file.text();
          const parser = new DOMParser();
          const xml = parser.parseFromString(text, "application/xml");

          const cfdiNS = "http://www.sat.gob.mx/cfd/4";
          const comprobante = xml.getElementsByTagNameNS(cfdiNS, "Comprobante")[0];
          const emisor = xml.getElementsByTagNameNS(cfdiNS, "Emisor")[0];
          const receptor = xml.getElementsByTagNameNS(cfdiNS, "Receptor")[0];

          // Buscar timbre fiscal digital
          let timbre = null;
          for (const node of xml.getElementsByTagName("*")) {
            if (node.localName === "TimbreFiscalDigital") {
              timbre = node;
              break;
            }
          }

          const uuid = timbre?.getAttribute("UUID")?.toUpperCase().trim() || "";
          const tipo = comprobante?.getAttribute("TipoDeComprobante")?.trim() || "";
          const emisorRFC = emisor?.getAttribute("Rfc")?.toUpperCase().trim() || "";

          // Excluir CFDI con complementos no deseados
          const xmlTxt = text.toUpperCase();
          const tieneExcluido = (
            xmlTxt.includes("NOMINA12") ||
            xmlTxt.includes("CARTAPORTE") ||
            xmlTxt.includes("PAGOS20") ||
            tipo === "E" // egresos
          );

          // Filtro principal: solo tipo I y emisor CAC180615354
          if (tipo !== "I" || emisorRFC !== "CAC180615354" || tieneExcluido || !uuid) {
            const motivo =
              !uuid ? "sin UUID" :
              tipo !== "I" ? `tipo ${tipo}` :
              emisorRFC !== "CAC180615354" ? `emisor ${emisorRFC}` :
              tieneExcluido ? `complemento o tipo excluido` :
              "motivo desconocido";
            const li = document.createElement("li");
            li.dataset.uuid = uuid;
            li.innerHTML = `‚ùå <b>${file.name}</b> <span class="err">‚Üí Rechazado (${motivo})</span>`;
            lista.appendChild(li);
            continue;
          }

          // Datos CFDI v√°lidos
          const receptorRFC = receptor?.getAttribute("Rfc")?.toUpperCase().trim() || "";
          const receptorNombre = receptor?.getAttribute("Nombre") || "";
          const razonSocial = emisor?.getAttribute("Nombre") || "";
          const folio = comprobante?.getAttribute("Folio") || "";
          const serie = comprobante?.getAttribute("Serie") || "";
          const total = parseFloat(comprobante?.getAttribute("Total")) || 0;
          const subtotal = parseFloat(comprobante?.getAttribute("SubTotal")) || 0;
          const descuento = parseFloat(comprobante?.getAttribute("Descuento")) || 0;
          const moneda = comprobante?.getAttribute("Moneda") || "";
          const formaPago = comprobante?.getAttribute("FormaPago") || "";
          const metodoPago = comprobante?.getAttribute("MetodoPago") || "";
          const usoCFDI = receptor?.getAttribute("UsoCFDI") || "";
          const fecha = comprobante?.getAttribute("Fecha") || "";
          const fechaTimbrado = timbre?.getAttribute("FechaTimbrado") || "";
          const selloSAT = timbre?.getAttribute("SelloSAT") || "";
          const noCertificadoSAT = timbre?.getAttribute("NoCertificadoSAT") || "";

          // Conceptos
          const conceptosDetalle = [];
          const conceptos = xml.getElementsByTagNameNS(cfdiNS, "Concepto");
          for (let c of conceptos) {
            const cantidad = parseFloat(c.getAttribute("Cantidad")) || 0;
            const descripcion = c.getAttribute("Descripcion") || "";
            const codigoSAT = c.getAttribute("ClaveProdServ") || "";
            const claveUnidad = c.getAttribute("ClaveUnidad") || "";
            const valorUnitario = parseFloat(c.getAttribute("ValorUnitario")) || 0;
            const importe = parseFloat(c.getAttribute("Importe")) || 0;
            const descuentoConcepto = parseFloat(c.getAttribute("Descuento")) || 0;

            const impuestos = [];
            const traslados = c.getElementsByTagNameNS(cfdiNS, "Traslado");
            for (let t of traslados) {
              impuestos.push({
                impuesto: t.getAttribute("Impuesto"),
                tipoFactor: t.getAttribute("TipoFactor"),
                tasaOCuota: parseFloat(t.getAttribute("TasaOCuota")) || 0,
                importe: parseFloat(t.getAttribute("Importe")) || 0,
              });
            }

            conceptosDetalle.push({
              cantidad,
              descripcion,
              codigoSAT,
              claveUnidad,
              valorUnitario,
              importe,
              descuentoConcepto,
              impuestos,
            });
          }

          archivosDatos.push({
            uuid,
            tipo,
            receptorRFC,
            receptorNombre,
            emisorRFC,
            razonSocial,
            folio,
            serie,
            total,
            subtotal,
            descuento,
            moneda,
            formaPago,
            metodoPago,
            usoCFDI,
            fecha,
            fecha_certificacion: fechaTimbrado,
            selloSAT,
            noCertificadoSAT,
            conceptosDetalle,
          });

          const li = document.createElement("li");
          li.dataset.uuid = uuid;
          li.innerHTML = `üìÑ <b>${uuid}</b> <span class="pending">‚Üí Precargado</span>`;
          lista.appendChild(li);

        } catch (err) {
          const li = document.createElement("li");
          li.innerHTML = `‚ùå <b>${file.name}</b> <span class="err">‚Üí Error al leer (${err.message})</span>`;
          lista.appendChild(li);
        }
      }
    });

    async function procesarArchivos() {
      const progreso = document.getElementById("progreso");
      const totalArchivos = archivosDatos.length;
      const loteTama√±o = 10;
      const pausaEntreLotes = 2000;

      for (let inicio = 0; inicio < archivosDatos.length; inicio += loteTama√±o) {
        const lote = archivosDatos.slice(inicio, inicio + loteTama√±o);

        for (let i = 0; i < lote.length; i++) {
          const index = inicio + i;
          const data = lote[i];
          const item = document.querySelector(`#archivoList li[data-uuid="${data.uuid}"]`);
          if (!item) {
            logBitacora(`‚ö†Ô∏è No se encontr√≥ elemento visual para UUID: ${data.uuid}`);
            continue;
          }

          const avance = ((index + 1) / totalArchivos) * 100;
          progreso.style.width = `${avance}%`;
          logBitacora(`üìÑ Revisando UUID: ${data.uuid}`);

          const existe = await fetch(`${SUPABASE_URL}/rest/v1/ingresos_cac?uuid_cfdi=eq.${data.uuid}`, {
            headers: { apikey: API_KEY, Authorization: `Bearer ${API_KEY}` },
          });
          const yaExiste = await existe.json();
          if (yaExiste.length > 0) {
            item.querySelector("span").textContent = `‚ö†Ô∏è Ya existe`;
            item.querySelector("span").className = "warn";
            logBitacora(`‚ö†Ô∏è Ya exist√≠a: ${data.uuid}`);
            continue;
          }

          const datosInsert = {
            uuid_cfdi: data.uuid,
            fecha: data.fecha,
            rfc_emisor: data.emisorRFC,
            razon_social_emisor: data.razonSocial,
            rfc_receptor: data.receptorRFC,
            razon_social_receptor: data.receptorNombre,
            factura: data.folio,
            serie: data.serie,
            subtotal: data.subtotal,
            descuento: data.descuento,
            total: data.total,
            moneda: data.moneda,
            forma_pago: data.formaPago,
            metodo_pago: data.metodoPago,
            uso_cfdi: data.usoCFDI,
            sello_sat: data.selloSAT,
            no_certificado_sat: data.noCertificadoSAT,
            fecha_certificacion: data.fecha_certificacion,
            conceptos_detalle: data.conceptosDetalle,
          };

          try {
            const insert = await fetch(`${SUPABASE_URL}/rest/v1/ingresos_cac`, {
              method: "POST",
              headers: {
                apikey: API_KEY,
                Authorization: `Bearer ${API_KEY}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(datosInsert),
            });

            if (insert.ok) {
              item.querySelector("span").textContent = `‚úÖ Subido`;
              item.querySelector("span").className = "ok";
              logBitacora(`‚úîÔ∏è Subida exitosa`);
            } else {
              const err = await insert.text();
              item.querySelector("span").textContent = `‚ùå Error: ${err}`;
              item.querySelector("span").className = "err";
              logBitacora(`‚ùå Error al subir: ${err}`);
            }
          } catch (error) {
            item.querySelector("span").textContent = `‚ùå Error de red`;
            item.querySelector("span").className = "err";
            logBitacora(`‚ùå Error de red: ${error.message}`);
          }

          await new Promise(r => setTimeout(r, 300));
        }

        if (inicio + loteTama√±o < totalArchivos) {
          logBitacora(`üïí Esperando ${pausaEntreLotes / 1000} segundos antes del siguiente lote...`);
          await new Promise(r => setTimeout(r, pausaEntreLotes));
        }
      }

      progreso.style.width = `100%`;
      logBitacora("‚úÖ Proceso completo");
    }

    function logBitacora(mensaje) {
      const log = document.getElementById("bitacora");
      log.textContent += mensaje + "\n";
      log.scrollTop = log.scrollHeight;
    }
  </script>

  <footer style="margin-top:40px;padding:10px;text-align:center;font-size:13px;color:#555;border-top:1px solid #ccc;">
    ¬©Ô∏è 2025 Ingresos CAC180615354 ¬∑ Desarrollado por Gerardo Quezada ¬∑ versi√≥n con exclusi√≥n de n√≥mina, egreso, carta porte y pagos
  </footer>
</body>
</html>
