<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro de Pagos</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  body { font-family: sans-serif; margin: 20px; }
  label { display: block; margin-top: 10px; font-weight: bold; }
  input, textarea, select { width: 100%; padding: 8px; margin-top: 5px; }
  button { margin-top: 15px; padding: 10px 15px; }
  .pago-card {
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 12px 16px;
    margin: 10px 0;
    background: #f9f9f9;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    font-family: "Segoe UI", sans-serif;
  }
  .pago-card h4 { margin: 0 0 8px 0; color: #333; }
  .pago-detalle {
    display: grid;
    grid-template-columns: 140px 1fr;
    row-gap: 4px;
  }
  .pago-card img {
    margin-top: 10px;
    max-width: 300px;
    border-radius: 6px;
  }
  .monto-negativo { color: red; font-weight: bold; }
  .monto-positivo { color: black; }
</style>
</head>
<body>

<h2>Registrar pago</h2>

<label>Pega aqu√≠ la l√≠nea de Excel o una captura:</label>
<textarea id="linea" rows="3" placeholder="Ctrl+C en Excel o Win+Mayus+S para imagen y luego Ctrl+V aqu√≠"></textarea>

<h3>Datos detectados</h3>
<div id="jsonPreview"></div>

<label>Imagen del comprobante:</label>
<div id="previewImagen"></div>

<label>Proveedor:</label>
<select id="proveedor"></select>

<button onclick="guardarPago()">Guardar en BD</button>

<hr>
<h2>Buscar pago</h2>
<input type="text" id="buscar" placeholder="Buscar por UUID, RFC o proveedor">
<button onclick="buscarPago()">Buscar</button>
<div id="resultado"></div>

<script>
const SUPABASE_URL = "https://cvpbtjlupswbyxenugpz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY";
const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let datosPago = [];
let imagenFile = null;

function parseLineaPago(linea) {
  const partes = linea.trim().split(/\s+/).map(p => p.trim());
  const resultado = { fecha:null, uuid:null, rfc:null, proveedor:"", referencia:null, monto:null };

  partes.forEach((valor, i) => {
    if (!resultado.fecha && /^\d{4}-\d{2}-\d{2}/.test(valor)) { resultado.fecha = valor; return; }
    if (!resultado.uuid && /^[0-9A-Fa-f\-]{30,40}$/.test(valor)) { resultado.uuid = valor; return; }
    if (!resultado.rfc && /^[A-Z√ë&]{3,4}\d{6}[A-Z0-9]{3}$/.test(valor)) { resultado.rfc = valor; return; }
    if (!resultado.monto && /^-?(\d{1,3}(,\d{3})*|\d+)(\.\d{2})?$/.test(valor.replace(/,/g,''))) { 
      resultado.monto = valor.replace(/,/g,''); 
      return; 
    }
  });

  // La referencia suele venir justo antes del monto
  const idxMonto = partes.findIndex(v => v.replace(/,/g,'').match(/^-?\d+(\.\d{2})?$/));
  if (idxMonto > 0) {
    resultado.referencia = partes[idxMonto - 1];
    // El proveedor son las palabras entre RFC y referencia
    const idxRFC = partes.findIndex(v => v.match(/^[A-Z√ë&]{3,4}\d{6}[A-Z0-9]{3}$/));
    if (idxRFC > -1 && idxRFC < idxMonto-1) {
      resultado.proveedor = partes.slice(idxRFC+1, idxMonto-1).join(" ");
    }
  }

  return resultado;
}
// Render bonito
function renderPreviewPagos(lista) {
  if (!Array.isArray(lista)) return;
  let html = "";
  lista.forEach(p => {
    const montoNum = parseFloat(p.monto || "0");
    const montoClass = montoNum < 0 ? "monto-negativo" : "monto-positivo";
    html += `
      <div class="pago-card">
        <h4>${p.proveedor || "Proveedor"}</h4>
        <div class="pago-detalle">
          <div><b>Fecha:</b></div><div>${p.fecha || "-"}</div>
          <div><b>UUID:</b></div><div>${p.uuid || "-"}</div>
          <div><b>RFC:</b></div><div>${p.rfc || "-"}</div>
          <div><b>Referencia:</b></div><div>${p.referencia || "-"}</div>
          <div><b>Monto:</b></div><div class="${montoClass}">$ ${p.monto || "0.00"}</div>
        </div>
      </div>`;
  });
  document.getElementById("jsonPreview").innerHTML = html;
}

// Cargar proveedores
async function cargarProveedores() {
  const { data, error } = await client.from("proveedores").select("*").order("nombre");
  if (error) return console.error(error);
  const sel = document.getElementById("proveedor");
  sel.innerHTML = "<option value=''>--Seleccionar--</option>" + 
    data.map(p => `<option value="${p.id}" data-rfc="${p.rfc}">${p.rfc} - ${p.nombre}</option>`).join("");
}

// Subir imagen
async function subirImagen(file) {
  const fileName = `pagos/${Date.now()}_${file.name}`;
  const { error } = await client.storage.from("comprobantes").upload(fileName, file);
  if (error) throw error;
  return `${SUPABASE_URL}/storage/v1/object/public/comprobantes/${fileName}`;
}

// Guardar en BD (todos los pagos pegados)
async function guardarPago() {
  if (!datosPago || !Array.isArray(datosPago) || datosPago.length === 0) 
    return alert("No se detectaron datos v√°lidos del pago.");
  if (!imagenFile) return alert("No hay imagen de comprobante.");

  const imgUrl = await subirImagen(imagenFile);
  const proveedorId = document.getElementById("proveedor").value || null;

  const registros = datosPago.map(p => ({
    proveedor_id: proveedorId,
    detalle_pago: p,
    imagen_url: imgUrl,
    canal: "pendiente"
  }));

  const { error } = await client.from("envios_pagos").insert(registros);

  if (error) {
    alert("Error al guardar: " + error.message);
  } else {
    alert("Pagos guardados con √©xito");
    document.getElementById("linea").value = "";
    document.getElementById("jsonPreview").innerHTML = "";
    document.getElementById("previewImagen").innerHTML = "";
    imagenFile = null;
    datosPago = [];
  }
}

// Buscar pagos
async function buscarPago() {
  const term = document.getElementById("buscar").value.trim();
  if (!term) return alert("Escribe algo para buscar");

  const { data, error } = await client
    .from("envios_pagos")
    .select("*")
    .or(`detalle_pago->>uuid.ilike.%${term}%,detalle_pago->>rfc.ilike.%${term}%,detalle_pago->>proveedor.ilike.%${term}%`)
    .order("id", { ascending: false })
    .limit(10);

  if (error) {
    console.error(error);
    alert("Error en b√∫squeda");
    return;
  }

  if (data.length === 0) {
    document.getElementById("resultado").innerHTML = "<p>No se encontr√≥ ning√∫n pago</p>";
    return;
  }

  let html = "";
  data.forEach(row => {
    const p = row.detalle_pago || {};
    const montoNum = parseFloat(p.monto || "0");
    const montoClass = montoNum < 0 ? "monto-negativo" : "monto-positivo";
    html += `
      <div class="pago-card">
        <h4>${p.proveedor || "Proveedor no registrado"}</h4>
        <div class="pago-detalle">
          <div><b>Fecha:</b></div><div>${p.fecha || "-"}</div>
          <div><b>UUID:</b></div><div>${p.uuid || "-"}</div>
          <div><b>RFC:</b></div><div>${p.rfc || "-"}</div>
          <div><b>Referencia:</b></div><div>${p.referencia || "-"}</div>
          <div><b>Monto:</b></div><div class="${montoClass}">$ ${p.monto || "0.00"}</div>
        </div>
        ${row.imagen_url ? `<img src="${row.imagen_url}">` : '<em>Sin imagen</em>'}
      </div>
    `;
  });

  document.getElementById("resultado").innerHTML = html;
}

// Evento de pegado
document.getElementById("linea").addEventListener("paste", (event) => {
  const items = event.clipboardData.items;
  for (const item of items) {
    if (item.type.indexOf("image") !== -1) {
      const blob = item.getAsFile();
      imagenFile = new File([blob], `captura_${Date.now()}.png`, { type: blob.type });
      const imgURL = URL.createObjectURL(imagenFile);
      document.getElementById("previewImagen").innerHTML = `<img src="${imgURL}" width="200">`;
      event.preventDefault();
      return;
    }
    if (item.type === "text/plain") {
      item.getAsString(text => {
        const lineas = text.split(/\r?\n/).filter(l => l.trim() !== "");
        datosPago = lineas.map(l => parseLineaPago(l));
        renderPreviewPagos(datosPago);
// üëá Parche: seleccionar proveedor por RFC
if (datosPago.length > 0 && datosPago[0].rfc) {
  const sel = document.getElementById("proveedor");
  const rfcDetectado = datosPago[0].rfc.trim().toUpperCase();
  const opcion = [...sel.options].find(o => (o.dataset.rfc || "").trim().toUpperCase() === rfcDetectado);
  if (opcion) sel.value = opcion.value;
}
      });
      return;
    }
  }
});

cargarProveedores();
</script>

</body>
</html>





