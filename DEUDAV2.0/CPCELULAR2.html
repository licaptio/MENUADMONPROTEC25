<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consulta de Facturas por RFC</title>

  <!-- ================================
       [1] LIBRER√çAS
  =================================-->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <!-- ================================
       [2] ESTILOS CSS
  =================================-->
  <style>

  /* =====================================
       2.0 ‚Äî AUTOCOMPLETE
  ======================================*/
  .autocomplete-list {
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    width: 250px;
    max-height: 180px;
    overflow-y: auto;
    display: none;
    border-radius: 6px;
    z-index: 10;
  }

  .autocomplete-list div {
    padding: 8px;
    cursor: pointer;
  }

  .autocomplete-list div:hover {
    background: #007bff;
    color: white;
  }

  /* =====================================
       2.1 ‚Äî REGLAS BASE
  ======================================*/
  body {
    font-family: sans-serif;
    background: #f4f4f4;
    margin: 0;
    padding: 1rem;
  }

  button {
    margin: 1rem 0;
    padding: 10px 20px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  button:hover { background: #218838; }

  /* =====================================
       2.2 ‚Äî TABLAS (PC)
  ======================================*/
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  th, td {
    padding: 8px;
    border: 1px solid #ccc;
    font-size: 0.9em;
    text-align: left;
  }
  th {
    background-color: #007bff;
    color: white;
  }

  /* =====================================
       2.3 ‚Äî TARJETAS M√ìVIL
  ======================================*/
  @media (max-width: 768px) {
    table, thead, tbody, th, td, tr { display: block; }
    thead { display: none; }

    tr {
      margin-bottom: 18px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,.08);
      padding: 12px 15px;
      border: 1px solid #e0e0e0;
    }

    td {
      border: none;
      border-bottom: 1px dashed #ddd;
      padding: 10px 6px;
      font-size: 0.95rem;
    }

    td:last-child { border-bottom: none; }
  }

  /* =====================================
       2.4 ‚Äî TARJETA DETALLE
  ======================================*/
  .card {
    background: #fff;
    margin: 12px 0;
    padding: 14px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    border: 1px solid #e0e0e0;
    font-size: 0.95rem;
  }
#rfcFiltro,
label[for="rfcFiltro"],
#sugerenciasRFC {
  display: none !important;
}
  </style>
</head>
<body>

<h2>üîç Consulta de Facturas por RFC</h2>

<!-- =====================================
     [3] INPUT RFC + AUTOCOMPLETE
======================================-->
<label><strong>RFC:</strong></label>
<input type="text" id="rfcFiltro" placeholder="Escribe RFC‚Ä¶" oninput="autocompleteRFC()" autocomplete="off">
<div id="sugerenciasRFC" class="autocomplete-list"></div>

<!-- =====================================
     [4] INPUT NOMBRE + AUTOCOMPLETE
======================================-->
<label style="margin-left:1rem;"><strong>Nombre:</strong></label>
<input type="text" id="nombreFiltro" placeholder="Escribe Nombre‚Ä¶" oninput="autocompleteNombre()" autocomplete="off">
<div id="sugerenciasNombre" class="autocomplete-list"></div>

<button onclick="consultarPorRFC()">üîé Consultar</button>

<label style="margin-left:1rem;">
  <input type="checkbox" id="togglePagadas" onchange="filtrarPagadas()">
  Mostrar pagadas
</label>

<div id="resumenConteo" style="margin-top: 1rem; font-weight: bold;"></div>
<div id="tablaResultados"></div>

<!-- =====================================
     [5] L√ìGICA JAVASCRIPT
======================================-->
<script>

const supabase = window.supabase.createClient(
  "https://cvpbtjlupswbyxenugpz.supabase.co",
  "eyJhbGciOiJIUzI1..."
);

const tabla = "deuda_limpia_pdd";
let datosCrudos = [];
let listaBusqueda = [];

/* =====================================
   5.1 CARGAR RFC + NOMBRE
======================================*/
async function cargarRFCs() {
  const { data, error } = await supabase.rpc("obtener_rfc_y_nombre_unicos");
  if (error) { alert("Error al cargar RFCs"); return; }

  // üî• AQU√ç S√ç VA ‚Äî TU ERROR ESTABA EN ESTO
  listaBusqueda = data.map(x => ({
    rfc: x.rfc,
    nombre: x.nombre.toUpperCase()
  }));
}

cargarRFCs();

/* =====================================
   5.2 AUTOCOMPLETE RFC
======================================*/
function autocompleteRFC() {
  const txt = rfcFiltro.value.toUpperCase();
  const lista = document.getElementById("sugerenciasRFC");

  lista.innerHTML = "";
  if (txt.length < 1) return lista.style.display = "none";

  listaBusqueda
    .filter(x => x.rfc.includes(txt))
    .forEach(x => {
      let div = document.createElement("div");
      div.textContent = `${x.rfc} ‚Äî ${x.nombre}`;
div.onclick = () => {
  nombreFiltro.value = x.nombre;
  window.rfcSeleccionado = x.rfc;  // guardamos RFC aunque el input no exista
  lista.style.display = "none";
};

      lista.appendChild(div);
    });

  lista.style.display = "block";
}

/* =====================================
   5.3 AUTOCOMPLETE NOMBRE
======================================*/
function autocompleteNombre() {
  const txt = nombreFiltro.value.toUpperCase();
  const lista = document.getElementById("sugerenciasNombre");

  lista.innerHTML = "";
  if (txt.length < 1) return lista.style.display = "none";

  listaBusqueda
    .filter(x => x.nombre.includes(txt))
    .forEach(x => {
      let div = document.createElement("div");
      div.textContent = `${x.nombre} ‚Äî ${x.rfc}`;
      div.onclick = () => {
        nombreFiltro.value = x.nombre;
        rfcFiltro.value = x.rfc;
        lista.style.display = "none";
      };
      lista.appendChild(div);
    });

  lista.style.display = "block";
}
/* =====================================
   5.4 CONSULTAR FACTURAS SOLO POR PROVEEDOR
======================================*/
async function consultarPorRFC() {

  // Obtenemos el RFC seleccionado desde autocompleteNombre()
  const rfc = window.rfcSeleccionado;

  if (!rfc) {
    alert("Selecciona un proveedor v√°lido de la lista");
    return;
  }

  document.getElementById("tablaResultados").innerHTML = "";
  document.getElementById("resumenConteo").innerText = "";

  // √∫ltimos 60 d√≠as
  const hoy = new Date();
  const limite = new Date();
  limite.setDate(hoy.getDate() - 60);
  const limiteISO = limite.toISOString().split("T")[0];

  // contar registros
  const { count, error: errorConteo } = await supabase
    .from("v_deuda_proveedores")
    .select("*", { count: "exact", head: true })
    .eq("rfc_emisor", rfc)
    .gte("fecha", limiteISO);

  if (errorConteo) {
    alert("Error al contar registros");
    return;
  }

  // consultar facturas
  const { data: facturas, error } = await supabase
    .from("v_deuda_proveedores")
    .select("*")
    .eq("rfc_emisor", rfc)
    .gte("fecha", limiteISO)
    .order("fecha", { ascending: true });

  if (error) {
    alert("Error al traer facturas");
    return;
  }

  datosCrudos = facturas;

  document.getElementById("resumenConteo").innerText =
    `üî¢ Total: ${count}\nüìÑ Mostrados: ${facturas.length}`;

  filtrarPagadas();
}
function filtrarPagadas() {
  const mostrar = document.getElementById("togglePagadas").checked;
  const datos = mostrar
    ? datosCrudos
    : datosCrudos.filter(f => (f.factura_pagada || "NO") !== "SI");

  mostrarTabla(datos);
}
function mostrarTabla(data) {
  let html = `<table><thead><tr>
    <th>Fecha</th><th>D√≠as</th><th>UUID</th><th>Proveedor</th>
    <th>Total</th><th>Pagada</th>
  </tr></thead><tbody>`;

  data.forEach(f => {
    html += `
      <tr>
        <td>${f.fecha}</td>
        <td>${calcDiasDesdeHoy(f.fecha)}</td>
        <td>${f.uuid_cfdi}</td>
        <td>${f.razon_social_emisor}</td>
        <td>${(f.total||0).toLocaleString('es-MX',{minimumFractionDigits:2})}</td>
        <td>${(f.factura_pagada||"NO")}</td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  document.getElementById("tablaResultados").innerHTML = html;
}
function calcDiasDesdeHoy(iso){
  const f = new Date(iso);
  const h = new Date();
  return Math.floor((h - f) / 1000 / 60 / 60 / 24);
}

</script>

</body>
</html>
