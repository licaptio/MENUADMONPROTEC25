<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consulta de Facturas por RFC</title>

  <!-- ================================
       [1] LIBRER√çAS
  =================================-->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <!-- ================================
       [2] ESTILOS CSS
  =================================-->
  <style>

  /* =====================================
       2.0 ‚Äî AUTOCOMPLETE
  ======================================*/
.autocomplete-list {
  position: absolute;
  background: white;
  border: 1px solid #ccc;
  width: 250px;
  max-height: 180px;
  overflow-y: auto;
  display: none;
  border-radius: 6px;
  z-index: 10;

  /* üî• ESTA L√çNEA LA AGREGA: BAJA LA LISTA */
  margin-top: 18px; 
}


  .autocomplete-list div {
    padding: 8px;
    cursor: pointer;
  }

  .autocomplete-list div:hover {
    background: #007bff;
    color: white;
  }

  /* =====================================
       2.1 ‚Äî REGLAS BASE
  ======================================*/
  body {
    font-family: sans-serif;
    background: #f4f4f4;
    margin: 0;
    padding: 1rem;
  }

  button {
    margin: 1rem 0;
    padding: 10px 20px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  button:hover { background: #218838; }

  /* =====================================
       2.2 ‚Äî TABLAS (PC)
  ======================================*/
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  th, td {
    padding: 8px;
    border: 1px solid #ccc;
    font-size: 0.9em;
    text-align: left;
  }
  th {
    background-color: #007bff;
    color: white;
  }

  /* =====================================
       2.3 ‚Äî TARJETAS M√ìVIL
  ======================================*/
  @media (max-width: 768px) {
    table, thead, tbody, th, td, tr { display: block; }
    thead { display: none; }

    tr {
      margin-bottom: 18px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,.08);
      padding: 12px 15px;
      border: 1px solid #e0e0e0;
    }

    td {
      border: none;
      border-bottom: 1px dashed #ddd;
      padding: 10px 6px;
      font-size: 0.95rem;
    }

    td:last-child { border-bottom: none; }
  }
@media (max-width: 768px) {

  td {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    text-align: right;
    position: relative;
  }

  td::before {
    content: attr(data-label);
    font-weight: bold;
    text-transform: capitalize;
    color: #555;
    flex-basis: 50%;
    text-align: left;
  }
}

  /* =====================================
       2.4 ‚Äî TARJETA DETALLE
  ======================================*/
  .card {
    background: #fff;
    margin: 12px 0;
    padding: 14px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    border: 1px solid #e0e0e0;
    font-size: 0.95rem;
  }
#rfcFiltro,
label[for="rfcFiltro"],
#sugerenciasRFC {
  display: none !important;
}
.badge-toggle {
  display: inline-block;
  padding: 6px 14px;
  color: white;
  border-radius: 12px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: bold;
  user-select: none;
}

.badge-si {
  background: #28a745;
}

.badge-no {
  background: #dc3545;
}
/* FILA QUE CONTIENE RFC + NOMBRE */
.fila-filtros {
  display: flex;
  gap: 20px;
  align-items: flex-start; /* üî• Esto alinea perfectamente las cajas */
  flex-wrap: wrap;         /* Para que en m√≥vil caigan uno debajo del otro */
}

/* CONTENEDOR DE CADA INPUT CON SU AUTOCOMPLETE */
.campo-autocomplete {
  position: relative; /* üî• NECESARIO para que la lista se alinee */
  width: 250px;       /* Igual al ancho del dropdown */
}

</style>
</head>
<body>

<h2>üîç Consulta de Facturas por RFC</h2>

<!-- =====================================
     [3] FILA DE FILTROS ALINEADA
======================================-->

<div class="fila-filtros">

  <div class="campo-autocomplete">
    <label><strong>RFC:</strong></label>
    <input type="text" id="rfcFiltro" placeholder="Escribe RFC‚Ä¶" 
           oninput="autocompleteRFC()" autocomplete="off">
    <div id="sugerenciasRFC" class="autocomplete-list"></div>
  </div>

  <div class="campo-autocomplete">
    <label><strong>Nombre:</strong></label>
    <input type="text" id="nombreFiltro" placeholder="Escribe Nombre‚Ä¶" 
           oninput="autocompleteNombre()" autocomplete="off">
    <div id="sugerenciasNombre" class="autocomplete-list"></div>
  </div>

</div>

<button onclick="consultarPorRFC()">üîé Consultar</button>


<label style="margin-left:1rem;">
  <input type="checkbox" id="togglePagadas" onchange="filtrarPagadas()">
  Mostrar pagadas
</label>

<div id="resumenConteo" style="margin-top: 1rem; font-weight: bold;"></div>
<div id="tablaResultados"></div>

<!-- =====================================
     [5] L√ìGICA JAVASCRIPT
======================================-->
<script>

const supabase = window.supabase.createClient(
  "https://cvpbtjlupswbyxenugpz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
);

const tabla = "deuda_limpia_pdd";
let datosCrudos = [];
let listaBusqueda = [];

/* =====================================
   5.1 CARGAR RFC + NOMBRE
======================================*/
async function cargarRFCs() {
  const { data, error } = await supabase.rpc("obtener_rfc_y_nombre_unicos");
  if (error) { alert("Error al cargar RFCs"); return; }

listaBusqueda = data.map(x => ({
  rfc: x.rfc,
  nombre: (x.nombre || x.rfc).toUpperCase().trim()
}));

}

cargarRFCs();

/* =====================================
   5.2 AUTOCOMPLETE RFC
======================================*/
function autocompleteRFC() {
  const txt = rfcFiltro.value.toUpperCase().trim();
  const lista = document.getElementById("sugerenciasRFC");

  lista.innerHTML = "";
  if (txt.length < 1) return lista.style.display = "none";

  const normalizado = txt.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

  listaBusqueda
    .filter(x => 
      x.rfc.includes(normalizado) ||
      x.nombre.includes(normalizado)
    )
    .forEach(x => {
      let div = document.createElement("div");
      div.textContent = `${x.rfc} ‚Äî ${x.nombre}`;
      div.onclick = () => {
        rfcFiltro.value = x.rfc;
        nombreFiltro.value = x.nombre;
        window.rfcSeleccionado = x.rfc;
        lista.style.display = "none";
      };
      lista.appendChild(div);
    });

  lista.style.display = "block";
}

/* =====================================
   5.3 AUTOCOMPLETE NOMBRE
======================================*/
function autocompleteNombre() {
  const txt = nombreFiltro.value.toUpperCase().trim();
  const lista = document.getElementById("sugerenciasNombre");

  lista.innerHTML = "";

  if (txt.length < 1) {
    lista.style.display = "none";
    return;
  }

  // Fuzzy-lite: permite errores de letras
  const normalizado = txt.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

  const resultados = listaBusqueda.filter(x => {
    const nom = (x.nombre || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const rfc = x.rfc || "";

    return (
      nom.includes(normalizado) ||         // por nombre
      rfc.includes(normalizado) ||        // por RFC
      nom.replace(/\s+/g, '').includes(normalizado.replace(/\s+/g, '')) // fuzzy-lite
    );
  });

  resultados.forEach(x => {
    let div = document.createElement("div");
    div.textContent = `${x.nombre} ‚Äî ${x.rfc}`;
    div.onclick = () => {
      nombreFiltro.value = x.nombre;
      window.rfcSeleccionado = x.rfc;
      lista.style.display = "none";
    };
    lista.appendChild(div);
  });

  lista.style.display = "block";
}

/* =====================================
   5.4 CONSULTAR FACTURAS SOLO POR PROVEEDOR
======================================*/
async function consultarPorRFC() {

  // Obtenemos el RFC seleccionado desde autocompleteNombre()
  let rfc = window.rfcSeleccionado;

// Detecci√≥n autom√°tica si el usuario NO clicke√≥ nada:
if (!rfc) {
  const txt = nombreFiltro.value.toUpperCase().trim();
  const encontrado = listaBusqueda.find(x =>
    x.nombre.includes(txt) || x.rfc.includes(txt)
  );
  if (encontrado) rfc = encontrado.rfc;
}


  if (!rfc) {
    alert("Selecciona un proveedor v√°lido de la lista");
    return;
  }

  document.getElementById("tablaResultados").innerHTML = "";
  document.getElementById("resumenConteo").innerText = "";

  // √∫ltimos 60 d√≠as
  const hoy = new Date();
  const limite = new Date();
  limite.setDate(hoy.getDate() - 99);
  const limiteISO = limite.toISOString().split("T")[0];

  // contar registros
const { count, error: errorConteo } = await supabase
  .from("v_deuda_proveedores")
  .select("*", { count: "exact", head: true })
  .eq("rfc_emisor", rfc)
  .gte("fecha", limiteISO);

  if (errorConteo) {
    alert("Error al contar registros");
    return;
  }

  // consultar facturas
const { data: facturas, error } = await supabase
  .from("v_deuda_proveedores")
  .select("*")
  .eq("rfc_emisor", rfc)
  .gte("fecha", limiteISO)
  .order("fecha", { ascending: true });

  if (error) {
    alert("Error al traer facturas");
    return;
  }

  datosCrudos = facturas;

  document.getElementById("resumenConteo").innerText =
    `üî¢ Total: ${count}\nüìÑ Mostrados: ${facturas.length}`;

  filtrarPagadas();
}
function filtrarPagadas() {
  const mostrar = document.getElementById("togglePagadas").checked;
  const datos = mostrar
    ? datosCrudos
    : datosCrudos.filter(f => f.factura_pagada !== "SI");

  mostrarTabla(datos);
}
  
function mostrarTabla(data) {
  let html = `<table><thead><tr>
    <th>Fecha</th>
    <th>D√≠as</th>
    <th>UUID</th>
    <th>RFC</th>
    <th>Proveedor</th>
    <th>Total</th>
    <th>Serie/Folio</th>
    <th>Pagada</th>
    <th>Factura F√≠sica</th>
    <th>üì∑ Fotos</th>
  </tr></thead><tbody>`;

  data.forEach(f => {
    /* ===========================
       1. UUID CORRECTO - USAR EL MISMO QUE EN LA TABLA BASE
       =========================== */
    // üî• CAMBIAR ESTO: usar uuid_cfdi en lugar de uuid
    const uuid = f.uuid_cfdi || f.uuid;  
    

    /* ===========================
       2. PROVEEDOR REAL
       =========================== */
    let proveedor = f.proveedor_unificado;
    if (f.razon_social_emisor && f.razon_social_emisor.trim() !== "") {
      proveedor = f.razon_social_emisor;
    }
    else if (f.nombre_emisor && f.nombre_emisor.trim() !== "") {
      proveedor = f.nombre_emisor;
    }
    else {
      proveedor = f.rfc_emisor;
    }

    /* ===========================
       3. CONSTRUCCI√ìN DE LA FILA
       =========================== */
    html += `
<tr>
  <td>${formatearFecha(f.fecha)}</td>
  <td>${f.dias}</td>

<td>
  <a href="detalle.html?uuid=${uuid}" target="_blank" style="color:#007bff;">
    ${uuid}
  </a>
</td>


  <td>${f.rfc_emisor}</td>
  <td>${proveedor}</td>
  <td>${monedaMXN(f.total)}</td>
  <td>${f.serie_folio || "‚Äî"}</td>

  <td>
    <div class="badge-toggle ${(f.factura_pagada === 'SI') ? 'badge-si' : 'badge-no'}"
      onclick="togglePagada('${uuid}')"
      data-uuid-pagada="${uuid}">
      ${f.factura_pagada}
    </div>
  </td>

  <td>
    <div class="badge-toggle ${(f.factura_fisicamente === 'SI') ? 'badge-si' : 'badge-no'}"
      onclick="toggleFisica('${uuid}')"
      data-uuid-fisica="${uuid}">
      ${f.factura_fisicamente}
    </div>
  </td>

  <td>
    ${
      (f.fotos && f.fotos.length > 0)
      ? f.fotos.map(url => `<a href="${url}" target="_blank">üì∑</a>`).join("")
      : "‚Äî"
    }
  </td>
</tr>
`;
  });

  html += "</tbody></table>";
  document.getElementById("tablaResultados").innerHTML = html;
}
function calcDiasDesdeHoy(iso){
  const f = new Date(iso);
  const h = new Date();
  return Math.floor((h - f) / 1000 / 60 / 60 / 24);
}
function formatearFecha(fechaISO) {
  const fecha = new Date(fechaISO);
  const dia = String(fecha.getDate()).padStart(2, '0');
  const mes = String(fecha.getMonth() + 1).padStart(2, '0');
  const a√±o = fecha.getFullYear();
  return `${dia}/${mes}/${a√±o}`;
}
function monedaMXN(valor) {
  return Number(valor).toLocaleString('es-MX', {
    style: 'currency',
    currency: 'MXN'
  });
}

async function toggleFisica(uuid) {
  try {
    // üîç 1) Obtener el estado actual desde la VISTA usando "uuid"
    const { data, error } = await supabase
      .from("v_deuda_proveedores")
      .select("factura_fisicamente")
      .eq("uuid", uuid)   // ‚Üê Aqu√≠ NO es uuid_cfdi
      .single();

    if (error) {
      console.error("Error al leer estado actual:", error);
      alert("Error al leer estado actual de factura f√≠sica");
      return;
    }

    // üîÑ 2) Determinar nuevo estado
    const estadoActual = data.factura_fisicamente || "NO";
    const nuevoEstado = estadoActual === "SI" ? "NO" : "SI";

    // üíæ 3) Actualizar en la TABLA REAL usando "uuid_cfdi"
    const { error: updateError } = await supabase
      .from("deuda_limpia_pdd")
      .update({ factura_fisicamente: nuevoEstado })
      .eq("uuid_cfdi", uuid); // ‚Üê aqu√≠ S√ç debe ser uuid_cfdi

    if (updateError) {
      console.error("Error al actualizar:", updateError);
      alert("Error al actualizar el estado f√≠sico");
      return;
    }

    // üî• 4) Actualizar en los datos locales usando "uuid"
    const idx = datosCrudos.findIndex(f => f.uuid === uuid);
    if (idx !== -1) {
      datosCrudos[idx].factura_fisicamente = nuevoEstado;
    }

    // ‚ú® 5) Refrescar tabla completa para respetar el filtro
    filtrarPagadas();

    console.log(`Factura f√≠sica actualizada: ${uuid} -> ${nuevoEstado}`);

  } catch (err) {
    console.error("Error inesperado:", err);
    alert("Error inesperado al actualizar factura f√≠sica");
  }
}

async function togglePagada(uuid) {
  try {
    // üîç 1) Obtener estado actual desde la VISTA usando "uuid"
    const { data, error } = await supabase
      .from("v_deuda_proveedores")
      .select("factura_pagada")
      .eq("uuid", uuid)   // ‚Üê CORRECTO
      .single();

    if (error) {
      console.error("Error al leer estado actual:", error);
      alert("Error al leer estado actual de la factura");
      return;
    }

    // üîÑ 2) Determinar nuevo estado
    const estadoActual = data.factura_pagada || "NO";
    const nuevoEstado = estadoActual === "SI" ? "NO" : "SI";

    // üíæ 3) Actualizar en la TABLA REAL usando "uuid_cfdi"
    const { error: updateError } = await supabase
      .from("deuda_limpia_pdd")
      .update({ factura_pagada: nuevoEstado })
      .eq("uuid_cfdi", uuid);  // ‚Üê CORRECTO

    if (updateError) {
      console.error("Error al actualizar:", updateError);
      alert("Error al actualizar el estado de pago: " + updateError.message);
      return;
    }

    // üî• 4) Actualizar en el arreglo local
    const idx = datosCrudos.findIndex(f => f.uuid === uuid);
    if (idx !== -1) {
      datosCrudos[idx].factura_pagada = nuevoEstado;
    }

    // üîÅ 5) Redibujar tabla
    filtrarPagadas();

  } catch(err) {
    console.error("Error inesperado:", err);
    alert("Error inesperado al actualizar el estado");
  }
}

</script>

</body>
</html>
