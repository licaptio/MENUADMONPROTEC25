<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consulta de Facturas por RFC</title>

  <!-- ================================
       [1] LIBRER√çAS
  =================================-->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <!-- ================================
       [2] ESTILOS CSS
  =================================-->
  <style>

  /* =====================================
       2.0 ‚Äî AUTOCOMPLETE
  ======================================*/
.autocomplete-list {
  position: absolute;
  background: white;
  border: 1px solid #ccc;
  width: 250px;
  max-height: 180px;
  overflow-y: auto;
  display: none;
  border-radius: 6px;
  z-index: 10;

  /* üî• ESTA L√çNEA LA AGREGA: BAJA LA LISTA */
  margin-top: 18px; 
}


  .autocomplete-list div {
    padding: 8px;
    cursor: pointer;
  }

  .autocomplete-list div:hover {
    background: #007bff;
    color: white;
  }

  /* =====================================
       2.1 ‚Äî REGLAS BASE
  ======================================*/
  body {
    font-family: sans-serif;
    background: #f4f4f4;
    margin: 0;
    padding: 1rem;
  }

  button {
    margin: 1rem 0;
    padding: 10px 20px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  button:hover { background: #218838; }

  /* =====================================
       2.2 ‚Äî TABLAS (PC)
  ======================================*/
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  th, td {
    padding: 8px;
    border: 1px solid #ccc;
    font-size: 0.9em;
    text-align: left;
  }
  th {
    background-color: #007bff;
    color: white;
  }

  /* =====================================
       2.3 ‚Äî TARJETAS M√ìVIL
  ======================================*/
  @media (max-width: 768px) {
    table, thead, tbody, th, td, tr { display: block; }
    thead { display: none; }

    tr {
      margin-bottom: 18px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,.08);
      padding: 12px 15px;
      border: 1px solid #e0e0e0;
    }

    td {
      border: none;
      border-bottom: 1px dashed #ddd;
      padding: 10px 6px;
      font-size: 0.95rem;
    }

    td:last-child { border-bottom: none; }
  }
@media (max-width: 768px) {

  td {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    text-align: right;
    position: relative;
  }

  td::before {
    content: attr(data-label);
    font-weight: bold;
    text-transform: capitalize;
    color: #555;
    flex-basis: 50%;
    text-align: left;
  }
}

  /* =====================================
       2.4 ‚Äî TARJETA DETALLE
  ======================================*/
  .card {
    background: #fff;
    margin: 12px 0;
    padding: 14px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    border: 1px solid #e0e0e0;
    font-size: 0.95rem;
  }
#rfcFiltro,
label[for="rfcFiltro"],
#sugerenciasRFC {
  display: none !important;
}

.badge-toggle {
  display: inline-block;
  padding: 6px 14px;
  color: white;
  border-radius: 12px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: bold;
  user-select: none;
}

.badge-si {
  background: #28a745;
}

.badge-no {
  background: #dc3545;
}
/* FILA QUE CONTIENE RFC + NOMBRE */
.fila-filtros {
  display: flex;
  gap: 20px;
  align-items: flex-start; /* üî• Esto alinea perfectamente las cajas */
  flex-wrap: wrap;         /* Para que en m√≥vil caigan uno debajo del otro */
}

/* CONTENEDOR DE CADA INPUT CON SU AUTOCOMPLETE */
.campo-autocomplete {
  position: relative; /* üî• NECESARIO para que la lista se alinee */
  width: 250px;       /* Igual al ancho del dropdown */
}

</style>
</head>
<body>

<h2>üîç Consulta de Facturas por RFC O NOMBRE DE PROVEEDOR </h2>

<!-- =====================================
     [3] INPUT RFC + AUTOCOMPLETE
======================================-->
<label><strong>RFC O NOMBRE:</strong></label>
<input type="text" id="rfcFiltro" placeholder="Escribe RFC‚Ä¶" oninput="autocompleteRFC()" autocomplete="off">
<div id="sugerenciasRFC" class="autocomplete-list"></div>

<!-- =====================================
     [4] INPUT NOMBRE + AUTOCOMPLETE
======================================-->
<input type="text" id="nombreFiltro" placeholder="Escribe Nombre‚Ä¶" oninput="autocompleteNombre()" autocomplete="off">
<div id="sugerenciasNombre" class="autocomplete-list"></div>

<button onclick="consultarPorRFC()">üîé Consultar</button>
<label style="display:block; margin-top:1rem;">
  <input type="checkbox" id="togglePagadas" onchange="filtrarPagadas()">
  Mostrar pagadas
</label>

<div id="resumenConteo" style="margin-top: 1rem; font-weight: bold;"></div>
<div id="tablaResultados"></div>
<!-- =====================================
     [5] L√ìGICA JAVASCRIPT
======================================-->
<script>

const supabase = window.supabase.createClient(
  "https://cvpbtjlupswbyxenugpz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
);

const tabla = "deuda_limpia_pdd";
let datosCrudos = [];
let listaBusqueda = [];

/* =====================================
   5.1 CARGAR RFCs SIN L√çMITE (Paginaci√≥n real)
======================================*/
async function cargarRFCs() {
  console.log("üöÄ Cargando TODOS los RFCs (paginado)...");

  let todos = [];
  let desde = 0;
  let pagina = [];

  do {
    const { data, error } = await supabase
      .from("v_deuda_proveedores")
      .select("rfc_emisor, proveedor_unificado, razon_social_emisor, nombre_emisor")
      .not("rfc_emisor", "is", null)
      .order("rfc_emisor", { ascending: true })
      .range(desde, desde + 999);   // ‚Üê Pide bloques de 1000

    if (error) {
      console.error("‚ùå Error cargando p√°gina:", error);
      break;
    }

    pagina = data;
    todos = todos.concat(data);  // ‚Üê Acumula
    desde += 1000;               // ‚Üê Avanza a la siguiente p√°gina

    console.log(`üì• P√°gina cargada: ${pagina.length} registros`);
  } while (pagina.length === 1000); // ‚Üê Repetir mientras venga llena

  console.log(`üèÅ TOTAL FINAL TRA√çDO: ${todos.length} registros`);

  // --------------------------------------------
  // üîç CREAR LISTA √öNICA DE RFCs + NOMBRES
  // --------------------------------------------

  const mapa = new Map();

  todos.forEach(item => {
    if (!item.rfc_emisor) return;

    const rfc = item.rfc_emisor.toUpperCase().trim();

    let nombre = "";
    if (item.proveedor_unificado?.trim()) nombre = item.proveedor_unificado;
    else if (item.razon_social_emisor?.trim()) nombre = item.razon_social_emisor;
    else if (item.nombre_emisor?.trim()) nombre = item.nombre_emisor;
    else nombre = rfc;

    mapa.set(rfc, nombre.toUpperCase().trim());
  });

  listaBusqueda = Array.from(mapa, ([rfc, nombre]) => ({ rfc, nombre }))
    .sort((a, b) => a.rfc.localeCompare(b.rfc));

  console.log(`üìä RFCs √öNICOS: ${listaBusqueda.length}`);
  console.log("üéØ Ejemplo:", listaBusqueda.slice(0, 5));
}

// Recargar inmediatamente despu√©s de cambiar
cargarRFCs();
/* =====================================
   5.2 AUTOCOMPLETE RFC
======================================*/
function autocompleteRFC() {
  const txt = rfcFiltro.value.trim().toUpperCase();
  const lista = document.getElementById("sugerenciasRFC");

  lista.innerHTML = "";
  
  if (txt.length < 2) {
    lista.style.display = "none";
    return;
  }

  console.log("Buscando:", txt);
  console.log("En lista de", listaBusqueda.length, "proveedores");

  // B√∫squeda simple y directa
  const resultados = listaBusqueda.filter(x => {
    // Buscar en RFC (exacto o parcial)
    if (x.rfc && x.rfc.includes(txt)) return true;
    
    // Buscar en nombre (sin normalizar para mantener tildes)
    if (x.nombre && x.nombre.includes(txt)) return true;
    
    // Buscar sin acentos en nombre (opcional)
    const nombreSinAcentos = x.nombre.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    if (nombreSinAcentos.includes(txt.normalize("NFD").replace(/[\u0300-\u036f]/g, ""))) {
      return true;
    }
    
    return false;
  });

  console.log("Resultados encontrados:", resultados.length);

  if (resultados.length === 0) {
    lista.style.display = "none";
    return;
  }

  // Mostrar resultados
  resultados.slice(0, 15).forEach(x => {
    const div = document.createElement("div");
    div.textContent = `${x.rfc} ‚Äî ${x.nombre}`;
    div.onclick = () => {
      rfcFiltro.value = x.rfc;
      nombreFiltro.value = x.nombre;
      window.rfcSeleccionado = x.rfc;
      lista.style.display = "none";
    };
    lista.appendChild(div);
  });

  lista.style.display = "block";
}
/* =====================================
   5.3 AUTOCOMPLETE NOMBRE
======================================*/
function autocompleteNombre() {
  const txt = nombreFiltro.value
    .toUpperCase()
    .trim()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, " "); // limpia dobles espacios

  const lista = document.getElementById("sugerenciasNombre");
  lista.innerHTML = "";

  if (txt.length < 1) {
    lista.style.display = "none";
    return;
  }

  const resultados = listaBusqueda.filter(x => {
    const nom = (x.nombre || "")
      .toUpperCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ");

    const rfc = (x.rfc || "").toUpperCase();

    return (
      nom.includes(txt) ||                 // MINERVA ‚Üí coincide
      nom.startsWith(txt) ||               // inicio coincide
      rfc.includes(txt) ||                 // busca por RFC
      nom.replace(/\s+/g, '').includes(txt.replace(/\s+/g, '')) // fuzzy
    );
  });

  resultados.forEach(x => {
    let div = document.createElement("div");
    div.textContent = `${x.nombre} ‚Äî ${x.rfc}`;
    div.onclick = () => {
      nombreFiltro.value = x.nombre;
      window.rfcSeleccionado = x.rfc;
      lista.style.display = "none";
    };
    lista.appendChild(div);
  });

  lista.style.display = "block";
}

/* =====================================
   5.4 CONSULTAR FACTURAS SOLO POR PROVEEDOR
======================================*/
async function consultarPorRFC() {

  // Obtenemos el RFC seleccionado desde autocompleteNombre()
  let rfc = window.rfcSeleccionado;

// Detecci√≥n autom√°tica si el usuario NO clicke√≥ nada:
if (!rfc) {
  const txt = nombreFiltro.value.toUpperCase().trim();
  const encontrado = listaBusqueda.find(x =>
    x.nombre.includes(txt) || x.rfc.includes(txt)
  );
  if (encontrado) rfc = encontrado.rfc;
}


  if (!rfc) {
    alert("Selecciona un proveedor v√°lido de la lista");
    return;
  }

  document.getElementById("tablaResultados").innerHTML = "";
  document.getElementById("resumenConteo").innerText = "";

  // √∫ltimos 60 d√≠as
  const hoy = new Date();
  const limite = new Date();
  limite.setDate(hoy.getDate() - 99);
  const limiteISO = limite.toISOString().split("T")[0];

  // contar registros
const { count, error: errorConteo } = await supabase
  .from("v_deuda_proveedores")
  .select("*", { count: "exact", head: true })
  .eq("rfc_emisor", rfc)
  .gte("fecha", limiteISO);

  if (errorConteo) {
    alert("Error al contar registros");
    return;
  }

  // consultar facturas
const { data: facturas, error } = await supabase
  .from("v_deuda_proveedores")
  .select("*")
  .eq("rfc_emisor", rfc)
  .gte("fecha", limiteISO)
  .order("fecha", { ascending: true });

  if (error) {
    alert("Error al traer facturas");
    return;
  }

  datosCrudos = facturas;

  document.getElementById("resumenConteo").innerText =
    `üî¢ Total: ${count}\nüìÑ Mostrados: ${facturas.length}`;

  filtrarPagadas();
}
function filtrarPagadas() {
  const mostrar = document.getElementById("togglePagadas").checked;
  const datos = mostrar
    ? datosCrudos
    : datosCrudos.filter(f => f.factura_pagada !== "SI");

  mostrarTabla(datos);
}
  
function mostrarTabla(data) {
  let html = `<table><thead><tr>
    <th>Copiar</th>
    <th>Fecha</th>
    <th>D√≠as</th>
    <th>UUID</th>
    <th>RFC</th>
    <th>Proveedor</th>
    <th>Total</th>
    <th>Serie/Folio</th>
    <th>Pagada</th>
    <th>Factura F√≠sica</th>
    <th>üì∑ Fotos</th>
  </tr></thead><tbody>`;

  data.forEach(f => {
    /* ===========================
       1. UUID CORRECTO - USAR EL MISMO QUE EN LA TABLA BASE
       =========================== */
    // üî• CAMBIAR ESTO: usar uuid_cfdi en lugar de uuid
    const uuid = f.uuid_cfdi || f.uuid;  
    

    /* ===========================
       2. PROVEEDOR REAL
       =========================== */
    let proveedor = f.proveedor_unificado;
    if (f.razon_social_emisor && f.razon_social_emisor.trim() !== "") {
      proveedor = f.razon_social_emisor;
    }
    else if (f.nombre_emisor && f.nombre_emisor.trim() !== "") {
      proveedor = f.nombre_emisor;
    }
    else {
      proveedor = f.rfc_emisor;
    }

    /* ===========================
       3. CONSTRUCCI√ìN DE LA FILA
       =========================== */
    html += `
<tr>
  <td>
  <button onclick='copiarFila(${JSON.stringify(f)})'>üìã</button>
</td>
  <td>${formatearFecha(f.fecha)}</td>
  <td>${calcDiasDesdeHoy(f.fecha)}</td>

<td>
  <a href="detalle.html?uuid=${uuid}" target="_blank" style="color:#007bff;">
    ${uuid}
  </a>
</td>


  <td>${f.rfc_emisor}</td>
  <td>${proveedor}</td>
  <td>${monedaMXN(f.total)}</td>
  <td>${f.serie_folio || "‚Äî"}</td>

  <td>
    <div class="badge-toggle ${(f.factura_pagada === 'SI') ? 'badge-si' : 'badge-no'}"
      onclick="togglePagada('${uuid}')"
      data-uuid-pagada="${uuid}">
      ${f.factura_pagada}
    </div>
  </td>

  <td>
    <div class="badge-toggle ${(f.factura_fisicamente === 'SI') ? 'badge-si' : 'badge-no'}"
      onclick="toggleFisica('${uuid}')"
      data-uuid-fisica="${uuid}">
      ${f.factura_fisicamente}
    </div>
  </td>

  <td>
    ${
      (f.fotos && f.fotos.length > 0)
      ? f.fotos.map(url => `<a href="${url}" target="_blank">üì∑</a>`).join("")
      : "‚Äî"
    }
  </td>
</tr>
`;
  });

  html += "</tbody></table>";
  document.getElementById("tablaResultados").innerHTML = html;
}
function calcDiasDesdeHoy(iso) {
  // iso puede venir como "2025-11-20" o "2025-11-20T00:00:00Z"
  const soloFecha = iso.split("T")[0]; // <-- aqu√≠ arreglamos todo

  const [anio, mes, dia] = soloFecha.split("-").map(Number);

  const fecha = new Date(anio, mes - 1, dia);

  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  fecha.setHours(0, 0, 0, 0);

  const diff = hoy - fecha;
  return Math.floor(diff / 86400000);
}

function formatearFecha(fechaISO) {
  const fecha = new Date(fechaISO);
  const dia = String(fecha.getDate()).padStart(2, '0');
  const mes = String(fecha.getMonth() + 1).padStart(2, '0');
  const a√±o = fecha.getFullYear();
  return `${dia}/${mes}/${a√±o}`;
}
function monedaMXN(valor) {
  return Number(valor).toLocaleString('es-MX', {
    style: 'currency',
    currency: 'MXN'
  });
}
function copiarFila(fila) {
  const texto = `
Fecha: ${formatearFecha(fila.fecha)}
D√≠as: ${calcDiasDesdeHoy(fila.fecha)}
UUID: ${fila.uuid_cfdi || fila.uuid}
RFC: ${fila.rfc_emisor}
Proveedor: ${fila.proveedor_unificado || fila.razon_social_emisor || fila.nombre_emisor}
Total: ${fila.total}
Serie/Folio: ${fila.serie_folio}
Pagada: ${fila.factura_pagada}
Factura F√≠sica: ${fila.factura_fisicamente}
`;

  navigator.clipboard.writeText(texto).then(() => {
    alert("Copiado al portapapeles");
  });
}

async function toggleFisica(uuid) {
  try {
    // üîç 1) Obtener el estado actual desde la VISTA usando "uuid"
    const { data, error } = await supabase
      .from("v_deuda_proveedores")
      .select("factura_fisicamente")
      .eq("uuid", uuid)   // ‚Üê Aqu√≠ NO es uuid_cfdi
      .single();

    if (error) {
      console.error("Error al leer estado actual:", error);
      alert("Error al leer estado actual de factura f√≠sica");
      return;
    }

    // üîÑ 2) Determinar nuevo estado
    const estadoActual = data.factura_fisicamente || "NO";
    const nuevoEstado = estadoActual === "SI" ? "NO" : "SI";

    // üíæ 3) Actualizar en la TABLA REAL usando "uuid_cfdi"
    const { error: updateError } = await supabase
      .from("deuda_limpia_pdd")
      .update({ factura_fisicamente: nuevoEstado })
      .eq("uuid_cfdi", uuid); // ‚Üê aqu√≠ S√ç debe ser uuid_cfdi

    if (updateError) {
      console.error("Error al actualizar:", updateError);
      alert("Error al actualizar el estado f√≠sico");
      return;
    }

    // üî• 4) Actualizar en los datos locales usando "uuid"
    const idx = datosCrudos.findIndex(f => f.uuid === uuid);
    if (idx !== -1) {
      datosCrudos[idx].factura_fisicamente = nuevoEstado;
    }

    // ‚ú® 5) Refrescar tabla completa para respetar el filtro
    filtrarPagadas();

    console.log(`Factura f√≠sica actualizada: ${uuid} -> ${nuevoEstado}`);

  } catch (err) {
    console.error("Error inesperado:", err);
    alert("Error inesperado al actualizar factura f√≠sica");
  }
}

async function togglePagada(uuid) {
  try {
    // üîç 1) Obtener estado actual desde la VISTA usando "uuid"
    const { data, error } = await supabase
      .from("v_deuda_proveedores")
      .select("factura_pagada")
      .eq("uuid", uuid)   // ‚Üê CORRECTO
      .single();

    if (error) {
      console.error("Error al leer estado actual:", error);
      alert("Error al leer estado actual de la factura");
      return;
    }

    // üîÑ 2) Determinar nuevo estado
    const estadoActual = data.factura_pagada || "NO";
    const nuevoEstado = estadoActual === "SI" ? "NO" : "SI";

    // üíæ 3) Actualizar en la TABLA REAL usando "uuid_cfdi"
    const { error: updateError } = await supabase
      .from("deuda_limpia_pdd")
      .update({ factura_pagada: nuevoEstado })
      .eq("uuid_cfdi", uuid);  // ‚Üê CORRECTO

    if (updateError) {
      console.error("Error al actualizar:", updateError);
      alert("Error al actualizar el estado de pago: " + updateError.message);
      return;
    }

    // üî• 4) Actualizar en el arreglo local
    const idx = datosCrudos.findIndex(f => f.uuid === uuid);
    if (idx !== -1) {
      datosCrudos[idx].factura_pagada = nuevoEstado;
    }

    // üîÅ 5) Redibujar tabla
    filtrarPagadas();

  } catch(err) {
    console.error("Error inesperado:", err);
    alert("Error inesperado al actualizar el estado");
  }
}

</script>

</body>
</html>
