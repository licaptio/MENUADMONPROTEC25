<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resumen Deudas No Pagadas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      font-size: 0.9em;
    }
    th {
      background-color: #007bff;
      color: white;
      position: sticky;
      top: 0;
    }
    .vencida-30 { background: #fff8e1; }
    .vencida-60 { background: #ffe082; }
    .vencida-90 { background: #ffca28; }
    .vencida-mas { background: #ff7043; color: white; }
    .proveedor-destacado { font-weight: bold; color: #2c3e50; }
    button {
      margin: 1rem 0;
      padding: 10px 20px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background: #218838; }
    td.numero { text-align: right; }
.proveedor-especial {
  background-color: #d0ecff !important; /* azul claro */
  animation: parpadeo 1.6s infinite;
}
@keyframes parpadeo {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}
.proveedor-especial-vencido {
  background-color: #ede7f6 !important; /* Morado claro */
  animation: parpadeo-morado 1.6s infinite;
}

@keyframes parpadeo-morado {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}
.proveedor-contado {
  background-color: #d0f0ff !important; /* celeste claro */
  animation: parpadeo-celeste 1.5s infinite;
  color: #003344;
  font-weight: bold;
}

@keyframes parpadeo-celeste {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}
.fisica-si {
  background: #2ecc71 !important;  /* verde */
  color: white !important;
  font-weight: bold;
  cursor: pointer;
}

.fisica-no {
  background: #e74c3c !important;  /* rojo */
  color: white !important;
  font-weight: bold;
  cursor: pointer;
}
.pagada-reciente {
  background: #e8f5e9 !important; /* verde muy claro */
  opacity: 0.85;
}
  </style>
</head>
<body>
  <h2>ðŸ“Œ Facturas Pendientes</h2>
  
  <div id="tabla"></div>

  <script>
const _supabase = window.supabase.createClient(
  'https://cvpbtjlupswbyxenugpz.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY'
);
const proveedoresEspeciales = {
  "ROBERTO CANTU OZUNA": 12,
  "DECASA DEL CENTRO": 20,
  "DULCES LAS DELICIAS": 28,
  "GUSTAVO MARTINEZ PLATAS": 10,
  "EDDY HERNANDEZ VILLARREAL": 7,
  "DISTRIBUIDORA DE DULCES DEL NORTE": 27,
  "INOCENCIO DELGADO MARQUEZ": 15,
  "DUL-TAM PAVITO": 7,
  "LOCALIZACION ESPECIALIZADA GPS": 2,
  "LUIS FERNANDO KARR GARCIA": 2, 
  "DISTRIBUIDORA DE PRODUCTOS DESHIDRATADOS": 28,
  "DETALLE Y DISTRIBUCIONES": 20,
  "PRODUCTOS VIGAR": 15,
  "DISTRIBUIDORA DE LA ROSA": 15,
  "COMERCIALIZADORA INDUSTRIAL IDALI": 15,
  "MAXILUM": 15,
  "DESFICO": 7,
  "GRUPO CHI-SO": 15,
  "ABARROTES": 25
};
const proveedoresContado = [
  "BBVA MEXICO, S.A., INSTITUCION DE BANCA MULTIPLE, GRUPO FINANCIERO BBVA MEXICO",
  "BANCO SANTANDER MEXICO S.A., INSTITUCION DE BANCA MULTIPLE, GRUPO FINANCIERO SANTANDER MEXICO",
  "MARIA IMELDA CHAPA PARAS",
  "JOSE ANTONIO PEÃ‘A MARTINEZ",
  "COMERCIALIZADORA PEPSICO MEXICO",
  "DISTRIBUIDORA ARCA CONTINENTAL",
  "WINETPC",
  "GASNGO MEXICO",
  "RADIOMOVIL DIPSA",	
  "SERVICIOS GASOLINEROS DE MEXICO",	
  "PEÃ‘AFIEL BEBIDAS",
  "DELIA EUSTOLIA TORRES GARCIA",
  "BONAFONT",
  "BOTANAS Y DERIVADOS",
  "ANDRES EULALIO RAMIREZ CRUZ",
  "TELEFONOS DE MEXICO",
  "LA CACHOTA",
  "DOLORES BRISEÃ‘O MANCHA",
  "COMISION FEDERAL DE ELECTRICIDAD"
];

    const tabla = "deuda_limpia_pdd";
    
    async function cargar() {
const { data, error } = await _supabase
  .from("v_deuda_proveedores")
  .select("*")
  if (error) return alert("Error cargando datos");
const hoy = new Date();

const visibles = data.filter(f => {
  const dias = calcularDias(f.fecha);

  // NO pagadas â†’ siempre visibles
  if ((f.factura_pagada || "NO").toUpperCase() !== "SI") {
    return true;
  }

  // Pagadas â†’ solo si tienen 90 dÃ­as o menos
  return dias <= 90;
});

      //-------------------------------------------------------
// 1) PÃ‰GAS AQUÃ TU ARREGLO VIEJO (DE PRECIOS, FACTURAS, ETC.)
//-------------------------------------------------------
const datosViejos = [
  // Ejemplo:
  // {fecha:"2024-06-10", total:"1200", razon_social_emisor:"ALGO", uuid_cfdi:"---", ...}
  // PÃ‰GAME AQUÃ TODO TU ARREGLO VIEJO
];


//-------------------------------------------------------
// 2) NORMALIZADOR UNIVERSAL PARA UNIR VIEJO + NUEVO
//-------------------------------------------------------
function normalizarFactura(f) {
  return {
    uuid_cfdi: (f.uuid_cfdi || f.uuid || "").trim(),
    fecha: f.fecha ? new Date(f.fecha) : null,
    rfc_emisor: f.rfc_emisor || "",
    razon_social_emisor: f.razon_social_emisor || "",
    factura: f.factura || "",
    serie: f.serie || "",
    total: parseFloat(f.total || 0),
    factura_pagada: (f.factura_pagada || "").toUpperCase().trim(),
    factura_fisicamente: (f.factura_fisicamente || "").toUpperCase().trim(),
    fotos: Array.isArray(f.fotos) ? f.fotos : [],
    // mantener el resto sin afectar
    ...f
  };
}

//-------------------------------------------------------
// 4) UNIR AMBAS FUENTES (VIEJO + NUEVO) NORMALIZADAS
//-------------------------------------------------------
const unidas = [
  ...datosViejos.map(normalizarFactura),
  ...visibles.map(normalizarFactura)
];

//-------------------------------------------------------
// 5) QUITAR DUPLICADOS POR uuid_cfdi
//-------------------------------------------------------
const unicas = Object.values(
  unidas.reduce((acc, f) => {
    const key = f.uuid_cfdi || `${f.rfc_emisor}-${f.factura}-${f.fecha}`;
    if (!acc[key]) acc[key] = f;
    return acc;
  }, {})
);


//-------------------------------------------------------
// 6) ORDENAR POR RFC â†’ FECHA
//-------------------------------------------------------
const ordenadosFinal = unicas.sort((a, b) => {
  const rfcA = (a.rfc_emisor || "").toLowerCase();
  const rfcB = (b.rfc_emisor || "").toLowerCase();
  if (rfcA !== rfcB) return rfcA.localeCompare(rfcB);
  return new Date(a.fecha) - new Date(b.fecha);
});


//-------------------------------------------------------
// 7) YA PUEDES USAR ESTE: ordenadosFinal
//-------------------------------------------------------
mostrarTabla(ordenadosFinal);

    // total solo de NO PAGADAS
const pendientes = ordenadosFinal.filter(f =>
  (f.factura_pagada || "NO") !== "SI"
);

const sumaTotal = pendientes.reduce(
  (acc, f) => acc + (parseFloat(f.total) || 0),
  0
);

// limpiar encabezado previo si existe
document.getElementById("resumen-header")?.remove();

document.getElementById("tabla").insertAdjacentHTML("beforebegin", `
  <div id="resumen-header"
       style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <div>
      <strong>Total visibles:</strong> ${ordenadosFinal.length} registros<br>
      <strong>No pagados:</strong> ${pendientes.length} registros
    </div>

    <div style="text-align:right;">
      <strong style="display:block;">Total $ pendiente:</strong>
      <span style="font-size:1.3em;color:darkgreen;">
        $${sumaTotal.toLocaleString("es-MX", { minimumFractionDigits: 2 })}
      </span>
    </div>
  </div>
`);

const vencidas30 = ordenadosFinal.filter(f =>
  calcularDias(f.fecha) > 30 &&
  (f.factura_pagada || "NO") !== "SI"
);

}

    function mostrarTabla(data) {
      const sumaTotal = data.reduce((acc, f) => acc + (parseFloat(f.total) || 0), 0);
      let html = `<table><thead><tr>
        <th>Fecha</th><th>DÃ­as</th><th>UUID</th><th>RFC</th><th>Proveedor</th>
        <th>Factura</th><th>Total</th><th>FÃ­sica</th><th>Fotos</th>
        <th>Pagada</th>
      </tr></thead><tbody>`;

      for (const f of data) {
        const dias = calcularDias(f.fecha);
        const razon = (f.razon_social_emisor || "").toUpperCase().trim();
let clase = obtenerClaseVencimiento(dias);
// ðŸ”¹ Marcar pagadas recientes (â‰¤ 90 dÃ­as)
if (f.factura_pagada === "SI") {
  clase = "pagada-reciente";
}
if (proveedoresContado.includes(razon)) {
  clase = "proveedor-contado";
}
        if (proveedoresEspeciales[razon]) {
  const limite = proveedoresEspeciales[razon];
  if (dias >= limite && dias < 30) {
    clase = "proveedor-especial-vencido"; // Morado claro y parpadeo
  }
}

        html += `<tr class="${clase}">
          <td>${f.fecha}</td>
          <td>${dias}</td>
          <td><a href="detalle-factura.html?uuid=${f.uuid_cfdi}" target="_blank">${f.uuid_cfdi}</a></td>
          <td>${f.rfc_emisor || '-'}</td>
<!-- PROVEEDOR FINAL -->
<td class="proveedor-destacado">
  ${f.proveedor_unificado || f.razon_social_emisor || f.nombre_emisor || f.rfc_emisor}
</td>

<!-- SERIE / FOLIO FINAL -->
<td>${f.serie_folio || (f.serie ? f.serie + "-" + f.factura : f.factura) || "â€”"}</td>
          <td class="numero">${parseFloat(f.total || 0).toLocaleString("es-MX", { minimumFractionDigits: 2 })}</td>
<td 
  class="${(f.factura_fisicamente === 'SI' ? 'fisica-si' : 'fisica-no')}"
  onclick="toggleFisica('${f.uuid_cfdi}', '${f.factura_fisicamente === 'SI' ? 'SI' : 'NO'}')"
>
  ${f.factura_fisicamente === 'SI' ? 'SI' : 'NO'}
</td>


          <td style="text-align:center">
            ${(Array.isArray(f.fotos) && f.fotos.length)
              ? f.fotos.map(url => `<a href="${url}" target="_blank" title="Ver foto">ðŸ“·</a>`).join(' ')
              : ''}
          </td>
          <td
  style="cursor:pointer;font-weight:bold;
         background:${f.factura_pagada === 'SI' ? '#27ae60' : '#c0392b'};
         color:white;"
  onclick="togglePagada('${f.uuid_cfdi}', '${f.factura_pagada || 'NO'}')"
>
  ${f.factura_pagada === 'SI' ? 'SI' : 'NO'}
</td>

        </tr>`;
      }
      document.getElementById("tabla").innerHTML = html;
    }

    function calcularDias(fecha) {
      const hoy = new Date();
      const f = new Date(fecha);
      return Math.floor((hoy - f) / (1000 * 60 * 60 * 24));
    }

    function obtenerClaseVencimiento(d) {
      if (d > 90) return "vencida-mas";
      if (d > 60) return "vencida-90";
      if (d > 30) return "vencida-60";
      return "vencida-30";
    }



    document.addEventListener("DOMContentLoaded", cargar);
async function toggleFisica(uuid, valorActual) {
  const nuevoValor = valorActual === "SI" ? "NO" : "SI";

  const { error } = await _supabase
    .from('deuda_limpia_pdd')
    .update({ factura_fisicamente: nuevoValor })
    .eq('uuid_cfdi', uuid);

  if (error) {
    alert("Error actualizando factura fÃ­sica");
    console.error(error);
    return;
  }

  // Recargar tabla para mostrar el color actualizado
  cargar();
}
    
async function togglePagada(uuid, valorActual) {
  const nuevoValor = valorActual === "SI" ? "NO" : "SI";

  const { error } = await _supabase
    .from('deuda_limpia_pdd')
    .update({ factura_pagada: nuevoValor })
    .eq('uuid_cfdi', uuid);

  if (error) {
    alert("Error actualizando factura pagada");
    console.error(error);
    return;
  }

  // ðŸ‘‡ para ti es suficiente refrescar
  cargar();
}

  </script>
</body>
</html>
