<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consulta de Facturas por RFC</title>

  <!-- ================================
       [1] LIBRER√çAS
  =================================-->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <!-- ================================
       [2] ESTILOS CSS
  =================================-->
  <style>

  /* =====================================
       2.0 ‚Äî AUTOCOMPLETE
  ======================================*/
.autocomplete-list {
  position: absolute;
  background: white;
  border: 1px solid #ccc;
  width: 250px;
  max-height: 180px;
  overflow-y: auto;
  display: none;
  border-radius: 6px;
  z-index: 10;

  /* üî• ESTA L√çNEA LA AGREGA: BAJA LA LISTA */
  margin-top: 18px; 
}


  .autocomplete-list div {
    padding: 8px;
    cursor: pointer;
  }

  .autocomplete-list div:hover {
    background: #007bff;
    color: white;
  }

  /* =====================================
       2.1 ‚Äî REGLAS BASE
  ======================================*/
  body {
    font-family: sans-serif;
    background: #f4f4f4;
    margin: 0;
    padding: 1rem;
  }

  button {
    margin: 1rem 0;
    padding: 10px 20px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  button:hover { background: #218838; }

  /* =====================================
       2.2 ‚Äî TABLAS (PC)
  ======================================*/
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  th, td {
    padding: 8px;
    border: 1px solid #ccc;
    font-size: 0.9em;
    text-align: left;
  }
  th {
    background-color: #007bff;
    color: white;
  }

  /* =====================================
       2.3 ‚Äî TARJETAS M√ìVIL
  ======================================*/
  @media (max-width: 768px) {
    table, thead, tbody, th, td, tr { display: block; }
    thead { display: none; }

    tr {
      margin-bottom: 18px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,.08);
      padding: 12px 15px;
      border: 1px solid #e0e0e0;
    }

    td {
      border: none;
      border-bottom: 1px dashed #ddd;
      padding: 10px 6px;
      font-size: 0.95rem;
    }

    td:last-child { border-bottom: none; }
  }
@media (max-width: 768px) {

  td {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    text-align: right;
    position: relative;
  }

  td::before {
    content: attr(data-label);
    font-weight: bold;
    text-transform: capitalize;
    color: #555;
    flex-basis: 50%;
    text-align: left;
  }
}

  /* =====================================
       2.4 ‚Äî TARJETA DETALLE
  ======================================*/
  .card {
    background: #fff;
    margin: 12px 0;
    padding: 14px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    border: 1px solid #e0e0e0;
    font-size: 0.95rem;
  }
.badge-toggle {
  display: inline-block;
  padding: 6px 14px;
  color: white;
  border-radius: 12px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: bold;
  user-select: none;
}

.badge-si {
  background: #28a745;
}

.badge-no {
  background: #dc3545;
}

</style>
</head>
<body>

<h2>üîç Consulta de Facturas por RFC</h2>

<!-- =====================================
     [3] INPUT RFC + AUTOCOMPLETE
======================================-->
<label><strong>RFC:</strong></label>
<input type="text" id="rfcFiltro" placeholder="Escribe RFC‚Ä¶" oninput="autocompleteRFC()" autocomplete="off">
<div id="sugerenciasRFC" class="autocomplete-list"></div>

<!-- =====================================
     [4] INPUT NOMBRE + AUTOCOMPLETE
======================================-->
<input type="text" id="nombreFiltro" placeholder="Escribe Nombre‚Ä¶" oninput="autocompleteNombre()" autocomplete="off">
<div id="sugerenciasNombre" class="autocomplete-list"></div>

<button onclick="consultarPorRFC()">üîé Consultar</button>

<div id="resumenConteo" style="margin-top: 1rem; font-weight: bold;"></div>
<div id="tablaResultados"></div>

<!-- =====================================
     [5] L√ìGICA JAVASCRIPT
======================================-->
<script>

const supabase = window.supabase.createClient(
  "https://cvpbtjlupswbyxenugpz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
);

const tabla = "deuda_limpia_pdd";
let datosCrudos = [];
let listaBusqueda = [];

/* =====================================
   5.1 CARGAR RFC + NOMBRE
======================================*/
async function cargarRFCs() {
  const { data, error } = await supabase
    .from("v_deuda_proveedores")
    .select("rfc_emisor, proveedor_unificado, razon_social_emisor, nombre_emisor")
    .not("rfc_emisor", "is", null)
    .order("rfc_emisor");

  if (error) {
    alert("Error al cargar lista de proveedores");
    return;
  }

  console.log("Total de registros obtenidos:", data.length);
  
  // DEBUG: Mostrar el RFC espec√≠fico
  const rfcEspecifico = data.filter(x => 
    x.rfc_emisor && x.rfc_emisor.includes("PPC0311111KA")
  );
  console.log("DEBUG - RFC PPC0311111KA encontrado:", rfcEspecifico);

  // Usar Map para evitar duplicados
  const mapaUnico = new Map();

  data.forEach(x => {
    if (!x.rfc_emisor) return;

    const rfc = x.rfc_emisor.toUpperCase().trim();
    
    // Determinar el mejor nombre disponible
    let nombre = "";
    if (x.proveedor_unificado && x.proveedor_unificado.trim() !== "") {
      nombre = x.proveedor_unificado;
    } else if (x.razon_social_emisor && x.razon_social_emisor.trim() !== "") {
      nombre = x.razon_social_emisor;
    } else if (x.nombre_emisor && x.nombre_emisor.trim() !== "") {
      nombre = x.nombre_emisor;
    } else {
      nombre = rfc;
    }

    // Solo guardar si no existe o si el nombre es m√°s completo
    if (!mapaUnico.has(rfc) || nombre.length > mapaUnico.get(rfc).length) {
      mapaUnico.set(rfc, nombre.toUpperCase().trim());
    }
  });

  // Convertir a array
  listaBusqueda = Array.from(mapaUnico, ([rfc, nombre]) => ({
    rfc: rfc,
    nombre: nombre
  }));

  // Ordenar alfab√©ticamente por RFC
  listaBusqueda.sort((a, b) => a.rfc.localeCompare(b.rfc));

  console.log("Lista de b√∫squeda creada con:", listaBusqueda.length, "proveedores √∫nicos");
  
  // DEBUG: Mostrar los primeros 5
  console.log("Primeros 5 RFCs:", listaBusqueda.slice(0, 5));
}
cargarRFCs();   // ‚úî CORRECTO


/* =====================================
   5.2 AUTOCOMPLETE RFC
======================================*/
function autocompleteRFC() {
  const txt = rfcFiltro.value.trim().toUpperCase();
  const lista = document.getElementById("sugerenciasRFC");

  lista.innerHTML = "";
  
  if (txt.length < 2) {
    lista.style.display = "none";
    return;
  }

  console.log("Buscando:", txt);
  console.log("En lista de", listaBusqueda.length, "proveedores");

  // B√∫squeda simple y directa
  const resultados = listaBusqueda.filter(x => {
    // Buscar en RFC (exacto o parcial)
    if (x.rfc && x.rfc.includes(txt)) return true;
    
    // Buscar en nombre (sin normalizar para mantener tildes)
    if (x.nombre && x.nombre.includes(txt)) return true;
    
    // Buscar sin acentos en nombre (opcional)
    const nombreSinAcentos = x.nombre.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    if (nombreSinAcentos.includes(txt.normalize("NFD").replace(/[\u0300-\u036f]/g, ""))) {
      return true;
    }
    
    return false;
  });

  console.log("Resultados encontrados:", resultados.length);

  if (resultados.length === 0) {
    lista.style.display = "none";
    return;
  }

  // Mostrar resultados
  resultados.slice(0, 15).forEach(x => {
    const div = document.createElement("div");
    div.textContent = `${x.rfc} ‚Äî ${x.nombre}`;
    div.onclick = () => {
      rfcFiltro.value = x.rfc;
      nombreFiltro.value = x.nombre;
      window.rfcSeleccionado = x.rfc;
      lista.style.display = "none";
    };
    lista.appendChild(div);
  });

  lista.style.display = "block";
}
/* =====================================
   5.3 AUTOCOMPLETE NOMBRE
======================================*/
function autocompleteNombre() {
  const txt = nombreFiltro.value.toUpperCase().trim();
  const lista = document.getElementById("sugerenciasNombre");

  lista.innerHTML = "";

  if (txt.length < 1) {
    lista.style.display = "none";
    return;
  }

  // Fuzzy-lite: permite errores de letras
  const normalizado = txt.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

  const resultados = listaBusqueda.filter(x => {
    const nom = (x.nombre || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const rfc = x.rfc || "";

    return (
      nom.includes(normalizado) ||         // por nombre
      rfc.includes(normalizado) ||        // por RFC
      nom.replace(/\s+/g, '').includes(normalizado.replace(/\s+/g, '')) // fuzzy-lite
    );
  });

  resultados.forEach(x => {
    let div = document.createElement("div");
    div.textContent = `${x.nombre} ‚Äî ${x.rfc}`;
    div.onclick = () => {
      nombreFiltro.value = x.nombre;
      window.rfcSeleccionado = x.rfc;
      lista.style.display = "none";
    };
    lista.appendChild(div);
  });

  lista.style.display = "block";
}

/* =====================================
   5.4 CONSULTAR FACTURAS SOLO POR PROVEEDOR
======================================*/
async function consultarPorRFC() {

  // Obtenemos el RFC seleccionado desde autocompleteNombre()
  let rfc = window.rfcSeleccionado;

// Detecci√≥n autom√°tica si el usuario NO clicke√≥ nada:
if (!rfc) {
  const txt = nombreFiltro.value.toUpperCase().trim();
  const encontrado = listaBusqueda.find(x =>
    x.nombre.includes(txt) || x.rfc.includes(txt)
  );
  if (encontrado) rfc = encontrado.rfc;
}


  if (!rfc) {
    alert("Selecciona un proveedor v√°lido de la lista");
    return;
  }

  document.getElementById("tablaResultados").innerHTML = "";
  document.getElementById("resumenConteo").innerText = "";

  // √∫ltimos 60 d√≠as
  const hoy = new Date();
  const limite = new Date();
  limite.setDate(hoy.getDate() - 99);
  const limiteISO = limite.toISOString().split("T")[0];

  // contar registros
const { count, error: errorConteo } = await supabase
  .from("v_deuda_proveedores")
  .select("*", { count: "exact", head: true })
  .eq("rfc_emisor", rfc)
  .gte("fecha", limiteISO);

  if (errorConteo) {
    alert("Error al contar registros");
    return;
  }

  // consultar facturas
const { data: facturas, error } = await supabase
  .from("v_deuda_proveedores")
  .select("*")
  .eq("rfc_emisor", rfc)
  .gte("fecha", limiteISO)
  .order("fecha", { ascending: true });

  if (error) {
    alert("Error al traer facturas");
    return;
  }

  datosCrudos = facturas;

  document.getElementById("resumenConteo").innerText =
    `üî¢ Total: ${count}\nüìÑ Mostrados: ${facturas.length}`;

  mostrarTabla(datosCrudos);
}

  
function mostrarTabla(data) {
  let html = `<table><thead><tr>
    <th>Fecha</th>
    <th>D√≠as</th>
    <th>UUID</th>
    <th>RFC</th>
    <th>Proveedor</th>
    <th>Total</th>
    <th>Serie/Folio</th>
    <th>üì∑ Fotos</th>
  </tr></thead><tbody>`;

  data.forEach(f => {

    const uuid = f.uuid_cfdi || f.uuid;

    let proveedor = f.proveedor_unificado;
    if (f.razon_social_emisor && f.razon_social_emisor.trim() !== "") {
      proveedor = f.razon_social_emisor;
    } else if (f.nombre_emisor && f.nombre_emisor.trim() !== "") {
      proveedor = f.nombre_emisor;
    } else {
      proveedor = f.rfc_emisor;
    }

    html += `
<tr>
  <td>${formatearFecha(f.fecha)}</td>
  <td>${f.dias}</td>

<td>
  <a href="detalle.html?uuid=${uuid}" target="_blank" style="color:#007bff;">
    ${uuid}
  </a>
</td>


  <td>${f.rfc_emisor}</td>
  <td>${proveedor}</td>
  <td>${monedaMXN(f.total)}</td>
  <td>${f.serie_folio || "‚Äî"}</td>

  <td>
    ${
      (f.fotos && f.fotos.length > 0)
      ? f.fotos.map(url => `<a href="${url}" target="_blank">üì∑</a>`).join(" ")
      : "‚Äî"
    }
  </td>
</tr>
`;
  });

  html += "</tbody></table>";
  document.getElementById("tablaResultados").innerHTML = html;
}

function calcDiasDesdeHoy(iso){
  const f = new Date(iso);
  const h = new Date();
  return Math.floor((h - f) / 1000 / 60 / 60 / 24);
}
function formatearFecha(fechaISO) {
  const fecha = new Date(fechaISO);
  const dia = String(fecha.getDate()).padStart(2, '0');
  const mes = String(fecha.getMonth() + 1).padStart(2, '0');
  const a√±o = fecha.getFullYear();
  return `${dia}/${mes}/${a√±o}`;
}
function monedaMXN(valor) {
  return Number(valor).toLocaleString('es-MX', {
    style: 'currency',
    currency: 'MXN'
  });
}
</script>

</body>
</html>


