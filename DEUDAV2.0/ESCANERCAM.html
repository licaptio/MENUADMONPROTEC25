<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Esc√°ner QR CFDI SAT</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <!-- Librer√≠a c√°mara QR -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <!-- Estilos -->
  <style>
    body { font-family: sans-serif; padding: 1rem; max-width: 600px; margin: auto; }
    input, select, button { width: 100%; margin: 10px 0; padding: 10px; font-size: 1rem; }
    #result { background: #eef; padding: 10px; border-radius: 6px; margin-top: 20px; display: none; }
    #uuidDetectado { font-weight: bold; color: #003366; margin-top: 10px; }
    footer {
      position: fixed;
      bottom: 0;
      right: 0;
      padding: 6px 12px;
      font-size: 0.8em;
      color: #777;
      background: #f5f5f5;
      border-top-left-radius: 8px;
      box-shadow: -2px -2px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h2>Escanear CFDI con QR (SAT)</h2>

  <!-- C√°mara -->
  <div id="lectorQR" style="width:100%; max-width:400px; margin:auto;"></div>

  <button onclick="guardarCambios()" style="background-color: green; color: white; width: 100%; margin-top: 5px;">
    Guardar Cambios
  </button>

  <div id="uuidDetectado"></div>

  <!-- Datos de la factura -->
  <div id="result">
    <h3>Factura encontrada</h3>
    <p><strong>UUID:</strong> <span id="uuidTexto"></span></p>
    <p><strong>Fecha:</strong> <span id="fechaTexto"></span></p>
    <p><strong>RFC Emisor:</strong> <span id="rfcTexto"></span></p>
    <p><strong>Raz√≥n Social:</strong> <span id="razonTexto"></span></p>
    <p><strong>Factura:</strong> <span id="facturaTexto"></span></p>
    <p><strong>Total:</strong> $<span id="totalTexto"></span></p>
    <p><strong>Pagada:</strong> <span id="pagadaTexto"></span></p>

    <!-- F√≠sico -->
    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
      <label for="fisicaTexto" style="min-width: 60px;"><strong>F√≠sica:</strong></label>
      <select id="fisicaTexto" style="width: 100px; padding: 6px;">
        <option value="NO">NO</option>
        <option value="SI">S√ç</option>
      </select>
    </div>

    <!-- Comentario -->
    <div style="margin-top: 10px;">
      <label for="comentarioTexto"><strong>Comentario:</strong></label>
      <textarea id="comentarioTexto"
                rows="4"
                placeholder="Factura f√≠sica recibida completa, pero sin comentarios"
                style="width: 100%; font-size: 1rem; padding: 8px; border-radius: 6px;"></textarea>
    </div>

    <!-- Galer√≠a fotos -->
    <div id="galeriaFotos" style="margin-top: 20px;">
      <h4>Fotos adjuntas:</h4>
      <div id="contenedorFotos" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
      <input type="file" id="fotoExterna" accept="image/*" capture="environment" style="display: none;" />
      <button onclick="document.getElementById('fotoExterna').click()" style="flex: 1;">üì∏ Tomar Foto</button>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    const supabaseClient = window.supabase.createClient(
      "https://cvpbtjlupswbyxenugpz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
    );

    let uuidActual = null;
    let html5QrCode = null;

    async function buscarPorUUID(uuid) {
      const { data, error } = await supabaseClient
        .from("deuda_limpia_pdd")
        .select("*")
        .eq("uuid_cfdi", uuid)
        .maybeSingle();

      if (error || !data) {
        alert("Factura no encontrada");
        return;
      }

      document.getElementById("result").style.display = "block";
      document.getElementById("uuidTexto").innerText = uuid;
      document.getElementById("fechaTexto").innerText = new Date(data.fecha).toLocaleString();
      document.getElementById("rfcTexto").innerText = data.rfc_emisor;
      document.getElementById("razonTexto").innerText = data.razon_social_emisor;
      document.getElementById("facturaTexto").innerText = data.factura;
      document.getElementById("totalTexto").innerText = parseFloat(data.total).toFixed(2);
      document.getElementById("pagadaTexto").innerText = data.factura_pagada || "NO";
      document.getElementById("fisicaTexto").value = "SI";
      document.getElementById("comentarioTexto").value = data.comentario_factura_fisica || "";
      document.getElementById("contenedorFotos").innerHTML = "";
      uuidActual = uuid;

      mostrarFotos(data.fotos);
    }

    function normalizaCfdiQR(raw) {
      let s = (raw || "").trim();
      s = s.replace(/https√ë--/gi, "https://");
      s = s.replace(/√ë/g, ":");
      s = s.replace(/¬°/g, "=");
      s = s.replace(/[‚Äô'¬¥`]/g, "-");
      s = s.replace(/\s+/g, " ");
      return s;
    }

    function extraeUUID(raw) {
      const s = normalizaCfdiQR(raw);
      let m = s.match(/id\s*=\s*([a-f0-9\-]{32,40})/i);
      if (!m) m = s.match(/id\s*=\s*([a-f0-9]{16,})/i);
      if (m && m[1]) {
        let v = m[1].toUpperCase().replace(/[^A-F0-9\-]/g, "");
        const soloHex = v.replace(/-/g, "");
        if (soloHex.length === 32) {
          v = [soloHex.slice(0,8), soloHex.slice(8,12), soloHex.slice(12,16), soloHex.slice(16,20), soloHex.slice(20)].join("-");
        }
        if (/^[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}$/.test(v)) return v;
      }
      return null;
    }

    function mostrarFotos(fotos) {
      const contenedor = document.getElementById("contenedorFotos");
      contenedor.innerHTML = "";
      if (Array.isArray(fotos) && fotos.length > 0) {
        fotos.forEach(url => {
          const wrapper = document.createElement("div");
          wrapper.style.position = "relative";
          const img = document.createElement("img");
          img.src = url;
          img.style.width = "100px";
          img.style.border = "1px solid #ccc";
          img.style.borderRadius = "4px";
          const btn = document.createElement("button");
          btn.innerText = "‚úñ";
          btn.style.position = "absolute";
          btn.style.top = "-8px";
          btn.style.right = "-8px";
          btn.style.background = "crimson";
          btn.style.color = "white";
          btn.onclick = () => eliminarFoto(url);
          wrapper.appendChild(img);
          wrapper.appendChild(btn);
          contenedor.appendChild(wrapper);
        });
      }
    }

    async function eliminarFoto(urlEliminar) {
      if (!confirm("¬øEliminar esta imagen?")) return;
      const { data: filaActual } = await supabaseClient
        .from("deuda_limpia_pdd")
        .select("fotos")
        .eq("uuid_cfdi", uuidActual)
        .maybeSingle();

      const nuevasFotos = filaActual.fotos.filter(foto => foto !== urlEliminar);
      await supabaseClient
        .from("deuda_limpia_pdd")
        .update({ fotos: nuevasFotos })
        .eq("uuid_cfdi", uuidActual);
      buscarPorUUID(uuidActual);
    }

    async function guardarCambios() {
      if (!uuidActual) return;
      const fisica = document.getElementById("fisicaTexto").value;
      const comentario = document.getElementById("comentarioTexto").value;

      // üëâ Crear mensaje flotante
      let guardandoMsg = document.getElementById("mensajeGuardando");
      if (!guardandoMsg) {
        guardandoMsg = document.createElement("div");
        guardandoMsg.id = "mensajeGuardando";
        document.body.appendChild(guardandoMsg);
      }
      guardandoMsg.textContent = "Guardando...";
      guardandoMsg.style.position = "fixed";
      guardandoMsg.style.top = "10px";
      guardandoMsg.style.right = "10px";
      guardandoMsg.style.background = "#007700";
      guardandoMsg.style.color = "white";
      guardandoMsg.style.padding = "10px 20px";
      guardandoMsg.style.borderRadius = "6px";
      guardandoMsg.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";
      guardandoMsg.style.zIndex = "9999";

      // üëâ Pausa artificial (1 segundo)
      await new Promise(resolve => setTimeout(resolve, 1000));

      const { error } = await supabaseClient
        .from("deuda_limpia_pdd")
        .update({ factura_fisicamente: fisica, comentario_factura_fisica: comentario })
        .eq("uuid_cfdi", uuidActual);

      if (error) {
        guardandoMsg.textContent = "‚ùå Error al guardar";
        guardandoMsg.style.background = "#990000";
      } else {
        guardandoMsg.textContent = "‚úÖ Guardado correctamente";
        guardandoMsg.style.background = "#007700";
        limpiarFormulario(); // üëà reinicia el esc√°ner despu√©s de guardar
      }

      // üëâ Quitar mensaje despu√©s de 2 segundos
      setTimeout(() => {
        if (guardandoMsg) guardandoMsg.remove();
      }, 2000);
    }

    function limpiarFormulario() {
      uuidActual = null;
      document.getElementById("result").style.display = "none";
      document.getElementById("uuidDetectado").innerText = "";
      iniciarScanner(); // üëà reinicia la c√°mara
    }

    function iniciarScanner() {
      // Si ya hab√≠a un esc√°ner, destruirlo primero
      if (html5QrCode) {
        html5QrCode.stop().catch(() => {});
        html5QrCode.clear(); // üëà limpia el div
      }

      html5QrCode = new Html5Qrcode("lectorQR");

      Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
          html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            qrCodeMessage => {
              document.getElementById("uuidDetectado").innerText = `UUID detectado: ${qrCodeMessage}`;
              const uuid = extraeUUID(qrCodeMessage);
              if (uuid) buscarPorUUID(uuid);
              html5QrCode.stop().catch(() => {}); // se pausa hasta guardar
            }
          );
        }
      });
    }

    window.addEventListener("load", iniciarScanner);
  </script>

  <footer>
    v1.0 miley cirrus
  </footer>
</body>
</html>
