<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Esc√°ner QR CFDI SAT</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <!-- Librer√≠a c√°mara QR -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <!-- Estilos -->
  <style>
    body { font-family: sans-serif; padding: 1rem; max-width: 600px; margin: auto; }
    input, select, button { width: 100%; margin: 10px 0; padding: 10px; font-size: 1rem; }
    #result { background: #eef; padding: 10px; border-radius: 6px; margin-top: 20px; display: none; }
    #uuidDetectado { font-weight: bold; color: #003366; margin-top: 10px; }
    #lectorQR { margin-top: 15px; }
    footer {
      position: fixed;
      bottom: 0;
      right: 0;
      padding: 6px 12px;
      font-size: 0.8em;
      color: #777;
      background: #f5f5f5;
      border-top-left-radius: 8px;
      box-shadow: -2px -2px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h2>Escanear CFDI con QR (SAT)</h2>

  <!-- Bot√≥n para iniciar esc√°ner -->
  <button onclick="iniciarScanner()" style="background-color: #0044cc; color: white;">
    üì∑ Iniciar Esc√°ner
  </button>

  <!-- C√°mara -->
  <div id="lectorQR" style="width:100%; max-width:400px; margin:auto;"></div>

  <button onclick="guardarCambios()" style="background-color: green; color: white; width: 100%; margin-top: 5px;">
    Guardar Cambios
  </button>

  <div id="uuidDetectado"></div>

  <!-- Datos de la factura -->
  <div id="result">
    <h3>Factura encontrada</h3>
    <p><strong>UUID:</strong> <span id="uuidTexto"></span></p>
    <p><strong>Fecha:</strong> <span id="fechaTexto"></span></p>
    <p><strong>RFC Emisor:</strong> <span id="rfcTexto"></span></p>
    <p><strong>Raz√≥n Social:</strong> <span id="razonTexto"></span></p>
    <p><strong>Factura:</strong> <span id="facturaTexto"></span></p>
    <p><strong>Total:</strong> $<span id="totalTexto"></span></p>
    <p><strong>Pagada:</strong> <span id="pagadaTexto"></span></p>

    <!-- F√≠sico -->
    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
      <label for="fisicaTexto" style="min-width: 60px;"><strong>F√≠sica:</strong></label>
      <select id="fisicaTexto" style="width: 100px; padding: 6px;">
        <option value="NO">NO</option>
        <option value="SI">S√ç</option>
      </select>
    </div>

    <!-- Comentario -->
    <div style="margin-top: 10px;">
      <label for="comentarioTexto"><strong>Comentario:</strong></label>
      <textarea id="comentarioTexto"
                rows="4"
                placeholder="Factura f√≠sica recibida completa, pero sin comentarios"
                style="width: 100%; font-size: 1rem; padding: 8px; border-radius: 6px;"></textarea>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    const supabaseClient = window.supabase.createClient(
      "https://cvpbtjlupswbyxenugpz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
    );

    let uuidActual = null;
    let html5QrCode = null;

    async function buscarPorUUID(uuid) {
      const { data, error } = await supabaseClient
        .from("deuda_limpia_pdd")
        .select("*")
        .eq("uuid_cfdi", uuid)
        .maybeSingle();

      if (error || !data) {
        alert("Factura no encontrada");
        return;
      }

      document.getElementById("result").style.display = "block";
      document.getElementById("uuidTexto").innerText = uuid;
      document.getElementById("fechaTexto").innerText = new Date(data.fecha).toLocaleString();
      document.getElementById("rfcTexto").innerText = data.rfc_emisor;
      document.getElementById("razonTexto").innerText = data.razon_social_emisor;
      document.getElementById("facturaTexto").innerText = data.factura;
      document.getElementById("totalTexto").innerText = parseFloat(data.total).toFixed(2);
      document.getElementById("pagadaTexto").innerText = data.factura_pagada || "NO";
      uuidActual = uuid;
    }

    function extraeUUID(raw) {
      let m = raw.match(/id\s*=\s*([a-f0-9\-]{32,40})/i);
      if (!m) m = raw.match(/id\s*=\s*([a-f0-9]{16,})/i);
      if (m && m[1]) {
        let v = m[1].toUpperCase().replace(/[^A-F0-9\-]/g, "");
        const soloHex = v.replace(/-/g, "");
        if (soloHex.length === 32) {
          v = [soloHex.slice(0,8), soloHex.slice(8,12), soloHex.slice(12,16), soloHex.slice(16,20), soloHex.slice(20)].join("-");
        }
        if (/^[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}$/.test(v)) return v;
      }
      return null;
    }

    async function guardarCambios() {
      if (!uuidActual) return;
      const fisica = document.getElementById("fisicaTexto").value;
      const comentario = document.getElementById("comentarioTexto").value;

      const { error } = await supabaseClient
        .from("deuda_limpia_pdd")
        .update({ factura_fisicamente: fisica, comentario_factura_fisica: comentario })
        .eq("uuid_cfdi", uuidActual);

      if (error) {
        alert("‚ùå Error al guardar");
      } else {
        alert("‚úÖ Guardado correctamente");
        regresarInicio();
      }
    }

    function regresarInicio() {
      uuidActual = null;
      document.getElementById("result").style.display = "none";
      document.getElementById("uuidDetectado").innerText = "";
      document.getElementById("lectorQR").innerHTML = ""; // limpia c√°mara
    }

    function iniciarScanner() {
      regresarInicio();
      html5QrCode = new Html5Qrcode("lectorQR");

      Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
          html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            qrCodeMessage => {
              document.getElementById("uuidDetectado").innerText = `UUID detectado: ${qrCodeMessage}`;
              const uuid = extraeUUID(qrCodeMessage);
              if (uuid) buscarPorUUID(uuid);
              html5QrCode.stop().catch(() => {});
            }
          );
        }
      });
    }
  </script>

  <footer>
    powered by PROVSOFT
  </footer>
</body>
</html>
