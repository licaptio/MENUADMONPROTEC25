<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Buscar por Folio Tecnopro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root{
      --azul:#003366; --link:#0d6efd;
      --bg:#f3f6fa; --card:#fff; --borde:#d9e3f0;
    }
    *{ box-sizing:border-box }
    body{
      font-family:'Segoe UI',system-ui,Arial; background:var(--bg);
      padding:16px; margin:0; color:#1b1f24;
    }
    h2{ color:var(--azul); text-align:center; margin:6px 0 16px }

    .buscador{
      display:flex; gap:10px; max-width:900px; margin:0 auto 14px;
      background:var(--card); padding:12px; border-radius:10px; box-shadow:0 0 8px rgba(0,0,0,.06);
      align-items:center; border:1px solid var(--borde);
    }
    .buscador label{ font-weight:600; color:var(--azul); white-space:nowrap }
    .buscador input{
      flex:1; padding:12px 14px; border:1px solid #c9d7ee; border-radius:10px; font-size:16px;
    }
    .buscador button{
      padding:12px 16px; border:0; border-radius:10px; background:var(--link); color:#fff; font-weight:700; cursor:pointer;
    }
    .buscador button:disabled{ opacity:.6; cursor:not-allowed }

    .info{
      position:relative; background:#fff; border-radius:10px; padding:16px;
      box-shadow:0 0 8px rgba(0,0,0,.08); margin:0 auto; max-width:900px; border:1px solid var(--borde)
    }
    .campo{ margin-bottom:10px }
    .campo span{ font-weight:700; color:var(--azul) }
    .campo-inline{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    #uuidText{ word-break:break-all }
    a{ color:var(--link) }

    .tabla-wrapper{ overflow-x:auto; margin-top:10px }
    table{ width:100%; border-collapse:collapse; min-width:640px; background:#fff }
    th,td{ border:1px solid #e5e7eb; padding:6px 8px; text-align:center; font-size:.92rem }
    thead tr{ background:#dbe5f1; color:var(--azul) }
    tfoot tr{ background:#f1f5f9 }
    .acciones{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap }

    .folio-chip{
      position:absolute; top:12px; right:14px;
      background:#fff; border:1px dashed #9db3d1; border-radius:10px; padding:8px 12px; color:#334155;
      font-weight:600; box-shadow:0 6px 16px rgba(0,0,0,.06)
    }

    .vacio, .error{
      max-width:900px; margin:12px auto; padding:14px; border-radius:10px; text-align:center;
      border:1px solid #e5e7eb; background:#fff;
    }
    .error{ border-color:#fecaca; background:#fff1f2; color:#991b1b }
    .hint{ font-size:.86rem; color:#6b7280; margin:6px 0 0 2px }
  </style>
</head>
<body>
  <h2>Buscar Factura por Folio Tecnopro</h2>

  <div class="buscador">
    <label for="folioTec">Folio Tecnopro</label>
    <input id="folioTec" type="text" inputmode="numeric" maxlength="7" placeholder="hasta 7 dígitos (ej. 0024100)">
    <button id="btnBuscar" type="button">Buscar</button>
  </div>
  <p class="hint" style="max-width:900px;margin:0 auto 12px;">
    Consejo: pega el folio, el campo deja sólo dígitos y lo rellena a 7 posiciones automáticamente.
  </p>

  <div id="resultado"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // -------- CONFIG --------
    const supabaseUrl = "https://cvpbtjlupswbyxenugpz.supabase.co";
    const apiKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"; // anon
    const TABLA = "deuda_limpia_pdd";
    const supa = window.supabase.createClient(supabaseUrl, apiKey);

    const $folio = document.getElementById('folioTec');
    const $btn   = document.getElementById('btnBuscar');
    const $res   = document.getElementById('resultado');

    // Limpia a dígitos y limita a 7
    $folio.addEventListener('input', e=>{
      e.target.value = e.target.value.replace(/\D+/g,'').slice(0,7);
    });
    // Enter = buscar
    $folio.addEventListener('keydown', e=>{ if(e.key==='Enter') $btn.click() });

    $btn.addEventListener('click', buscar);

    async function buscar(){
      const raw = ($folio.value||'').trim();
      if(!raw){ pintaError("Ingresa un folio Tecnopro"); return; }

      const padded = raw.padStart(7,'0');
      $btn.disabled = true; $btn.textContent = 'Buscando…';
      $res.innerHTML = '';

      try{
        // 1) intenta con padding (7 dígitos)
        let fila = await consultaPorFolio(padded);
        // 2) si no hay, intenta sin padding (por si hay registros antiguos)
        if(!fila) fila = await consultaPorFolio(raw);

        if(!fila){ pintaVacio("No se encontró una factura con ese Folio Tecnopro."); return; }

        pintaDetalle(fila);
      }catch(err){
        console.error(err);
        pintaError("Ocurrió un error al buscar. Revisa la consola.");
      }finally{
        $btn.disabled = false; $btn.textContent = 'Buscar';
      }
    }

    async function consultaPorFolio(valor){
      const url = `${supabaseUrl}/rest/v1/${TABLA}?select=*&foliotecnopro=eq.${encodeURIComponent(valor)}`;
      const r = await fetch(url, { headers:{apikey:apiKey} });
      const j = await r.json();
      if(Array.isArray(j) && j.length) return j[0];
      return null;
    }

    function pintaVacio(msg){
      $res.innerHTML = `<div class="vacio">${msg}</div>`;
    }
    function pintaError(msg){
      $res.innerHTML = `<div class="error">${msg}</div>`;
    }

    function pintaDetalle(f){
      const formatoPesos = new Intl.NumberFormat('es-MX', {style:'currency', currency:'MXN'});
      let subtotal = 0, impuestos = 0, conceptosHTML = '';

      if(Array.isArray(f.conceptos_detalle)){
        for(const c of f.conceptos_detalle){
          const qty  = Number(c.cantidad||0);
          const cu   = Number(c.costoUnitario||0);
          const tasa = Number(c.tasaImpuesto||0);
          const sinImp = qty*cu;
          const imp    = sinImp*tasa;
          subtotal += sinImp; impuestos += imp;
          conceptosHTML += `
            <tr>
              <td>${qty}</td>
              <td>${c.codigoSAT ?? ''}</td>
              <td style="text-align:left">${c.descripcion ?? ''}</td>
              <td>$${cu.toFixed(2)}</td>
              <td>${(tasa*100).toFixed(2)}%</td>
              <td>$${sinImp.toFixed(2)}</td>
            </tr>`;
        }
      }

      const fotoHTML = (Array.isArray(f.fotos) && f.fotos[0])
        ? `<div class="campo"><span>Foto:</span> <a href="${f.fotos[0]}" target="_blank" rel="noopener">Ver imagen</a></div>`
        : '';

      $res.innerHTML = `
        <div class="info">
          <div class="folio-chip">Folio Tecnopro: <strong>${f.foliotecnopro ?? '-'}</strong></div>

          <div class="campo campo-inline">
            <span>UUID:</span>
            <span id="uuidText">${f.uuid_cfdi ?? '-'}</span>
          </div>
          <div class="campo"><span>Factura:</span> ${f.factura ?? '-'}</div>
          <div class="campo"><span>Razón Social Emisor:</span> ${f.razon_social_emisor ?? '-'}</div>
          <div class="campo"><span>RFC Emisor:</span> ${f.rfc_emisor ?? '-'}</div>
          <div class="campo"><span>Fecha:</span> ${f.fecha ? new Date(f.fecha).toLocaleDateString('es-MX') : '-'}</div>
          <div class="campo"><span>Total:</span> ${formatoPesos.format(Number(f.total||0))}</div>
          ${fotoHTML}

          <div class="campo"><span>Conceptos:</span></div>
          <div class="tabla-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Cantidad</th><th>Código SAT</th><th>Descripción</th>
                  <th>Costo Unitario</th><th>Impuesto</th><th>Subtotal</th>
                </tr>
              </thead>
              <tbody>
                ${conceptosHTML || `<tr><td colspan="6">No hay conceptos registrados.</td></tr>`}
              </tbody>
              <tfoot>
                <tr><td colspan="5" style="text-align:right;font-weight:700">SUBTOTAL</td><td>${formatoPesos.format(subtotal)}</td></tr>
                <tr><td colspan="5" style="text-align:right;font-weight:700">IVA</td><td>${formatoPesos.format(impuestos)}</td></tr>
                <tr style="background:#003366;color:#fff">
                  <td colspan="5" style="text-align:right;font-weight:700">TOTAL</td>
                  <td>${formatoPesos.format(subtotal+impuestos)}</td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="acciones">
            ${f.uuid_cfdi ? `<a class="btn" href="./detalle.html?uuid=${encodeURIComponent(f.uuid_cfdi)}" target="_blank" rel="noopener">Abrir detalle por UUID ↗</a>` : ''}
            ${f.factura ? `<a class="btn" href="./detalle.html?folio=${encodeURIComponent(f.factura)}" target="_blank" rel="noopener">Abrir detalle por Factura ↗</a>` : ''}
          </div>
        </div>
      `;
    }
  </script>
</body>
</html>
