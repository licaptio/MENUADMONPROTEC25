<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Detalle de Factura</title>
  <!-- üëá Esto hace que en m√≥vil se vea bien -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f3f6fa;
      padding: 15px;
      max-width: 900px;
      margin: auto;
    }
    h2 {
      color: #003366;
      text-align: center;
      margin-bottom: 20px;
    }
    .info {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      font-size: 0.95rem;
    }
    .campo { margin-bottom: 10px; }
    .campo span { font-weight: bold; color: #003366; }

    /* üëâ UUID en l√≠nea con bot√≥n */
    .campo-inline {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap; /* si el UUID es largo, permite salto ordenado */
    }
    #uuidText { word-break: break-all; }

    .error { color: red; font-weight: bold; }
    a { color: #0066cc; word-break: break-word; }

    .upload-box {
      background: #fff;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .upload-box h3 { margin: 0 0 10px; font-size: 1rem; color: #003366; }
    input[type="file"] {
      display: block;
      margin: 10px 0;
      font-size: 1rem;
      width: 100%;
    }

    button {
      padding: 12px 18px;
      background: #0066cc;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      width: 100%; /* en m√≥vil ocupa ancho completo */
    }
    button:hover { background: #004c99; }

    /* Bot√≥n mini en l√≠nea (para copiar) */
    .mini-btn {
      display: inline-block;
      padding: 4px 8px;
      font-size: .8rem;
      border-radius: 4px;
      background: #0066cc;
      color: #fff;
      border: none;
      cursor: pointer;
      margin-left: 8px;
      width: auto; /* override al button global */
    }
    .mini-btn:hover { background:#004c99; }

    /* üëá Hace que la tabla sea desplazable en pantallas chicas */
    .tabla-wrapper { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9rem;
      min-width: 600px; /* para que active el scroll en m√≥vil */
    }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
    thead tr { background: #dbe5f1; color: #003366; }
    tfoot tr { background: #eee; }

    @media (max-width: 600px) {
      h2 { font-size: 1.3rem; }
      .info { font-size: 0.9rem; }
      table { font-size: 0.8rem; }
    }

    /* Toast (mensaje flotante) */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: #003366;
      color: #fff;
      padding: 10px 14px;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,.2);
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s ease;
      z-index: 9999;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <h2>Detalle de Factura</h2>
  <div class="info" id="contenedor"></div>


<!-- üì∑ Subir foto -->
<div class="upload-box">
  <h3>Subir Foto de Factura</h3>
  <!-- üëá abre la c√°mara directamente -->
  <input type="file" accept="image/*" capture="environment" id="fotoInput">
  <button onclick="subirFoto()">üì§ Tomar y Subir Foto</button>
</div>


  <!-- Toast -->
  <div id="toast" class="toast">Copiado</div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const uuid = params.get("uuid");
    const folio = params.get("folio");

    const contenedor = document.getElementById('contenedor');
    const apiKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"; // ‚ö†Ô∏è c√°mbiala por la tuya
    const supabaseUrl = "https://cvpbtjlupswbyxenugpz.supabase.co";
    const supabaseClient = window.supabase.createClient(supabaseUrl, apiKey);

    if (!uuid && !folio) {
      contenedor.innerHTML = '<p class="error">Folio o UUID no proporcionado en la URL.</p>';
    } else {
      const url = uuid
        ? `${supabaseUrl}/rest/v1/deuda_limpia_pdd?uuid_cfdi=eq.${uuid}`
        : `${supabaseUrl}/rest/v1/deuda_limpia_pdd?factura=eq.${folio}`;

      fetch(url, { headers: { apikey: apiKey } })
        .then(r => r.json())
        .then(json => {
          if (!json.length) {
            contenedor.innerHTML = `<p class="error">No se encontr√≥ informaci√≥n.</p>`;
            return;
          }

          const f = json[0];
          const formatoPesos = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });

          let subtotal = 0, impuestos = 0;
          let conceptosHTML = '';

          if (Array.isArray(f.conceptos_detalle)) {
            for (let c of f.conceptos_detalle) {
              const totalSinImp = c.cantidad * c.costoUnitario;
              const imp = totalSinImp * c.tasaImpuesto;
              subtotal += totalSinImp;
              impuestos += imp;
              conceptosHTML += `
                <tr>
                  <td>${c.cantidad}</td>
                  <td>${c.codigoSAT}</td>
                  <td>${c.descripcion}</td>
                  <td>$${c.costoUnitario.toFixed(2)}</td>
                  <td>${(c.tasaImpuesto*100).toFixed(2)}%</td>
                  <td>$${totalSinImp.toFixed(2)}</td>
                </tr>`;
            }
          }

          contenedor.innerHTML = `
            <div class="campo campo-inline">
              <span>UUID:</span>
              <span id="uuidText">${f.uuid_cfdi}</span>
              <button type="button" class="mini-btn" onclick="copiarUUID('${f.uuid_cfdi}')" title="Copiar UUID">üìã Copiar</button>
            </div>
            <div class="campo"><span>Factura:</span> ${f.factura}</div>
            <div class="campo"><span>Raz√≥n Social Emisor:</span> ${f.razon_social_emisor}</div>
            <div class="campo"><span>RFC Emisor:</span> ${f.rfc_emisor}</div>
            <div class="campo"><span>Fecha:</span> ${new Date(f.fecha).toLocaleDateString('es-MX')}</div>
            <div class="campo"><span>Total:</span> ${formatoPesos.format(f.total)}</div>
            ${Array.isArray(f.fotos) && f.fotos[0]
              ? `<div class="campo"><span>Foto:</span> <a href="${f.fotos[0]}" target="_blank">Ver imagen</a></div>`
              : ""}
            <div class="campo"><span>Conceptos:</span></div>
            <div class="tabla-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Cantidad</th><th>C√≥digo SAT</th><th>Descripci√≥n</th>
                    <th>Costo Unitario</th><th>Impuesto</th><th>Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  ${conceptosHTML || `<tr><td colspan="6">No hay conceptos registrados.</td></tr>`}
                </tbody>
                <tfoot>
                  <tr><td colspan="5" style="text-align:right;font-weight:bold;">SUBTOTAL</td><td>${formatoPesos.format(subtotal)}</td></tr>
                  <tr><td colspan="5" style="text-align:right;font-weight:bold;">IVA</td><td>${formatoPesos.format(impuestos)}</td></tr>
                  <tr style="background:#003366;color:#fff;">
                    <td colspan="5" style="text-align:right;font-weight:bold;">TOTAL</td>
                    <td>${formatoPesos.format(subtotal+impuestos)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>`;
        });
    }

async function subirFoto() {
  const fileInput = document.getElementById("fotoInput");
  const file = fileInput.files[0];
  if (!file) return alert("Selecciona o toma una foto üì∑");

  const nombreArchivo = `${crypto.randomUUID()}.jpg`;

  // Subir al bucket
  const { error } = await supabaseClient.storage
    .from("fotos-facturas")
    .upload(`clientes/${nombreArchivo}`, file, { contentType: file.type });

  if (error) return alert("‚ùå Error al subir: " + error.message);

  // Obtener URL p√∫blica
  const { data: urlData } = supabaseClient.storage
    .from("fotos-facturas")
    .getPublicUrl(`clientes/${nombreArchivo}`);

  if (uuid) {
    // Actualizar la BD con la nueva foto
    await supabaseClient
      .from("deuda_limpia_pdd")
      .update({ fotos: [urlData.publicUrl] })
      .eq("uuid_cfdi", uuid);
  }

  alert("‚úÖ Foto tomada y subida correctamente");
}

    /* ====== Toast + Copiar UUID ====== */
    function showToast(msg = "Copiado") {
      const t = document.getElementById('toast');
      if (!t) return;
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 1800);
    }

    async function copiarUUID(texto) {
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(texto);
          showToast("‚úÖ UUID copiado");
        } else {
          // Fallback para contextos no seguros o navegadores antiguos
          const ta = document.createElement('textarea');
          ta.value = texto;
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          showToast("‚úÖ UUID copiado");
        }
      } catch (err) {
        showToast("‚ùå No se pudo copiar");
        console.error(err);
      }
    }
  </script>
</body>
</html>


