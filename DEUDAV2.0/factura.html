<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Factura</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; text-align: center; background: #f7f9fc; }
    h2 { color: #333; margin-bottom: 1rem; }
    #result {
      background: #eef;
      padding: 1.2rem;
      border-radius: 10px;
      margin-top: 1rem;
      text-align: left;
      font-size: 1rem;
      line-height: 1.6;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    textarea {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 6px;
    }
    button {
      margin-top: 1.2rem;
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      width: 90%;
      max-width: 320px;
      background: green;
      color: white;
      box-shadow: 0 4px 6px rgba(0,0,0,0.15);
    }
    button:active { transform: scale(0.97); }
    #statusMsg {
      margin: 10px 0;
      font-weight: bold;
      color: #333;
    }
    .foto {
      display: inline-block;
      margin: 5px;
      text-align: center;
    }
    .foto img {
      width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid #ccc;
    }
    .foto button {
      margin-top: 5px;
      padding: 4px 8px;
      font-size: 0.8rem;
      background: red;
      color: white;
      border: none;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h2>Factura detectada</h2>
  <div id="result"></div>

  <!-- Subir fotos -->
  <input type="file" id="fotoInput" accept="image/*" />
  <button onclick="subirFoto()">üì§ Subir foto</button>

  <!-- Estado -->
  <div id="statusMsg"></div>

  <button onclick="guardar()">üíæ Guardar y regresar</button>

  <script>
    const supabaseClient = window.supabase.createClient(
      "https://cvpbtjlupswbyxenugpz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
    );

    const params = new URLSearchParams(window.location.search);
    const uuid = params.get("uuid");
    const raw = params.get("raw");

    let factura = null;

    async function cargar() {
      const { data, error } = await supabaseClient
        .from("deuda_limpia_pdd")
        .select("*")
        .eq("uuid_cfdi", uuid)
        .maybeSingle();

      if (error || !data) {
        document.getElementById("result").innerHTML = `<p style="color:red;"><b>‚ö†Ô∏è Factura no encontrada</b></p>`;
        return;
      }

      factura = data;
      let html = `
        <p><b>QR detectado (crudo):</b><br><span style="background:#fff; display:block; padding:6px;">${raw || "(no disponible)"}</span></p>
        <p><b>UUID convertido:</b><br><span style="background:#fff; display:block; padding:6px;">${uuid}</span></p>
        <p><b>Fecha:</b> ${new Date(data.fecha).toLocaleString()}</p>
        <p><b>RFC:</b> ${data.rfc_emisor}</p>
        <p><b>Raz√≥n Social:</b> ${data.razon_social_emisor}</p>
        <p><b>Factura:</b> ${data.factura}</p>
        <p><b>Total:</b> $${parseFloat(data.total).toFixed(2)}</p>
        <p><b>Pagada:</b> ${data.factura_pagada || "NO"}</p>
        <p><b>F√≠sica:</b> SI</p>
      `;

      // Notas
      if (factura.comentario_factura_fisica && factura.comentario_factura_fisica.trim() !== "") {
        html += `<label><b>Notas:</b></label><br>
          <textarea id="notaTexto">${factura.comentario_factura_fisica}</textarea>`;
      } else {
        html += `<p style="color:#999; font-style: italic; text-align:center;">‚Äî Sin notas ‚Äî</p>
          <textarea id="notaTexto" placeholder="Escribe un comentario (opcional)"></textarea>`;
      }

      // Fotos
      html += `<h3>Fotos</h3>`;
      if (factura.fotos && factura.fotos.length > 0) {
        factura.fotos.forEach((url, idx) => {
          html += `
            <div class="foto">
              <img src="${url}" alt="foto-${idx}" />
              <button onclick="eliminarFoto('${url}')">‚ùå Borrar</button>
            </div>
          `;
        });
      } else {
        html += `<p style="color:#999; font-style: italic; text-align:center;">‚Äî Sin fotos ‚Äî</p>`;
      }

      document.getElementById("result").innerHTML = html;
    }

    async function guardar() {
      const comentario = document.getElementById("notaTexto")?.value || "";

      const { error } = await supabaseClient
        .from("deuda_limpia_pdd")
        .update({
          factura_fisicamente: "SI",
          comentario_factura_fisica: comentario
        })
        .eq("uuid_cfdi", uuid);

      if (error) {
        document.getElementById("statusMsg").innerText = "‚ùå Error al guardar";
      } else {
        document.getElementById("statusMsg").innerText = "‚úÖ Factura actualizada";
        setTimeout(() => window.location.href = "iniciacam.html", 1200);
      }
    }

    async function subirFoto() {
      const file = document.getElementById("fotoInput").files[0];
      if (!file) return;

      const status = document.getElementById("statusMsg");
      status.innerText = "üì∏ Cargando foto...";

      const filePath = `clientes/${uuid}/${Date.now()}_${file.name}`;
      const { error: uploadError } = await supabaseClient.storage
        .from("fotos-facturas")
        .upload(filePath, file);

      if (uploadError) {
        status.innerText = "‚ùå Error al subir foto";
        return;
      }

      const { data: { publicUrl } } = supabaseClient.storage
        .from("fotos-facturas")
        .getPublicUrl(filePath);

      const nuevasFotos = factura.fotos ? [...factura.fotos, publicUrl] : [publicUrl];

      const { error: dbError } = await supabaseClient
        .from("deuda_limpia_pdd")
        .update({ fotos: nuevasFotos })
        .eq("uuid_cfdi", uuid);

      if (dbError) {
        status.innerText = "‚ùå Error al guardar foto en la BD";
      } else {
        status.innerText = "‚úÖ Foto agregada";
        setTimeout(() => location.reload(), 1000);
      }
    }

    async function eliminarFoto(url) {
      const nuevasFotos = factura.fotos.filter(f => f !== url);

      const { error } = await supabaseClient
        .from("deuda_limpia_pdd")
        .update({ fotos: nuevasFotos })
        .eq("uuid_cfdi", uuid);

      if (error) {
        document.getElementById("statusMsg").innerText = "‚ùå Error al borrar foto";
      } else {
        document.getElementById("statusMsg").innerText = "‚úÖ Foto eliminada";
        setTimeout(() => location.reload(), 1000);
      }
    }

    cargar();
  </script>
</body>
</html>
