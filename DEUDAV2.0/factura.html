<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Factura</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0.8rem; background: #f3f4f6; color: #111827; }
    h2 { text-align: center; margin-bottom: 0.8rem; color: #1f2937; font-size: 1.4rem; }
    .card { background: #fff; border-radius: 12px; padding: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 0.8rem; }
    .label { font-weight: 600; color: #374151; font-size: 0.9rem; }
    .value { display: block; background: #f9fafb; padding: 6px 8px; border-radius: 6px; margin: 4px 0 10px; font-size: 0.9rem; }
    textarea, select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 0.9rem; margin-top: 6px; }
    .btn { display: block; width: 100%; padding: 0.9rem; font-size: 1rem; font-weight: bold; border: none; border-radius: 10px; margin: 0.5rem 0; color: white; box-shadow: 0 3px 6px rgba(0,0,0,0.12); transition: transform 0.1s ease; }
    .btn:active { transform: scale(0.97); }
    .btn-green { background: #16a34a; }
    .btn-blue { background: #2563eb; }
    .btn-red { background: #dc2626; font-size: 0.9rem; padding: 4px 8px; width: auto; margin-top: 6px; }
    #statusMsg { margin: 10px 0; font-weight: bold; text-align: center; font-size: 0.9rem; }
    .fotos-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 0.5rem; }
    .foto { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 4px; text-align: center; width: 90px; }
    .foto img { width: 100%; height: 70px; object-fit: cover; border-radius: 4px; }
  </style>
</head>
<body>
  <h2>üìë Factura detectada</h2>

  <div id="result" class="card">Cargando factura...</div>
  <div id="statusMsg"></div>

  <!-- Tomar foto -->
  <div class="card">
    <label class="label">üì∏ Tomar foto</label>
    <input type="file" id="fotoInput" accept="image/*" capture="environment" style="display:none;">
    <button class="btn btn-blue" onclick="document.getElementById('fotoInput').click()">üì∏ Tomar foto</button>
    <div id="previewContainer" style="margin-top:10px; text-align:center;"></div>
  </div>

  <script>
    const supabaseClient = window.supabase.createClient(
      "https://cvpbtjlupswbyxenugpz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
    );

    const params = new URLSearchParams(window.location.search);
    const uuid = params.get("uuid");
    const raw = params.get("raw");

    let factura = null;
    let fotoPendiente = null;

    async function cargar() {
      const { data, error } = await supabaseClient
        .from("deuda_limpia_pdd")
        .select("*")
        .eq("uuid_cfdi", uuid)
        .maybeSingle();

      if (error || !data) {
        document.getElementById("result").innerHTML = `<p style="color:red;"><b>‚ö†Ô∏è Factura no encontrada</b></p>`;
        return;
      }

      factura = data;

      let html = `
        <span class="label">QR detectado:</span>
        <span class="value">${raw || "(no disponible)"}</span>

        <span class="label">UUID:</span>
        <span class="value">${uuid}</span>

        <span class="label">Fecha:</span>
        <span class="value">${new Date(data.fecha).toLocaleDateString()}</span>

        <span class="label">RFC:</span>
        <span class="value">${data.rfc_emisor}</span>

        <span class="label">Raz√≥n Social:</span>
        <span class="value">${data.razon_social_emisor}</span>

        <span class="label">Factura:</span>
        <span class="value">${data.factura}</span>

        <span class="label">Total:</span>
        <span class="value">$${parseFloat(data.total).toFixed(2)}</span>

        <span class="label">Pagada:</span>
        <span class="value">${data.factura_pagada || "NO"}</span>

        <span class="label">F√≠sica:</span>
        <select id="fisicaSelect">
          <option value="SI" selected>SI</option>
          <option value="NO">NO</option>
        </select>

        <!-- üëá Bot√≥n insertado din√°micamente justo aqu√≠ -->
        <button class="btn btn-green" onclick="guardar()">üíæ Guardar y regresar</button>
      `;

      // Comentarios
      if (factura.comentario_factura_fisica && factura.comentario_factura_fisica.trim() !== "") {
        html += `<span class="label">üìù Notas:</span><textarea id="notaTexto">${factura.comentario_factura_fisica}</textarea>`;
      } else {
        html += `<textarea id="notaTexto" placeholder="üìù Escribe comentario (opcional)" style="display:none;"></textarea>`;
      }

      // Fotos actuales
      html += `<span class="label">üì∑ Fotos:</span><div class="fotos-container">`;
      if (factura.fotos && factura.fotos.length > 0) {
        factura.fotos.forEach((url, idx) => {
          html += `
            <div class="foto">
              <img src="${url}" alt="foto-${idx}" />
              <button class="btn btn-red" onclick="eliminarFoto('${url}')">Borrar</button>
            </div>`;
        });
      } else {
        html += `<p style="color:#999; font-style: italic;">‚Äî Sin fotos ‚Äî</p>`;
      }
      html += `</div>`;

      document.getElementById("result").innerHTML = html;
    }

    // Precargar foto
    document.getElementById("fotoInput").addEventListener("change", (e) => {
      fotoPendiente = e.target.files[0];
      const container = document.getElementById("previewContainer");
      container.innerHTML = "";
      if (fotoPendiente) {
        const preview = document.createElement("img");
        preview.src = URL.createObjectURL(fotoPendiente);
        preview.style.maxWidth = "150px";
        preview.style.borderRadius = "6px";
        container.appendChild(preview);
      }
    });

    // Guardar
    async function guardar() {
      const comentario = document.getElementById("notaTexto")?.value || "";
      const fisica = document.getElementById("fisicaSelect")?.value || "SI";
      const status = document.getElementById("statusMsg");
      status.innerText = "üíæ Guardando...";

      let { error } = await supabaseClient
        .from("deuda_limpia_pdd")
        .update({ factura_fisicamente: fisica, comentario_factura_fisica: comentario })
        .eq("uuid_cfdi", uuid);

      if (error) {
        status.innerText = "‚ùå Error al guardar";
        return;
      }

      if (fotoPendiente) {
        const filePath = `clientes/${uuid}/${Date.now()}_${fotoPendiente.name}`;
        const { error: uploadError } = await supabaseClient.storage
          .from("fotos-facturas")
          .upload(filePath, fotoPendiente);

        if (!uploadError) {
          const { data: { publicUrl } } = supabaseClient.storage
            .from("fotos-facturas")
            .getPublicUrl(filePath);

          const nuevasFotos = factura.fotos ? [...factura.fotos, publicUrl] : [publicUrl];
          await supabaseClient
            .from("deuda_limpia_pdd")
            .update({ fotos: nuevasFotos })
            .eq("uuid_cfdi", uuid);
        }
      }

      status.innerText = "‚úÖ Factura actualizada";
      setTimeout(() => window.location.href = "iniciacam.html", 1000);
    }

    async function eliminarFoto(url) {
      const nuevasFotos = factura.fotos.filter(f => f !== url);
      await supabaseClient
        .from("deuda_limpia_pdd")
        .update({ fotos: nuevasFotos })
        .eq("uuid_cfdi", uuid);

      document.getElementById("statusMsg").innerText = "‚úÖ Foto eliminada";
      setTimeout(() => location.reload(), 800);
    }

    cargar();
  </script>
</body>
</html>
