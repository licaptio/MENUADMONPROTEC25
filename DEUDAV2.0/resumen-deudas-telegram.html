<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resumen Deudas No Pagadas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      font-size: 0.9em;
    }
    th {
      background-color: #007bff;
      color: white;
      position: sticky;
      top: 0;
    }
    .vencida-30 { background: #fff8e1; }
    .vencida-60 { background: #ffe082; }
    .vencida-90 { background: #ffca28; }
    .vencida-mas { background: #ff7043; color: white; }
    .proveedor-destacado { font-weight: bold; color: #2c3e50; }
    button {
      margin: 1rem 0;
      padding: 10px 20px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background: #218838; }
    td.numero { text-align: right; }
.proveedor-especial {
  background-color: #d0ecff !important; /* azul claro */
  animation: parpadeo 1.6s infinite;
}
@keyframes parpadeo {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}
.proveedor-especial-vencido {
  background-color: #ede7f6 !important; /* Morado claro */
  animation: parpadeo-morado 1.6s infinite;
}

@keyframes parpadeo-morado {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}
.proveedor-contado {
  background-color: #eeeeee !important;
  font-style: italic;
  color: #555;
}

  </style>
</head>
<body>
  <h2>📌 Facturas Pendientes</h2>
  <button onclick="enviarTelegram()">📤 Enviar resumen por Telegram</button>
  <div id="tabla"></div>

  <script>
const _supabase = window.supabase.createClient(
  'https://cvpbtjlupswbyxenugpz.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY'
);
const proveedoresEspeciales = {
  "ROBERTO CANTU OZUNA": 12,
  "DECASA DEL CENTRO": 20,
  "DULCES LAS DELICIAS": 28,
  "DISTRIBUIDORA DE DULCES DEL NORTE": 29,
  "INOCENCIO DELGADO MARQUEZ": 15,
  "DUL-TAM PAVITO": 7,
  "DISTRIBUIDORA DE PRODUCTOS DESHIDRATADOS": 28,
  "DISTRIBUIDORA DE LA ROSA": 15,
  "DESFICO": 7,
  "GRUPO CHI-SO": 15,
  "ABARROTES": 25
};
const proveedoresContado = [
  "BBVA MEXICO, S.A., INSTITUCION DE BANCA MULTIPLE, GRUPO FINANCIERO BBVA MEXICO",
  "BANCO SANTANDER MEXICO S.A., INSTITUCION DE BANCA MULTIPLE, GRUPO FINANCIERO SANTANDER MEXICO",
  "MARIA IMELDA CHAPA PARAS",
  "COMERCIALIZADORA PEPSICO MEXICO",
  "DISTRIBUIDORA ARCA CONTINENTAL",
  "GASNGO MEXICO",
  "PEÑAFIEL BEBIDAS",
  "TELEFONOS DE MEXICO",
  "COMISION FEDERAL DE ELECTRICIDAD"
];

    const tabla = "deuda_limpia_pdd";
    let resumenTelegram = "";

    async function cargar() {
const { data, error } = await _supabase
  .from(tabla)
  .select("*")
  .neq('factura_pagada', 'SI');
      if (error) return alert("Error cargando datos");

      const pendientes = data.filter(f => (f.factura_pagada || "").toUpperCase().trim() !== "SI");
      const sumaTotal = pendientes.reduce((acc, f) => acc + (parseFloat(f.total) || 0), 0);

      document.getElementById("tabla").insertAdjacentHTML("beforebegin", `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <div>
            <strong>Total en Supabase:</strong> ${data.length} registros<br>
            <strong>No pagados:</strong> ${pendientes.length} registros
          </div>
          <div style="text-align: right;">
            <strong style="display: block;">Total $ pendiente:</strong>
            <span style="font-size: 1.3em; color: darkgreen;">$${sumaTotal.toLocaleString("es-MX", { minimumFractionDigits: 2 })}</span>
          </div>
        </div>
      `);

      const ordenados = pendientes.sort((a, b) => {
        const rfcA = (a.rfc_emisor || "").toLowerCase();
        const rfcB = (b.rfc_emisor || "").toLowerCase();
        if (rfcA !== rfcB) return rfcA.localeCompare(rfcB);
        return new Date(a.fecha) - new Date(b.fecha);
      });

      mostrarTabla(ordenados);
const vencidas30 = ordenados.filter(f => calcularDias(f.fecha) > 30);

// Detectar vencimientos especiales
const vencidasEspeciales = ordenados.filter(f => {
  const razon = (f.razon_social_emisor || "").toUpperCase().trim();
  const dias = calcularDias(f.fecha);
  return proveedoresEspeciales[razon] && dias > proveedoresEspeciales[razon];
});

// Quitar duplicados (que ya están en vencidas30)
const especialesUnicas = vencidasEspeciales.filter(esp => {
  const diasEsp = calcularDias(esp.fecha);
  return diasEsp <= 30; // Solo incluir si aún no está en los de 30+
});

// Unir textos
resumenTelegram =
  generarResumenTextoEspeciales(especialesUnicas) +
  "\n\n" +
  generarResumenTexto(vencidas30) +
  "\n\n" +
  generarResumenTextoContado(ordenados) +
  "\n\n📩 Reporte generado por *Loba | Ejecutor de Operaciones*";
  
    }

    function mostrarTabla(data) {
      const sumaTotal = data.reduce((acc, f) => acc + (parseFloat(f.total) || 0), 0);
      let html = `<table><thead><tr>
        <th>Fecha</th><th>Días</th><th>UUID</th><th>RFC</th><th>Proveedor</th>
        <th>Factura</th><th>Total</th><th>Física</th><th>Fotos</th>
      </tr></thead><tbody>`;

      for (const f of data) {
        const dias = calcularDias(f.fecha);
        const razon = (f.razon_social_emisor || "").toUpperCase().trim();
let clase = obtenerClaseVencimiento(dias);
if (proveedoresContado.includes(razon)) {
  clase = "proveedor-contado";
}
        if (proveedoresEspeciales[razon]) {
  const limite = proveedoresEspeciales[razon];
  if (dias >= limite && dias < 30) {
    clase = "proveedor-especial-vencido"; // Morado claro y parpadeo
  }
}

        html += `<tr class="${clase}">
          <td>${f.fecha}</td>
          <td>${dias}</td>
          <td><a href="detalle-factura.html?uuid=${f.uuid_cfdi}" target="_blank">${f.uuid_cfdi}</a></td>
          <td>${f.rfc_emisor || '-'}</td>
          <td class="proveedor-destacado">${f.razon_social_emisor || '-'}</td>
          <td>${f.serie ? f.serie + ' - ' : ''}${f.factura || '-'}</td>
          <td class="numero">${parseFloat(f.total || 0).toLocaleString("es-MX", { minimumFractionDigits: 2 })}</td>
          <td style="text-align:center">${(f.factura_fisicamente || '').toUpperCase() === 'SI' ? '✅' : ''}</td>
          <td style="text-align:center">
            ${(Array.isArray(f.fotos) && f.fotos.length)
              ? f.fotos.map(url => `<a href="${url}" target="_blank" title="Ver foto">📷</a>`).join(' ')
              : ''}
          </td>
        </tr>`;
      }
      document.getElementById("tabla").innerHTML = html;
    }

    function calcularDias(fecha) {
      const hoy = new Date();
      const f = new Date(fecha);
      return Math.floor((hoy - f) / (1000 * 60 * 60 * 24));
    }

    function obtenerClaseVencimiento(d) {
      if (d > 90) return "vencida-mas";
      if (d > 60) return "vencida-90";
      if (d > 30) return "vencida-60";
      return "vencida-30";
    }

function generarResumenTexto(facturas) {
  if (facturas.length === 0) return "✅ No hay facturas vencidas mayores a 30 días.";

  const frasesMotivacionales = [
    "⚔️ *Con fuerza, como Loba. Cada deuda es una batalla ganada.*",
    "🛡️ *Hoy no retrocedas. Acomoda la armadura y sigue firme.*",
    "🔥 *Lo que no se paga, se enfrenta. Y tú no le huyes a nada.*",
    "🐺 *Una loba no duda, actúa. Tú ya sabes qué hacer.*",
    "🏹 *Hoy es el día de marcar territorio. ¡Hazlo con estilo!*",
    "💼 *Hoy cobramos. No es presión, es misión.*",
    "🧭 *La deuda no se pierde, solo espera que la señales.*",
    "🪓 *Un tajo a tiempo es mejor que mil excusas.*",
    "🩸 *Deja que Loba marque el camino, pero tú ejecuta sin temblar.*",
    "📢 *Lo que se calla, se acumula. Cuando actúas, te liberas. ¡Hazlo ya!*",
    "🏰 *No hay castillo sin contabilidad. Y tú ya estás tomando el trono.*"
  ];
  const fraseAleatoria = frasesMotivacionales[Math.floor(Math.random() * frasesMotivacionales.length)];
let texto = `${fraseAleatoria}\n\n📌 *Resumen de Facturas Pendientes:*\n`;
for (const f of facturas) {
  const dias = calcularDias(f.fecha);
  const fisica = (f.factura_fisicamente || '').toUpperCase() === 'SI' ? '✅' : '❌';
  texto += `\n• *${f.razon_social_emisor}* - ${f.factura || '-'}\n  $${parseFloat(f.total || 0).toFixed(2)} - ${dias} días - Física: ${fisica}\n`;
}
 return texto; // <- Cierre correcto aquí
}
  function generarResumenTextoEspeciales(facturas) {
  if (facturas.length === 0) return "✅ No hay vencimientos especiales fuera de plazo.";

  let texto = "📌 *Vencimientos según plazo acordado:*\n";

  for (const f of facturas) {
    const razon = (f.razon_social_emisor || "").toUpperCase().trim();
    const dias = calcularDias(f.fecha);
    const fisica = (f.factura_fisicamente || '').toUpperCase() === 'SI' ? '✅' : '❌';
    const plazo = proveedoresEspeciales[razon] || '?';
    texto += `\n• *${f.razon_social_emisor}* - ${f.factura || '-'}\n  $${parseFloat(f.total || 0).toFixed(2)} - ${dias} días (Plazo: ${plazo}) - Física: ${fisica}`;
  }

   return texto;
}
function generarResumenTextoContado(facturas) {
  const encontrados = facturas.filter(f => {
    const razon = (f.razon_social_emisor || "").toUpperCase().trim();
    return proveedoresContado.includes(razon);
  });

  if (encontrados.length === 0) return "";

  let texto = "📌 *Proveedores sin crédito (facturan contado o ya pagado):*\n";
  texto += "🧹 Favor de depurar si no deben considerarse deuda.\n";

  for (const f of encontrados) {
    const dias = calcularDias(f.fecha);
    texto += `\n• ${f.razon_social_emisor} - ${f.factura || '-'} - ${dias} días`;
  }

  return texto;
}


async function enviarTelegram() {
  const telegramToken = "7349070760:AAHYA8YPoDWfUuLMjgUDubRi9CSYZi4Oirg";
  const chatId = "6617988297";

  if (!telegramToken || !chatId) {
    alert("Falta configurar el TOKEN o el CHAT ID.");
    return;
  }

  // Sanitiza para Markdown (Telegram lo odia cuando no cierras * o usas caracteres raros)
let texto = resumenTelegram
  .replace(/([_*[\]()~`>#+\-=|{}.!])/g, "\\$1")  // Escapa correctamente para Markdown
  .trim();

  console.log("Resumen a enviar:", texto);
  const partes = [];
  const MAX_LENGTH = 4000;

  for (let i = 0; i < texto.length; i += MAX_LENGTH) {
    partes.push(texto.slice(i, i + MAX_LENGTH));
  }

  try {
    for (const parte of partes) {
      const res = await fetch(`https://api.telegram.org/bot${telegramToken}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: chatId,
          text: parte,
          parse_mode: "Markdown"
        })
      });

      const body = await res.json();

      if (!body.ok) {
        console.error("❌ Telegram respondió con error:", body);
        alert("Error al enviar: " + (body.description || "desconocido"));
        return;
      }
    }

    alert("Resumen enviado por Telegram ✅");
  } catch (error) {
    console.error("❌ Error en el envío:", error);
    alert("Hubo un error al enviar el resumen");
  }
}

    document.addEventListener("DOMContentLoaded", cargar);
  </script>
</body>
</html>
