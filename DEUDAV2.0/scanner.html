<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Esc√°ner QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- üîë para m√≥viles -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      background: #f7f9fc;
      padding: 1rem;
    }
    h2 {
      font-size: 1.6rem;
      margin-bottom: 1rem;
      color: #333;
    }
    #lectorQR {
      margin: 1rem auto;
      width: 95%;
      max-width: 500px;
      background: #000; /* fondo negro para mejor contraste */
      border-radius: 12px;
      overflow: hidden;
    }
    button {
      margin-top: 1rem;
      padding: 1.2rem;
      font-size: 1.3rem;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      background: #e3342f;
      color: white;
      width: 95%;
      max-width: 400px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      transition: transform 0.1s ease;
    }
    button:active {
      transform: scale(0.97);
    }
  </style>
</head>
<body>
  <h2>üì∑ Escaneando...</h2>
  <div id="lectorQR"></div>
  <button onclick="cancelar()">‚ùå Cancelar</button>

<script>
  function extraeUUID(raw) {
    try {
      // Caso 1: QR con URL (SAT)
      const url = new URL(raw);
      const uuid = url.searchParams.get("id");
      if (uuid && /^[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}$/i.test(uuid)) {
        return uuid.toUpperCase();
      }
    } catch (e) {
      // Caso 2: QR directo con UUID
      let m = raw.match(/[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}/i);
      if (m) return m[0].toUpperCase();
    }
    return null;
  }

  const html5QrCode = new Html5Qrcode("lectorQR");

  Html5Qrcode.getCameras().then(cameras => {
    if (cameras && cameras.length) {
      // üîë Si es PC usa cuadro, si es m√≥vil usa toda la pantalla
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      const config = isMobile
        ? { fps: 10 }   // m√≥vil: usar pantalla completa
        : { fps: 10, qrbox: { width: 300, height: 300 } }; // PC: cuadro m√°s chico

      html5QrCode.start(
        { facingMode: "environment" },
        config,
        qrCodeMessage => {
          console.log("Detectado:", qrCodeMessage); // debug
          const uuid = extraeUUID(qrCodeMessage);
          if (uuid) {
            html5QrCode.stop().catch(()=>{});
            window.location.href =
              "factura.html?uuid=" + encodeURIComponent(uuid) +
              "&raw=" + encodeURIComponent(qrCodeMessage);
          }
        },
        errorMessage => {
          // üëÄ importante en m√≥viles: evita que se congele
          console.log("Fall√≥ escaneo:", errorMessage);
        }
      );
    }
  });

  function cancelar() {
    html5QrCode.stop().catch(()=>{}).finally(()=>{
      window.location.href = "iniciacam.html";
    });
  }
</script>
</body>
</html>
