<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Asignación por factura — Central → Destino</title>
<style>
  :root{--bg:#0b0b0b;--card:#151515;--border:#262626;--text:#eaeaea;--brand:#1f4fff}
  body{font-family:system-ui;background:var(--bg);color:var(--text);margin:0;padding:18px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;max-width:1100px;margin:auto}
  h1{font-size:18px;margin:0 0 12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,input{background:#1a1a1a;color:#ddd;border:1px solid var(--border);border-radius:8px;padding:8px}
  button{background:#1f4fff;border:1px solid #2b2b2b;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
  .muted{opacity:.75}
  .ok{color:#8ef59e} .err{color:#ff9c9c}
</style>
</head>
<body>
<div class="card">
  <h1>Asignación por factura — <code>ALMACENCENTRALPDD</code> → destino</h1>

  <div class="row">
    <label>Factura (entrada aplicada):</label>
    <select id="selFactura"></select>

    <label>Destino:</label>
    <select id="selDestino">
      <option value="almacen_cigarro">almacen_cigarro</option>
      <option value="almacen_zapata">almacen_zapata</option>
      <option value="Almacen_Dulces">Almacen_Dulces</option>
      <!-- agrega más si necesitas -->
    </select>

    <button id="btnCargar">Cargar partidas</button>
  </div>

  <div id="info" class="muted" style="margin-top:6px"></div>

  <table id="tbl">
    <thead><tr><th>Código</th><th>Descripción</th><th>Cantidad</th></tr></thead>
    <tbody></tbody>
  </table>

  <div class="row" style="justify-content:flex-end;margin-top:12px">
    <button id="btnAsignar" disabled>Asignar todo</button>
  </div>

  <div id="msg" class="muted" style="margin-top:8px"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getFirestore, collection, query, where, orderBy, getDocs,
  doc, getDoc, runTransaction, setDoc, arrayUnion   // ⬅️ aquí
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

/* Config Firebase (tu proyecto) */
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

const CENTRAL = "ALMACENCENTRALPDD";
const $ = (s)=>document.querySelector(s);

const selFactura = $("#selFactura");
const selDestino = $("#selDestino");
const btnCargar  = $("#btnCargar");
const btnAsignar = $("#btnAsignar");
const tbody      = $("#tbl tbody");
const info       = $("#info");
const msg        = $("#msg");

let seleccion = null; // {uuid, destino, items: [{codigo, descripcion, cantidad}]}

window.addEventListener("DOMContentLoaded", cargarEntradasAplicadas);
btnCargar.addEventListener("click", cargarPartidas);
btnAsignar.addEventListener("click", asignarTodo);

/* 1) Llenar combo con entradas APLICADAS */
async function cargarEntradasAplicadas(){
  selFactura.innerHTML = '<option value="">Cargando…</option>';
  const q = query(
    collection(db, "almacenes", CENTRAL, "entradas"),
    where("estado","==","aplicada"),
    orderBy("fechaXML","desc")
  );
  const s = await getDocs(q);
  const opts = ['<option value="">— elige factura —</option>'];
  s.forEach(d=>{
    const e = d.data();
    opts.push(`<option value="${d.id}">${e.folioXML || '-'} — ${e.nombreEmisor || ''} — ${d.id.slice(0,8)}…</option>`);
  });
  selFactura.innerHTML = opts.join("");
}

/* 2) Cargar itemsMapeados de la entrada y agregarlos (si hay duplicados, se agrupan) */
async function cargarPartidas(){
  msg.textContent = "";
  const uuid = selFactura.value;
  const destino = selDestino.value;
  if(!uuid){ alert("Elige una factura."); return; }

  const ref = doc(db,"almacenes",CENTRAL,"entradas",uuid);
  const s = await getDoc(ref);
  if(!s.exists()){ alert("Entrada no encontrada"); return; }
  const e = s.data();
  if (e.estado !== "aplicada"){ alert("La entrada no está aplicada."); return; }

  let items = [];
  if (Array.isArray(e.articulos) && e.articulos.length){
    const acc = {};
    e.articulos.forEach(a=>{
      const k = (a.codigo||"").toUpperCase(); if(!k) return;
      if(!acc[k]) acc[k] = { codigo:k, descripcion:a.nombre||"", cantidad:0 };
      acc[k].cantidad += Number(a.cantidad||0);
    });
    items = Object.values(acc);
  }else{
    const acc = {};
    (e.itemsMapeados || []).forEach(it=>{
      const k = (it.codigo||'').toUpperCase(); if(!k) return;
      if(!acc[k]) acc[k] = { codigo:k, descripcion:it.descripcion||"", cantidad:0 };
      acc[k].cantidad += Number(it.cantidad||0);
    });
    items = Object.values(acc);
  }

  tbody.innerHTML = items.map(it=>`
    <tr><td><code>${it.codigo}</code></td><td>${it.descripcion}</td><td>${it.cantidad}</td></tr>
  `).join("") || '<tr><td colspan="3" class="muted">Sin partidas.</td></tr>';

  info.textContent = `UUID: ${uuid} • Partidas: ${items.length} • Destino: ${destino}`;
  btnAsignar.disabled = items.length===0;

  seleccion = { uuid, destino, items };
}



/* 3) Generar folio simple para transferencia */
async function nextFolio(){
  // usamos un doc contador: consecutivos/asig_factura
  let next = 0;
  await runTransaction(db, async tx=>{
    const ref = doc(db,"consecutivos","asig_factura");
    const s = await tx.get(ref);
    const curr = s.exists() ? (s.data().valor||0) : 0;
    next = curr + 1;
    tx.set(ref, { valor: next }, { merge:true });
  });
  return `AF-${String(next).padStart(6,'0')}`;
}

/* 4) Asignar TODO en una única transacción */
async function asignarTodo(){
  if(!seleccion){ return; }
  const { uuid, destino, items } = seleccion;
  const folio = await nextFolio();

  try{
    await runTransaction(db, async tx=>{
      const entradaRef = doc(db,"almacenes",CENTRAL,"entradas",uuid);
      const s = await tx.get(entradaRef);
      if(!s.exists()) throw new Error("Entrada no encontrada");
      if(s.data().estado !== "aplicada") throw new Error("La entrada cambió de estado.");

      // 1) Lecturas: stocks en central y destino
      const lecturas = [];
      for (const it of items){
        const oriRef = doc(db,"almacenes",CENTRAL,"inventarios", it.codigo);
        const dstRef = doc(db,"almacenes",destino,"inventarios", it.codigo);

        const [oriSnap, dstSnap] = [await tx.get(oriRef), await tx.get(dstRef)];
        const stockOri = oriSnap.exists() ? (oriSnap.data().stock||0) : 0;
        const stockDst = dstSnap.exists() ? (dstSnap.data().stock||0) : 0;

        if (stockOri < it.cantidad){
          throw new Error(`Stock insuficiente: ${it.codigo} requiere ${it.cantidad}, hay ${stockOri}`);
        }
        lecturas.push({oriRef,dstRef,stockOri,stockDst,it});
      }

      // 2) Escrituras inventario
      const now = new Date().toISOString();

      for (const r of lecturas){
        // Central: resta
        tx.set(r.oriRef, {
          codigo: r.it.codigo,
          descripcion: r.it.descripcion || null,
          stock: r.stockOri - r.it.cantidad,
          ultimaActualizacion: now,
          ultimaSalidaFolio: folio,
          ultimaSalidaUUID: uuid
        }, { merge:true });

        // Destino: suma
        tx.set(r.dstRef, {
          codigo: r.it.codigo,
          descripcion: r.it.descripcion || null,
          stock: r.stockDst + r.it.cantidad,
          ultimaActualizacion: now,
          ultimaEntradaFolio: folio,
          ultimaEntradaUUID: uuid
        }, { merge:true });
      }

      // 3) Marcar en la ENTRADA (UUID) el historial de asignaciones
      const totalPzas = items.reduce((a, b) => a + Number(b.cantidad || 0), 0);
      const resumen = items.map(it => ({ codigo: it.codigo, cantidad: it.cantidad }));

      tx.update(entradaRef, {
        asignaciones: arrayUnion({
          folio,
          destino,
          fecha: now,
          totalPiezas: totalPzas,
          items: resumen
        }),
        ultimaAsignacion: {
          folio,
          destino,
          fecha: now,
          totalPiezas: totalPzas
        }
      });

      // 4) 🔴 Aquí está el cambio: normalizamos a "articulos[]" para los LOGS
      const articulos = items.map(it => ({
        codigo: (it.codigo||"").toUpperCase(),
        nombre: it.descripcion || "",
        cantidad: Number(it.cantidad||0)
      }));

      // 5) Logs (SALIDA central y ENTRADA destino) usando articulos[]
      const salRef = doc(collection(db,"almacenes",CENTRAL,"salidas"));
      tx.set(salRef, {
        tipo: "transferencia_factura",
        folio, fecha: now, destino,
        relacionadoUUID: uuid,
        articulos
      });

      const entRef = doc(collection(db,"almacenes",destino,"entradas"));
      tx.set(entRef, {
        tipo: "transferencia_factura",
        folio, fecha: now, origen: CENTRAL,
        relacionadoUUID: uuid,
        articulos
      });
    });

    msg.innerHTML = `<span class="ok">Asignación aplicada ✅ Folio ${folio}</span>`;
    btnAsignar.disabled = true;
  }catch(err){
    msg.innerHTML = `<span class="err">${err.message || err}</span>`;
    console.error(err);
  }
}

</script>
</body>
</html>
