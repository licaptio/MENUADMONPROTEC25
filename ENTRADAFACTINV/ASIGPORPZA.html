<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Asignaciones — Central → Sucursales</title>
<style>
  :root{--bg:#0b0b0b;--card:#151515;--border:#262626;--text:#eaeaea;--brand:#1f4fff}
  body{font-family:system-ui;background:var(--bg);color:var(--text);margin:0;padding:18px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;max-width:980px;margin:auto}
  h1{font-size:18px;margin:0 0 12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select{background:#1a1a1a;color:#ddd;border:1px solid var(--border);border-radius:8px;padding:8px}
  button{background:#1f4fff;border:1px solid #2b2b2b;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
  .small{font-size:12px;opacity:.75}
</style>
</head>
<body>
<div class="card">
  <h1>Asignaciones — <code>ALMACENCENTRALPDD</code> → destino</h1>

  <div class="row">
    <label>Destino:</label>
    <select id="destino">
      <option value="almacen_cigarro">almacen_cigarro</option>
      <option value="almacen_zapata">almacen_zapata</option>
      <option value="Almacen_Dulces">Almacen_Dulces</option>
      <!-- agrega los que uses -->
    </select>
    <button id="btnNueva">Nueva asignación</button>
  </div>

  <div id="area" style="margin-top:12px;display:none">
    <div class="row">
      <input id="codigo" placeholder="código interno (ID de productos)" />
      <input id="cantidad" type="number" step="1" min="1" placeholder="cant" style="width:100px"/>
      <button id="btnAdd">Agregar item</button>
      <span class="small" id="folio"></span>
    </div>

    <table id="tabla">
      <thead><tr><th>Código</th><th>Descripción</th><th>Cantidad</th><th></th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="btnAplicar">Aplicar transferencia</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, runTransaction, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const CENTRAL = "ALMACENCENTRALPDD";
const $ = (s)=>document.querySelector(s);

let asignacion = null; // {folio, destino, items:[]}

$("#btnNueva").addEventListener("click", nuevaAsignacion);
$("#btnAdd").addEventListener("click", addItem);
$("#btnAplicar").addEventListener("click", aplicar);

async function nuevaAsignacion(){
  const folio = await nextFolio("asignacion");   // ← primero obtenemos el folio
  asignacion = {
    folio,
    destino: $("#destino").value,
    items: []
  };
  $("#folio").textContent = `Folio: ${asignacion.folio}`;
  $("#area").style.display = "block";
  render();
}

async function nextFolio(tipo){
  const ref = doc(db, "consecutivos", tipo);
  let nextNum = 0;

  await runTransaction(db, async (tx) => {
    const s = await tx.get(ref);
    const curr = s.exists() ? (s.data().valor || 0) : 0;
    nextNum = curr + 1;
    tx.set(ref, { valor: nextNum }, { merge: true });
  });

  return `${tipo[0].toUpperCase()}-${String(nextNum).padStart(6, "0")}`; // p.ej. A-000001
}


function render(){
  const tbody = $("#tabla tbody");
  tbody.innerHTML = asignacion.items.map((it,i)=>`
    <tr>
      <td><code>${it.codigo}</code></td>
      <td>${it.descripcion||""}</td>
      <td>${it.cantidad}</td>
      <td><button onclick="delItem(${i})">Quitar</button></td>
    </tr>
  `).join("") || `<tr><td colspan="4" class="small">Sin items</td></tr>`;
}

window.delItem = (i)=>{ asignacion.items.splice(i,1); render(); };

async function addItem(){
  const codigo = $("#codigo").value.trim().toUpperCase();
  const cantidad = Number($("#cantidad").value || 0);
  if(!codigo || !cantidad) return alert("Código y cantidad");
  // opcional: obtener descripción desde productos
  let descripcion = "";
  const pSnap = await getDoc(doc(db,"productos", codigo));
  if (pSnap.exists()) descripcion = pSnap.data()["Concepto"] || pSnap.data().descripcion || "";
  asignacion.items.push({ codigo, cantidad, descripcion });
  $("#codigo").value = ""; $("#cantidad").value = "";
  render();
}

async function aplicar(){
  if(!asignacion || !asignacion.items.length) return alert("Agrega items.");
  const destino = asignacion.destino;
  const folio = asignacion.folio;

  try{
    await runTransaction(db, async tx=>{
      // 1) Validar stock en central (leer todo primero)
      const now = new Date().toISOString();
      const lecturas = [];
      for (const it of asignacion.items){
        const oriRef = doc(db,"almacenes",CENTRAL,"inventarios", it.codigo);
        const dstRef = doc(db,"almacenes",destino,"inventarios", it.codigo);
        const oriSnap = await tx.get(oriRef);
        const stockOri = oriSnap.exists() ? (oriSnap.data().stock||0) : 0;
        if (stockOri < it.cantidad){
          throw new Error(`Stock insuficiente en central para ${it.codigo} (req ${it.cantidad}, hay ${stockOri})`);
        }
        const dstSnap = await tx.get(dstRef);
        const stockDst = dstSnap.exists() ? (dstSnap.data().stock||0) : 0;
        lecturas.push({oriRef, dstRef, stockOri, stockDst, it});
      }

      // 2) Escribir movimientos (todas las writes después)
      for (const r of lecturas){
        tx.set(r.oriRef, {
          codigo: r.it.codigo,
          descripcion: r.it.descripcion || null,
          stock: r.stockOri - r.it.cantidad,
          ultimaActualizacion: now,
          ultimaSalidaFolio: folio
        }, { merge:true });

        tx.set(r.dstRef, {
          codigo: r.it.codigo,
          descripcion: r.it.descripcion || null,
          stock: r.stockDst + r.it.cantidad,
          ultimaActualizacion: now,
          ultimaEntradaFolio: folio
        }, { merge:true });
      }

      // 3) Log en salidas del central y entradas del destino
      const salRef = doc(collection(db,"almacenes",CENTRAL,"salidas"));
      tx.set(salRef, { folio, fecha: now, tipo:"transferencia", destino, items: asignacion.items });

      const entRef = doc(collection(db,"almacenes",destino,"entradas"));
      tx.set(entRef, { folio, fecha: now, tipo:"transferencia", origen:CENTRAL, items: asignacion.items });
    });

    alert(`Transferencia aplicada ✅ Folio ${asignacion.folio}`);
    // limpiar
    asignacion = null;
    $("#area").style.display = "none";
  }catch(err){
    alert(err.message || "No se pudo aplicar.");
    console.error(err);
  }
}
</script>
</body>
</html>
