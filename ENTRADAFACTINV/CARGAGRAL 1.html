<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cargador XML → ALMACENCENTRALPDD (modular v9)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;padding:16px;max-width:820px;margin:auto;background:#0b0b0b;color:#eaeaea}
    h1{font-size:1.1rem;margin:0 0 10px}
    .card{background:#151515;border:1px solid #252525;border-radius:12px;padding:14px;margin-top:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type=file]{padding:10px;background:#1c1c1c;border:1px solid #2b2b2b;border-radius:8px;color:#ddd}
    button{padding:10px 14px;border-radius:10px;border:1px solid #2b2b2b;background:#1f4fff;color:white;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .log{font-family:ui-monospace,Consolas,monospace;font-size:12px;white-space:pre-wrap;background:#0f0f0f;border:1px solid #222;border-radius:8px;padding:10px;max-height:260px;overflow:auto}
    .ok{color:#9cf59c} .warn{color:#ffd38a} .err{color:#ff9c9c}
    .stat{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .pill{background:#141414;border:1px solid #2a2a2a;border-radius:10px;padding:8px;text-align:center}
    .pill b{display:block;font-size:1.2rem}
  </style>
</head>
<body>
  <h1>Subir XML a <code>ALMACENCENTRALPDD</code> (pendiente_mapeo, sin duplicados)</h1>

  <div class="card">
    <div class="row">
      <input type="file" id="xmlFile" accept=".xml" multiple />
      <button id="btnSubir">Subir XML</button>
    </div>
    <div class="stat">
      <div class="pill">Creados<b id="cCreados">0</b></div>
      <div class="pill">Duplicados<b id="cDupl">0</b></div>
      <div class="pill">Rechazados<b id="cRech">0</b></div>
    </div>
  </div>

  <div class="card">
    <div class="log" id="log"></div>
  </div>

  <script type="module">
    // ======== IMPORTS MODULAR v9 (CDN) ========
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, runTransaction
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // ======== TU CONFIG (la que me pasaste) ========
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    // ======== INIT ========
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ======== CONSTANTES DE NEGOCIO ========
    const CENTRAL = 'ALMACENCENTRALPDD';
    const RFC_RECEPTOR_PERMITIDO = 'PDD031204KL5';

    // ======== UI HELPERS ========
    const logEl = document.getElementById('log');
    const btn   = document.getElementById('btnSubir');
    function addLog(msg, cls=''){ const d=document.createElement('div'); if(cls)d.className=cls; d.textContent=msg; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; }
    function setStat(id,v){ document.getElementById(id).textContent = v; }
    function attr(n,a){ return n ? (n.getAttribute(a) || '').trim() : ''; }

    // ======== ASEGURAR DOC CENTRAL ========
    async function asegurarCentral(){
      await setDoc(doc(db,'almacenes', CENTRAL), {}, { merge:true });
    }

    // ======== PARSEO CFDI 4.0 ========
    function parseCFDI(xmlText){
      const NS_CFDI="http://www.sat.gob.mx/cfd/4";
      const NS_TFD ="http://www.sat.gob.mx/TimbreFiscalDigital";
      const docXML = new DOMParser().parseFromString(xmlText, "text/xml");

      const c = docXML.getElementsByTagNameNS(NS_CFDI,"Comprobante")[0];
      if(!c) throw new Error("No es CFDI 4.0");

      const tipo      = (attr(c,"TipoDeComprobante")||'').toUpperCase();
      const serie     = attr(c,"Serie");
      const folioXML  = attr(c,"Folio");
      const fechaXML  = attr(c,"Fecha");
      const total     = parseFloat(attr(c,"Total")||0);
      const moneda    = attr(c,"Moneda");

      const emisor    = docXML.getElementsByTagNameNS(NS_CFDI,"Emisor")[0];
      const rfcEmisor = attr(emisor,"Rfc")||'';
      const nomEmisor = attr(emisor,"Nombre")||'';

      const receptor  = docXML.getElementsByTagNameNS(NS_CFDI,"Receptor")[0];
      const rfcRec    = (attr(receptor,"Rfc")||'').toUpperCase();
      const nomRec    = attr(receptor,"Nombre")||'';

      const conceptosProveedor = Array.from(docXML.getElementsByTagNameNS(NS_CFDI,"Concepto"))
        .map(x=>({
          codigoProveedor: attr(x,"NoIdentificacion")||'',
          descripcion: attr(x,"Descripcion")||'',
          cantidad: Number(attr(x,"Cantidad")||0),
          costoUnit: Number(attr(x,"ValorUnitario")||0),
          importe: Number(attr(x,"Importe")||0)
        }))
        .filter(i=>i.codigoProveedor && i.cantidad>0);

      const tfd = docXML.getElementsByTagNameNS(NS_TFD,"TimbreFiscalDigital")[0];
      const uuid = tfd ? (attr(tfd,"UUID")||'').toUpperCase() : '';

      return { uuid, tipo, serie, folioXML, fechaXML, total, moneda,
               rfcEmisor, nombreEmisor: nomEmisor,
               rfcReceptor: rfcRec, nombreReceptor: nomRec,
               conceptosProveedor };
    }

    // ======== VALIDACIONES ========
    function validarCFDI(meta){
      if(!meta.uuid) throw new Error("XML sin UUID.");
      if(meta.tipo !== 'I') throw new Error(`Tipo ${meta.tipo} rechazado (solo I).`);
      if(meta.rfcReceptor !== RFC_RECEPTOR_PERMITIDO)
        throw new Error(`RFC receptor ${meta.rfcReceptor} ≠ ${RFC_RECEPTOR_PERMITIDO}.`);
      if(!meta.conceptosProveedor.length) throw new Error("Sin conceptos válidos.");
    }

    // ======== CREAR ENTRADA CRUDA (SIN DUPLICADOS) ========
    async function crearEntradaCruda(meta){
      const entradaRef = doc(db, 'almacenes', CENTRAL, 'entradas', meta.uuid); // ID = UUID
      const now = new Date().toISOString();

      // Transacción: crea solo si NO existe (antiduplicado real)
      await runTransaction(db, async (tx) => {
        const snap = await tx.get(entradaRef);
        if (snap.exists()) throw new Error("DUPLICADO_UUID");
        tx.set(entradaRef, {
          uuid: meta.uuid,
          tipoComprobante: meta.tipo,
          serie: meta.serie || null,
          folioXML: meta.folioXML || null,
          fechaXML: meta.fechaXML || null,
          fechaRegistro: now,
          rfcEmisor: meta.rfcEmisor || null,
          nombreEmisor: meta.nombreEmisor || null,
          rfcReceptor: meta.rfcReceptor || null,
          nombreReceptor: meta.nombreReceptor || null,
          total: meta.total ?? null,
          moneda: meta.moneda || null,
          conceptosProveedor: meta.conceptosProveedor, // RAW proveedor
          itemsMapeados: [],
          estado: "pendiente_mapeo" // rol 2 mapeará y aplicará después
        });
      });
    }

    // ======== FLUJO PRINCIPAL ========
    document.getElementById('btnSubir').addEventListener('click', subirXMLs);

    async function subirXMLs(){
      btn.disabled = true;
      logEl.textContent = '';
      setStat('cCreados', 0); setStat('cDupl', 0); setStat('cRech', 0);

      try{
        await asegurarCentral();
        const files = document.getElementById('xmlFile').files;
        if(!files.length){ addLog('Selecciona uno o más XML.', 'warn'); btn.disabled=false; return; }

        let creados=0, duplicados=0, rechazados=0;

        for (const f of files){
          try{
            const xmlText = await f.text();
            const meta = parseCFDI(xmlText);
            validarCFDI(meta);
            await crearEntradaCruda(meta);
            creados++; addLog(`✔ ${f.name} → creado UUID=${meta.uuid}`, 'ok');
          }catch(e){
            const msg = String(e && e.message ? e.message : e);
            if (msg === 'DUPLICADO_UUID'){ duplicados++; addLog(`↷ ${f.name} → duplicado (UUID ya registrado)`, 'warn'); }
            else { rechazados++; addLog(`✖ ${f.name} → ${msg}`, 'err'); }
          }
          setStat('cCreados', creados);
          setStat('cDupl', duplicados);
          setStat('cRech', rechazados);
        }

        addLog(`\nResumen → Creados:${creados} | Duplicados:${duplicados} | Rechazados:${rechazados}`);
      }catch(err){
        addLog(`Error general: ${err.message||err}`, 'err');
      }finally{
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
