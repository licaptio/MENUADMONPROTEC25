<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Pendientes & Mapeo ‚Äî ALMACENCENTRALPDD</title>
<style>
  :root{--bg:#0b0b0b;--card:#151515;--border:#262626;--text:#eaeaea;--brand:#1f4fff}
  body{font-family:system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text);margin:0}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border)}
  header h1{font-size:16px;margin:0}
  main{padding:16px 18px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:10px 8px;font-size:14px;text-align:left}
  th{opacity:.9}
  button{background:var(--brand);border:1px solid #2b2b2b;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
  button.ghost{background:#111;border-color:var(--border);color:#ddd}
  input{background:#1a1a1a;color:#ddd;border:1px solid var(--border);border-radius:8px;padding:8px}
  .muted{opacity:.72} .red{color:#ff9c9c} .green{color:#8ef59e}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#101010}
  .ok{background:#0f2714;border-color:#1f5c2e} .danger{background:#2a1212;border-color:#4d1b1b}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .hidden{display:none}
  .small{font-size:12px}
</style>
</head>
<body>

<header>
  <h1 id="title">Pendientes de mapeo ‚Üí <code>ALMACENCENTRALPDD</code></h1>
  <div class="toolbar" id="toolbar">
    <button id="btnRefrescar">Refrescar</button>
  </div>
</header>

<main>
  <!-- Vista 1: pendientes -->
  <section id="viewList" class="card">
    <table>
      <thead>
        <tr><th>UUID</th><th>Proveedor</th><th>Folio</th><th>Fecha</th><th>Ptes</th><th></th></tr>
      </thead>
      <tbody id="tbodyList">
        <tr><td colspan="6" class="muted">Cargando‚Ä¶</td></tr>
      </tbody>
    </table>
  </section>

  <!-- Vista 2: mapear entrada -->
  <section id="viewMap" class="card hidden">
    <div class="toolbar" style="justify-content:space-between;margin-bottom:10px">
      <div class="toolbar">
        <button class="ghost" id="btnBack">‚Üê Volver</button>
        <span class="muted small">Proveedor: <code id="m_rfc"></code> ‚Ä¢ UUID: <code id="m_uuid"></code></span>
      </div>
      <span id="m_estado" class="pill danger">pendiente_mapeo</span>
    </div>

    <div class="small muted" style="margin:-4px 0 12px">
      Folio XML: <code id="m_folio"></code> ‚Ä¢ Fecha: <code id="m_fecha"></code>
    </div>

    <table>
      <thead>
        <tr>
          <th>Cod. proveedor</th>
          <th>Descripci√≥n</th>
          <th>Cant</th>
          <th>Buscar en <code>productos</code></th>
          <th>Equivalencia</th>
        </tr>
      </thead>
      <tbody id="m_tbody"></tbody>
    </table>

    <div id="m_actions" style="margin-top:12px"></div>
  </section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getFirestore, collection, query, where, getDocs, doc, getDoc, setDoc,
  runTransaction, orderBy, startAt, endAt
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

/* Config */
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const CENTRAL = "ALMACENCENTRALPDD";

/* Router simple */
const $ = (s)=>document.querySelector(s);
const viewList = $("#viewList"), viewMap  = $("#viewMap");
const title = $("#title"), toolbar = $("#toolbar");
$("#btnBack").addEventListener("click", ()=>showList());
$("#btnRefrescar").addEventListener("click", cargarPendientes);
window.addEventListener("DOMContentLoaded", cargarPendientes);

function showList(){ title.innerHTML = 'Pendientes de mapeo ‚Üí <code>ALMACENCENTRALPDD</code>'; toolbar.classList.remove("hidden"); viewMap.classList.add("hidden"); viewList.classList.remove("hidden"); cargarPendientes(); }
function showMap(){ title.textContent = "Mapear entrada"; toolbar.classList.add("hidden"); viewList.classList.add("hidden"); viewMap.classList.remove("hidden"); }

/* LISTA */
async function cargarPendientes(){
  const tbody = $("#tbodyList");
  tbody.innerHTML = `<tr><td colspan="6" class="muted">Cargando‚Ä¶</td></tr>`;
  const q = query(collection(db,"almacenes",CENTRAL,"entradas"), where("estado","in",["pendiente_mapeo","parcial"]));
  const snap = await getDocs(q);
  const rows = [];
  for (const d of snap.docs){
    const e = d.data();
    const ptes = await contarPendientes(e);
    rows.push(`<tr>
      <td class="small"><code>${d.id}</code></td>
      <td class="small">${e.nombreEmisor || "-"}</td>
      <td class="small">${e.folioXML || "-"}</td>
      <td class="small">${e.fechaXML || "-"}</td>
      <td class="small ${ptes? 'red':'green'}">${ptes}</td>
      <td><button onclick="irMapear('${d.id}')">Mapear</button></td>
    </tr>`);
  }
  tbody.innerHTML = rows.join("") || `<tr><td colspan="6" class="muted">Sin pendientes üéâ</td></tr>`;
}
async function contarPendientes(e){
  let n=0;
  for (const it of (e.conceptosProveedor||[])){
    const idEq = `${(e.rfcEmisor||'').toUpperCase()}_${(it.codigoProveedor||'').toUpperCase()}`;
    const eq = await getDoc(doc(db,"equivalencias", idEq));
    if (!eq.exists() || !eq.data().codigoInterno) n++;
  }
  return n;
}

/* VISTA MAPEO */
window.irMapear = async (uuid)=>{ showMap(); await cargarDetalle(uuid); };

async function cargarDetalle(uuid){
  const ref = doc(db,"almacenes",CENTRAL,"entradas",uuid);
  const s = await getDoc(ref); if(!s.exists()) { alert("Entrada no encontrada"); showList(); return; }
  const e = s.data();

  $("#m_uuid").textContent  = uuid;
  $("#m_rfc").textContent   = e.rfcEmisor || "-";
  $("#m_folio").textContent = e.folioXML || "-";
  $("#m_fecha").textContent = e.fechaXML || "-";
  const estadoEl = $("#m_estado");
  estadoEl.textContent = e.estado || "-";
  estadoEl.className = "pill " + (e.estado==="aplicada" ? "ok" : "danger");

  const tbody = $("#m_tbody");
  const rows = [];
  let pendientes = 0;
  const bloqueado = e.estado === "aplicada"; // no editar si ya fue aplicada

  for (const it of (e.conceptosProveedor||[])){
    const prov = (it.codigoProveedor||'').toUpperCase();
    const idEq = `${(e.rfcEmisor||'').toUpperCase()}_${prov}`;
    const safe = idEq.replace(/[^a-zA-Z0-9_-]/g,"_");
    const eqSnap = await getDoc(doc(db,"equivalencias", idEq));
    const eq = eqSnap.exists() ? (eqSnap.data().codigoInterno || "") : "";

    if (!eq) pendientes++;

    rows.push(`<tr>
      <td><code>${prov}</code></td>
      <td>${it.descripcion || ""}</td>
      <td>${it.cantidad}</td>
      <td>
        ${bloqueado ? '<span class="muted small">‚Äî</span>' : `
        <div class="toolbar small">
          <input id="bus_${safe}" placeholder="buscar ID de producto..." style="min-width:200px" />
          <button onclick="buscarProducto('bus_${safe}','res_${safe}')">Buscar</button>
        </div>
        <div id="res_${safe}" class="small muted"></div>`}
      </td>
      <td id="eqcell_${safe}">
        ${eq
          ? (bloqueado
            ? `<code class="green">${eq}</code> <span class="muted small">(bloqueado)</span>`
            : `<code class="green">${eq}</code>
               <button class="ghost small" onclick="startEditEq('${idEq}','${eq}','eqcell_${safe}','${uuid}','${(it.descripcion||"").replace(/'/g,"&#39;")}')">Editar</button>
               <button class="ghost small" onclick="eliminarEq('${idEq}','${uuid}')">Quitar</button>`
            )
          : (bloqueado
            ? `<span class="muted small">‚Äî</span>`
            : `<div class="toolbar small">
                 <input id="ci_${safe}" placeholder="pegar ID (doc) de productos" />
                 <button onclick="guardarEq('${idEq}','ci_${safe}','${(it.descripcion||"").replace(/'/g,"&#39;")}','${uuid}')">Guardar</button>
               </div>`
            )
        }
      </td>
    </tr>`);
  }

  tbody.innerHTML = rows.join("") || `<tr><td colspan="5" class="muted">Sin partidas</td></tr>`;
  if (bloqueado){
    $("#m_actions").innerHTML = `<span class="muted">Entrada <b>aplicada</b>. No editable.</span>`;
    return;
  }
  $("#m_actions").innerHTML = (pendientes===0)
    ? `<button onclick="aplicar('${uuid}')">‚úÖ Aplicar al inventario del central</button>`
    : `<span class="muted">Pendientes de equivalencia: <b class="red">${pendientes}</b></span>`;
}

/* Buscar en productos (por ID prefijo o "Codigo Barra" exacto) */
window.buscarProducto = async (inputId, resultsId)=>{
  const term = (document.getElementById(inputId).value || "").trim();
  const out  = document.getElementById(resultsId);
  out.textContent = "Buscando‚Ä¶";
  if (!term){ out.textContent = "Escribe un ID de producto o c√≥digo de barras."; return; }

  const prodCol = collection(db,"productos");
  let html = "", count = 0;

  const q1 = query(prodCol, orderBy("__name__"), startAt(term), endAt(term + "\uf8ff"));
  const s1 = await getDocs(q1);
  s1.forEach(d=>{
    const p = d.data();
    html += `<div><b>${d.id}</b> ‚Äî ${p["Concepto"] || p["descripcion"] || ""} <button onclick="pegarCodigo('${resultsId}','${d.id}')">Usar</button></div>`;
    count++;
  });

  if (!count){
    const q2 = query(prodCol, where("Codigo Barra","==", term));
    const s2 = await getDocs(q2);
    s2.forEach(d=>{
      const p = d.data();
      html += `<div><b>${d.id}</b> ‚Äî ${p["Concepto"] || ""} <button onclick="pegarCodigo('${resultsId}','${d.id}')">Usar</button></div>`;
      count++;
    });
  }

  out.innerHTML = count ? html : "Sin coincidencias.";
};
window.pegarCodigo = (resultsId, code)=>{
  const ciId = resultsId.replace("res_","ci_");
  const inp = document.getElementById(ciId);
  if (inp){ inp.value = code; inp.focus(); }
};

/* Guardar/editar/quitar equivalencia */
window.guardarEq = async (idEq, inputId, descProv, uuid)=>{
  const codigoInterno = (document.getElementById(inputId).value || "").trim().toUpperCase();
  if(!codigoInterno){ alert("Escribe o selecciona un c√≥digo interno."); return; }
  await setDoc(doc(db,"equivalencias", idEq), {
    rfcEmisor: idEq.split("_")[0],
    codigoProveedor: idEq.split("_")[1],
    codigoInterno,
    descripcionProveedor: descProv || null,
    actualizadoEn: new Date().toISOString()
  }, { merge:true });
  await cargarDetalle(uuid);
};

window.startEditEq = (idEq, actual, cellId, uuid, descProv)=>{
  const cell = document.getElementById(cellId);
  const safe = cellId.replace("eqcell_","");
  cell.innerHTML = `
    <div class="toolbar small">
      <input id="ci_${safe}" value="${actual}" />
      <button onclick="guardarEq('${idEq}','ci_${safe}','${descProv}','${uuid}')">Guardar</button>
      <button class="ghost" onclick="cargarDetalle('${uuid}')">Cancelar</button>
    </div>
  `;
};

window.eliminarEq = async (idEq, uuid)=>{
  await setDoc(doc(db,"equivalencias", idEq), {
    codigoInterno: null,
    actualizadoEn: new Date().toISOString()
  }, { merge:true });
  await cargarDetalle(uuid);
};

// ‚¨áÔ∏è REEMPLAZA COMPLETA tu funci√≥n window.aplicar por ESTA
window.aplicar = async (uuid)=>{
  try{
    await runTransaction(db, async (tx)=>{
      const entradaRef = doc(db,"almacenes",CENTRAL,"entradas",uuid);

      // === FASE 1: LECTURAS ===
      const s = await tx.get(entradaRef);
      if(!s.exists()) throw new Error("Entrada no encontrada");
      const e = s.data();
      if (e.estado === "aplicada") throw new Error("Ya aplicada.");

      // 1.a) Resolver equivalencias -> mapeados [{codigo, descripcion, cantidad, ...}]
      const mapeados = [];
      for (const it of (e.conceptosProveedor || [])){
        const idEq = `${(e.rfcEmisor||'').toUpperCase()}_${(it.codigoProveedor||'').toUpperCase()}`;
        const eqRef = doc(db,"equivalencias", idEq);
        const eqSnap = await tx.get(eqRef);
        if (!eqSnap.exists() || !eqSnap.data().codigoInterno){
          throw new Error(`Falta equivalencia para ${it.codigoProveedor}`);
        }
        const codigo = (eqSnap.data().codigoInterno || '').toUpperCase();
        mapeados.push({
          codigo,
          descripcion: it.descripcion || null,
          cantidad: Number(it.cantidad || 0),
          costoUnit: it.costoUnit ?? null,
          importe: it.importe ?? null
        });
      }

      // 1.b) Lectura de inventarios actuales del CENTRAL
      const invLecturas = [];
      for (const it of mapeados){
        const invRef = doc(db,"almacenes",CENTRAL,"inventarios", it.codigo);
        const invSnap = await tx.get(invRef);
        const curr = invSnap.exists() ? (invSnap.data().stock || 0) : 0;
        invLecturas.push({ invRef, curr, it });
      }

      // === FASE 2: ESCRITURAS === (sin m√°s lecturas despu√©s)
      const now = new Date().toISOString();

      // 2.a) Actualizar inventarios del CENTRAL (sumar)
      for (const {invRef, curr, it} of invLecturas){
        tx.set(invRef, {
          codigo: it.codigo,
          descripcion: it.descripcion,
          proveedor: e.rfcEmisor || null,
          costoPromedio: it.costoUnit ?? null,
          stock: curr + it.cantidad,
          ultimaActualizacion: now,
          ultimaEntradaUUID: uuid
        }, { merge:true });
      }

      // 2.b) Normalizar a TU esquema: articulos[] (igual que salidas)
      const articulos = mapeados.map(it => ({
        codigo: it.codigo,
        nombre: it.descripcion || "",
        cantidad: Number(it.cantidad || 0)
      }));

      // 2.c) Marcar la entrada como aplicada y guardar ambos formatos (compatibilidad)
      tx.update(entradaRef, {
        estado: "aplicada",
        aplicadaEn: now,

        // compatibilidad con lo que ya ten√≠as:
        itemsMapeados: mapeados,

        // nuevo esquema igual que salidas:
        articulos,                         // üëà <‚Äî LO NUEVO
        tipo: e.tipo || "entrada_xml",     // etiqueta del movimiento
        origen: e.origen || (e.rfcEmisor ? "proveedor" : null),
        proveedorRFC: e.rfcEmisor || null,
        proveedorNombre: e.nombreEmisor || null,

        // alias para visores (si quieres usar siempre los mismos nombres):
        folio: e.folioXML || null,
        fecha: e.fechaXML || e.fecha || null
      });
    });

    alert("Aplicada al inventario del central ‚úÖ");
    showList();
  }catch(err){
    alert(err.message || "No se pudo aplicar.");
    console.error(err);
  }
};
</script>
</body>
</html>
