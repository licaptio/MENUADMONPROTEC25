<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Visor de Entradas — almacen_zapata</title>
<style>
  :root{--bg:#0b0b0b;--card:#151515;--border:#262626;--text:#eaeaea;--brand:#1f4fff}
  body{font-family:system-ui;background:var(--bg);color:var(--text);margin:0}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border)}
  header h1{font-size:16px;margin:0}
  main{padding:16px 18px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,button{border-radius:10px;border:1px solid var(--border);padding:8px}
  input,select{background:#1a1a1a;color:#ddd}
  button{background:var(--brand);color:#fff;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;font-size:14px}
  .muted{opacity:.75}
  .small{font-size:12px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#101010}
  .list{max-height:60vh;overflow:auto}
  code{background:#111;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
<header>
  <h1>Entradas — <code>almacen_zapata</code></h1>
  <div class="row small muted">
    Ruta: <code>almacenes/almacen_zapata/entradas</code>
  </div>
</header>

<main class="card">
  <!-- Filtros -->
  <div class="row" style="margin-bottom:10px">
    <label>Desde:</label><input type="date" id="fDesde"/>
    <label>Hasta:</label><input type="date" id="fHasta"/>
    <input id="fBuscar" placeholder="Buscar folio o UUID"/>
    <select id="fTipo">
      <option value="">Tipo (todos)</option>
      <option value="transferencia">transferencia</option>
      <option value="transferencia_factura">transferencia_factura</option>
      <option value="entrada_manual">entrada_manual</option>
    </select>
    <button id="btnFiltrar">Aplicar filtros</button>
    <button id="btnLimpiar" style="background:#333;border-color:#444">Limpiar</button>
  </div>

  <!-- Resumen -->
  <div class="row small">
    <span class="pill">Total docs: <b id="kDocs">0</b></span>
    <span class="pill">Total piezas: <b id="kPzas">0</b></span>
  </div>

  <!-- Tabla -->
  <div class="list">
    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Folio</th>
          <th>Tipo</th>
          <th>Origen / UUID</th>
          <th>Items</th>
          <th>Ver</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="6" class="muted">Cargando…</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Detalle -->
  <div id="detalle" class="card" style="margin-top:12px;display:none">
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div>
        <div class="small muted">Detalle de entrada</div>
        <div style="margin-top:4px">
          <span>Folio: <code id="d_folio"></code></span> ·
          <span>Tipo: <code id="d_tipo"></code></span> ·
          <span>Fecha: <code id="d_fecha"></code></span>
        </div>
        <div class="small muted" style="margin-top:4px">
          Origen: <code id="d_origen"></code> · UUID: <code id="d_uuid"></code>
        </div>
        <div class="small muted" style="margin-top:4px">
          Doc ID: <code id="d_id"></code>
        </div>
      </div>
      <button id="btnCerrar" style="background:#333;border-color:#444">Cerrar</button>
    </div>

    <table style="margin-top:10px">
      <thead><tr><th>Código</th><th>Descripción</th><th>Cantidad</th></tr></thead>
      <tbody id="d_items"></tbody>
    </table>
  </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getFirestore, collection, query, where, orderBy, getDocs,
  startAt, endAt, doc, getDoc, limit
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

/* Firebase (tu proyecto) */
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

const $ = (s)=>document.querySelector(s);
const tbody = $("#tbody");
const dPanel = $("#detalle");

/* Defaults: últimos 30 días */
window.addEventListener("DOMContentLoaded", ()=>{
  const today = new Date();
  const past  = new Date(today); past.setDate(today.getDate()-30);
  $("#fHasta").value  = toYMD(today);
  $("#fDesde").value  = toYMD(past);
  cargar();
});
$("#btnFiltrar").addEventListener("click", cargar);
$("#btnLimpiar").addEventListener("click", ()=>{
  $("#fDesde").value = ""; $("#fHasta").value = "";
  $("#fBuscar").value = ""; $("#fTipo").value = "";
  cargar();
});
$("#btnCerrar").addEventListener("click", ()=> dPanel.style.display="none");

function toYMD(d){ return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }

/* Carga con filtros */
async function cargar(){
  tbody.innerHTML = `<tr><td colspan="6" class="muted">Cargando…</td></tr>`;

  const col = collection(db, "almacenes", "almacen_zapata", "entradas");
  let q = query(col, orderBy("fecha","desc"), limit(250)); // hasta 250 últimas; ajusta si necesitas

  // Filtro por rango (si "fecha" es ISO string o Timestamp funciona con orderBy + where)
  const d1 = $("#fDesde").value;
  const d2 = $("#fHasta").value;
  if (d1 && d2){
    // Si guardas ISO string: amplía con 'T00:00:00' y 'T23:59:59' para incluir el día completo
    const from = d1.length===10 ? d1+"T00:00:00" : d1;
    const to   = d2.length===10 ? d2+"T23:59:59" : d2;
    // Usa 2 where para rango + orderBy("fecha")
    q = query(col, where("fecha", ">=", from), where("fecha", "<=", to), orderBy("fecha","desc"), limit(500));
  }

  const snap = await getDocs(q);

  // Filtros en cliente (evitamos pedir índices compuestos)
  const needle = ($("#fBuscar").value||"").trim().toLowerCase();
  const tipo   = $("#fTipo").value;

  const rows = [];
  let totalPzas = 0;

  snap.forEach(d=>{
    const x = d.data();
    // Normaliza campos esperados
    const fecha = x.fecha || x.fechaXML || "";
    const folio = x.folio || x.folioXML || "";
    const uuid  = x.relacionadoUUID || x.uuid || "";
    const tipoDoc = x.tipo || "";

    // Filtrado en cliente
    if (tipo && tipoDoc !== tipo) return;
    if (needle && !(`${folio}`.toLowerCase().includes(needle) || `${uuid}`.toLowerCase().includes(needle))) return;

    const items = Array.isArray(x.items) ? x.items : (Array.isArray(x.itemsMapeados)? x.itemsMapeados : []);
    const piezas = items.reduce((a,b)=> a + Number(b.cantidad||0), 0);
    totalPzas += piezas;

    rows.push(`
      <tr>
        <td>${fecha || "-"}</td>
        <td>${folio ? `<code>${folio}</code>` : "-"}</td>
        <td><code>${tipoDoc||"-"}</code></td>
        <td>${(x.origen || "—")} / ${uuid ? `<code>${uuid}</code>`:"—"}</td>
        <td>${piezas}</td>
        <td><button onclick="ver('${d.id}')">Ver</button></td>
      </tr>
    `);
  });

  tbody.innerHTML = rows.join("") || `<tr><td colspan="6" class="muted">Sin resultados.</td></tr>`;
  $("#kDocs").textContent = rows.length;
  $("#kPzas").textContent = totalPzas;
}

/* Detalle */
window.ver = async (id)=>{
  const ref = doc(db,"almacenes","almacen_zapata","entradas", id);
  const s = await getDoc(ref);
  if (!s.exists()) return alert("Documento no encontrado.");
  const x = s.data();

  $("#d_id").textContent    = s.id;
  $("#d_folio").textContent = x.folio || x.folioXML || "-";
  $("#d_tipo").textContent  = x.tipo || "-";
  $("#d_fecha").textContent = x.fecha || x.fechaXML || "-";
  $("#d_origen").textContent= x.origen || "-";
  $("#d_uuid").textContent  = x.relacionadoUUID || x.uuid || "-";

  const items = Array.isArray(x.items) ? x.items : (Array.isArray(x.itemsMapeados)? x.itemsMapeados : []);
  const lines = items.map(it=>`
    <tr>
      <td><code>${(it.codigo||"").toString().toUpperCase()}</code></td>
      <td>${it.descripcion || ""}</td>
      <td>${Number(it.cantidad||0)}</td>
    </tr>
  `);
  $("#d_items").innerHTML = lines.join("") || `<tr><td colspan="3" class="muted">Sin items</td></tr>`;

  dPanel.style.display = "block";
}
</script>
</body>
</html>
