<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“ˆ EstadÃ­sticas Ingresos Fiscales</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #fdfbfb, #ebedee);
      margin: 0;
      padding: 1em;
    }

    h2 {
      text-align: center;
      color: #34495e;
      margin-top: 0.5em;
    }

    .aviso-movil {
      text-align: center;
      color: #e74c3c;
      font-weight: bold;
      font-size: 1em;
      margin-top: 0.5em;
      animation: parpadeo 1s infinite;
      display: none;
    }

    @keyframes parpadeo {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    .chart-container {
      width: 100%;
      overflow-x: auto;
      margin: 1.5em 0;
    }

    .chart-wrapper {
      min-width: 300px;
      max-width: 1000px;
      margin: 0 auto;
      padding: 1em;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    canvas {
      display: block;
      width: 100% !important;
      height: auto !important;
      aspect-ratio: 2 / 1;
    }

    .tabla-scroll-wrapper {
      overflow: auto;
      margin-top: 1em;
      border-radius: 10px;
      background-color: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 1200px;
    }

    th, td {
      padding: 0.5em;
      border: 1px solid #ddd;
      text-align: center;
      font-size: 0.9em;
      white-space: nowrap;
    }

    th {
      background-color: #2980b9;
      color: white;
      position: sticky;
      top: 0;
      z-index: 3;
    }

    /* Columnas fijas */
    th.sticky-col, td.sticky-col {
      position: sticky;
      left: 0;
      z-index: 2;
      background-color: #2980b9;
    }

    th.sticky-col-2, td.sticky-col-2 {
      position: sticky;
      left: 100px; /* Ancho estimado de la primera columna */
      z-index: 2;
      background-color: #2980b9;
    }

    td.sticky-col, td.sticky-col-2 {
      background-color: #fff;
    }

    /* Responsive */
    @media (max-width: 768px) {
      th, td {
        font-size: 0.75em;
        padding: 0.4em;
      }
      .aviso-movil { display: block; }
    }

    @media (min-width: 768px) {
      h2 { font-size: 2em; }
      body { padding: 2em 3em; }
    }
  </style>
</head>
<body>

<h2>ðŸ“Š EstadÃ­sticas Ingresos Fiscales</h2>
<div class="aviso-movil">ðŸ”„ Para una mejor visualizaciÃ³n, gira tu celular en horizontal</div>

<div class="chart-container">
  <div class="chart-wrapper">
    <canvas id="graficaComparativa"></canvas>
  </div>
</div>

<div class="chart-container">
  <div class="chart-wrapper">
    <canvas id="graficaHistorica"></canvas>
  </div>
</div>

<h2>ðŸ“‹ Tabla de Ingresos Fiscales</h2>
<div class="tabla-scroll-wrapper">
  <table id="tablaDatos">
    <thead>
      <tr>
        <th class="sticky-col">CONCEPTO</th>
        <th class="sticky-col-2">AÃ‘O</th>
        <th>ENERO</th><th>FEBRERO</th><th>MARZO</th><th>ABRIL</th>
        <th>MAYO</th><th>JUNIO</th><th>JULIO</th><th>AGOSTO</th><th>SEPTIEMBRE</th>
        <th>OCTUBRE</th><th>NOVIEMBRE</th><th>DICIEMBRE</th><th>ANUAL</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const supabase = window.supabase.createClient(
  'https://cvpbtjlupswbyxenugpz.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY'
);

async function cargarDatos() {
  const { data, error } = await supabase.from('tablapdddatos').select('*').order('anio');
  if (error) return alert("Error al cargar: " + error.message);
  graficarComparativaMensual(data);
  graficarComparativaHistorica(data);
  mostrarTabla(data);
}

function mostrarTabla(data) {
  const tbody = document.querySelector("#tablaDatos tbody");
  tbody.innerHTML = "";
  const meses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];

  data.forEach(registro => {
    let fila = `<tr><td class="sticky-col">${registro.concepto || ''}</td><td class="sticky-col-2">${registro.anio}</td>`;
    let total = 0;
    meses.forEach(mes => {
      const val = parseFloat(registro[mes] || 0);
      total += val;
      fila += `<td>$${val.toLocaleString('es-MX', {minimumFractionDigits:2})}</td>`;
    });
    fila += `<td><strong>$${total.toLocaleString('es-MX', {minimumFractionDigits:2})}</strong></td></tr>`;
    tbody.innerHTML += fila;
  });
}

function graficarComparativaMensual(data) {
  const ctx = document.getElementById('graficaComparativa').getContext('2d');
  const meses = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];

  const datasets = data.map((registro, index) => {
    const is2025 = registro.anio === 2025;
    const color = is2025 ? '#2980b9' : `hsl(${index * 60}, 70%, 50%)`;

    return {
      label: registro.anio,
      data: meses.map(mes => parseFloat(registro[mes.toLowerCase()] || 0)),
      borderColor: color,
      backgroundColor: color,
      fill: false,
      tension: 0.3,
      borderWidth: is2025 ? 4 : 2,
      hidden: false,
      pointRadius: is2025 ? 5 : 3,
      pointBackgroundColor: is2025 ? '#2980b9' : color,
      pointBorderColor: is2025 ? '#2980b9' : color,
    };
  });

  const chart = new Chart(ctx, {
    type: 'line',
    data: { labels: meses, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: 'ðŸ“ˆ Comparativa mensual por aÃ±o' },
        legend: { position: 'bottom' }
      },
      scales: {
        y: {
          ticks: {
            callback: val => `$ ${val.toLocaleString("es-MX")}`
          }
        }
      }
    }
  });

  let visible = true;
  setInterval(() => {
    const ds = chart.data.datasets.find(d => d.label === 2025);
    if (ds) {
      ds.borderColor = visible ? '#2980b9' : 'rgba(0,0,0,0)';
      ds.pointBackgroundColor = visible ? '#2980b9' : 'rgba(0,0,0,0)';
      chart.update();
      visible = !visible;
    }
  }, 700);
}

function graficarComparativaHistorica(data) {
  const ctx = document.getElementById('graficaHistorica').getContext('2d');
  data.sort((a, b) => a.anio - b.anio);
  const meses = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];
  const etiquetas = [], valores = [];
  data.forEach(reg => {
    meses.forEach(mes => {
      etiquetas.push(`${mes.slice(0,3)} ${reg.anio}`);
      valores.push(parseFloat(reg[mes.toLowerCase()] || 0));
    });
  });
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: etiquetas,
      datasets: [{
        label: 'Ingreso Fiscal Mensual',
        data: valores,
        fill: true,
        borderColor: '#2ecc71',
        backgroundColor: 'rgba(46, 204, 113, 0.2)',
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: 'ðŸ“‰ EvoluciÃ³n histÃ³rica' },
        legend: { display: false }
      },
      scales: {
        y: {
          ticks: {
            callback: val => `$ ${val.toLocaleString("es-MX")}`
          }
        }
      }
    }
  });
}

cargarDatos();
</script>

</body>
</html>
