<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>📊 Reporte Financiero Dinámico</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background: #eef1f4; padding: 20px; text-align: center; }
    h2 { margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    th { background: #f3f3f3; }
    input { width: 100%; box-sizing: border-box; text-align: right; }
    select { width: 100%; }
    button { padding: 4px 8px; cursor: pointer; }
    footer { margin-top: 30px; font-size: 0.9em; color: #666; }
  </style>
</head>
<body>
<h2>📊 Reporte Financiero (últimos 4 años)</h2>
<table id="tabla">
  <thead>
    <tr>
      <th>Cuenta ID</th>
      <th>Nombre</th>
      <th>Año</th>
      <th>Ene</th>
      <th>Feb</th>
      <th>Mar</th>
      <th>Abr</th>
      <th>May</th>
      <th>Jun</th>
      <th>Jul</th>
      <th>Ago</th>
      <th>Sep</th>
      <th>Oct</th>
      <th>Nov</th>
      <th>Dic</th>
      <th>💾</th>
    </tr>
  </thead>
  <tbody id="cuerpo-tabla">
    <tr><td colspan="16">Cargando datos...</td></tr>
  </tbody>
</table>

<footer>Hecho por Gera Quezaa · Supabase 2025</footer>

<script>
  const supabase = window.supabase.createClient(
    'https://cvpbtjlupswbyxenugpz.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY'
  );

  const cuerpo = document.getElementById("cuerpo-tabla");
  const años = Array.from({length: 4}, (_, i) => new Date().getFullYear() - i);

  async function cargar() {
    const [catalogoRes, reporteRes] = await Promise.all([
      supabase.from("catalogo_cuentas").select("codigo, nombre"),
      supabase.from("reporte_financiero").select("*")
    ]);

    const cuentas = catalogoRes.data;
    const reportes = reporteRes.data;
    cuerpo.innerHTML = "";

    cuentas.forEach(cuenta => {
      años.forEach(anio => {
        const existente = reportes.find(r => r.cuenta_id === cuenta.codigo && r.anio === anio);
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${cuenta.codigo}</td>
          <td>${cuenta.nombre}</td>
          <td>${anio}</td>
          ${["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"]
            .map(mes => `<td><input data-col="${mes}" type="number" step="0.01" value="${existente?.[mes] ?? ""}" /></td>`).join("")}
          <td><button class="guardar-btn" data-id="${existente?.id || ""}" data-cuenta="${cuenta.codigo}" data-anio="${anio}">${existente ? "💾" : "➕"}</button></td>
        `;

        cuerpo.appendChild(tr);
      });
    });
  }

  document.addEventListener("click", async (e) => {
    if (!e.target.classList.contains("guardar-btn")) return;

    const btn = e.target;
    const tr = btn.closest("tr");
    const inputs = tr.querySelectorAll("input");
    const objeto = { cuenta_id: btn.dataset.cuenta, anio: parseInt(btn.dataset.anio) };

    inputs.forEach(input => {
      const key = input.dataset.col;
      objeto[key] = input.value === "" ? null : parseFloat(input.value);
    });

    let res;
    if (btn.dataset.id) {
      res = await supabase.from("reporte_financiero").update(objeto).eq("id", btn.dataset.id);
    } else {
      res = await supabase.from("reporte_financiero").insert([objeto]);
    }

    if (res.error) {
      alert("❌ Error");
      console.error(res.error);
    } else {
      btn.textContent = "✅";
      setTimeout(() => cargar(), 800);
    }
  });

  cargar();
</script>
</body>
</html>
