
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reporte Ingresos Supabase</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
window.onload = function () {
  const supabase = supabase.createClient(
    'https://cvpbtjlupswbyxenugpz.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY'
  );

  const cuerpo = document.getElementById("cuerpo-tabla");
  const campos = [
    'concepto','anio','enero','febrero','marzo','abril','mayo','junio',
    'julio','agosto','septiembre','octubre','noviembre','diciembre'
  ];

  async function cargarDatos() {
    const { data, error } = await supabase.from('ingresos_fiscales').select('*').order('anio');
    if (error) return alert("Error al cargar: " + error.message);
    cuerpo.innerHTML = "";
    data.forEach(reg => agregarFilaDesdeDB(reg));
  }

  function agregarFilaDesdeDB(data) {
    const tr = document.createElement("tr");
    campos.forEach(campo => {
      const td = document.createElement("td");
      td.textContent = data[campo] ?? "";
      td.dataset.campo = campo;
      td.contentEditable = false;
      tr.appendChild(td);
    });

    const tdAnual = document.createElement("td");
    tdAnual.textContent = data.anual?.toLocaleString("es-MX", { minimumFractionDigits: 2 }) || "0.00";
    tdAnual.className = "anual";
    tr.appendChild(tdAnual);

    const btnEditar = document.createElement("button");
    btnEditar.textContent = "Editar";
    btnEditar.onclick = () => habilitarEdicion(tr);
    const tdEdit = document.createElement("td");
    tdEdit.appendChild(btnEditar);
    tr.appendChild(tdEdit);

    const btnGuardar = document.createElement("button");
    btnGuardar.textContent = "Guardar";
    btnGuardar.onclick = () => guardarFila(tr, data.id);
    const tdGuardar = document.createElement("td");
    tdGuardar.appendChild(btnGuardar);
    tr.appendChild(tdGuardar);

    cuerpo.appendChild(tr);
  }

  function habilitarEdicion(tr) {
    for (let i = 0; i < campos.length; i++) {
      tr.children[i].contentEditable = true;
      tr.children[i].classList.add("editable");
      tr.children[i].addEventListener("input", () => recalcularAnual(tr));
    }
  }

  function recalcularAnual(tr) {
    let suma = 0;
    for (let i = 2; i <= 13; i++) {
      const val = parseFloat(tr.children[i].innerText.replace(/,/g, '')) || 0;
      suma += val;
    }
    tr.children[14].textContent = suma.toLocaleString("es-MX", { minimumFractionDigits: 2 });
  }

  async function guardarFila(tr, id) {
    const obj = {};
    campos.forEach((campo, i) => {
      const val = tr.children[i].innerText.trim();
      obj[campo] = campo === 'anio' ? parseInt(val) : parseFloat(val.replace(/,/g, '')) || 0;
    });
    obj.anual = campos.slice(2).reduce((acc, campo, i) => {
      const val = tr.children[i + 2].innerText.replace(/,/g, '');
      return acc + (parseFloat(val) || 0);
    }, 0);
    const res = id
      ? await supabase.from('ingresos_fiscales').update(obj).eq('id', id)
      : await supabase.from('ingresos_fiscales').insert(obj);
    if (res.error) {
      alert("Error al guardar: " + res.error.message);
    } else {
      alert("Guardado exitoso");
      cargarDatos();
    }
  }

  function agregarFila() {
    const tr = document.createElement("tr");
    campos.forEach(campo => {
      const td = document.createElement("td");
      td.contentEditable = true;
      td.classList.add("editable");
      td.dataset.campo = campo;
      tr.appendChild(td);
      td.addEventListener("input", () => recalcularAnual(tr));
    });

    const tdAnual = document.createElement("td");
    tdAnual.textContent = "0.00";
    tdAnual.className = "anual";
    tr.appendChild(tdAnual);

    const tdEdit = document.createElement("td");
    tdEdit.textContent = "-";
    tr.appendChild(tdEdit);

    const btnGuardar = document.createElement("button");
    btnGuardar.textContent = "Guardar";
    btnGuardar.onclick = () => guardarFila(tr, null);
    const tdGuardar = document.createElement("td");
    tdGuardar.appendChild(btnGuardar);
    tr.appendChild(tdGuardar);

    cuerpo.appendChild(tr);
  }

  cargarDatos();
};
</script>
</head>
<body>

<h2>Ingresos Nominales Fiscales</h2>
<table>
  <thead>
    <tr><th colspan="17">INGRESOS NOMINALES FISCALES</th></tr>
    <tr>
      <th>CONCEPTO</th><th>AÃ‘O</th>
      <th>ENERO</th><th>FEBRERO</th><th>MARZO</th><th>ABRIL</th><th>MAYO</th><th>JUNIO</th>
      <th>JULIO</th><th>AGOSTO</th><th>SEPTIEMBRE</th><th>OCTUBRE</th><th>NOVIEMBRE</th><th>DICIEMBRE</th>
      <th>ANUAL</th><th>Editar</th><th>Guardar</th>
    </tr>
  </thead>
  <tbody id="cuerpo-tabla"></tbody>
</table>

<button onclick="agregarFila()">+ Agregar fila nueva</button>

</body>
</html>
