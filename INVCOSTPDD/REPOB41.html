<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Migrar Inventarios Bodega 41</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, doc } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- CONFIG FIREBASE ---
    const configInv = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    const app = initializeApp(configInv);
    const db = getFirestore(app);

    async function migrar() {
      const logs = document.getElementById("logs");
      logs.innerHTML = "Iniciando migración...<br>";

      let totalDocs = 0;

      // 1. Leer todos los usuarios en /inventarios/Bodega 41/usuarios
      const usuariosRef = collection(db, "inventarios", "Bodega 41", "usuarios");
      const usuariosSnap = await getDocs(usuariosRef);

      for (let usuarioDoc of usuariosSnap.docs) {
        const usuario = usuarioDoc.id;
        logs.innerHTML += `Usuario encontrado: ${usuario}<br>`;

        // 2. Leer todos los escaneos de ese usuario
        const escaneosRef = collection(db, "inventarios", "Bodega 41", "usuarios", usuario, "escaneos");
        const escaneosSnap = await getDocs(escaneosRef);

        for (let escaneoDoc of escaneosSnap.docs) {
          const data = escaneoDoc.data();

          // 3. Agregar campo usuario (por si no lo trae)
          data.usuario = usuario;

          // 4. Guardar en nueva ruta /inventarios/Bodega 41 reportes/escaneosPlano
          const destinoRef = doc(db, "inventarios", "Bodega 41 reportes", "escaneosPlano", escaneoDoc.id);
          await setDoc(destinoRef, data);

          totalDocs++;
        }
      }

      logs.innerHTML += `<br><b>Migración completada. Total documentos copiados: ${totalDocs}</b>`;
    }

    window.migrar = migrar;
  </script>
</head>
<body>
  <h2>Migración de Inventarios – Bodega 41 → Reportes</h2>
  <button onclick="migrar()">Migrar Ahora</button>
  <div id="logs" style="margin-top:20px; font-family: monospace; font-size: 13px; background:#f7f7f7; padding:10px; border:1px solid #ccc; max-height:300px; overflow:auto;">
    Listo para migrar...
  </div>
</body>
</html>
