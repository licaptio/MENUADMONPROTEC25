<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Descargar Inventario Costeado – Bodega 41</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    #progress-container {width:100%; background:#eee; border:1px solid #aaa; height:22px; margin-top:10px;}
    #progress-bar {height:100%; width:0%; background:#4caf50; text-align:center; color:white; font-size:12px;}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- CONFIG FIREBASE INVENTARIO ---
    const configInv = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    // --- CONFIG FIREBASE PRODUCTOS ---
    const configProd = {
      apiKey: "AIzaSyA0JYm16CaVXr86ZGbKP8tpe47rl0LdBaw",
      authDomain: "bd-bodega41.firebaseapp.com",
      projectId: "bd-bodega41",
      storageBucket: "bd-bodega41.firebasestorage.app",
      messagingSenderId: "63153834263",
      appId: "1:63153834263:web:32f306d4dea573bee74f52",
      measurementId: "G-YCCWZCHCEV"
    };

    const appInv = initializeApp(configInv, "appInv");
    const appProd = initializeApp(configProd, "appProd");

    const dbInv = getFirestore(appInv);
    const dbProd = getFirestore(appProd);

    let productosMap = {};

    // -------- Cargar productos --------
    async function cargarProductos() {
      const snap = await getDocs(collection(dbProd, "productos"));
      snap.forEach(doc => {
        const d = doc.data();
        productosMap[doc.id] = {
          descripcion: d.concepto || "",
          costo: Number(d.costoSinImpuesto) || 0
        };
      });
      console.log("Productos cargados:", Object.keys(productosMap).length);
    }

    // -------- Exportar a Excel --------
    async function exportarExcel() {
      document.getElementById("status").innerText = "⏳ Cargando productos...";
      actualizarBarra(0);

      await cargarProductos();

      document.getElementById("status").innerText = "⏳ Cargando inventario...";
      const registros = [];
      const escaneosSnap = await getDocs(collection(dbInv, "inventarios", "Bodega 41 reportes", "escaneosPlano"));
      const total = escaneosSnap.size;
      let procesados = 0;

      escaneosSnap.forEach(it => {
        const d = it.data();
        const prod = productosMap[d.codigo] || {};
        const costo = prod.costo || 0;
        const importe = (Number(d.cantidad) || 0) * costo;

        registros.push({
          Usuario: d.usuario || "",
          Codigo: d.codigo || "",
          Descripcion: prod.descripcion || d.descripcion || "",
          Cantidad: Number(d.cantidad) || 0,
          Costo: costo,
          Importe: importe,
          Fecha: d.fecha || "",
          Sucursal: d.sucursal || "",
          FolioRegistro: d.folioRegistro || "",
          FolioSesion: d.folioSesion || ""
        });

        procesados++;
        if (procesados % 50 === 0) {
          actualizarBarra((procesados / total) * 100);
        }
      });

      actualizarBarra(100);

      // --- Totales ---
      const totalCantidad = registros.reduce((acc, r) => acc + r.Cantidad, 0);
      const totalImporte = registros.reduce((acc, r) => acc + r.Importe, 0);
      registros.push({
        Usuario: "TOTAL",
        Codigo: "",
        Descripcion: "",
        Cantidad: totalCantidad,
        Costo: "",
        Importe: totalImporte,
        Fecha: "",
        Sucursal: "",
        FolioRegistro: "",
        FolioSesion: ""
      });

      // Crear Excel
      const ws = XLSX.utils.json_to_sheet(registros);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "InventarioCosteado");

      XLSX.writeFile(wb, "InventarioCosteado.xlsx");
      document.getElementById("status").innerText = "✅ Archivo generado con éxito";
    }

    function actualizarBarra(pct) {
      const bar = document.getElementById("progress-bar");
      bar.style.width = pct.toFixed(0) + "%";
      bar.innerText = pct.toFixed(0) + "%";
    }

    window.exportarExcel = exportarExcel;
  </script>
</head>
<body>
  <h2>Descargar Inventario Costeado – Bodega 41</h2>
  <button onclick="exportarExcel()">Exportar a Excel</button>

  <div id="progress-container">
    <div id="progress-bar">0%</div>
  </div>

  <p id="status"></p>
</body>
</html>
