<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Migrar Inventarios – Lizandro</title>
  <style>
    #progress-container {width:100%; background:#eee; border:1px solid #aaa; height:20px; margin-top:10px;}
    #progress-bar {height:100%; width:0%; background:#2196f3; text-align:center; color:white; font-size:12px;}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, doc } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- CONFIG FIREBASE ---
    const configInv = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    const app = initializeApp(configInv);
    const db = getFirestore(app);

    async function migrar() {
      const logs = document.getElementById("logs");
      logs.innerHTML = "Iniciando migración de Lizandro...<br>";

      let totalDocs = 0;
      let procesados = 0;

      // 1. Referencia directa a los escaneos de Lizandro
      const escaneosRef = collection(db, "inventarios", "Bodega 41", "usuarios", "Lizandro", "escaneos");
      const escaneosSnap = await getDocs(escaneosRef);

      if (escaneosSnap.empty) {
        logs.innerHTML += "⚠️ No se encontraron escaneos en Lizandro<br>";
        return;
      }

      const totalEscaneos = escaneosSnap.size;
      logs.innerHTML += `Escaneos encontrados en Lizandro: ${totalEscaneos}<br>`;

      // 2. Copiar cada documento a la colección plana
      for (let escaneoDoc of escaneosSnap.docs) {
        const data = escaneoDoc.data();
        data.usuario = "Lizandro"; // aseguramos que quede el usuario

        const destinoRef = doc(db, "inventarios", "Bodega 41 reportes", "escaneosPlano", escaneoDoc.id);
        await setDoc(destinoRef, data);

        totalDocs++;
        procesados++;
        actualizarBarra(procesados, totalEscaneos);
      }

      logs.innerHTML += `<br><b>✅ Migración completada de Lizandro. Total documentos copiados: ${totalDocs}</b>`;
    }

    function actualizarBarra(actual, total) {
      const bar = document.getElementById("progress-bar");
      const pct = Math.round((actual / total) * 100);
      bar.style.width = pct + "%";
      bar.innerText = pct + "%";
    }

    window.migrar = migrar;
  </script>
</head>
<body>
  <h2>Migración de Inventarios – Lizandro → Reportes</h2>
  <button onclick="migrar()">Migrar Ahora</button>
  
  <div id="progress-container">
    <div id="progress-bar">0%</div>
  </div>
  
  <div id="logs" style="margin-top:20px; font-family: monospace; font-size: 13px; background:#f7f7f7; padding:10px; border:1px solid #ccc; max-height:300px; overflow:auto;">
    Listo para migrar solo Lizandro...
  </div>
</body>
</html>
