<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reporte Costeado – Bodega 41</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, collection, getDocs, query, orderBy, limit, startAfter, startAt 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // -------- CONFIG FIREBASE --------
    const configInv = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    const app = initializeApp(configInv);
    const db = getFirestore(app);

    // -------- VARIABLES --------
    const porPagina = 50;
    let pagina = 0;
    let docsPorPagina = []; // guardamos los snapshots de cada página
    let cursors = [];       // para manejar startAfter de cada página

    let totalGlobalCantidad = 0;
    let totalGlobalImporte = 0;

    // -------- CALCULAR TOTALES GLOBALES --------
    async function calcularTotalesGlobales() {
      totalGlobalCantidad = 0;
      totalGlobalImporte = 0;

      const escaneosRef = collection(db, "inventarios", "Bodega41_reportes", "escaneosPlano");
      const snap = await getDocs(escaneosRef);

      snap.forEach(doc => {
        const d = doc.data();
        const cantidad = Number(d.cantidad) || 0;
        const costo = Number(d.costo) || 0;
        totalGlobalCantidad += cantidad;
        totalGlobalImporte += cantidad * costo;
      });

      document.getElementById("totalesGlobales").innerHTML =
        `<b>Totales Globales → Cantidad: ${totalGlobalCantidad} | Importe: $${totalGlobalImporte.toFixed(2)}</b>`;
    }

    // -------- CARGAR PÁGINA --------
    async function cargarPagina(num) {
      const escaneosRef = collection(db, "inventarios", "Bodega41_reportes", "escaneosPlano");
      let q = query(escaneosRef, orderBy("usuario"), orderBy("fecha"), limit(porPagina));

      if (num > 0 && cursors[num - 1]) {
        // Si ya tenemos cursor, continuar desde ahí
        q = query(escaneosRef, orderBy("usuario"), orderBy("fecha"), startAfter(cursors[num - 1]), limit(porPagina));
      }

      const snap = await getDocs(q);

      if (snap.empty && num > pagina) {
        return; // no hay más páginas
      }

      pagina = num;
      docsPorPagina[pagina] = snap.docs;
      cursors[pagina] = snap.docs[snap.docs.length - 1]; // último doc de esta página

      let registros = [];
      snap.forEach(it => {
        const d = it.data();
        registros.push({
          usuario: d.usuario,
          codigo: d.codigo,
          descripcion: d.descripcion,
          cantidad: Number(d.cantidad) || 0,
          costo: Number(d.costo) || 0,
          fecha: d.fecha,
          sucursal: d.sucursal,
          folioRegistro: d.folioRegistro,
          folioSesion: d.folioSesion
        });
      });

      renderTabla(registros);
    }

    // -------- RENDER TABLA --------
    function renderTabla(registros) {
      let totalCantidad = 0;
      let totalImporte = 0;
      registros.forEach(r => {
        totalCantidad += r.cantidad;
        totalImporte += r.cantidad * r.costo;
      });

      let html = `
        <div style="margin-bottom:10px;">
          <b>Totales Página → Cantidad: ${totalCantidad} | Importe: $${totalImporte.toFixed(2)}</b>
        </div>
        <table border="1" cellspacing="0" cellpadding="4"
               style="width:100%; border-collapse:collapse; font-size:12px;">
          <thead>
            <tr style="background:#eee;">
              <th>Usuario</th>
              <th>Código</th>
              <th>Descripción</th>
              <th>Cantidad</th>
              <th>Costo</th>
              <th>Importe</th>
              <th>Fecha</th>
              <th>Sucursal</th>
              <th>Folio Registro</th>
              <th>Folio Sesión</th>
            </tr>
          </thead>
          <tbody>
      `;

      registros.forEach(r => {
        html += `<tr>
          <td>${r.usuario}</td>
          <td>${r.codigo}</td>
          <td>${r.descripcion}</td>
          <td style="text-align:right;">${r.cantidad}</td>
          <td style="text-align:right;">${r.costo.toFixed(2)}</td>
          <td style="text-align:right;">${(r.cantidad * r.costo).toFixed(2)}</td>
          <td>${r.fecha}</td>
          <td>${r.sucursal}</td>
          <td>${r.folioRegistro}</td>
          <td>${r.folioSesion}</td>
        </tr>`;
      });

      html += `</tbody></table>`;

      html += `<div style="margin-top:10px; text-align:center;">
        Página ${pagina + 1}
        <button onclick="cargarPagina(${pagina - 1})" ${pagina == 0 ? "disabled" : ""}>Anterior</button>
        <button onclick="cargarPagina(${pagina + 1})">Siguiente</button>
      </div>`;

      document.getElementById("tabla").innerHTML = html;
    }

    // -------- INICIO --------
    calcularTotalesGlobales();
    cargarPagina(0); // primera página
  </script>
</head>
<body>
  <h2>Reporte Costeado – Bodega 41</h2>
  <div id="totalesGlobales" style="margin:10px 0; font-size:14px; color:#00416A;">
    Calculando totales globales...
  </div>
  <div id="tabla">Cargando...</div>
</body>
</html>
