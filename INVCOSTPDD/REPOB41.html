<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reporte Costeado – Bodega 41</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // -------- CONFIG FIREBASE --------
    const configInv = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    const configProd = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "bd-bodega41.firebaseapp.com",
      projectId: "bd-bodega41",
      storageBucket: "bd-bodega41.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:63153834263:web:32f306d4dea573bee74f52",
    };

    const appInv = initializeApp(configInv, "appInv");
    const appProd = initializeApp(configProd, "appProd");

    const dbInv = getFirestore(appInv);
    const dbProd = getFirestore(appProd);

    // -------- CARGA Y COSTEO --------
    async function cargarInventarios() {
      let registros = [];

      const escaneosRef = collection(dbInv, "inventarios", "Bodega 41 reportes", "escaneosPlano");
      const escaneosSnap = await getDocs(escaneosRef);

      for (let it of escaneosSnap.docs) {
        const d = it.data();
        let costoUnit = 0;

        // Buscar producto en BD BODEGA41
        if (d.codigo) {
          const prodRef = doc(dbProd, "productos", d.codigo);
          const prodSnap = await getDoc(prodRef);
          if (prodSnap.exists()) {
            const prod = prodSnap.data();
            costoUnit = prod.costoSinImpuesto || 0;
          }
        }

        registros.push({
          usuario: d.usuario,
          codigo: d.codigo,
          descripcion: d.descripcion,
          cantidad: d.cantidad,
          fecha: d.fecha,
          sucursal: d.sucursal,
          folioRegistro: d.folioRegistro,
          folioSesion: d.folioSesion,
          costoUnit,
          subtotal: (Number(d.cantidad) || 0) * costoUnit
        });
      }

      console.log("Registros costeados:", registros.length);
      renderTabla(registros);
    }

    // -------- PAGINACIÓN --------
    let datosGlobal = [];
    let pagina = 1;
    const porPagina = 50;

    function renderTabla(datos) {
      datosGlobal = datos;
      mostrarPagina(1);
    }

    function mostrarPagina(num) {
      pagina = num;
      const inicio = (pagina - 1) * porPagina;
      const fin = inicio + porPagina;
      const subset = datosGlobal.slice(inicio, fin);

      let totalCantidad = subset.reduce((acc, r) => acc + (Number(r.cantidad) || 0), 0);
      let totalCosto = subset.reduce((acc, r) => acc + (Number(r.subtotal) || 0), 0);

      let html = `
        <h3>Total Cantidad: ${totalCantidad} | Total Costo: $${totalCosto.toFixed(2)}</h3>
        <table border="1" cellspacing="0" cellpadding="4" 
               style="width:100%; border-collapse:collapse; font-size:12px;">
          <thead>
            <tr style="background:#eee;">
              <th>Usuario</th>
              <th>Código</th>
              <th>Descripción</th>
              <th>Cantidad</th>
              <th>Costo Unitario</th>
              <th>Subtotal</th>
              <th>Fecha</th>
              <th>Sucursal</th>
              <th>Folio Registro</th>
              <th>Folio Sesión</th>
            </tr>
          </thead>
          <tbody>
      `;

      subset.forEach(r => {
        html += `<tr>
          <td>${r.usuario}</td>
          <td>${r.codigo}</td>
          <td>${r.descripcion}</td>
          <td style="text-align:right;">${r.cantidad}</td>
          <td style="text-align:right;">$${r.costoUnit.toFixed(2)}</td>
          <td style="text-align:right;">$${r.subtotal.toFixed(2)}</td>
          <td>${r.fecha}</td>
          <td>${r.sucursal}</td>
          <td>${r.folioRegistro}</td>
          <td>${r.folioSesion}</td>
        </tr>`;
      });

      html += `</tbody></table>`;

      const totalPaginas = Math.ceil(datosGlobal.length / porPagina) || 1;
      html += `<div style="margin-top:10px; text-align:center;">
        Página ${pagina} de ${totalPaginas} 
        <button onclick="mostrarPagina(${pagina-1})" ${pagina==1?"disabled":""}>Anterior</button>
        <button onclick="mostrarPagina(${pagina+1})" ${pagina==totalPaginas?"disabled":""}>Siguiente</button>
      </div>`;

      document.getElementById("tabla").innerHTML = html;
    }

    cargarInventarios();
  </script>
</head>
<body>
  <h2>Reporte Costeado – Bodega 41</h2>
  <div id="tabla">Cargando...</div>
</body>
</html>
