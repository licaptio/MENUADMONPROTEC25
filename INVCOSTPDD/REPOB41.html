<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reporte Costeado – Bodega 41</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, collection, getDocs, query, orderBy, limit, startAfter 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // -------- CONFIG FIREBASE --------
    const configInv = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    const app = initializeApp(configInv);
    const db = getFirestore(app);

    // -------- VARIABLES DE PAGINACIÓN --------
    let ultimoDoc = null;
    let paginaActual = 1;
    const porPagina = 50;
    let cachePaginas = [];

    async function cargarPagina(direccion = "inicio") {
      const escaneosRef = collection(db, "inventarios", "Bodega41_reportes", "escaneosPlano");
      let q;

      if (direccion === "inicio") {
        q = query(
          escaneosRef,
          orderBy("usuario"),      // primero usuario alfabético
          orderBy("epochMs"),      // después fecha
          limit(porPagina)
        );
        paginaActual = 1;
        cachePaginas = [];
      } 
      else if (direccion === "siguiente" && ultimoDoc) {
        q = query(
          escaneosRef,
          orderBy("usuario"),
          orderBy("epochMs"),
          startAfter(ultimoDoc),
          limit(porPagina)
        );
        paginaActual++;
      } 
      else if (direccion === "anterior" && cachePaginas[paginaActual - 2]) {
        renderTabla(cachePaginas[paginaActual - 2], paginaActual - 1);
        paginaActual--;
        return;
      } 
      else {
        return;
      }

      const snap = await getDocs(q);
      let registros = [];
      snap.forEach(doc => registros.push(doc.data()));

      if (!snap.empty) {
        ultimoDoc = snap.docs[snap.docs.length - 1];
      }

      if (direccion !== "anterior") {
        cachePaginas[paginaActual - 1] = registros;
      }

      renderTabla(registros, paginaActual);
    }

    // -------- RENDER --------
    function renderTabla(datos, pagina) {
      let totalCantidad = datos.reduce((acc, r) => acc + (Number(r.cantidad) || 0), 0);
      let totalCosto = datos.reduce((acc, r) => acc + ((Number(r.cantidad) || 0) * (Number(r.costo) || 0)), 0);

      let html = `
        <h3 style="margin-bottom:5px;">
          Página ${pagina} – Total Cantidad: ${totalCantidad} | Total Costo: $${totalCosto.toFixed(2)}
        </h3>
        <table border="1" cellspacing="0" cellpadding="4" 
               style="width:100%; border-collapse:collapse; font-size:12px;">
          <thead>
            <tr style="background:#eee;">
              <th>Usuario</th>
              <th>Código</th>
              <th>Descripción</th>
              <th>Cantidad</th>
              <th>Costo Unitario</th>
              <th>Subtotal</th>
              <th>Fecha</th>
              <th>Sucursal</th>
              <th>Folio Registro</th>
              <th>Folio Sesión</th>
            </tr>
          </thead>
          <tbody>
      `;

      datos.forEach(r => {
        const cantidad = Number(r.cantidad) || 0;
        const costo = Number(r.costo) || 0;
        const subtotal = cantidad * costo;
        html += `<tr>
          <td>${r.usuario || ""}</td>
          <td>${r.codigo || ""}</td>
          <td>${r.descripcion || ""}</td>
          <td style="text-align:right;">${cantidad}</td>
          <td style="text-align:right;">$${costo.toFixed(2)}</td>
          <td style="text-align:right;">$${subtotal.toFixed(2)}</td>
          <td>${r.fecha || ""}</td>
          <td>${r.sucursal || ""}</td>
          <td>${r.folioRegistro || ""}</td>
          <td>${r.folioSesion || ""}</td>
        </tr>`;
      });

      html += `</tbody></table>
        <div style="margin-top:10px; text-align:center;">
          <button onclick="cargarPagina('anterior')" ${pagina===1 ? "disabled":""}>Anterior</button>
          <button onclick="cargarPagina('siguiente')" ${datos.length < porPagina ? "disabled":""}>Siguiente</button>
        </div>
      `;

      document.getElementById("tabla").innerHTML = html;
    }

    // iniciar
    cargarPagina("inicio");
    window.cargarPagina = cargarPagina;
  </script>
</head>
<body>
  <h2>Reporte Costeado – Bodega 41</h2>
  <div id="tabla">Cargando...</div>
</body>
</html>
