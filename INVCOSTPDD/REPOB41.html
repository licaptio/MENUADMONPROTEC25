<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Migrar Inventarios Bodega 41</title>
  <style>
    #progress-container {width:100%; background:#eee; border:1px solid #aaa; height:20px; margin-top:10px;}
    #progress-bar {height:100%; width:0%; background:#4caf50; text-align:center; color:white; font-size:12px;}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, doc } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- CONFIG FIREBASE ---
    const configInv = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    const app = initializeApp(configInv);
    const db = getFirestore(app);

    async function migrar() {
      const logs = document.getElementById("logs");
      logs.innerHTML = "Iniciando migraci√≥n...<br>";

      let totalDocs = 0;
      let procesados = 0;

      // 1. Leer usuarios
      const usuariosRef = collection(db, "inventarios", "Bodega 41", "usuarios");
      const usuariosSnap = await getDocs(usuariosRef);

      if (usuariosSnap.empty) {
        logs.innerHTML += "‚ö†Ô∏è No se encontraron usuarios en /inventarios/Bodega 41/usuarios<br>";
        return;
      }

      // Contar primero cu√°ntos docs en total hay
      let totalEscaneos = 0;
      for (let usuarioDoc of usuariosSnap.docs) {
        const escaneosRef = collection(db, "inventarios", "Bodega 41", "usuarios", usuarioDoc.id, "escaneos");
        const escaneosSnap = await getDocs(escaneosRef);
        totalEscaneos += escaneosSnap.size;
      }

      logs.innerHTML += `Usuarios encontrados: ${usuariosSnap.size}<br>`;
      logs.innerHTML += `Escaneos totales a migrar: ${totalEscaneos}<br>`;

      // 2. Procesar usuario por usuario
      for (let usuarioDoc of usuariosSnap.docs) {
        const usuario = usuarioDoc.id;
        logs.innerHTML += `<br>üë§ Usuario: ${usuario}<br>`;

        const escaneosRef = collection(db, "inventarios", "Bodega 41", "usuarios", usuario, "escaneos");
        const escaneosSnap = await getDocs(escaneosRef);

        for (let escaneoDoc of escaneosSnap.docs) {
          const data = escaneoDoc.data();
          data.usuario = usuario;

          const destinoRef = doc(db, "inventarios", "Bodega 41 reportes", "escaneosPlano", escaneoDoc.id);
          await setDoc(destinoRef, data);

          totalDocs++;
          procesados++;

          actualizarBarra(procesados, totalEscaneos);
        }
      }

      logs.innerHTML += `<br><b>‚úÖ Migraci√≥n completada. Total documentos copiados: ${totalDocs}</b>`;
    }

    function actualizarBarra(actual, total) {
      const bar = document.getElementById("progress-bar");
      const pct = Math.round((actual / total) * 100);
      bar.style.width = pct + "%";
      bar.innerText = pct + "%";
    }

    window.migrar = migrar;
  </script>
</head>
<body>
  <h2>Migraci√≥n de Inventarios ‚Äì Bodega 41 ‚Üí Reportes</h2>
  <button onclick="migrar()">Migrar Ahora</button>
  
  <div id="progress-container">
    <div id="progress-bar">0%</div>
  </div>
  
  <div id="logs" style="margin-top:20px; font-family: monospace; font-size: 13px; background:#f7f7f7; padding:10px; border:1px solid #ccc; max-height:300px; overflow:auto;">
    Listo para migrar...
  </div>
</body>
</html>
