<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reporte Crudo Inventario</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // -------- CONFIG FIREBASE --------
    const configInv = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    const appInv = initializeApp(configInv, "appInv");
    const dbInv = getFirestore(appInv);

    // -------- CARGA INVENTARIOS CRUDO --------
    async function cargarInventarios() {
      let registros = [];

      // ðŸ“Œ Paso 1: obtener los usuarios dentro de /inventarios/Bodega 41/usuarios
      const usuariosRef = collection(dbInv, "inventarios", "Bodega 41", "usuarios");
      const usuariosSnap = await getDocs(usuariosRef);
      console.log("Usuarios encontrados:", usuariosSnap.size);

      for (let usuarioDoc of usuariosSnap.docs) {
        const usuario = usuarioDoc.id;
        console.log("Leyendo usuario:", usuario);

        // ðŸ“Œ Paso 2: leer la colecciÃ³n de escaneos de cada usuario
        const escaneosRef = collection(dbInv, "inventarios", "Bodega 41", "usuarios", usuario, "escaneos");
        const escaneosSnap = await getDocs(escaneosRef);

        escaneosSnap.forEach(it => {
          const d = it.data();
          registros.push({
            usuario,
            codigo: d.codigo,
            descripcion: d.descripcion,
            cantidad: d.cantidad,
            fecha: d.fecha,
            sucursal: d.sucursal,
            folioRegistro: d.folioRegistro,
            folioSesion: d.folioSesion,
            epochMs: d.epochMs
          });
        });
      }

      console.log("Registros capturados:", registros.length);
      renderTabla(registros);
    }

    // -------- PAGINACIÃ“N --------
    let datosGlobal = [];
    let pagina = 1;
    const porPagina = 50;

    function renderTabla(datos) {
      datosGlobal = datos;
      mostrarPagina(1);
    }

    function mostrarPagina(num) {
      pagina = num;
      const inicio = (pagina - 1) * porPagina;
      const fin = inicio + porPagina;
      const subset = datosGlobal.slice(inicio, fin);

      let html = `
        <table border="1" cellspacing="0" cellpadding="4" 
               style="width:100%; border-collapse:collapse; font-size:12px;">
          <thead>
            <tr style="background:#eee;">
              <th>Usuario</th>
              <th>CÃ³digo</th>
              <th>DescripciÃ³n</th>
              <th>Cantidad</th>
              <th>Fecha</th>
              <th>Sucursal</th>
              <th>Folio Registro</th>
              <th>Folio SesiÃ³n</th>
              <th>EpochMs</th>
            </tr>
          </thead>
          <tbody>
      `;

      subset.forEach(r => {
        html += `<tr>
          <td>${r.usuario}</td>
          <td>${r.codigo}</td>
          <td>${r.descripcion}</td>
          <td style="text-align:right;">${r.cantidad}</td>
          <td>${r.fecha}</td>
          <td>${r.sucursal}</td>
          <td>${r.folioRegistro}</td>
          <td>${r.folioSesion}</td>
          <td>${r.epochMs}</td>
        </tr>`;
      });

      html += `</tbody></table>`;

      const totalPaginas = Math.ceil(datosGlobal.length / porPagina) || 1;
      html += `<div style="margin-top:10px; text-align:center;">
        PÃ¡gina ${pagina} de ${totalPaginas} 
        <button onclick="mostrarPagina(${pagina-1})" ${pagina==1?"disabled":""}>Anterior</button>
        <button onclick="mostrarPagina(${pagina+1})" ${pagina==totalPaginas?"disabled":""}>Siguiente</button>
      </div>`;

      document.getElementById("tabla").innerHTML = html;
    }

    cargarInventarios();
  </script>
</head>
<body>
  <h2>Reporte Crudo â€“ Bodega 41</h2>
  <div id="tabla">Cargando...</div>
</body>
</html>
