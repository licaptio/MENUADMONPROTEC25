<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reporte Crudo Inventario</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // -------- CONFIG FIREBASE --------
    const configInv = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    const configProd = {
      apiKey: "AIzaSyA0JYm16CaVXr86ZGbKP8tpe47rl0LdBaw",
      authDomain: "bd-bodega41.firebaseapp.com",
      projectId: "bd-bodega41",
      storageBucket: "bd-bodega41.firebasestorage.app",
      messagingSenderId: "63153834263",
      appId: "1:63153834263:web:32f306d4dea573bee74f52",
      measurementId: "G-YCCWZCHCEV"
    };

    // Inicializar dos apps
    const appInv = initializeApp(configInv, "appInv");
    const appProd = initializeApp(configProd, "appProd");

    const dbInv = getFirestore(appInv);
    const dbProd = getFirestore(appProd);

    // -------- MAPA DE PRODUCTOS --------
    let productosMap = {};

    async function cargarProductos() {
      const snap = await getDocs(collection(dbProd, "productos"));
      snap.forEach(doc => {
        const d = doc.data();
        productosMap[d.codigoBarra] = {
          descripcion: d.concepto,
          costo: d.costoSinImpuesto
        };
      });
      console.log("Productos cargados:", Object.keys(productosMap).length);
    }

    // -------- CARGA INVENTARIOS --------
    async function cargarInventarios() {
      await cargarProductos();

      let registros = [];
      const usuariosSnap = await getDocs(collection(dbInv, "inventarios", "Bodega 41", "usuarios"));
      for (let usuarioDoc of usuariosSnap.docs) {
        const usuario = usuarioDoc.id;
        const itemsSnap = await getDocs(collection(dbInv, "inventarios", "Bodega 41", "usuarios", usuario, "items"));
        itemsSnap.forEach(it => {
          const d = it.data();
          const prod = productosMap[d.codigoBarra] || { descripcion: "N/D", costo: 0 };
          registros.push({
            usuario,
            codigo: d.codigoBarra,
            descripcion: prod.descripcion,
            cantidad: d.cantidad,
            costo: prod.costo,
            total: d.cantidad * prod.costo
          });
        });
      }
      renderTabla(registros);
    }

    // -------- PAGINACIÓN --------
    let datosGlobal = [];
    let pagina = 1;
    const porPagina = 50;

    function renderTabla(datos) {
      datosGlobal = datos;
      mostrarPagina(1);
    }

    function mostrarPagina(num) {
      pagina = num;
      const inicio = (pagina - 1) * porPagina;
      const fin = inicio + porPagina;
      const subset = datosGlobal.slice(inicio, fin);

      // Totales de la página
      let totalCantidad = 0;
      let totalImporte = 0;
      subset.forEach(r => {
        totalCantidad += r.cantidad;
        totalImporte += r.total;
      });

      // Totales globales
      let totalCantidadGlobal = 0;
      let totalImporteGlobal = 0;
      datosGlobal.forEach(r => {
        totalCantidadGlobal += r.cantidad;
        totalImporteGlobal += r.total;
      });

      let html = `
        <div style="margin-bottom:10px; font-weight:bold;">
          Totales Página → Cantidad: ${totalCantidad} | Importe: $${totalImporte.toFixed(2)} <br>
          Totales Globales → Cantidad: ${totalCantidadGlobal} | Importe: $${totalImporteGlobal.toFixed(2)}
        </div>
        <table border="1" cellspacing="0" cellpadding="4" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:#eee;">
              <th>Usuario</th>
              <th>Código</th>
              <th>Descripción</th>
              <th>Cantidad</th>
              <th>Costo</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
      `;
      subset.forEach(r => {
        html += `<tr>
          <td>${r.usuario}</td>
          <td>${r.codigo}</td>
          <td>${r.descripcion}</td>
          <td style="text-align:right;">${r.cantidad}</td>
          <td style="text-align:right;">${r.costo.toFixed(2)}</td>
          <td style="text-align:right;">${r.total.toFixed(2)}</td>
        </tr>`;
      });

      html += `</tbody></table>`;

      // Controles
      const totalPaginas = Math.ceil(datosGlobal.length / porPagina);
      html += `<div style="margin-top:10px; text-align:center;">
        Página ${pagina} de ${totalPaginas} 
        <button onclick="mostrarPagina(${pagina-1})" ${pagina==1?"disabled":""}>Anterior</button>
        <button onclick="mostrarPagina(${pagina+1})" ${pagina==totalPaginas?"disabled":""}>Siguiente</button>
      </div>`;

      document.getElementById("tabla").innerHTML = html;
    }

    // Ejecutar
    cargarInventarios();
  </script>
</head>
<body>
  <h2>Reporte Crudo – Bodega 41</h2>
  <div id="tabla">Cargando...</div>
</body>
</html>
