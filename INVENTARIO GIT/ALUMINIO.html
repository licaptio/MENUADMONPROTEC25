<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventario Estilo Excel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; padding:1rem; }
    h1 { text-align:center; font-size:1.8rem; margin-bottom:1rem; }

    table { width:100%; max-width:1100px; margin:auto; border-collapse:collapse; background:#fff; box-shadow:0 0 8px rgba(0,0,0,.1); }
    th, td { border:1px solid #ccc; padding:.5rem; vertical-align:middle; }
    th { background:#e6e6e6; font-weight:bold; }

    td.corto, th.corto { width:5ch; text-align:center; }
    td.largo, th.largo { width:24ch; text-align:left; white-space:nowrap; overflow:hidden; vertical-align:middle; }
    td.largo input { text-align:left; padding-left:4px; }

    input { width:100%; border:none; font-size:1rem; background:transparent; padding:.2rem; height:1.8rem; box-sizing:border-box; }
    input:focus { outline:none; background:#ffffcc; }

    .controls { text-align:center; margin-bottom:1rem; display:flex; gap:.5rem; justify-content:center; flex-wrap:wrap; }
    .btn { border:1px solid #bbb; background:#fff; padding:.5rem .8rem; border-radius:.4rem; cursor:pointer; }
    .btn:hover { background:#f2f2f2; }

    .no-print { display:block; margin:0 auto 1rem; }
    @media print { .no-print { display:none !important; } }

    /* Overlay de vista previa */
    .overlay {
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:none; align-items:center; justify-content:center; padding:1rem; z-index:9999;
    }
    .overlay-inner {
      background:#fff; padding:1rem; border-radius:.6rem; max-width:95vw; max-height:90vh; overflow:auto;
      box-shadow:0 10px 30px rgba(0,0,0,.3);
    }
    .overlay-header { display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-bottom:.8rem; }
    .overlay-title { font-weight:bold; }
    .overlay-actions { display:flex; gap:.5rem; }
    .preview-img { max-width:100%; height:auto; display:block; border:1px solid #ddd; }
  </style>
</head>
<body>

  <h1>Inventario Estilo Excel</h1>

  <div class="controls">
    <button id="export-img" class="btn no-print">Exportar pedido como imagen</button>
    <button id="clear-data" class="btn no-print">Borrar datos</button>
  </div>

  <table id="tabla">
    <thead>
      <tr>
        <th class="largo">ALUMINIO</th>
        <th class="corto">INV</th>
        <th class="corto">STO</th>
        <th class="corto">PED</th>
      </tr>
    </thead>
    <tbody id="contenido"></tbody>
  </table>

  <!-- Overlay de vista previa temporal -->
  <div id="overlay" class="overlay no-print" aria-hidden="true">
    <div class="overlay-inner">
      <div class="overlay-header">
        <div class="overlay-title">Vista previa del pedido</div>
        <div class="overlay-actions">
          <button id="open-new" class="btn">Abrir en nueva pestaña</button>
          <button id="close-overlay" class="btn">Cerrar</button>
        </div>
      </div>
      <img id="preview-img" alt="Vista previa del pedido" class="preview-img"/>
      <p style="margin-top:.6rem;color:#333">
        Sugerencia: puedes tomar una captura de pantalla o hacer clic derecho sobre la imagen para guardarla y enviarla manualmente.
      </p>
    </div>
  </div>

  <script>
    const tablaBody = document.getElementById('contenido');
    const KEY = 'inventario_ALUMINIO';

    const datosIniciales = [
      { ALUMINIO: 'ALUMINIO 5 MTS C/24', inventario: '', sto: 30, pedido: '' },
      { ALUMINIO: 'ALUMINIO 7 MTS C/24', inventario: '', sto: 30, pedido: '' },
      { ALUMINIO: 'ALUMINIO 10 MTS C/24', inventario: '', sto: 20, pedido: '' },
      { ALUMINIO: 'ALUMINIO 50 MTS CARO', inventario: '', sto: 10, pedido: '' },
      { ALUMINIO: 'STAR FOIL 500GR C/12', inventario: '', sto: 2, pedido: '' },
      { ALUMINIO: 'ALUMINIO 3 kg c/4pz', inventario: '', sto: 1, pedido: '' },
      { ALUMINIO: 'PAPEL PARA ESTUFA', inventario: '', sto: 30, pedido: '' },
      { ALUMINIO: 'ENCERADO 10 MTS', inventario: '', sto: 5, pedido: '' },
      { ALUMINIO: 'ENCERADO 20 MTS', inventario: '', sto: 5, pedido: '' },
      { ALUMINIO: 'ROLLO ENCERADO 3 KG', inventario: '', sto: 2, pedido: '' },
      { ALUMINIO: 'HILO LINKER', inventario: '', sto: 10, pedido: '' },
      { ALUMINIO: 'HILO RAFIA', inventario: '', sto: 10, pedido: '' },
      { ALUMINIO: 'REVOLUCION CORTO', inventario: '', sto: 30, pedido: '' },
      { ALUMINIO: 'REVOLUCION LARGO', inventario: '', sto: 10, pedido: '' },
    ];

    function cargarDatos() {
      const datos = JSON.parse(localStorage.getItem(KEY)) || datosIniciales;
      tablaBody.innerHTML = '';
      datos.forEach((fila, i) => {
        const tr = document.createElement('tr');
        ['ALUMINIO', 'inventario', 'sto', 'pedido'].forEach(campo => {
          const td = document.createElement('td');
          td.className = (campo === 'ALUMINIO') ? 'largo' : 'corto';
          if (campo === 'ALUMINIO') {
            td.textContent = fila[campo];
          } else {
            td.innerHTML = `<input value="${fila[campo] ?? ''}" data-fila="${i}" data-campo="${campo}">`;
          }
          tr.appendChild(td);
        });
        tablaBody.appendChild(tr);
      });
    }

    tablaBody.addEventListener('input', (e) => {
      const input = e.target;
      const fila = parseInt(input.dataset.fila, 10);
      const campo = input.dataset.campo;
      const datos = JSON.parse(localStorage.getItem(KEY)) || datosIniciales.slice();
      datos[fila][campo] = input.value;
      localStorage.setItem(KEY, JSON.stringify(datos));
    });

    // ===== Exportar como imagen (compacto y sin descarga) =====
    document.getElementById('export-img').addEventListener('click', async () => {
      const filas = document.querySelectorAll('#tabla tbody tr');

      // Tabla temporal compacta
      const temp = document.createElement('table');
      Object.assign(temp.style, {
        borderCollapse: 'collapse',
        background: '#ffffff',
        margin: '0',
        fontFamily: 'Arial, sans-serif',
        fontSize: '14px',
        tableLayout: 'fixed',
      });

      // Encabezado
      const thead = temp.createTHead();
      const hRow = thead.insertRow();
      ['ALUMINIO', 'PED'].forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        Object.assign(th.style, {
          border: '1px solid #ccc',
          padding: '.35rem',
          backgroundColor: '#e6e6e6',
          textAlign: text === 'PED' ? 'center' : 'left'
        });
        hRow.appendChild(th);
      });

      // Cuerpo con sólo PED > 0
      const tBody = temp.createTBody();
      filas.forEach(r => {
        const val = r.cells[3].querySelector('input').value.trim();
        const num = Number(val.replace(',', '.'));
        if (!Number.isNaN(num) && num > 0) {
          const nuevaFila = tBody.insertRow();

          const c1 = document.createElement('td');
          c1.textContent = r.cells[0].textContent;
          Object.assign(c1.style, { border: '1px solid #ccc', padding: '.35rem' });
          nuevaFila.appendChild(c1);

          const c2 = document.createElement('td');
          c2.textContent = num;
          Object.assign(c2.style, { border: '1px solid #ccc', padding: '.35rem', textAlign: 'center' });
          nuevaFila.appendChild(c2);
        }
      });

      if (tBody.rows.length === 0) {
        alert('No hay filas con PED > 0 para exportar.');
        return;
      }

      // Render a tamaño natural
      document.body.appendChild(temp);
      const canvas = await html2canvas(temp, { backgroundColor: '#ffffff', scale: 1 });
      temp.remove();

      // Reducir a ~800 px de ancho (más ligera)
      const maxW = 800;
      let dataUrl = canvas.toDataURL('image/jpeg', 0.92);
      if (canvas.width > maxW) {
        const ratio = maxW / canvas.width;
        const out = document.createElement('canvas');
        out.width = Math.round(canvas.width * ratio);
        out.height = Math.round(canvas.height * ratio);
        const octx = out.getContext('2d');
        octx.imageSmoothingEnabled = true;
        octx.imageSmoothingQuality = 'high';
        octx.drawImage(canvas, 0, 0, out.width, out.height);
        dataUrl = out.toDataURL('image/jpeg', 0.9);
      }

      // Mostrar en overlay
      const overlay = document.getElementById('overlay');
      const img = document.getElementById('preview-img');
      img.src = dataUrl;
      overlay.style.display = 'flex';

      // Abrir en nueva pestaña (opcional)
      document.getElementById('open-new').onclick = () => {
        const w = window.open('', '_blank');
        if (w) {
          w.document.write(`<img src="${dataUrl}" style="max-width:100%;height:auto;display:block;margin:auto"/>`);
          w.document.title = 'Pedido';
        }
      };
    });

    // Cerrar overlay
    document.getElementById('close-overlay').addEventListener('click', () => {
      const overlay = document.getElementById('overlay');
      const img = document.getElementById('preview-img');
      overlay.style.display = 'none';
      img.src = '';
    });

    // Borrar datos
    document.getElementById('clear-data').addEventListener('click', () => {
      const ok = confirm('¿Borrar todos los datos y reiniciar la tabla?');
      if (!ok) return;
      localStorage.removeItem(KEY);
      cargarDatos();
    });

    // Inicializa
    cargarDatos();
  </script>
</body>
</html>
