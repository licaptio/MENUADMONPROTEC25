<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cacahuate Clara — Inventario Estilo Excel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; padding:1rem; }
    h1 { text-align:center; font-size:1.8rem; margin-bottom:1rem; }

    table { width:100%; max-width:1100px; margin:auto; border-collapse:collapse; background:#fff; box-shadow:0 0 8px rgba(0,0,0,.1); }
    th, td { border:1px solid #ccc; padding:.5rem; vertical-align:middle; }
    th { background:#e6e6e6; font-weight:bold; }

    td.corto, th.corto { width:5ch; text-align:center; }
    td.largo, th.largo { width:24ch; text-align:left; white-space:nowrap; overflow:hidden; vertical-align:middle; }
    td.largo input { text-align:left; padding-left:4px; }

    input { width:100%; border:none; font-size:1rem; background:transparent; padding:.2rem; height:1.8rem; box-sizing:border-box; }
    input:focus { outline:none; background:#ffffcc; }

    .controls { text-align:center; margin-bottom:1rem; display:flex; gap:.5rem; justify-content:center; flex-wrap:wrap; }
    .btn { border:1px solid #bbb; background:#fff; padding:.5rem .8rem; border-radius:.4rem; cursor:pointer; }
    .btn:hover { background:#f2f2f2; }

    @media print { .no-print { display:none !important; } }

    /* Overlay de vista previa */
    .overlay {
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:none; align-items:center; justify-content:center; padding:1rem; z-index:9999;
    }
    .overlay-inner {
      background:#fff; padding:1rem; border-radius:.6rem; max-width:95vw; max-height:90vh; overflow:auto;
      box-shadow:0 10px 30px rgba(0,0,0,.3);
    }
    .overlay-header { display:flex; justify-content:space-between; align-items:center; gap:.5rem; margin-bottom:.8rem; flex-wrap:wrap; }
    .overlay-title { font-weight:bold; }
    .overlay-actions { display:flex; gap:.5rem; flex-wrap:wrap; }
    .preview-img { max-width:100%; height:auto; display:block; border:1px solid #ddd; }
  </style>
</head>
<body>

  <h1>Cacahuate Clara</h1>

  <div class="controls no-print">
    <button id="export-img" class="btn">Exportar pedido como imagen</button>
    <button id="clear-data" class="btn">Borrar datos</button>
  </div>

  <table id="tabla">
    <thead>
      <tr>
        <th class="largo">CLARA</th>
        <th class="corto">INV</th>
        <th class="corto">STO</th>
        <th class="corto">PED</th>
      </tr>
    </thead>
    <tbody id="contenido"></tbody>
  </table>

  <!-- Overlay de vista previa temporal -->
  <div id="overlay" class="overlay no-print" aria-hidden="true">
    <div class="overlay-inner">
      <div class="overlay-header">
        <div class="overlay-title">Vista previa del pedido — Cacahuate Clara</div>
        <div class="overlay-actions">
          <button id="copy-img" class="btn">Copiar imagen</button>
          <button id="open-new" class="btn">Abrir en nueva pestaña</button>
          <button id="close-overlay" class="btn">Cerrar</button>
        </div>
      </div>
      <img id="preview-img" alt="Vista previa del pedido" class="preview-img"/>
      <p style="margin-top:.6rem;color:#333">
        Tip: puedes tomar captura, copiar la imagen, o abrirla en nueva pestaña para enviarla manualmente.
      </p>
    </div>
  </div>

<script>
  const KEY = 'inventario_cacahuate';
  const tabla = document.getElementById('contenido');

  // Lista base (nombres y STO siempre vienen de aquí)
  const datosIniciales = [
    { cacahuate: 'CACAH SALADO 10KG',     sto: 20 },
    { cacahuate: 'BLANCO SALADO 10k',     sto: 1  },
    { cacahuate: 'CANTINERO TOTOPO Y AJO',sto: 15 },
    { cacahuate: 'ENCHILADO MITADES 10KG',sto: 3  },
    { cacahuate: 'GARAPIÑADO 10KG',       sto: 20 },
    { cacahuate: 'MIXTO CON FRITURA 10KG',sto: 10 },
    { cacahuate: 'JAPONES HOT NUT 10KG',  sto: 10 },
    { cacahuate: 'JAPONES 10KG',          sto: 10 },
    { cacahuate: 'CHICHARRON KRANKY KILO',sto: 3  },
    { cacahuate: 'CERDO KILO',            sto: 3  },
  ];

  // Lee valores guardados (solo inventario/pedido). Si está corrupto, ignora.
  function leerGuardado() {
    try {
      const arr = JSON.parse(localStorage.getItem(KEY) || '[]');
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }

  // Construye los datos a pintar mezclando base + guardado
  function datosParaPintar() {
    const saved = leerGuardado();
    return datosIniciales.map((base, i) => ({
      cacahuate: base.cacahuate,
      sto: base.sto,
      inventario: saved[i]?.inventario ?? '',
      pedido:     saved[i]?.pedido ?? ''
    }));
  }

  function pintarTabla() {
    const datos = datosParaPintar();
    tabla.innerHTML = '';
    datos.forEach((fila, i) => {
      const tr = document.createElement('tr');

      // Nombre
      let td = document.createElement('td');
      td.className = 'largo';
      td.textContent = fila.cacahuate;
      tr.appendChild(td);

      // Inventario (input)
      td = document.createElement('td');
      td.className = 'corto';
      td.innerHTML = `<input value="${fila.inventario}" data-fila="${i}" data-campo="inventario" inputmode="numeric" pattern="[0-9]*">`;
      tr.appendChild(td);

      // STO (solo muestra)
      td = document.createElement('td');
      td.className = 'corto';
      td.textContent = fila.sto;
      tr.appendChild(td);

      // PED (input)
      td = document.createElement('td');
      td.className = 'corto';
      td.innerHTML = `<input value="${fila.pedido}" data-fila="${i}" data-campo="pedido" inputmode="numeric" pattern="[0-9]*">`;
      tr.appendChild(td);

      tabla.appendChild(tr);
    });
  }

  // Guarda SOLO inventario/pedido
  function guardarCambio(i, campo, valor) {
    const saved = leerGuardado();
    // Asegura largo
    for (let k = saved.length; k < datosIniciales.length; k++) saved[k] = { inventario: '', pedido: '' };
    saved[i][campo] = valor;
    localStorage.setItem(KEY, JSON.stringify(saved));
  }

  tabla.addEventListener('input', (e) => {
    const el = e.target;
    if (el.tagName !== 'INPUT') return;
    const fila = parseInt(el.dataset.fila, 10);
    const campo = el.dataset.campo;
    guardarCambio(fila, campo, el.value);
  });

  // ===== Exportar imagen (letra grande, poco padding, PED>0) =====
  document.getElementById('export-img').addEventListener('click', async () => {
    const filas = document.querySelectorAll('#tabla tbody tr');

    // Tabla temporal
    const temp = document.createElement('table');
    Object.assign(temp.style, {
      borderCollapse: 'collapse',
      background: '#ffffff',
      margin: '0',
      fontFamily: 'Arial, sans-serif',
      fontSize: '18px',
      tableLayout: 'auto',
      minWidth: '700px'
    });

    // Encabezado
    const thead = temp.createTHead();
    const hRow = thead.insertRow();
    ['CLARA', 'PED'].forEach(text => {
      const th = document.createElement('th');
      th.textContent = text;
      Object.assign(th.style, {
        border: '1px solid #ccc',
        padding: '.25rem .4rem',
        backgroundColor: '#e6e6e6',
        textAlign: text === 'PED' ? 'center' : 'left'
      });
      hRow.appendChild(th);
    });

    // Cuerpo (solo PED > 0)
    const tBody = temp.createTBody();
    filas.forEach(r => {
      const val = r.cells[3].querySelector('input')?.value.trim() ?? '';
      const num = Number(val.replace(',', '.'));
      if (!Number.isNaN(num) && num > 0) {
        const row = tBody.insertRow();

        const c1 = document.createElement('td');
        c1.textContent = r.cells[0].textContent;
        Object.assign(c1.style, { border: '1px solid #ccc', padding: '.25rem .4rem' });
        row.appendChild(c1);

        const c2 = document.createElement('td');
        c2.textContent = num;
        Object.assign(c2.style, { border: '1px solid #ccc', padding: '.25rem .4rem', textAlign: 'center' });
        row.appendChild(c2);
      }
    });

    if (tBody.rows.length === 0) {
      alert('No hay filas con PED > 0 para exportar.');
      return;
    }

    // Captura y escala a 1000 px de ancho
    document.body.appendChild(temp);
    const canvas = await html2canvas(temp, { backgroundColor: '#ffffff', scale: 1 });
    temp.remove();

    const targetW = 1000;
    let out = canvas;
    if (canvas.width !== targetW) {
      const ratio = targetW / canvas.width;
      out = document.createElement('canvas');
      out.width = Math.round(canvas.width * ratio);
      out.height = Math.round(canvas.height * ratio);
      const ctx = out.getContext('2d');
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(canvas, 0, 0, out.width, out.height);
    }
    const dataUrl = out.toDataURL('image/jpeg', 0.92);

    // Overlay
    const overlay = document.getElementById('overlay');
    const img = document.getElementById('preview-img');
    img.src = dataUrl;
    overlay.style.display = 'flex';

    document.getElementById('open-new').onclick = () => {
      const w = window.open('', '_blank');
      if (w) {
        w.document.write(`<img src="${dataUrl}" style="max-width:100%;height:auto;display:block;margin:auto"/>`);
        w.document.title = 'Pedido — Cacahuate Clara';
      }
    };

    document.getElementById('copy-img').onclick = async () => {
      try {
        const res = await fetch(dataUrl);
        const blob = await res.blob();
        await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
        alert('Imagen copiada al portapapeles ✅');
      } catch {
        alert('No se pudo copiar la imagen automáticamente. Abre en nueva pestaña y copia/guarda manual.');
      }
    };
  });

  // Cerrar overlay
  document.getElementById('close-overlay').addEventListener('click', () => {
    const overlay = document.getElementById('overlay');
    const img = document.getElementById('preview-img');
    overlay.style.display = 'none';
    img.src = '';
  });

  // Borrar datos
  document.getElementById('clear-data').addEventListener('click', () => {
    const ok = confirm('¿Borrar todos los datos y reiniciar la tabla?');
    if (!ok) return;
    localStorage.removeItem(KEY);
    pintarTabla();
  });

  // Inicializa
  pintarTabla();
</script>
</body>
</html>

