<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>‚öôÔ∏è Administraci√≥n de Secciones</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#f4f4f4; color:#333; }
    header { background:#007bff; color:white; padding:14px; text-align:center; font-size:18px; }
    h2 { font-size:16px; margin:14px 0 6px; text-align:center; }
    form { margin:12px auto; padding:12px; background:#fff; border-radius:10px; max-width:95%; box-shadow:0 2px 6px rgba(0,0,0,.1); }
    input, select, button { width:100%; padding:10px; margin:6px 0; border-radius:6px; border:1px solid #ccc; font-size:15px; }
    button { background:#007bff; color:white; font-weight:bold; border:none; }
    button:hover { background:#0056b3; }

    table { width:100%; border-collapse:collapse; margin:12px auto; max-width:95%; background:#fff; }
    th, td { padding:8px; border:1px solid #ccc; text-align:center; font-size:14px; }
    th { background:#eee; }

    .acciones button, .acciones select {
      padding:6px 8px; font-size:13px; border-radius:6px; margin:2px;
    }
    .edit { background:#ffc107; color:#000; }
    .edit:hover { background:#e0a800; }
    .delete { background:#dc3545; color:#fff; }
    .delete:hover { background:#a71d2a; }
    .view { background:#17a2b8; color:#fff; }
    .view:hover { background:#11707f; }

    /* Modal para ver la imagen */
    #modal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.8); justify-content:center; align-items:center;
      z-index:1000;
    }
    #modal img {
      max-width:90%; max-height:90%; border:4px solid white; border-radius:10px;
    }
  </style>
</head>
<body>
  <header>‚öôÔ∏è Administraci√≥n de Secciones</header>

  <!-- Crear secci√≥n -->
  <form id="formSeccion">
    <h2>‚ûï Nueva Secci√≥n</h2>
    <select id="bodegaId" required>
      <option value="B1">Bodega Central</option>
      <option value="B2">Bodega L√≠quido</option>
      <option value="B3">Bodega Zapata</option>
      <option value="B4">Bodega Cigarro</option>
      <option value="B5">Bodega Tienda PDD</option>
      <option value="B6">Bodega Extra</option>
    </select>
    <input type="text" id="idSeccion" placeholder="ID secci√≥n (ej: B1A1)" required>
    <input type="text" id="nombreSeccion" placeholder="Nombre de la secci√≥n" required>
    <input type="file" id="foto" accept="image/*" required>
    <button type="submit">Crear Secci√≥n</button>
  </form>

  <h2>üìã Lista de Secciones</h2>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Bodega</th>
        <th>Foto</th>
        <th>Modo</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaSecciones"></tbody>
  </table>

  <!-- Modal para foto -->
  <div id="modal" onclick="this.style.display='none'">
    <img id="modalImg" src="" alt="Secci√≥n">
  </div>

  <script>
    const supabase = window.supabase.createClient(
      "https://cvpbtjlupswbyxenugpz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
    );

    const form = document.getElementById("formSeccion");
    const tablaSecciones = document.getElementById("tablaSecciones");
    const modal = document.getElementById("modal");
    const modalImg = document.getElementById("modalImg");

    // üîπ Cargar secciones
    async function cargarSecciones() {
      const { data, error } = await supabase.from("secciones").select("*").order("created_at",{ascending:false});
      if (error) return console.error(error);
      tablaSecciones.innerHTML = "";
      data.forEach(sec => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${sec.id}</td>
          <td>${sec.nombre}</td>
          <td>${sec.bodega_id}</td>
          <td><button class="view" onclick="verFoto('${sec.img_url}')">üëÅÔ∏è Ver</button></td>
          <td>
            <select onchange="cambiarModo('${sec.id}', this.value)">
              <option value="contain" ${sec.display_mode === "contain" ? "selected" : ""}>Contain</option>
              <option value="cover" ${sec.display_mode === "cover" ? "selected" : ""}>Cover</option>
            </select>
          </td>
          <td class="acciones">
            <button class="edit" onclick="editarSeccion('${sec.id}','${sec.nombre}')">‚úèÔ∏è</button>
            <button class="delete" onclick="eliminarSeccion('${sec.id}')">‚ùå</button>
          </td>
        `;
        tablaSecciones.appendChild(tr);
      });
    }

    // üîπ Crear secci√≥n
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("idSeccion").value;
      const nombre = document.getElementById("nombreSeccion").value;
      const bodega = document.getElementById("bodegaId").value;
      const archivo = document.getElementById("foto").files[0];

      const { error: err1 } = await supabase
        .storage.from("recorridos")
        .upload(`bodega${bodega}/${id}.jpg`, archivo, { upsert: true });
      if (err1) { alert("Error al subir imagen"); return; }

      const urlPublica = supabase
        .storage.from("recorridos")
        .getPublicUrl(`bodega${bodega}/${id}.jpg`).data.publicUrl;

      const { error: err2 } = await supabase.from("secciones").insert([
        { id, bodega_id: bodega, nombre, img_url: urlPublica, display_mode:"contain" }
      ]);
      if (err2) { console.error(err2); alert("Error al guardar en DB"); return; }

      form.reset();
      cargarSecciones();
    });

    // üîπ Ver foto en modal
    function verFoto(url){
      modalImg.src = url;
      modal.style.display = "flex";
    }

    // üîπ Cambiar modo visualizaci√≥n
    async function cambiarModo(id, modo) {
      const { error } = await supabase.from("secciones").update({ display_mode: modo }).eq("id", id);
      if (error) alert("Error al actualizar modo");
    }

    // üîπ Editar nombre secci√≥n
    async function editarSeccion(id,nombreActual){
      const nuevoNombre = prompt("Nuevo nombre de la secci√≥n:", nombreActual);
      if (!nuevoNombre) return;
      await supabase.from("secciones").update({nombre:nuevoNombre}).eq("id",id);
      cargarSecciones();
    }

    // üîπ Eliminar secci√≥n
    async function eliminarSeccion(id){
      if (!confirm("¬øEliminar secci√≥n "+id+"?")) return;
      await supabase.from("secciones").delete().eq("id",id);
      cargarSecciones();
    }

    cargarSecciones();
  </script>
</body>
</html>
