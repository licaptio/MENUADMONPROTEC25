<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üó∫Ô∏è Recorrido Virtual</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#111; color:#fff; }
    h1 { text-align:center; padding:15px; background:#222; margin:0; }
    #panorama { width:100%; height:90vh; }
  </style>
</head>
<body>
  <h1>üåç Recorrido Virtual</h1>
  <div id="panorama"></div>

  <script>
    // üöÄ Conexi√≥n Supabase
    const supabase = window.supabase.createClient(
      "https://cvpbtjlupswbyxenugpz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
    );

    let viewer;
    let scenes = {};

    async function cargarRecorrido() {
      // üìå 1. Traer todas las secciones
      const { data: secciones, error: err1 } = await supabase.from("secciones").select("*");
      if (err1) { console.error(err1); return; }

      // üìå 2. Traer todos los enlaces
      const { data: enlaces, error: err2 } = await supabase.from("enlaces").select("*");
      if (err2) { console.error(err2); return; }

      // üìå 3. Construir escenas
      secciones.forEach(sec => {
        scenes[sec.id] = {
          title: sec.nombre,
          hfov: 110,
          pitch: 0,
          yaw: 0,
          type: "equirectangular",
          panorama: sec.img_url,
          hotSpots: []  // se rellenan abajo
        };
      });

      // üìå 4. Agregar enlaces como hotspots
      enlaces.forEach(enl => {
        if (scenes[enl.from_seccion]) {
          scenes[enl.from_seccion].hotSpots.push({
            pitch: parseFloat(enl.y), // vertical
            yaw: parseFloat(enl.x),   // horizontal
            type: "scene",
            text: `Ir a ${enl.to_seccion}`,
            sceneId: enl.to_seccion
          });
        }
      });

      // üìå 5. Inicializar viewer
      viewer = pannellum.viewer('panorama', {
        default: {
          firstScene: secciones[0]?.id || "",
          sceneFadeDuration: 1000
        },
        scenes: scenes
      });
    }

    cargarRecorrido();
  </script>
</body>
</html>
