<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>‚öôÔ∏è Administraci√≥n de Secciones</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#f4f4f4; color:#333; }
    header { background:#007bff; color:white; padding:14px; text-align:center; font-size:18px; }
    h2 { font-size:16px; margin:14px 0 6px; text-align:center; }
    form { margin:12px auto; padding:12px; background:#fff; border-radius:10px; max-width:95%; box-shadow:0 2px 6px rgba(0,0,0,.1); }
    input, select, button { width:100%; padding:10px; margin:6px 0; border-radius:6px; border:1px solid #ccc; font-size:15px; }
    button { background:#007bff; color:white; font-weight:bold; border:none; }
    button:hover { background:#0056b3; }
    .grid { display:grid; grid-template-columns:1fr; gap:12px; padding:12px; }
    @media (min-width:600px){ .grid{ grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); } }
    .card { background:white; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.1); overflow:hidden; }
    .card img { width:100%; height:160px; object-fit:cover; }
    .card h3 { margin:10px; font-size:16px; }
    .card p { margin:6px 10px; font-size:14px; color:#555; }
    .acciones { display:flex; gap:6px; flex-wrap:wrap; padding:8px; }
    .acciones button, .acciones select { flex:1; padding:8px; font-size:13px; border-radius:6px; }
    .edit { background:#ffc107; color:#000; }
    .edit:hover { background:#e0a800; }
    .delete { background:#dc3545; }
    .delete:hover { background:#a71d2a; }
  </style>
</head>
<body>
  <header>‚öôÔ∏è Administraci√≥n de Secciones</header>

  <!-- Crear secci√≥n -->
  <form id="formSeccion">
    <h2>‚ûï Nueva Secci√≥n</h2>
    <select id="bodegaId" required>
      <option value="B1">Bodega Central</option>
      <option value="B2">Bodega L√≠quido</option>
      <option value="B3">Bodega Zapata</option>
      <option value="B4">Bodega Cigarro</option>
      <option value="B5">Bodega Tienda PDD</option>
      <option value="B6">Bodega Extra</option>
    </select>
    <input type="text" id="idSeccion" placeholder="ID secci√≥n (ej: B1A1)" required>
    <input type="text" id="nombreSeccion" placeholder="Nombre de la secci√≥n" required>
    <input type="file" id="foto" accept="image/*" required>
    <button type="submit">Crear Secci√≥n</button>
  </form>

  <h2>üìã Lista de Secciones</h2>
  <div id="gridSecciones" class="grid"></div>

  <script>
    const supabase = window.supabase.createClient(
      "https://cvpbtjlupswbyxenugpz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
    );

    const form = document.getElementById("formSeccion");
    const gridSecciones = document.getElementById("gridSecciones");

    // üîπ Cargar secciones
    async function cargarSecciones() {
      const { data, error } = await supabase.from("secciones").select("*").order("created_at",{ascending:false});
      if (error) return console.error(error);
      gridSecciones.innerHTML = "";
      data.forEach(sec => {
        const card = document.createElement("div");
        card.className="card";
        card.innerHTML = `
          <img src="${sec.img_url}" alt="${sec.nombre}">
          <h3>${sec.nombre}</h3>
          <p><b>ID:</b> ${sec.id}</p>
          <p><b>Bodega:</b> ${sec.bodega_id}</p>
          <div class="acciones">
            <select onchange="cambiarModo('${sec.id}', this.value)">
              <option value="contain" ${sec.display_mode === "contain" ? "selected" : ""}>Centrada</option>
              <option value="cover" ${sec.display_mode === "cover" ? "selected" : ""}>Pantalla completa</option>
            </select>
            <button class="edit" onclick="editarSeccion('${sec.id}','${sec.nombre}')">‚úèÔ∏è Editar</button>
            <button class="delete" onclick="eliminarSeccion('${sec.id}')">‚ùå Eliminar</button>
          </div>
        `;
        gridSecciones.appendChild(card);
      });
    }

    // üîπ Crear secci√≥n
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("idSeccion").value;
      const nombre = document.getElementById("nombreSeccion").value;
      const bodega = document.getElementById("bodegaId").value;
      const archivo = document.getElementById("foto").files[0];

      const { error: err1 } = await supabase
        .storage.from("recorridos")
        .upload(`bodega${bodega}/${id}.jpg`, archivo, { upsert: true });
      if (err1) { alert("Error al subir imagen"); return; }

      const urlPublica = supabase
        .storage.from("recorridos")
        .getPublicUrl(`bodega${bodega}/${id}.jpg`).data.publicUrl;

      const { error: err2 } = await supabase.from("secciones").insert([
        { id, bodega_id: bodega, nombre, img_url: urlPublica, display_mode:"contain" }
      ]);
      if (err2) { console.error(err2); alert("Error al guardar en DB"); return; }

      form.reset();
      cargarSecciones();
    });

    // üîπ Cambiar modo visualizaci√≥n
    async function cambiarModo(id, modo) {
      const { error } = await supabase.from("secciones").update({ display_mode: modo }).eq("id", id);
      if (error) alert("Error al actualizar modo");
    }

    // üîπ Editar nombre secci√≥n
    async function editarSeccion(id,nombreActual){
      const nuevoNombre = prompt("Nuevo nombre de la secci√≥n:", nombreActual);
      if (!nuevoNombre) return;
      await supabase.from("secciones").update({nombre:nuevoNombre}).eq("id",id);
      cargarSecciones();
    }

    // üîπ Eliminar secci√≥n
    async function eliminarSeccion(id){
      if (!confirm("¬øEliminar secci√≥n "+id+"?")) return;
      await supabase.from("secciones").delete().eq("id",id);
      cargarSecciones();
    }

    cargarSecciones();
  </script>
</body>
</html>
