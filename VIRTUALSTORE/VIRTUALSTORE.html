<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üó∫Ô∏è Recorrido Virtual con Zoom</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#000;
      --panel:#1f1f1f;
      --chip:#2a2a2a;
      --chip-active:#4c8bf5;
      --chip-text:#ddd;
      --chip-active-text:#fff;
      --border:#3a3a3a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: var(--bg);
      font-family: Arial, sans-serif;
      overflow: hidden;
      color:#eee;
    }
    h1 {
      text-align: center;
      padding: 12px 16px;
      background: #333;
      color: white;
      margin: 0;
      font-size: clamp(16px, 2.2vw, 22px);
    }

    /* Barra de secciones */
    #seccionesBar {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 10px 12px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      scrollbar-width: thin;
      -webkit-overflow-scrolling: touch;
      white-space: nowrap;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--chip);
      color: var(--chip-text);
      border: 1px solid var(--border);
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
      font-size: 14px;
      transition: transform .15s ease, background .15s ease, color .15s ease, border-color .15s ease;
      flex: 0 0 auto;
    }
    .chip:hover { transform: translateY(-1px); border-color:#555; }
    .chip.active {
      background: var(--chip-active);
      color: var(--chip-active-text);
      border-color: transparent;
      font-weight: 600;
    }

    /* Contenedor principal */
    #viewerWrapper{
      height: calc(100% - 60px - 52px); /* h1 + barra chips */
      width: 100%;
    }
    @media (max-width:600px){
      #viewerWrapper{ height: calc(100% - 56px - 56px); }
    }

    #viewer {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      cursor: grab;
      background:#000;
    }
    #viewer img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.2s ease;
      transform-origin: center center;
      will-change: transform;
      /* para que no arrastre la imagen por defecto */
      user-select:none;
      pointer-events: none;
    }

    .hotspot {
      position: absolute;
      width: 28px;
      height: 28px;
      background: grey;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid white;
      transform: translate(-50%, -50%);
      animation: parpadeo 2s infinite ease-in-out;
      z-index: 10;
    }
    .hotspot:hover { transform: translate(-50%, -50%) scale(1.2); }
    @keyframes parpadeo { 0%,100%{opacity:.4} 50%{opacity:1} }

    /* Etiqueta flotante opcional sobre hotspots (tooltip simple) */
    .hotspot[data-title]:hover::after{
      content: attr(data-title);
      position:absolute; left:50%; top:-8px; transform:translate(-50%,-100%);
      background: rgba(0,0,0,.8);
      border:1px solid #fff2; color:#fff; padding:4px 8px; border-radius:6px;
      font-size:12px; white-space:nowrap; pointer-events:none;
    }
  </style>
</head>
<body>
  <h1>üó∫Ô∏è Recorrido Virtual</h1>
  <div id="seccionesBar" aria-label="Lista de secciones" role="tablist"></div>
  <div id="viewerWrapper">
    <div id="viewer" aria-label="Visor de secci√≥n">
      <img id="viewerImg" src="" alt="Secci√≥n actual">
    </div>
  </div>

  <script>
    // üîπ Configuraci√≥n Supabase
    const supabase = window.supabase.createClient(
      "https://cvpbtjlupswbyxenugpz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
    );

    // Estructuras
    let secciones = {};        // mapa {id: {id, nombre, img_url, display_mode, ...}}
    let ordenSecciones = [];   // para render de chips
    let enlaces = [];
    let actual = null;

    // üîπ Variables para zoom/pan
    let scale = 1;
    let posX = 0, posY = 0;
    let isDragging = false;
    let startX, startY;

    const viewer = document.getElementById("viewer");
    const img = document.getElementById("viewerImg");
    const seccionesBar = document.getElementById("seccionesBar");

    // ====== Interacciones Zoom / Pan ======
    viewer.addEventListener("wheel", (e) => {
      e.preventDefault();
      const zoomSpeed = 0.1;
      if (e.deltaY < 0) {
        scale += zoomSpeed; // acercar
      } else {
        scale = Math.max(1, scale - zoomSpeed); // alejar (m√≠nimo 1x)
      }
      actualizarTransform();
    });

    viewer.addEventListener("mousedown", (e) => {
      isDragging = true;
      startX = e.clientX - posX;
      startY = e.clientY - posY;
      viewer.style.cursor = "grabbing";
    });
    window.addEventListener("mouseup", () => { // usa window por si sueltan fuera del visor
      isDragging = false;
      viewer.style.cursor = "grab";
    });
    viewer.addEventListener("mouseleave", () => {
      isDragging = false;
      viewer.style.cursor = "grab";
    });
    viewer.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      posX = e.clientX - startX;
      posY = e.clientY - startY;
      actualizarTransform();
    });

    // Soporte t√°ctil (pan/zoom b√°sico pinch-to-zoom con dos dedos)
    let lastTouchDist = null;
    viewer.addEventListener("touchstart", (e) => {
      if (e.touches.length === 1) {
        isDragging = true;
        startX = e.touches[0].clientX - posX;
        startY = e.touches[0].clientY - posY;
      } else if (e.touches.length === 2) {
        isDragging = false;
        lastTouchDist = distancia(e.touches[0], e.touches[1]);
      }
    }, {passive:false});
    viewer.addEventListener("touchmove", (e) => {
      if (e.touches.length === 1 && isDragging) {
        posX = e.touches[0].clientX - startX;
        posY = e.touches[0].clientY - startY;
        actualizarTransform();
      } else if (e.touches.length === 2) {
        e.preventDefault();
        const d = distancia(e.touches[0], e.touches[1]);
        if (lastTouchDist !== null) {
          const delta = (d - lastTouchDist) / 200; // sensibilidad
          scale = Math.max(1, scale + delta);
          actualizarTransform();
        }
        lastTouchDist = d;
      }
    }, {passive:false});
    window.addEventListener("touchend", () => { isDragging = false; lastTouchDist = null; });

    function distancia(a,b){
      const dx = a.clientX - b.clientX;
      const dy = a.clientY - b.clientY;
      return Math.hypot(dx, dy);
    }

    function actualizarTransform() {
      img.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
    }

    // ====== Datos desde Supabase ======
    async function cargarDatos() {
      const { data: secs, error: err1 } = await supabase.from("secciones").select("*");
      if (err1) { alert("Error cargando secciones"); console.error(err1); return; }

      const { data: links, error: err2 } = await supabase.from("enlaces").select("*");
      if (err2) { alert("Error cargando enlaces"); console.error(err2); }

      if (!secs || secs.length === 0) return alert("No hay secciones cargadas");

      // Construye mapa y orden (ordena por 'orden' si existe, luego por nombre)
      secs.forEach(s => { secciones[s.id] = s; });
      ordenSecciones = [...secs].sort((a,b)=>{
        const ao = a.orden ?? Number.MAX_SAFE_INTEGER;
        const bo = b.orden ?? Number.MAX_SAFE_INTEGER;
        if (ao !== bo) return ao - bo;
        const an = (a.nombre || a.id || "").toString().toLowerCase();
        const bn = (b.nombre || b.id || "").toString().toLowerCase();
        return an.localeCompare(bn);
      }).map(s => s.id);

      enlaces = links || [];

      renderSeccionesBar();

      // arranca en esta secci√≥n (si existe), si no toma la primera del orden
      const startId = secciones["PDD"] ? "PDD" : ordenSecciones[0];
      mostrarSeccion(startId);
    }

    // ====== UI: Barra de secciones ======
    function renderSeccionesBar(){
      seccionesBar.innerHTML = "";
      ordenSecciones.forEach((id) => {
        const s = secciones[id];
        const label = (s.nombre && s.nombre.trim()) ? s.nombre : s.id;
        const chip = document.createElement("button");
        chip.className = "chip";
        chip.setAttribute("role","tab");
        chip.setAttribute("aria-selected","false");
        chip.dataset.id = id;
        chip.title = label;
        chip.textContent = label;
        chip.onclick = () => mostrarSeccion(id);
        seccionesBar.appendChild(chip);
      });
    }

    function setChipActiva(id){
      const chips = seccionesBar.querySelectorAll(".chip");
      chips.forEach(ch => {
        const active = ch.dataset.id === id;
        ch.classList.toggle("active", active);
        ch.setAttribute("aria-selected", active ? "true":"false");
        if (active) {
          // Autodesplazar suavemente para dejar visible la activa
          ch.scrollIntoView({behavior:"smooth", inline:"center", block:"nearest"});
        }
      });
    }

    // ====== Navegaci√≥n entre secciones ======
    function mostrarSeccion(id) {
      if (!secciones[id]) { console.warn("Secci√≥n no encontrada:", id); return; }
      actual = id;

      // Reset zoom/pan al cambiar de foto
      posX = 0; posY = 0; scale = 1;
      actualizarTransform();

      // Carga imagen y modo
      img.src = secciones[id].img_url;
      img.style.objectFit = secciones[id].display_mode || "contain";
      img.alt = `Secci√≥n: ${(secciones[id].nombre || secciones[id].id)}`;

      // Limpia hotspots previos
      viewer.querySelectorAll(".hotspot").forEach(h => h.remove());

      // Render hotspots salientes desde la secci√≥n actual
      const misEnlaces = enlaces.filter(e => e.from_seccion === id);
      misEnlaces.forEach(e => {
        const hs = document.createElement("div");
        hs.className = "hotspot";
        hs.style.left = (e.x ?? 50) + "%";
        hs.style.top = (e.y ?? 50) + "%";
        // Muestra como tooltip el destino si lo tenemos en cat√°logo
        const destino = secciones[e.to_seccion];
        if (destino) hs.setAttribute("data-title", destino.nombre || destino.id);
        hs.onclick = () => mostrarSeccion(e.to_seccion);
        viewer.appendChild(hs);
      });

      // Marca chip activo
      setChipActiva(id);
    }

    // Init
    cargarDatos();
  </script>
</body>
</html>
