window.cargarDatos = async function () {
  const prov = document.getElementById("selProveedor").value;
  if (!prov) return;

  let { data, error } = await supabaseClient
    .from("estadisticapagos")
    .select("fecha,cargo")
    .eq("proveedor", prov)
    .order("fecha");

  if (error) return console.error(error);

  // ðŸ“Œ Agrupar por mes (ej: 2025-09)
  const agrupado = {};
  data.forEach(r => {
    const d = new Date(r.fecha);
    const clave = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    agrupado[clave] = (agrupado[clave] || 0) + r.cargo;
  });

  // Convertir a arrays ordenados
  const labels = Object.keys(agrupado).sort();
  const valores = labels.map(k => agrupado[k]);

  // Tabla detallada (se sigue mostrando todo)
  const tbody = document.querySelector("#tabla tbody");
  tbody.innerHTML = "";
  data.forEach(r=>{
    const f = new Date(r.fecha).toLocaleDateString("es-MX",
      {weekday:"short", day:"2-digit", month:"short", year:"2-digit"});
    tbody.innerHTML += `<tr><td>${f}</td>
      <td>${r.cargo.toLocaleString("es-MX",{minimumFractionDigits:2})}</td></tr>`;
  });

  // ðŸ“Š GrÃ¡fico agrupado por mes
  const ctx = document.getElementById("grafico");
  new Chart(ctx, {
    type: "line",
    data: {
      labels: labels, // ej: ["2025-07","2025-08","2025-09"]
      datasets: [{
        label: "Pagos " + prov,
        data: valores,
        borderColor: "blue",
        fill: false
      }]
    }
  });
}
